{% extends 'painel_cliente/base.html' %}
{% load static %}

{% block title %}Meu Perfil{% endblock %}

{% block body_class %}page-perfil{% endblock %}

{% block content %}
<div class="perfil-page">
  <!-- Page Header -->
  <header class="page-header animate-fade-in-up">
    <div class="page-header-content">
      {% if not primeiro_acesso %}
      <a href="{% url 'painel_cliente:dashboard' %}" class="btn-back">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="19" y1="12" x2="5" y2="12"></line>
          <polyline points="12 19 5 12 12 5"></polyline>
        </svg>
      </a>
      {% endif %}
      <div class="page-title-wrapper">
        <h1 class="page-title">
          {% if primeiro_acesso %}
          Complete seu cadastro
          {% else %}
          Meu Perfil
          {% endif %}
        </h1>
        <p class="page-subtitle">
          {% if primeiro_acesso %}
          Precisamos de algumas informações para continuar
          {% else %}
          Gerencie suas informações pessoais
          {% endif %}
        </p>
      </div>
    </div>
  </header>

  <!-- First Access Alert -->
  {% if primeiro_acesso %}
  <div class="alert alert-info animate-fade-in-up" style="animation-delay: 0.1s;">
    <div class="alert-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="16" x2="12" y2="12"></line>
        <line x1="12" y1="8" x2="12.01" y2="8"></line>
      </svg>
    </div>
    <div class="alert-content">
      <p class="alert-title">Bem-vindo!</p>
      <p class="alert-message">Complete seus dados para ter acesso completo ao painel.</p>
    </div>
  </div>
  {% endif %}

  <!-- Success Message -->
  {% if messages %}
  {% for message in messages %}
  <div class="alert alert-{{ message.tags }} animate-fade-in-up" style="animation-delay: 0.1s;">
    <div class="alert-icon">
      {% if message.tags == 'success' %}
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
      {% else %}
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      {% endif %}
    </div>
    <div class="alert-content">
      <p class="alert-message">{{ message }}</p>
    </div>
  </div>
  {% endfor %}
  {% endif %}

  <!-- Profile Card -->
  <div class="card perfil-card animate-fade-in-up" style="animation-delay: 0.15s;">
    <!-- Avatar Section -->
    <div class="perfil-avatar-section">
      <div class="perfil-avatar">
        <span class="perfil-avatar-text">{{ cliente.nome|slice:":1"|upper|default:"?" }}</span>
      </div>
      <div class="perfil-avatar-info">
        <p class="perfil-avatar-name">{{ cliente.nome|default:"Novo Cliente" }}</p>
        <p class="perfil-avatar-since">Cliente desde {{ cliente.data_adesao|date:"d \d\e F \d\e Y"|default:"hoje" }}</p>
      </div>
    </div>

    <!-- Form -->
    <form method="post" action="{% url 'painel_cliente:perfil' %}" class="perfil-form" id="perfil-form">
      {% csrf_token %}

      <!-- Nome -->
      <div class="form-group">
        <label for="nome" class="form-label">
          Nome Completo
          <span class="form-label-required">*</span>
        </label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <input
            type="text"
            class="form-input"
            id="nome"
            name="nome"
            value="{{ cliente.nome|default:'' }}"
            placeholder="Seu nome completo"
            required
            autocomplete="name"
          >
        </div>
      </div>

      <!-- Telefone (readonly) -->
      <div class="form-group">
        <label for="telefone" class="form-label">Telefone</label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          <input
            type="text"
            class="form-input form-input-disabled"
            id="telefone"
            value="{{ cliente.telefone }}"
            disabled
            readonly
          >
          <div class="input-lock-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
        </div>
        <p class="form-hint">O telefone não pode ser alterado</p>
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="email" class="form-label">
          Email
          <span class="form-label-required">*</span>
        </label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
          </svg>
          <input
            type="email"
            class="form-input"
            id="email"
            name="email"
            value="{{ cliente.email|default:'' }}"
            placeholder="seu@email.com"
            autocomplete="email"
            required
          >
        </div>
        <p class="form-hint">Usado para enviar códigos de acesso</p>
      </div>

      <!-- CPF -->
      <div class="form-group">
        <label for="cpf" class="form-label">
          CPF
          <span class="form-label-required">*</span>
        </label>
        <div class="input-icon-wrapper">
          <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
            <line x1="2" y1="10" x2="22" y2="10"></line>
          </svg>
          <input
            type="text"
            class="form-input"
            id="cpf"
            name="cpf"
            value="{{ cliente.cpf|default:'' }}"
            placeholder="000.000.000-00"
            maxlength="14"
            autocomplete="off"
            inputmode="numeric"
            required
          >
        </div>
        <p class="form-hint">Necessário para emissão de comprovantes</p>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary btn-lg btn-block" id="btn-salvar">
          <span class="btn-text">
            {% if primeiro_acesso %}
            Salvar e Continuar
            {% else %}
            Salvar Alterações
            {% endif %}
          </span>
          <svg class="btn-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
        </button>

        {% if not primeiro_acesso %}
        <a href="{% url 'painel_cliente:dashboard' %}" class="btn btn-ghost btn-block">
          Voltar ao Dashboard
        </a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- Security Info -->
  <div class="security-info animate-fade-in-up" style="animation-delay: 0.2s;">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
    </svg>
    <span>Seus dados estão protegidos e seguros</span>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .perfil-page {
    max-width: 540px;
    margin: 0 auto;
    padding: var(--space-4);
  }

  /* Page Header */
  .page-header {
    margin-bottom: var(--space-6);
  }

  .page-header-content {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
  }

  .btn-back {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: var(--radius-lg);
    background: var(--color-surface);
    color: var(--color-text-secondary);
    border: 1px solid var(--color-border);
    transition: all var(--transition-fast);
    flex-shrink: 0;
  }

  .btn-back:hover {
    background: var(--color-surface-hover);
    color: var(--color-text-primary);
  }

  .page-title-wrapper {
    flex: 1;
  }

  .page-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-1) 0;
    line-height: 1.2;
  }

  .page-subtitle {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Alert */
  .alert {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-4);
  }

  .alert-info {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.2);
  }

  .alert-info .alert-icon {
    color: var(--color-info);
  }

  .alert-success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
  }

  .alert-success .alert-icon {
    color: var(--color-success);
  }

  .alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
  }

  .alert-error .alert-icon {
    color: var(--color-danger);
  }

  .alert-icon {
    flex-shrink: 0;
  }

  .alert-content {
    flex: 1;
  }

  .alert-title {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-1) 0;
    font-size: var(--text-sm);
  }

  .alert-message {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Profile Card */
  .perfil-card {
    background: var(--color-surface);
    border-radius: var(--radius-2xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--color-border-light);
  }

  /* Avatar Section */
  .perfil-avatar-section {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding-bottom: var(--space-5);
    margin-bottom: var(--space-5);
    border-bottom: 1px solid var(--color-border-light);
  }

  .perfil-avatar {
    width: 64px;
    height: 64px;
    border-radius: var(--radius-full);
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .perfil-avatar-text {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: white;
  }

  .perfil-avatar-info {
    flex: 1;
    min-width: 0;
  }

  .perfil-avatar-name {
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin: 0 0 var(--space-1) 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .perfil-avatar-since {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Form */
  .perfil-form {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-1);
  }

  .form-label-required {
    color: var(--color-danger);
  }

  .input-icon-wrapper {
    position: relative;
  }

  .input-icon {
    position: absolute;
    left: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
    transition: color var(--transition-fast);
  }

  .input-icon-wrapper .form-input {
    padding-left: calc(var(--space-4) + 28px);
  }

  .input-icon-wrapper:focus-within .input-icon {
    color: var(--color-primary);
  }

  .input-lock-icon {
    position: absolute;
    right: var(--space-4);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .form-input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-base);
    color: var(--color-text-primary);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all var(--transition-fast);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
  }

  .form-input::placeholder {
    color: var(--color-text-muted);
  }

  .form-input-disabled {
    background: var(--color-surface-elevated);
    color: var(--color-text-muted);
    cursor: not-allowed;
    padding-right: calc(var(--space-4) + 24px);
  }

  .form-hint {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Form Actions */
  .form-actions {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
    margin-top: var(--space-2);
  }

  .btn-text {
    transition: transform var(--transition-fast);
  }

  .btn-icon {
    width: 20px;
    height: 20px;
    transition: transform var(--transition-fast);
  }

  .btn:hover .btn-icon {
    transform: scale(1.1);
  }

  .btn-ghost {
    background: transparent;
    color: var(--color-text-secondary);
    border: none;
    padding: var(--space-3);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
  }

  .btn-ghost:hover {
    color: var(--color-text-primary);
    background: var(--color-surface-hover);
  }

  /* Security Info */
  .security-info {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-5);
    padding: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
  }

  .security-info svg {
    color: var(--color-success);
    flex-shrink: 0;
  }

  /* Responsive */
  @media (max-width: 480px) {
    .perfil-page {
      padding: var(--space-3);
    }

    .perfil-card {
      padding: var(--space-5);
      border-radius: var(--radius-xl);
    }

    .perfil-avatar {
      width: 56px;
      height: 56px;
    }

    .perfil-avatar-text {
      font-size: var(--text-xl);
    }
  }

  /* Dark mode */
  [data-theme="dark"] .form-input {
    background: var(--color-surface-elevated);
  }

  [data-theme="dark"] .form-input-disabled {
    background: var(--color-surface);
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('perfil-form');
    const cpfInput = document.getElementById('cpf');
    const nomeInput = document.getElementById('nome');
    const btnSalvar = document.getElementById('btn-salvar');

    // CPF Mask
    cpfInput.addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);

      if (value.length > 9) {
        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
      } else if (value.length > 6) {
        value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
      } else if (value.length > 3) {
        value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
      }

      e.target.value = value;
    });

    // CPF Validation
    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11) return false;
      if (/^(\d)\1+$/.test(cpf)) return false;

      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;

      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }
      resto = (soma * 10) % 11;
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(10))) return false;

      return true;
    }

    // Form submit
    const emailInput = document.getElementById('email');

    form.addEventListener('submit', function(e) {
      // Validate name
      const nome = nomeInput.value.trim();
      if (nome.length < 3) {
        e.preventDefault();
        nomeInput.focus();
        if (window.Toast) {
          Toast.error('Nome deve ter pelo menos 3 caracteres');
        }
        return;
      }

      // Validate email (required)
      const emailValue = emailInput.value.trim();
      if (!emailValue) {
        e.preventDefault();
        emailInput.focus();
        if (window.Toast) {
          Toast.error('Email é obrigatório');
        }
        return;
      }

      // Validate CPF (required)
      const cpfValue = cpfInput.value.trim();
      if (!cpfValue) {
        e.preventDefault();
        cpfInput.focus();
        if (window.Toast) {
          Toast.error('CPF é obrigatório');
        }
        return;
      }

      if (!validarCPF(cpfValue)) {
        e.preventDefault();
        cpfInput.focus();
        if (window.Toast) {
          Toast.error('CPF inválido. Verifique os dígitos.');
        }
        return;
      }

      // Show loading state
      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="spinner spinner-sm"></span> Salvando...';
    });

    // Update avatar initial when name changes
    nomeInput.addEventListener('input', function() {
      const avatarText = document.querySelector('.perfil-avatar-text');
      const avatarName = document.querySelector('.perfil-avatar-name');
      if (avatarText && this.value) {
        avatarText.textContent = this.value.charAt(0).toUpperCase();
      }
      if (avatarName) {
        avatarName.textContent = this.value || 'Novo Cliente';
      }
    });
  });
</script>
{% endblock %}
