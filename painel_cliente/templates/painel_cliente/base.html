{% load static %}
<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- Title -->
  <title>{% block title %}Painel de Pagamentos{% endblock %} | {{ config.nome_exibicao|default:"Pagamentos" }}</title>

  <!-- SEO Meta Tags -->
  <meta name="description" content="Gerencie suas mensalidades de forma simples e segura">
  <meta name="robots" content="noindex, nofollow">

  <!-- Theme Color (dynamic based on subdominio config) -->
  <meta name="theme-color" content="{{ config.cor_primaria|default:'#8B5CF6' }}" id="theme-color-meta">
  <meta name="msapplication-TileColor" content="{{ config.cor_primaria|default:'#8B5CF6' }}">

  <!-- Favicon and Apple Touch Icon (uses uploaded logo if available) -->
  {% if config and config.logo %}
  <link rel="icon" href="{{ config.logo.url }}">
  <link rel="shortcut icon" href="{{ config.logo.url }}">
  <link rel="apple-touch-icon" sizes="180x180" href="{{ config.logo.url }}">
  {% else %}
  <link rel="icon" type="image/png" sizes="32x32" href="{% static 'painel_cliente/icons/icon-192.png' %}">
  <link rel="shortcut icon" type="image/png" href="{% static 'painel_cliente/icons/icon-192.png' %}">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'painel_cliente/icons/icon-192.png' %}">
  {% endif %}

  <!-- PWA Manifest -->
  <link rel="manifest" href="{% static 'painel_cliente/manifest.json' %}">

  <!-- iOS PWA Settings -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="{{ config.nome_exibicao|default:'Pagamentos' }}">

  <!-- Preconnect to Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <!-- Google Fonts - Plus Jakarta Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- CSS Variables from SubdominioPainelCliente -->
  <style>
    :root {
      --cor-primaria: {{ config.cor_primaria|default:"#8B5CF6" }};
      --cor-secundaria: {{ config.cor_secundaria|default:"#06B6D4" }};
    }

    /* Loading Screen Styles */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--color-background, #0F0D1A);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .loading-content {
      text-align: center;
    }

    .loading-logo {
      max-width: 120px;
      max-height: 80px;
      margin-bottom: 1.5rem;
      animation: loading-pulse 1.5s ease-in-out infinite;
    }

    .loading-logo-text {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-secundaria) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1.5rem;
    }

    .loading-spinner {
      display: flex;
      justify-content: center;
    }

    @keyframes loading-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.98); }
    }
  </style>

  <!-- Design System CSS -->
  <link rel="stylesheet" href="{% static 'painel_cliente/css/variables.css' %}">
  <link rel="stylesheet" href="{% static 'painel_cliente/css/base.css' %}">
  <link rel="stylesheet" href="{% static 'painel_cliente/css/components.css' %}">
  <link rel="stylesheet" href="{% static 'painel_cliente/css/utilities.css' %}">
  <link rel="stylesheet" href="{% static 'painel_cliente/css/animations.css' %}">
  <link rel="stylesheet" href="{% static 'painel_cliente/css/dark-mode.css' %}">

  <!-- Page-specific CSS -->
  {% block extra_css %}{% endblock %}

  <!-- Page-specific head content (external CSS, etc) -->
  {% block extra_head %}{% endblock %}

</head>
<body class="{% block body_class %}{% endblock %}">
  <!-- Skip to content link for accessibility -->
  <a href="#main-content" class="skip-link">Pular para o conteúdo</a>

  <!-- Loading Screen -->
  <div id="loading-screen" class="loading-screen">
    <div class="loading-content">
      {% if config.logo %}
      <img src="{{ config.logo.url }}" alt="{{ config.nome_exibicao }}" class="loading-logo">
      {% else %}
      <div class="loading-logo-text">{{ config.nome_exibicao|default:"Pagamentos" }}</div>
      {% endif %}
      <div class="loading-spinner">
        <div class="spinner spinner-lg"></div>
      </div>
    </div>
  </div>

  {% block body %}
  <!-- Header -->
  {% block header %}
  {% if cliente %}
  <header class="header">
    <div class="container">
      <div class="header-content">
        <!-- Logo/Brand -->
        <a href="{% url 'painel_cliente:dashboard' %}" class="header-brand">
          {% if config.logo %}
          <img src="{{ config.logo.url }}" alt="{{ config.nome_exibicao }}" class="header-logo">
          {% else %}
          <span class="header-title">{{ config.nome_exibicao }}</span>
          {% endif %}
        </a>

        <!-- Right side -->
        <div class="header-actions">
          <!-- User Menu -->
          <div class="dropdown">
            <button type="button" class="user-menu-trigger" id="user-menu-trigger" aria-expanded="false" aria-haspopup="true">
              <div class="avatar avatar-sm">
                {{ cliente.nome|slice:":1"|upper }}
              </div>
              <span class="user-name" data-fullname="{{ cliente.nome }}">{{ cliente.nome }}</span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <div class="dropdown-menu" id="user-menu">
              <a href="{% url 'painel_cliente:perfil' %}" class="dropdown-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                  <circle cx="12" cy="7" r="4"></circle>
                </svg>
                Meu Perfil
              </a>
              <a href="{% url 'painel_cliente:historico' %}" class="dropdown-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Histórico
              </a>
              <div class="dropdown-divider"></div>
              <a href="{% url 'painel_cliente:logout' %}" class="dropdown-item dropdown-item-danger">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                  <polyline points="16 17 21 12 16 7"></polyline>
                  <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                Sair
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
  {% endif %}
  {% endblock %}

  <!-- Main Content -->
  <main id="main-content" class="main-content">
    <div class="container">
      {% block content %}{% endblock %}
    </div>
  </main>
  {% endblock %}

  <!-- WhatsApp FAB -->
  {% if config.whatsapp_suporte %}
  <a href="{{ config.get_whatsapp_url }}"
     target="_blank"
     rel="noopener noreferrer"
     class="fab fab-animate-in"
     aria-label="Falar com suporte via WhatsApp"
     title="Falar com suporte">
    <svg class="fab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
    </svg>
  </a>
  {% endif %}

  <!-- Toast Container -->
  <div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Base JavaScript -->
  <script src="{% static 'painel_cliente/js/app.js' %}" defer></script>
  <script src="{% static 'painel_cliente/js/toast.js' %}" defer></script>

  <!-- Page-specific JavaScript -->
  {% block extra_js %}{% endblock %}

  <!-- Loading Screen Controller -->
  <script>
    (function() {
      // Configuração do tempo de carregamento (em milissegundos)
      var LOADING_DURATION = 3000; // 3 segundos

      var LoadingScreen = {
        element: null,
        hideTimeout: null,
        isNavigating: false,

        init: function() {
          this.element = document.getElementById('loading-screen');
          if (!this.element) return;

          var self = this;

          // Garante que o loading esteja visível no início
          this.element.classList.remove('hidden');

          // Esconde loading após duração de 3 segundos
          this.hideTimeout = setTimeout(function() {
            self.hide();
          }, LOADING_DURATION);

          // Mostra loading ao navegar para outra página (links internos)
          document.addEventListener('click', function(e) {
            var link = e.target.closest('a[href]');
            if (link && self.isInternalLink(link)) {
              self.showForNavigation();
            }
          });

          // Mostra loading ao submeter formulário (exceto AJAX)
          document.addEventListener('submit', function(e) {
            var form = e.target;
            if (form && !form.hasAttribute('data-ajax')) {
              self.showForNavigation();
            }
          });

          // Mostra loading quando a página está sendo descarregada (F5, navegação, etc)
          window.addEventListener('beforeunload', function() {
            self.showForNavigation();
          });

          // Garante loading em navegação via histórico (botões voltar/avançar)
          window.addEventListener('pagehide', function() {
            self.showForNavigation();
          });

          // Para navegação via bfcache (back-forward cache)
          window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
              // Página restaurada do cache - mostra loading por 3 segundos
              self.isNavigating = false;
              self.show();
              setTimeout(function() {
                self.hide();
              }, LOADING_DURATION);
            }
          });
        },

        isInternalLink: function(link) {
          var href = link.getAttribute('href');
          if (!href) return false;
          if (href.startsWith('#') || href.startsWith('javascript:')) return false;
          if (link.target === '_blank') return false;
          if (link.hasAttribute('download')) return false;
          if (link.classList.contains('no-loading')) return false;
          // Links internos: relativos ou do mesmo origin
          return href.startsWith('/') || href.startsWith(window.location.origin);
        },

        show: function() {
          if (this.element) {
            this.element.classList.remove('hidden');
          }
        },

        showForNavigation: function() {
          this.isNavigating = true;
          this.show();
        },

        hide: function() {
          if (this.element && !this.isNavigating) {
            this.element.classList.add('hidden');
          }
          if (this.hideTimeout) {
            clearTimeout(this.hideTimeout);
          }
        },

        // Método para forçar o loading por 3 segundos (pode ser chamado externamente)
        forceShow: function() {
          var self = this;
          this.isNavigating = false;
          this.show();
          if (this.hideTimeout) {
            clearTimeout(this.hideTimeout);
          }
          this.hideTimeout = setTimeout(function() {
            self.hide();
          }, LOADING_DURATION);
        }
      };

      // Inicializa imediatamente para garantir que o loading apareça
      LoadingScreen.init();

      // Expõe globalmente para páginas específicas
      window.LoadingScreen = LoadingScreen;
    })();
  </script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('{% static "painel_cliente/sw.js" %}')
          .then(function(registration) {
            console.log('[SW] Registered:', registration.scope);
          })
          .catch(function(error) {
            console.log('[SW] Registration failed:', error);
          });
      });
    }
  </script>

  <!-- CSRF Token for AJAX requests -->
  <script>
    window.CSRF_TOKEN = '{{ csrf_token }}';
  </script>

  <!-- Django Messages Integration with Toast -->
  {% if messages %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      {% for message in messages %}
        {% if message.tags == 'success' %}
          Toast.success('{{ message|escapejs }}');
        {% elif message.tags == 'error' %}
          Toast.error('{{ message|escapejs }}');
        {% elif message.tags == 'warning' %}
          Toast.warning('{{ message|escapejs }}');
        {% else %}
          Toast.info('{{ message|escapejs }}');
        {% endif %}
      {% endfor %}
    });
  </script>
  {% endif %}

  <!-- First Name Extraction -->
  <script>
    document.querySelectorAll('[data-fullname]').forEach(function(el) {
      var fullName = el.dataset.fullname || '';
      el.textContent = fullName.split(' ')[0];
    });
  </script>
</body>
</html>
