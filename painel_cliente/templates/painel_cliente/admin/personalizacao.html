{% extends 'painel_cliente/admin/base_admin.html' %}

{% block title %}Personalização{% endblock %}
{% block breadcrumb %}Personalização{% endblock %}

{% block content %}
<div class="animate-fade-in-up">
  <!-- Page Header -->
  <div class="page-header-admin">
    <h1>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
      Personalização do Painel
    </h1>
  </div>

  <!-- Success Alert -->
  {% if sucesso %}
  <div class="admin-alert admin-alert-success animate-fade-in-up">
    <div class="admin-alert-icon">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    </div>
    <div class="admin-alert-content">
      Alterações salvas com sucesso!
    </div>
  </div>
  {% endif %}

  <form method="post" action="{% url 'painel_cliente:admin_personalizacao' %}" enctype="multipart/form-data" id="form-personalizacao">
    {% csrf_token %}

    <div class="personalizacao-layout">
      <!-- Main Column -->
      <div class="personalizacao-main">
        <!-- Identidade Visual -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 class="admin-card-title">Identidade Visual</h2>
          </div>
          <div class="admin-card-body">
            <div class="identity-layout">
              <!-- Logo (Esquerda) -->
              <div class="identity-left">
                <div class="form-group">
                  <label class="form-label">Logo</label>
                  <div class="logo-upload-area" id="logo-upload-area">
                    <!-- Logo Atual ou Preview -->
                    <div class="logo-preview-container" id="logo-preview-container" {% if not config.logo %}style="display: none;"{% endif %}>
                      <img
                        src="{% if config.logo %}{{ config.logo.url }}{% endif %}"
                        alt="Logo"
                        class="logo-preview-img"
                        id="logo-preview-img"
                      >
                      <div class="logo-preview-actions">
                        <button type="button" class="btn btn-sm btn-ghost" id="btn-trocar-logo" title="Trocar logo">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                          </svg>
                          Trocar
                        </button>
                        {% if config.logo %}
                        <button type="button" class="btn btn-sm btn-danger-outline" id="btn-remover-logo" title="Remover logo">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                          </svg>
                          Remover
                        </button>
                        {% endif %}
                      </div>
                    </div>

                    <!-- Dropzone para Upload -->
                    <div class="logo-dropzone" id="logo-dropzone" {% if config.logo %}style="display: none;"{% endif %}>
                      <input type="file" class="logo-file-input" id="logo" name="logo" accept="image/png,image/jpeg,image/webp,image/gif">
                      <div class="logo-dropzone-content">
                        <div class="logo-dropzone-icon">
                          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                          </svg>
                        </div>
                        <p class="logo-dropzone-text">
                          <span class="logo-dropzone-link">Clique para selecionar</span>
                          ou arraste uma imagem
                        </p>
                        <p class="logo-dropzone-hint">PNG, JPG ou WebP. Max 2MB</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Campos (Direita) -->
              <div class="identity-right">
                <!-- Nome de Exibicao -->
                <div class="form-group">
                  <label for="nome_exibicao" class="form-label">Nome de Exibição
                  <input
                    type="text"
                    class="form-input"
                    id="nome_exibicao"
                    name="nome_exibicao"
                    value="{{ config.nome_exibicao }}"
                    placeholder="Meu Negócio"
                  >
                  <p class="form-hint">Nome exibido no cabeçalho do painel</p>
                </div>

                <!-- Cores -->
                <div class="colors-row">
                  <!-- Cor Primaria -->
                  <div class="form-group">
                    <label for="cor_primaria" class="form-label">Cor Primária
                    <div class="color-input-group">
                      <input
                        type="color"
                        class="color-picker"
                        id="cor_primaria_picker"
                        value="{{ config.cor_primaria }}"
                      >
                      <input
                        type="text"
                        class="form-input"
                        id="cor_primaria"
                        name="cor_primaria"
                        value="{{ config.cor_primaria }}"
                        pattern="#[0-9A-Fa-f]{6}"
                        placeholder="#8B5CF6"
                      >
                    </div>
                    <p class="form-hint">Header, botões, cards</p>
                  </div>

                  <!-- Cor Secundaria -->
                  <div class="form-group">
                    <label for="cor_secundaria" class="form-label">Cor Secundária
                    <div class="color-input-group">
                      <input
                        type="color"
                        class="color-picker"
                        id="cor_secundaria_picker"
                        value="{{ config.cor_secundaria }}"
                      >
                      <input
                        type="text"
                        class="form-input"
                        id="cor_secundaria"
                        name="cor_secundaria"
                        value="{{ config.cor_secundaria }}"
                        pattern="#[0-9A-Fa-f]{6}"
                        placeholder="#06B6D4"
                      >
                    </div>
                    <p class="form-hint">Background, elementos secundários</p>
                  </div>
                </div>

                <!-- Botão Restaurar Cores -->
                <button type="button" class="btn btn-ghost btn-sm reset-colors-btn" id="btn-reset-cores">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                    <path d="M3 3v5h5"></path>
                  </svg>
                  Restaurar cores padrão
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Contato e Suporte -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 class="admin-card-title">Contato e Suporte</h2>
          </div>
          <div class="admin-card-body">
            <div class="form-grid">
              <!-- WhatsApp -->
              <div class="form-group">
                <label for="whatsapp_suporte" class="form-label">WhatsApp de Suporte</label>
                <div class="input-icon-wrapper">
                  <svg class="input-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                  </svg>
                  <input
                    type="text"
                    class="form-input"
                    id="whatsapp_suporte"
                    name="whatsapp_suporte"
                    value="{{ config.whatsapp_suporte }}"
                    placeholder="(71) 99999-9999"
                    style="padding-left: 44px;"
                  >
                </div>
                <p class="form-hint">Digite DDD + número.</p>
              </div>

              <!-- Mensagem Padrao -->
              <div class="form-group">
                <label for="mensagem_suporte" class="form-label">Mensagem Padrão
                <input
                  type="text"
                  class="form-input"
                  id="mensagem_suporte"
                  name="mensagem_suporte"
                  value="{{ config.mensagem_suporte }}"
                  placeholder="Olá, preciso de ajuda..."
                >
                <p class="form-hint">Mensagem enviada ao clicar no botão do WhatsApp</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Textos do Painel -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h2 class="admin-card-title">Textos do Painel</h2>
          </div>
          <div class="admin-card-body">
            <div class="form-group">
              <label for="texto_boas_vindas" class="form-label">Mensagem de Boas-vindas</label>
              <input
                type="text"
                class="form-input"
                id="texto_boas_vindas"
                name="texto_boas_vindas"
                value="{{ config.texto_boas_vindas }}"
                maxlength="255"
                placeholder="Bem-vindo ao seu painel de pagamentos!"
              >
              <p class="form-hint">Exibida no dashboard do cliente</p>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="form-actions-sticky">
          <button type="submit" class="btn btn-primary btn-lg" id="btn-salvar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Salvar Alterações
          </button>
        </div>
      </div>

      <!-- Preview Column -->
      <div class="personalizacao-preview">
        <div class="admin-card preview-card">
          <div class="admin-card-header">
            <h2 class="admin-card-title">Pré-visualização</h2>
          </div>
          <div class="admin-card-body-flush">
            <div class="preview-wrapper">
              <div class="preview-header" id="preview-header" style="background-color: {{ config.cor_primaria }};">
                {% if config.logo %}
                <img src="{{ config.logo.url }}" alt="Logo" class="preview-logo">
                {% else %}
                <span class="preview-logo-text" id="preview-logo-text">{{ config.nome_exibicao }}</span>
                {% endif %}
              </div>
              <div class="preview-content">
                <p class="preview-welcome" id="preview-welcome">{{ config.texto_boas_vindas|default:"Bem-vindo ao seu painel!" }}</p>
                <button type="button" class="preview-btn" id="preview-btn" style="background-color: {{ config.cor_primaria }};">
                  Botão Primário
                </button>
                <button type="button" class="preview-btn preview-btn-outline">
                  Botão Secundário
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .personalizacao-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--space-6);
    align-items: start;
  }

  @media (max-width: 1024px) {
    .personalizacao-layout {
      grid-template-columns: 1fr;
    }

    .personalizacao-preview {
      order: -1;
    }
  }

  .personalizacao-main {
    display: flex;
    flex-direction: column;
    gap: var(--space-5);
  }

  .admin-alert-success {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
    display: flex;
    gap: var(--space-3);
    padding: var(--space-4);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-5);
  }

  .admin-alert-success .admin-alert-icon {
    color: var(--color-success);
    flex-shrink: 0;
  }

  .admin-alert-content {
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    font-weight: var(--font-medium);
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-5);
    margin-bottom: var(--space-5);
  }

  .form-grid:last-child {
    margin-bottom: 0;
  }

  @media (max-width: 640px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .form-label {
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    color: var(--color-text-primary);
  }

  .form-input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-primary);
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    transition: all var(--transition-fast);
  }

  .form-input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15);
  }

  .form-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Logo Upload Area */
  .form-group-logo {
    grid-column: 1 / -1;
  }

  .logo-upload-area {
    width: 100%;
    max-width: 300px;
  }

  /* Logo Preview */
  .logo-preview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    background: var(--color-surface-elevated);
    border: 2px solid var(--color-border-light);
    border-radius: var(--radius-xl);
  }

  .logo-preview-img {
    max-width: 150px;
    max-height: 100px;
    object-fit: contain;
    border-radius: var(--radius-lg);
  }

  .logo-preview-actions {
    display: flex;
    gap: var(--space-2);
  }

  /* Logo Dropzone */
  .logo-dropzone {
    position: relative;
    border: 2px dashed var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    background: var(--color-surface-elevated);
  }

  .logo-dropzone:hover,
  .logo-dropzone.drag-over {
    border-color: var(--color-primary);
    background: rgba(139, 92, 246, 0.05);
  }

  .logo-file-input {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .logo-dropzone-content {
    pointer-events: none;
  }

  .logo-dropzone-icon {
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
  }

  .logo-dropzone-text {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0 0 var(--space-1) 0;
  }

  .logo-dropzone-link {
    color: var(--color-primary);
    font-weight: var(--font-medium);
  }

  .logo-dropzone-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0;
  }

  /* Color Input */
  .color-input-group {
    display: flex;
    gap: var(--space-2);
  }

  .color-picker {
    width: 48px;
    height: 48px;
    padding: 0;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    flex-shrink: 0;
  }

  .color-picker::-webkit-color-swatch-wrapper {
    padding: 4px;
  }

  .color-picker::-webkit-color-swatch {
    border-radius: var(--radius-md);
    border: none;
  }

  .color-input-group .form-input {
    flex: 1;
  }

  /* Input with icon */
  .input-icon-wrapper {
    position: relative;
  }

  .input-icon {
    position: absolute;
    left: var(--space-3);
    top: 50%;
    transform: translateY(-50%);
    color: #25D366;
  }

  /* Actions */
  .form-actions-sticky {
    display: flex;
    justify-content: flex-end;
    padding-top: var(--space-4);
    border-top: 1px solid var(--color-border-light);
  }

  /* Preview Card */
  .preview-card {
    position: sticky;
    top: calc(var(--topbar-height) + var(--space-6));
  }

  .preview-wrapper {
    border-radius: var(--radius-lg);
    overflow: hidden;
    background: var(--color-background);
    border: 1px solid var(--color-border-light);
    margin: var(--space-4);
  }

  .preview-header {
    padding: var(--space-4);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .preview-logo {
    max-height: 40px;
  }

  .preview-logo-text {
    font-weight: var(--font-bold);
    font-size: var(--text-base);
  }

  .preview-content {
    padding: var(--space-4);
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .preview-welcome {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin: 0;
  }

  .preview-btn {
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    border: none;
    color: white;
    transition: all var(--transition-fast);
  }

  .preview-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
  }

  .preview-btn-outline {
    background: transparent;
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
  }

  [data-theme="dark"] .form-input {
    background: var(--color-surface-elevated);
  }

  /* Identity Layout - Logo left, fields right */
  .identity-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: var(--space-6);
    align-items: start;
  }

  .identity-left {
    display: flex;
    flex-direction: column;
  }

  .identity-right {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .colors-row {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .reset-colors-btn {
    align-self: flex-start;
    margin-top: var(--space-1);
    color: var(--color-text-muted);
    font-size: var(--text-xs);
  }

  .reset-colors-btn:hover {
    color: var(--color-primary);
  }

  .reset-colors-btn svg {
    transition: transform var(--transition-fast);
  }

  .reset-colors-btn:hover svg {
    transform: rotate(-45deg);
  }

  @media (max-width: 768px) {
    .identity-layout {
      grid-template-columns: 1fr;
    }

    .identity-left {
      order: 0;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ===== Color Pickers =====
    const corPrimariaPicker = document.getElementById('cor_primaria_picker');
    const corPrimariaInput = document.getElementById('cor_primaria');
    const corSecundariaPicker = document.getElementById('cor_secundaria_picker');
    const corSecundariaInput = document.getElementById('cor_secundaria');
    const nomeExibicaoInput = document.getElementById('nome_exibicao');
    const textoBoasVindasInput = document.getElementById('texto_boas_vindas');

    const previewHeader = document.getElementById('preview-header');
    const previewBtn = document.getElementById('preview-btn');
    const previewLogoText = document.getElementById('preview-logo-text');
    const previewWelcome = document.getElementById('preview-welcome');

    function syncColors(picker, input) {
      picker.addEventListener('input', function() {
        input.value = this.value;
        updatePreview();
      });

      input.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
          picker.value = this.value;
          updatePreview();
        }
      });
    }

    syncColors(corPrimariaPicker, corPrimariaInput);
    syncColors(corSecundariaPicker, corSecundariaInput);

    function updatePreview() {
      previewHeader.style.backgroundColor = corPrimariaInput.value;
      previewBtn.style.backgroundColor = corPrimariaInput.value;
    }

    // ===== Reset Colors Button =====
    const btnResetCores = document.getElementById('btn-reset-cores');
    const COR_PRIMARIA_PADRAO = '#8B5CF6';
    const COR_SECUNDARIA_PADRAO = '#06B6D4';

    if (btnResetCores) {
      btnResetCores.addEventListener('click', function() {
        corPrimariaInput.value = COR_PRIMARIA_PADRAO;
        corPrimariaPicker.value = COR_PRIMARIA_PADRAO;
        corSecundariaInput.value = COR_SECUNDARIA_PADRAO;
        corSecundariaPicker.value = COR_SECUNDARIA_PADRAO;
        updatePreview();
      });
    }

    if (nomeExibicaoInput && previewLogoText) {
      nomeExibicaoInput.addEventListener('input', function() {
        previewLogoText.textContent = this.value || 'Meu Negócio';
      });
    }

    if (textoBoasVindasInput && previewWelcome) {
      textoBoasVindasInput.addEventListener('input', function() {
        previewWelcome.textContent = this.value || 'Bem-vindo ao seu painel!';
      });
    }

    // ===== Logo Upload =====
    const logoInput = document.getElementById('logo');
    const logoDropzone = document.getElementById('logo-dropzone');
    const logoPreviewContainer = document.getElementById('logo-preview-container');
    const logoPreviewImg = document.getElementById('logo-preview-img');
    const btnTrocarLogo = document.getElementById('btn-trocar-logo');
    const btnRemoverLogo = document.getElementById('btn-remover-logo');
    const previewLogoImg = document.querySelector('.preview-logo');

    // Preview de imagem ao selecionar arquivo
    logoInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleLogoFile(file);
      }
    });

    function handleLogoFile(file) {
      // Valida tamanho (max 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('A imagem deve ter no máximo 2MB');
        return;
      }

      // Valida tipo
      if (!file.type.match(/image\/(png|jpeg|jpg|webp|gif)/)) {
        alert('Formato inválido. Use PNG, JPG, WebP ou GIF');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        // Mostra preview
        logoPreviewImg.src = e.target.result;
        logoPreviewContainer.style.display = 'flex';
        logoDropzone.style.display = 'none';

        // Atualiza preview lateral
        if (previewLogoImg) {
          previewLogoImg.src = e.target.result;
        }

        // Esconde o texto do logo no preview se tiver imagem
        if (previewLogoText) {
          previewLogoText.style.display = 'none';
        }
      };
      reader.readAsDataURL(file);
    }

    // Drag and Drop
    logoDropzone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('drag-over');
    });

    logoDropzone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
    });

    logoDropzone.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        logoInput.files = files;
        handleLogoFile(files[0]);
      }
    });

    // Botão Trocar Logo
    if (btnTrocarLogo) {
      btnTrocarLogo.addEventListener('click', function() {
        logoPreviewContainer.style.display = 'none';
        logoDropzone.style.display = 'block';
        logoInput.value = '';
      });
    }

    // Botão Remover Logo
    if (btnRemoverLogo) {
      btnRemoverLogo.addEventListener('click', function() {
        if (!confirm('Tem certeza que deseja remover a logo?')) {
          return;
        }

        // Envia requisicao para remover
        fetch('{% url "painel_cliente:admin_remover_logo" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Atualiza UI
            logoPreviewContainer.style.display = 'none';
            logoDropzone.style.display = 'block';
            logoInput.value = '';

            // Atualiza preview lateral
            if (previewLogoImg) {
              previewLogoImg.style.display = 'none';
            }
            if (previewLogoText) {
              previewLogoText.style.display = 'block';
            }

            // Remove botão de remover (já não tem mais logo salva)
            btnRemoverLogo.remove();
          }
        })
        .catch(error => {
          console.error('Erro ao remover logo:', error);
          alert('Erro ao remover logo. Tente novamente.');
        });
      });
    }

    // ===== WhatsApp Phone Mask =====
    const whatsappInput = document.getElementById('whatsapp_suporte');

    if (whatsappInput) {
      // Format phone number as (xx) xxxxx-xxxx or (xx) xxxx-xxxx
      function formatPhone(value) {
        // Remove all non-digits
        const digits = value.replace(/\D/g, '').slice(0, 11);

        if (digits.length === 0) return '';
        if (digits.length <= 2) return `(${digits}`;
        if (digits.length <= 7) return `(${digits.slice(0, 2)}) ${digits.slice(2)}`;
        if (digits.length <= 10) return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
        return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
      }

      // Format on input
      whatsappInput.addEventListener('input', function(e) {
        const cursorPos = e.target.selectionStart;
        const oldValue = e.target.value;
        const newValue = formatPhone(oldValue);
        e.target.value = newValue;

        // Adjust cursor position
        if (cursorPos < oldValue.length) {
          const digitsBeforeCursor = oldValue.slice(0, cursorPos).replace(/\D/g, '').length;
          let newCursorPos = 0;
          let digitCount = 0;

          for (let i = 0; i < newValue.length && digitCount < digitsBeforeCursor; i++) {
            if (/\d/.test(newValue[i])) digitCount++;
            newCursorPos = i + 1;
          }

          e.target.setSelectionRange(newCursorPos, newCursorPos);
        }
      });

      // Format initial value if exists
      if (whatsappInput.value) {
        whatsappInput.value = formatPhone(whatsappInput.value);
      }
    }

    // ===== Form Submit =====
    const form = document.getElementById('form-personalizacao');
    const btnSalvar = document.getElementById('btn-salvar');

    form.addEventListener('submit', function(e) {
      // Remove formatting from WhatsApp before submit
      if (whatsappInput) {
        whatsappInput.value = whatsappInput.value.replace(/\D/g, '');
      }

      btnSalvar.disabled = true;
      btnSalvar.innerHTML = '<span class="spinner spinner-sm"></span> Salvando...';
    });
  });
</script>
{% endblock %}
