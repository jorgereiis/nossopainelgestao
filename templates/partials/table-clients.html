{% load static %}
{% load format_filters %}

<div class="table-responsive table-actions-visible">
    <table class="table text-nowrap mb-0 table-hover align-middle" id="myTable">
        <thead class="table-light">
            <tr>
                <th class="fw-bold text-center ps-3 sortable-header {% if current_sort == 'nome' %}sorted-{{ current_order }}{% endif %}"
                    data-sort-field="nome" style="min-width: 200px; cursor: pointer;" title="Clique para ordenar">Cliente</th>
                <th class="fw-bold text-center sortable-header {% if current_sort == 'data_adesao' %}sorted-{{ current_order }}{% endif %}"
                    data-sort-field="data_adesao" style="min-width: 110px; cursor: pointer;" title="Clique para ordenar">Ades√£o</th>
                <th class="fw-bold text-center sortable-header {% if current_sort == 'contas_count' %}sorted-{{ current_order }}{% endif %}"
                    data-sort-field="contas_count" style="min-width: 100px; cursor: pointer;" title="Clique para ordenar">Dispositivo + App</th>
                <th class="fw-bold text-center sortable-header {% if current_sort == 'ultimo_pagamento' %}sorted-{{ current_order }}{% endif %}"
                    data-sort-field="ultimo_pagamento" style="min-width: 110px; cursor: pointer;" title="Clique para ordenar">√öltimo pgto.</th>
                <th class="fw-bold text-center sortable-header {% if current_sort == 'dt_vencimento' %}sorted-{{ current_order }}{% endif %}"
                    data-sort-field="dt_vencimento" style="min-width: 150px; cursor: pointer;" title="Clique para ordenar">Pr√≥ximo pgto.</th>
                <th class="fw-bold text-center" style="width: 60px;">Pgto.</th>
                <th class="fw-bold text-center" style="width: 60px;">A√ß√µes</th>
            </tr>
        </thead>

        <tbody>
            {% for cliente in object_list %}
            <!-- COME√áO DA LINHA -->
            <tr id="cliente-{{ forloop.counter }}" class="odd dt-hasChild parent">
                <td class="dtr-control ps-3" data-sort-value="{{ cliente.nome|default_if_none:''|lower }}">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0 position-relative">
                            <img src="{{ cliente.servidor|servidor_imagem_url:user }}"
                                class="rounded-circle border border-2"
                                alt="{{ cliente.servidor.nome }}"
                                title="{{ cliente.servidor.nome }}"
                                style="width: 42px; height: 42px; object-fit: cover;"
                                onerror="this.src='{% static 'assets/images/logo-apps/default.png' %}'">
                        </div>
                        <div class="ms-3 lh-sm">
                            <h6 class="mb-0 fw-semibold text-capitalize text-dark"
                                style="font-size: 0.9375rem; transition: color 0.2s ease;">
                                {{cliente.nome}}
                            </h6>
                            <small class="text-muted d-block" style="font-size: 0.75rem;">
                                <i class="bi bi-hdd-network me-1"></i>{{ cliente.servidor.nome }}
                            </small>
                        </div>
                    </div>
                </td>
                <td class="text-center" data-sort-value="{{cliente.data_adesao|date:'Y-m-d'}}">
                    <span class="text-muted" style="font-size: 0.875rem;">{{cliente.data_adesao|date:'d/m/Y'}}</span>
                </td>
                <td class="text-center" data-sort-value="{{ cliente.contas_count }}">
                    {% with contas=cliente.contas_list plano_telas=cliente.plano.telas %}
                    {% if cliente.contas_count > 0 %}
                        {% if cliente.contas_count == plano_telas %}
                            <!-- CASO 1: Apps = Telas - Badge PRIMARY normal -->
                            <span class="badge bg-primary-subtle text-primary border border-primary"
                                  style="font-size: 0.8rem; padding: 0.35rem 0.7rem; cursor: help;"
                                  data-bs-toggle="tooltip"
                                  data-bs-html="true"
                                  data-bs-placement="top"
                                  title="<i class='bi bi-check-circle-fill text-primary' style='font-size: 1.1rem;'></i> <strong class='text-primary'>Tudo certo!</strong><br>{% for conta in contas %}<strong>{% if conta.dispositivo %}{{ conta.dispositivo.nome }}{% elif cliente.dispositivo %}{{ cliente.dispositivo.nome }}{% else %}Dispositivo n√£o especificado{% endif %}</strong> + {{ conta.app.nome }}{% if not forloop.last %}<br>{% endif %}{% endfor %}">
                                <i class="bi bi-tv me-1"></i>{{ cliente.contas_count }}/{{ plano_telas }}
                            </span>
                        {% elif cliente.contas_count < plano_telas %}
                            <!-- CASO 2: Apps < Telas - Badge WARNING com anima√ß√£o -->
                            <span class="badge bg-warning-subtle text-warning border border-warning badge-pulse-warning"
                                  style="font-size: 0.8rem; padding: 0.35rem 0.7rem; cursor: help;"
                                  data-bs-toggle="tooltip"
                                  data-bs-html="true"
                                  data-bs-placement="top"
                                  title="<strong class='text-warning'>‚ö†Ô∏è Aten√ß√£o</strong><br>Falta(m) app(s) a ser cadastrado - {{ cliente.contas_count }} de {{ plano_telas }} registrados<br><br>{% for conta in contas %}<strong>{% if conta.dispositivo %}{{ conta.dispositivo.nome }}{% elif cliente.dispositivo %}{{ cliente.dispositivo.nome }}{% else %}Dispositivo n√£o especificado{% endif %}</strong> + {{ conta.app.nome }}{% if not forloop.last %}<br>{% endif %}{% endfor %}">
                                <i class="bi bi-exclamation-circle-fill me-1"></i>{{ cliente.contas_count }}/{{ plano_telas }}
                            </span>
                        {% else %}
                            <!-- CASO 3: Apps > Telas - Badge INFO com leve destaque -->
                            <span class="badge bg-info-subtle text-info border border-info"
                                  style="font-size: 0.8rem; padding: 0.35rem 0.7rem; cursor: help; font-weight: 600;"
                                  data-bs-toggle="tooltip"
                                  data-bs-html="true"
                                  data-bs-placement="top"
                                  title="<strong class='text-info'>‚ÑπÔ∏è Excesso de Apps</strong><br>H√° app(s) acima da quantidade de telas - {{ cliente.contas_count }} apps de {{ plano_telas }} telas<br><br>{% for conta in contas %}<strong>{% if conta.dispositivo %}{{ conta.dispositivo.nome }}{% elif cliente.dispositivo %}{{ cliente.dispositivo.nome }}{% else %}Dispositivo n√£o especificado{% endif %}</strong> + {{ conta.app.nome }}{% if not forloop.last %}<br>{% endif %}{% endfor %}">
                                <i class="bi bi-info-circle-fill me-1"></i>{{ cliente.contas_count }}/{{ plano_telas }}
                            </span>
                        {% endif %}
                    {% else %}
                        <!-- Fallback para clientes antigos sem ContaDoAplicativo -->
                        {% if cliente.plano %}
                            <span class="badge bg-warning-subtle text-warning border border-warning badge-pulse-warning"
                                  style="font-size: 0.8rem; padding: 0.35rem 0.7rem; cursor: help;"
                                  data-bs-toggle="tooltip"
                                  data-bs-html="true"
                                  data-bs-placement="top"
                                  title="<strong class='text-warning'>‚ö†Ô∏è Nenhum app cadastrado!</strong><br>Este cliente possui {{ plano_telas }} tela(s) no plano mas nenhum dispositivo/app foi cadastrado ainda.">
                                <i class="bi bi-exclamation-circle-fill me-1"></i>0/{{ plano_telas }}
                            </span>
                        {% else %}
                            <span class="text-muted" style="font-size: 0.875rem;">‚Äî</span>
                        {% endif %}
                    {% endif %}
                    {% endwith %}
                </td>
                <td class="text-center" data-sort-value="{{cliente.ultimo_pagamento|date:'Y-m-d'}}">
                    {% if cliente.ultimo_pagamento %}
                        <span class="text-success" style="font-size: 0.875rem;">
                            <i class="bi bi-check-circle-fill me-1"></i>{{cliente.ultimo_pagamento|date:'d/m/Y'}}
                        </span>
                    {% else %}
                        <span class="text-muted" style="font-size: 0.875rem;">‚Äî</span>
                    {% endif %}
                </td>

                {% for mensalidade in cliente.mensalidade_set.all %}
                {% if not mensalidade.cancelado and not mensalidade.pgto %}
                {% if mensalidade.dt_pagamento is None and hoje > mensalidade.dt_vencimento %}
                <td class="text-center" data-sort-value="{{mensalidade.dt_vencimento|date:'Y-m-d'}}">
                    <div class="d-flex flex-column align-items-center gap-1">
                        <span class="badge bg-danger-subtle text-danger border border-danger" style="font-size: 0.8125rem; padding: 0.35rem 0.65rem;">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i>Vencido
                        </span>
                        <small class="text-danger fw-semibold" style="font-size: 0.75rem;"
                               {% if mensalidade.numero_mes_campanha %}data-bs-toggle="tooltip" title="Desconto {{mensalidade.numero_mes_campanha}}/{{cliente.plano.campanha_duracao_meses}}"{% endif %}>R$ {{mensalidade.valor}}{% if mensalidade.numero_mes_campanha %} üì¢{% endif %}</small>
                        <small class="text-muted" style="font-size: 0.7rem;">{{mensalidade.dt_vencimento|date:'d/m/Y'}}</small>
                    </div>
                </td>
                {% else %}
                <td class="text-center" data-sort-value="{{mensalidade.dt_vencimento|date:'Y-m-d'}}">
                    <div class="d-flex flex-column align-items-center gap-1">
                        <span class="badge bg-info-subtle text-info border border-info" style="font-size: 0.8125rem; padding: 0.35rem 0.65rem;">
                            <i class="bi bi-clock-fill me-1"></i>A vencer
                        </span>
                        <small class="text-info fw-semibold" style="font-size: 0.75rem;"
                               {% if mensalidade.numero_mes_campanha %}data-bs-toggle="tooltip" title="Desconto {{mensalidade.numero_mes_campanha}}/{{cliente.plano.campanha_duracao_meses}}"{% endif %}>R$ {{mensalidade.valor}}{% if mensalidade.numero_mes_campanha %} üì¢{% endif %}</small>
                        <small class="text-muted" style="font-size: 0.7rem;">{{mensalidade.dt_vencimento|date:'d/m/Y'}}</small>
                    </div>
                </td>
                {% endif %}
                {% if cliente.forma_pgto.nome == "PIX" %}
                <td class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light border"
                         style="width: 36px; height: 36px;"
                         title="PIX">
                        <img src="{% static 'assets/images/svg/pix.png' %}" style="width: 20px; height: 20px;">
                    </div>
                </td>
                {% elif cliente.forma_pgto.nome == "Cart√£o de Cr√©dito" %}
                <td class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light border"
                         style="width: 36px; height: 36px;"
                         title="Cart√£o de Cr√©dito">
                        <i class="bi bi-credit-card text-warning" style="font-size: 1.1rem;"></i>
                    </div>
                </td>
                {% elif cliente.forma_pgto.nome == "Boleto" %}
                <td class="text-center">
                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-light border"
                         style="width: 36px; height: 36px;"
                         title="Boleto">
                        <i class="bi bi-upc-scan text-danger" style="font-size: 1.1rem;"></i>
                    </div>
                </td>
                {% endif %}
                <!-- Dropdown da tabela -->
                <td class="text-center">
                    <div class="dropdown table-dropdown-actions">
                        <button
                            class="btn btn-sm btn-light rounded-circle d-inline-flex align-items-center justify-content-center border"
                            type="button"
                            id="dropdownMenuButton-{{ cliente.id }}"
                            data-bs-toggle="dropdown"
                            data-bs-auto-close="true"
                            aria-expanded="false"
                            style="width: 32px; height: 32px; padding: 0;">
                            <i class="bi bi-three-dots-vertical text-muted"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="dropdownMenuButton-{{ cliente.id }}">
                            <li>
                                <button class="dropdown-item dropdown-action-view"
                                        data-id="{{cliente.id}}"
                                        data-nome="{{cliente.nome}}"
                                        data-plano="{{cliente.plano}}"
                                        data-telas="{{cliente.plano.telas}}"
                                        data-notas="{{cliente.notas}}"
                                        data-telefone="{{cliente.telefone|formatar_telefone}}"
                                        data-servidor="{{cliente.servidor}}"
                                        data-aplicativo="{{cliente.sistema}}"
                                        data-forma_pgto="{{cliente.forma_pgto}}"
                                        data-dispositivo="{{cliente.dispositivo}}"
                                        data-data_adesao="{{cliente.data_adesao}}"
                                        data-indicado_por="{{cliente.indicado_por}}"
                                        data-data_vencimento="{{cliente.data_vencimento|date:'d/m/Y'}}"
                                        data-ultimo_pagamento="{{cliente.ultimo_pagamento|date:'d/m/Y'}}"
                                        data-conta_aplicativo="{{cliente.conta_aplicativo.all}}"
                                        onclick="exibirModalDetalhes(this)">
                                    <i class="bi bi-eye me-3"></i>
                                    <span>Ver Informa√ß√µes</span>
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item dropdown-action-edit"
                                data-id="{{cliente.id}}"
                                data-nome="{{cliente.nome}}"
                                data-telefone-raw="{{cliente.telefone}}"
                                data-telefone="{{cliente.telefone|formatar_telefone}}"
                                data-indicado_por="{{cliente.indicado_por}}"
                                data-servidor="{{cliente.servidor}}"
                                data-forma_pgto="{{cliente.forma_pgto}}"
                                data-plano="{{cliente.plano.id}}"
                                data-telas="{{cliente.telas}}"
                                data-data_vencimento="{{cliente.data_vencimento|date:'Y-m-d'}}"
                                data-dispositivo="{{cliente.dispositivo}}"
                                data-aplicativo="{{cliente.sistema}}"
                                data-notas="{{cliente.notas}}"
                                data-nao_enviar_msgs="{{cliente.nao_enviar_msgs}}"
                                onclick="exibirModalEdicao(this)">
                                    <i class="bi bi-pencil me-3"></i>
                                    <span>Editar Informa√ß√µes</span>
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item dropdown-action-payment"
                                    data-nome="{{cliente.nome}}"
                                    data-mensalidade="{{mensalidade.id}}"
                                    onclick="exibirModalConfirmacaoPagamento(this)">
                                    <i class="bi bi-cash-coin me-3"></i>
                                    <span>Registrar Pagamento</span>
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item dropdown-action-delete"
                                    data-nome="{{cliente.nome}}"
                                    data-cliente="{{cliente.id}}"
                                    onclick="exibirModalConfirmacaoCancelamento(this)">
                                    <i class="bi bi-x-circle me-3"></i>
                                    <span>Cancelar Cliente</span>
                                </button>
                            </li>
                        </ul>
                    </div>
                </td>
                {% endif %}
                {% endfor %}
            </tr>
            <!-- T√âRMINO DA LINHA -->
            {% endfor %}
        </tbody>
    </table>
</div>

<!--
    NOTA: A ordena√ß√£o da tabela √© gerenciada por:
    - setup/static/dashboard/js/components/table-sortable.js
    - setup/static/dashboard/js/components/dashboard-table-manager.js

    Os estilos CSS est√£o em:
    - setup/static/dashboard/css/dashboard.css
-->

<!-- pagination -->
<div class="card-footer bg-white">
    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-center gap-2">
        <!-- Seletor de registros por p√°gina -->
        <div class="d-flex align-items-center gap-2">
            <label for="per-page-select" class="text-muted small mb-0">Exibir:</label>
            <select id="per-page-select" class="form-select form-select-sm" style="width: auto;">
                {% for option in pagination_options %}
                <option value="{{ option }}" {% if option == current_per_page %}selected{% endif %}>
                    {{ option }}
                </option>
                {% endfor %}
            </select>
            <span class="text-muted small">registros</span>
        </div>

        <!-- Pagina√ß√£o -->
        <nav aria-label="Page navigation" class="paginator-nav">
        <ul class="pagination justify-content-end mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item">
            <a class="page-link" href="?page=1" data-page="1" aria-label="Primeira">
                <span aria-hidden="true">&laquo;</span>
            </a>
            </li>
            {% endif %}

            {% if page_obj.number > 3 %}
            <li class="page-item">
            <span class="page-link">...</span>
            </li>
            {% endif %}

            {% for page in page_obj.paginator.page_range %}
            {% if page == page_obj.number %}
                <li class="page-item active">
                <a class="page-link" href="#" data-page="{{ page }}">
                    {{ page }}
                    <span class="sr-only"></span>
                </a>
                </li>
            {% elif page > page_obj.number|add:'-2' and page < page_obj.number|add:'2' %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page }}" data-page="{{ page }}">
                    {{ page }}
                </a>
                </li>
            {% endif %}
            {% if page == page_obj.number|add:'2' and page_obj.number|add:'1' < page_obj.paginator.num_pages %}
                <li class="page-item">
                <span class="page-link">...</span>
                </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
            <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" data-page="{{ page_obj.paginator.num_pages }}">
                {{ page_obj.paginator.num_pages }}
            </a>
            </li>
            {% endif %}

            {% if page_obj.has_next %}
            <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}" data-page="{{ page_obj.paginator.num_pages }}" aria-label="√öltima">
                <span aria-hidden="true">&raquo;</span>
            </a>
            </li>
            {% endif %}
        </ul>
        </nav>
    </div>
</div>
