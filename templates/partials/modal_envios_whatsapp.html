{% load static %}

<!-- Modal de Envios WhatsApp - Design Premium -->
<div class="modal fade" id="modalEnviosWhatsapp" tabindex="-1" aria-labelledby="modalEnviosWhatsappLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content modal-envios-premium">
            <!-- Header com Status de Conexao -->
            <div class="modal-header border-0 pb-0">
                <div class="d-flex align-items-center gap-3 flex-grow-1">
                    <div class="icon-shape icon-lg bg-whatsapp-soft rounded-circle">
                        <i class="bi bi-whatsapp fs-4 text-whatsapp"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h4 class="modal-title mb-0" id="modalEnviosWhatsappLabel">Envios WhatsApp</h4>
                        <p class="text-muted small mb-0">Envie mensagens através da API WPPConnect</p>
                    </div>
                    <!-- Badge de Status de Conexao -->
                    <div class="connection-badge" id="connection-badge">
                        <span class="status-dot status-checking"></span>
                        <span class="status-text">Verificando...</span>
                    </div>
                </div>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body pt-3">
                <!-- Cards de Status e Contador Premium -->
                <div class="row g-3 mb-4">
                    <!-- Card Status de Conexao -->
                    <div class="col-sm-6">
                        <div class="stat-card-premium stat-card-connection" id="card-connection-status">
                            <div class="stat-card-body">
                                <div class="stat-icon-wrapper bg-whatsapp-soft">
                                    <i class="bi bi-wifi fs-5 text-whatsapp"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Status da Conexão</span>
                                    <div class="stat-value" id="status-conexao-texto">
                                        <span class="status-indicator status-checking"></span>
                                        Verificando...
                                    </div>
                                    <small class="stat-detail text-muted" id="status-sessao-info">-</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Card Contador de Envios -->
                    <div class="col-sm-6">
                        <div class="stat-card-premium stat-card-counter" id="contador-envios-card">
                            <div class="stat-card-body">
                                <div class="stat-icon-wrapper" id="contador-icon-wrapper">
                                    <i class="bi bi-send-check fs-5" id="contador-icone"></i>
                                </div>
                                <div class="stat-content">
                                    <span class="stat-label">Envios Hoje</span>
                                    <div class="stat-value">
                                        <span id="contador-envios-atual">0</span>/<span id="contador-envios-limite">150</span>
                                    </div>
                                    <div class="progress-mini mt-1">
                                        <div class="progress-bar-mini" id="contador-progress-bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                            <small class="stat-message" id="contador-mensagem">
                                <i class="bi bi-info-circle me-1"></i>Recomendamos não exceder 150 envios/dia
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Alert de Informacao (Compacto) -->
                <div class="alert alert-warning-soft d-flex align-items-center gap-2 mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                    <small>
                        <strong>Atenção:</strong> API não-oficial. Use com moderação para evitar bloqueios.
                    </small>
                </div>

                <!-- Formulário de Envio -->
                <form method="post" action="{% url 'enviar-mensagem' %}" id="form-wpp-modal" class="form-envio-premium">
                    {% csrf_token %}

                    <!-- Tipo de Envio -->
                    <div class="form-group-premium mb-4" id="select-tipo-envio">
                        <label for="options-modal" class="form-label-premium">
                            <i class="bi bi-send me-2"></i>Tipo de Envio
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select form-select-premium" name="options" id="options-modal" required>
                            <option value="">Selecione um tipo de envio</option>
                            <option value="ativos">Para todos os meus clientes ativos</option>
                            <option value="cancelados">Apenas para clientes cancelados</option>
                            <option value="avulso">Avulso (arquivo .txt)</option>
                        </select>
                    </div>

                    <!-- Campos de Envio (exibidos condicionalmente) -->
                    <div id="form-envio-modal">
                        <!-- Upload de Telefones (apenas para avulso) -->
                        <div class="form-group-premium mb-4 d-none" id="campo-telefones">
                            <label for="telefones-modal" class="form-label-premium">
                                <i class="bi bi-telephone me-2"></i>Telefones
                                <span class="text-danger">*</span>
                            </label>
                            <div class="upload-area" id="upload-area-telefones">
                                <input type="file" class="upload-input" id="telefones-modal" name="telefones"
                                       accept=".txt" aria-label="Arquivo de telefones .txt">
                                <div class="upload-placeholder">
                                    <i class="bi bi-file-earmark-text fs-2 text-muted mb-2"></i>
                                    <span class="upload-text">Arraste um arquivo .txt ou clique para selecionar</span>
                                    <small class="text-muted d-block mt-1">Um número por linha (formato: 5511999999999)</small>
                                </div>
                                <div class="upload-preview d-none">
                                    <i class="bi bi-file-earmark-check text-success me-2"></i>
                                    <span class="file-name"></span>
                                    <button type="button" class="btn btn-sm btn-link text-danger ms-2 p-0 remove-file">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Upload de Imagem (Opcional) -->
                        <div class="form-group-premium mb-4 d-none" id="campo-imagem">
                            <label for="imagem-modal" class="form-label-premium">
                                <i class="bi bi-image me-2"></i>Imagem
                                <span class="text-muted fw-normal">(opcional)</span>
                            </label>
                            <div class="upload-area upload-area-image" id="upload-area-imagem">
                                <input type="file" class="upload-input" id="imagem-modal" name="imagem"
                                       accept="image/png,image/jpeg,image/jpg" aria-label="Imagem PNG ou JPG">
                                <div class="upload-placeholder">
                                    <i class="bi bi-card-image fs-2 text-muted mb-2"></i>
                                    <span class="upload-text">Arraste uma imagem ou clique para selecionar</span>
                                    <small class="text-muted d-block mt-1">PNG, JPG ou JPEG (max 5MB)</small>
                                </div>
                                <div class="upload-preview d-none">
                                    <img class="image-thumbnail" src="" alt="Preview">
                                    <div class="image-info">
                                        <span class="file-name"></span>
                                        <button type="button" class="btn btn-sm btn-link text-danger p-0 remove-file">
                                            <i class="bi bi-x-lg"></i> Remover
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensagem -->
                        <div class="form-group-premium mb-4 d-none" id="campo-mensagem">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="mensagem-modal" class="form-label-premium mb-0">
                                    <i class="bi bi-chat-text me-2"></i>Mensagem
                                    <span class="text-danger">*</span>
                                </label>
                                <!-- Botao Usar Template -->
                                <button type="button" class="btn btn-outline-primary btn-sm" id="btn-templates-modal">
                                    <i class="bi bi-file-text me-1"></i>Usar Template
                                </button>
                            </div>
                            <textarea class="form-control form-control-premium" id="mensagem-modal" name="mensagem" rows="4"
                                      placeholder="Digite sua mensagem aqui..." required></textarea>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Use *negrito*, _italico_ e quebras de linha
                                </small>
                                <small class="char-counter" id="char-count-modal">0 caracteres</small>
                            </div>
                        </div>

                        <!-- Preview WhatsApp -->
                        <div class="whatsapp-preview-wrapper mb-4 d-none" id="preview-wrapper">
                            <label class="form-label-premium mb-2">
                                <i class="bi bi-eye me-2"></i>Preview da Mensagem
                            </label>
                            <div class="whatsapp-preview-container">
                                <div class="whatsapp-chat-header">
                                    <div class="chat-avatar">
                                        <i class="bi bi-person-fill"></i>
                                    </div>
                                    <div class="chat-info">
                                        <span class="chat-name">Cliente</span>
                                        <span class="chat-status">online</span>
                                    </div>
                                </div>
                                <div class="whatsapp-chat-body">
                                    <div class="whatsapp-message-bubble">
                                        <img class="preview-image d-none" id="preview-image" src="" alt="Imagem">
                                        <p class="preview-text" id="preview-text">Sua mensagem aparecerá aqui...</p>
                                        <span class="message-meta">
                                            <span class="message-time" id="preview-time">12:00</span>
                                            <span class="message-check"><i class="bi bi-check2-all"></i></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botoes de Controle -->
                        <div class="d-grid gap-2 d-none" id="botoes-controle">
                            <button class="btn btn-whatsapp btn-lg" type="button" id="botao-enviar-modal">
                                <i class="bi bi-send-fill me-2"></i>Enviar Mensagens
                            </button>
                            <button class="btn btn-warning btn-lg d-none" type="button" id="botao-parar-modal">
                                <i class="bi bi-pause-fill me-2"></i>Pausar Envio
                            </button>
                            <button class="btn btn-info btn-lg d-none" type="button" id="botao-retomar-modal">
                                <i class="bi bi-play-fill me-2"></i>Retomar Envio
                            </button>
                        </div>
                    </div>

                    <!-- Botao Ver Logs -->
                    <div class="mt-3">
                        <button class="btn btn-outline-secondary w-100" type="button" id="botao-ver-logs-modal">
                            <i class="bi bi-journal-text me-2"></i>Ver Logs de Envios
                        </button>
                    </div>
                </form>

                <!-- Console de Logs Humanizado -->
                <div class="logs-container-wrapper mt-4" id="console-modal" style="display: none;">
                    <!-- Header do Console -->
                    <div class="logs-header">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-journal-text"></i>
                            <span class="fw-semibold">Logs de Envio</span>
                        </div>
                        <div class="logs-header-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="limpar-console-modal">
                                <i class="bi bi-trash me-1"></i>Limpar
                            </button>
                        </div>
                    </div>

                    <!-- Resumo de Progresso -->
                    <div class="progress-summary" id="progress-summary">
                        <div class="progress-item progress-sent">
                            <i class="bi bi-check-circle-fill"></i>
                            <span>Enviados: <strong id="progress-sent-count">0</strong></span>
                        </div>
                        <div class="progress-item progress-failed">
                            <i class="bi bi-x-circle-fill"></i>
                            <span>Erros: <strong id="progress-failed-count">0</strong></span>
                        </div>
                        <div class="progress-item progress-remaining">
                            <i class="bi bi-hourglass-split"></i>
                            <span>Restantes: <strong id="progress-remaining-count">0</strong></span>
                        </div>
                    </div>

                    <!-- Lista de Logs -->
                    <div class="logs-list" id="logs-list">
                        <div class="log-item log-info">
                            <i class="bi bi-info-circle"></i>
                            <span class="log-message">Aguardando envios...</span>
                        </div>
                    </div>

                    <!-- Footer do Console -->
                    <div class="logs-footer">
                        <button class="btn btn-outline-secondary w-100" type="button" id="botao-voltar-modal">
                            <i class="bi bi-arrow-left me-2"></i>Voltar ao Formulário
                        </button>
                    </div>
                </div>

                <!-- Modal de Templates -->
                <div class="templates-dropdown d-none" id="templates-dropdown">
                    <div class="templates-header">
                        <span class="fw-semibold">Selecionar Template</span>
                        <button type="button" class="btn-close btn-sm" id="close-templates"></button>
                    </div>
                    <div class="templates-search">
                        <input type="text" class="form-control form-control-sm" placeholder="Buscar template..." id="search-template">
                    </div>
                    <div class="templates-list" id="templates-list">
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-hourglass-split"></i> Carregando...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* ========================================
   MODAL ENVIOS WHATSAPP - DESIGN PREMIUM
   ======================================== */

/* Variaveis de Cores */
.modal-envios-premium {
    --whatsapp-green: #25d366;
    --whatsapp-dark: #075e54;
    --whatsapp-light: #dcf8c6;
    --whatsapp-bg: #e5ddd5;
    --premium-purple: #754ffe;
    --success-color: #198754;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #0dcaf0;
    --card-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
    --card-shadow-hover: 0 0.5rem 1rem rgba(0,0,0,0.1);
}

/* Modal Container */
.modal-envios-premium {
    border: none;
    border-radius: 20px;
    box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
    overflow: hidden;
}

.modal-envios-premium .modal-header {
    padding: 1.5rem 1.75rem 0.75rem;
    background: linear-gradient(135deg, rgba(37, 211, 102, 0.05) 0%, rgba(7, 94, 84, 0.05) 100%);
}

.modal-envios-premium .modal-body {
    padding: 1rem 1.75rem 1.75rem;
    max-height: 75vh;
    overflow-y: auto;
}

/* Icon Shape */
.icon-shape {
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.bg-whatsapp-soft {
    background: linear-gradient(135deg, rgba(37, 211, 102, 0.15) 0%, rgba(7, 94, 84, 0.1) 100%);
}

.text-whatsapp {
    color: var(--whatsapp-green);
}

/* Connection Badge */
.connection-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.4rem 0.85rem;
    border-radius: 20px;
    background: #f8f9fa;
    font-size: 0.8rem;
    font-weight: 500;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

.status-dot.status-connected {
    background: var(--success-color);
    box-shadow: 0 0 8px rgba(25, 135, 84, 0.5);
    animation: pulse-green 2s infinite;
}

.status-dot.status-disconnected {
    background: var(--danger-color);
}

.status-dot.status-checking {
    background: var(--warning-color);
    animation: pulse-yellow 1s infinite;
}

@keyframes pulse-green {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

@keyframes pulse-yellow {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(1.1); }
}

/* Stat Cards Premium */
.stat-card-premium {
    background: #fff;
    border-radius: 16px;
    padding: 1rem 1.25rem;
    position: relative;
    overflow: hidden;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    height: 100%;
}

.stat-card-premium:hover {
    box-shadow: var(--card-shadow-hover);
    transform: translateY(-2px);
}

.stat-card-premium::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
}

.stat-card-connection::before {
    background: linear-gradient(180deg, var(--whatsapp-green), var(--whatsapp-dark));
}

.stat-card-counter::before {
    background: linear-gradient(180deg, var(--premium-purple), #5a3fd9);
}

.stat-card-body {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.stat-icon-wrapper {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    background: rgba(117, 79, 254, 0.1);
    color: var(--premium-purple);
}

.stat-content {
    flex-grow: 1;
    min-width: 0;
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
}

.stat-value {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stat-detail {
    font-size: 0.75rem;
}

.stat-message {
    display: block;
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #f1f5f9;
}

.status-indicator {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
}

.status-indicator.status-connected {
    background: var(--success-color);
    box-shadow: 0 0 6px rgba(25, 135, 84, 0.4);
}

.status-indicator.status-disconnected {
    background: var(--danger-color);
}

.status-indicator.status-checking {
    background: var(--warning-color);
    animation: pulse-yellow 1s infinite;
}

/* Progress Mini */
.progress-mini {
    height: 4px;
    background: #e9ecef;
    border-radius: 2px;
    overflow: hidden;
}

.progress-bar-mini {
    height: 100%;
    background: linear-gradient(90deg, var(--whatsapp-green), var(--whatsapp-dark));
    border-radius: 2px;
    transition: width 0.3s ease;
}

.progress-bar-mini.warning {
    background: linear-gradient(90deg, #ffc107, #ff9800);
}

.progress-bar-mini.danger {
    background: linear-gradient(90deg, #dc3545, #c82333);
}

/* Alert Soft */
.alert-warning-soft {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.2);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
}

/* Form Premium */
.form-label-premium {
    font-size: 0.9rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.form-select-premium,
.form-control-premium {
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.2s ease;
}

.form-select-premium:focus,
.form-control-premium:focus {
    border-color: var(--whatsapp-green);
    box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.15);
}

/* Upload Area */
.upload-area {
    border: 2px dashed #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    position: relative;
    transition: all 0.2s ease;
    background: #fafafa;
}

.upload-area:hover,
.upload-area.dragover {
    border-color: var(--whatsapp-green);
    background: rgba(37, 211, 102, 0.05);
}

.upload-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
}

.upload-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.upload-text {
    font-size: 0.9rem;
    color: #64748b;
}

.upload-preview {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.upload-area-image .upload-preview {
    flex-direction: column;
}

.image-thumbnail {
    max-width: 120px;
    max-height: 80px;
    border-radius: 8px;
    object-fit: cover;
}

.image-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
}

/* WhatsApp Preview */
.whatsapp-preview-wrapper {
    position: relative;
}

.whatsapp-preview-container {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.whatsapp-chat-header {
    background: var(--whatsapp-dark);
    padding: 0.75rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.chat-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
}

.chat-info {
    display: flex;
    flex-direction: column;
}

.chat-name {
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
}

.chat-status {
    color: #25d366;
    font-size: 0.75rem;
}

.whatsapp-chat-body {
    background: linear-gradient(135deg, #e5ddd5 0%, #d6cfc6 100%);
    background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8c0b5' fill-opacity='0.3'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    padding: 1rem;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.whatsapp-message-bubble {
    background: var(--whatsapp-light);
    border-radius: 8px 8px 0 8px;
    padding: 0.5rem 0.75rem;
    max-width: 85%;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.whatsapp-message-bubble::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: -8px;
    width: 0;
    height: 0;
    border: 8px solid transparent;
    border-left-color: var(--whatsapp-light);
    border-bottom-color: var(--whatsapp-light);
}

.preview-image {
    max-width: 100%;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.preview-text {
    margin: 0;
    font-size: 0.9rem;
    color: #303030;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.message-meta {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 0.15rem;
    margin-top: 0.25rem;
}

.message-time {
    font-size: 0.65rem;
    color: rgba(0,0,0,0.45);
}

.message-check {
    color: #53bdeb;
    font-size: 0.75rem;
}

/* Botao WhatsApp */
.btn-whatsapp {
    background: linear-gradient(135deg, var(--whatsapp-green) 0%, #20ba5a 100%);
    border: none;
    color: #fff;
    border-radius: 12px;
    padding: 0.875rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
}

.btn-whatsapp:hover {
    background: linear-gradient(135deg, #20ba5a 0%, #1da851 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
    color: #fff;
}

.btn-whatsapp:active {
    transform: translateY(0);
}

.btn-whatsapp:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
}

/* Char Counter */
.char-counter {
    font-size: 0.8rem;
    color: #6c757d;
}

.char-counter.text-danger {
    color: var(--danger-color) !important;
    font-weight: 600;
}

/* Logs Container */
.logs-container-wrapper {
    background: #fff;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--card-shadow);
}

.logs-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 0.875rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e9ecef;
}

.logs-header-actions {
    display: flex;
    gap: 0.5rem;
}

/* Progress Summary */
.progress-summary {
    display: flex;
    gap: 1rem;
    padding: 0.75rem 1.25rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    flex-wrap: wrap;
}

.progress-item {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.85rem;
}

.progress-item.progress-sent {
    color: var(--success-color);
}

.progress-item.progress-failed {
    color: var(--danger-color);
}

.progress-item.progress-remaining {
    color: #6c757d;
}

/* Logs List */
.logs-list {
    max-height: 280px;
    overflow-y: auto;
    padding: 0.5rem;
}

.log-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.6rem 0.875rem;
    border-radius: 10px;
    margin-bottom: 0.35rem;
    font-size: 0.85rem;
    transition: background 0.2s ease;
}

.log-item:last-child {
    margin-bottom: 0;
}

.log-item i {
    font-size: 1rem;
    flex-shrink: 0;
}

.log-item.log-success {
    background: rgba(25, 135, 84, 0.08);
    color: var(--success-color);
}

.log-item.log-success i {
    color: var(--success-color);
}

.log-item.log-error {
    background: rgba(220, 53, 69, 0.08);
    color: var(--danger-color);
}

.log-item.log-error i {
    color: var(--danger-color);
}

.log-item.log-info {
    background: rgba(108, 117, 125, 0.08);
    color: #6c757d;
}

.log-item.log-warning {
    background: rgba(255, 193, 7, 0.1);
    color: #856404;
}

.log-phone {
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
    font-size: 0.8rem;
    background: rgba(0,0,0,0.05);
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
}

.log-message {
    flex-grow: 1;
}

.log-time {
    font-size: 0.7rem;
    color: rgba(0,0,0,0.4);
    margin-left: auto;
}

.logs-footer {
    padding: 0.875rem 1.25rem;
    border-top: 1px solid #e9ecef;
}

/* Scrollbar Customizado */
.logs-list::-webkit-scrollbar {
    width: 6px;
}

.logs-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.logs-list::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.logs-list::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Templates Dropdown */
.templates-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    z-index: 1050;
    max-height: 300px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.templates-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
}

.templates-search {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e9ecef;
}

.templates-list {
    overflow-y: auto;
    flex-grow: 1;
}

.template-item {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: background 0.2s ease;
    border-bottom: 1px solid #f1f5f9;
}

.template-item:hover {
    background: #f8f9fa;
}

.template-item:last-child {
    border-bottom: none;
}

.template-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #1e293b;
}

.template-category {
    font-size: 0.75rem;
    color: #6c757d;
}

.template-preview {
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.25rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Responsividade */
@media (max-width: 767.98px) {
    .modal-envios-premium .modal-header {
        padding: 1rem 1.25rem 0.5rem;
    }

    .modal-envios-premium .modal-body {
        padding: 0.75rem 1.25rem 1.25rem;
    }

    .stat-card-premium {
        padding: 0.875rem 1rem;
    }

    .stat-icon-wrapper {
        width: 38px;
        height: 38px;
    }

    .stat-value {
        font-size: 1rem;
    }

    .connection-badge {
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
    }

    .whatsapp-preview-wrapper {
        display: none;
    }

    .progress-summary {
        gap: 0.5rem;
    }

    .progress-item {
        font-size: 0.75rem;
    }

    .log-item {
        padding: 0.5rem 0.75rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 575.98px) {
    .row.g-3 > .col-sm-6 {
        width: 100%;
    }

    .modal-envios-premium .modal-dialog {
        margin: 0.5rem;
    }

    .icon-shape {
        width: 44px;
        height: 44px;
    }

    .icon-shape i {
        font-size: 1.25rem !important;
    }
}

/* Animacao de Entrada */
.modal-envios-premium.fade .modal-dialog {
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
}

/* Estado de loading */
.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid currentColor;
    border-right-color: transparent;
    border-radius: 50%;
    animation: spinner 0.75s linear infinite;
}

@keyframes spinner {
    to { transform: rotate(360deg); }
}
</style>

<script>
/**
 * Sistema de Envios WhatsApp - Frontend Controller (Premium)
 *
 * Funcionalidades:
 * - Status de conexao em tempo real
 * - Preview de mensagem estilo WhatsApp
 * - Console de logs humanizado
 * - Integração com templates
 * - Envio com validacao client-side
 * - Polling de logs e status
 */

(function() {
    'use strict';

    // Estado global
    let estadoEnvio = {
        emProgresso: false,
        pausado: false,
        totalHoje: 0,
        enviados: 0,
        erros: 0,
        restantes: 0
    };

    let estadoConexao = {
        conectado: false,
        sessao: null
    };

    // Intervalos de polling
    let pollingInterval = null;
    let statusInterval = null;
    let connectionInterval = null;

    // Debounce para preview
    let previewTimeout = null;

    // ========================================
    // FUNCOES UTILITARIAS
    // ========================================

    function getCSRFToken() {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfMeta) return csrfMeta.content;
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) return csrfInput.value;
        return null;
    }

    function mascaraTelefone(telefone) {
        if (!telefone || telefone.length < 8) return telefone;
        const visivel = telefone.slice(0, -4);
        return visivel + '****';
    }

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    // ========================================
    // STATUS DE CONEXAO
    // ========================================

    async function verificarConexao() {
        try {
            const response = await fetch('/status-wpp/', {
                method: 'GET',
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Erro ao verificar conexão');

            const data = await response.json();
            atualizarStatusConexao(data);

        } catch (error) {
            console.error('Erro ao verificar conexão:', error);
            atualizarStatusConexao({ status: 'ERRO' });
        }
    }

    function atualizarStatusConexao(data) {
        const badge = document.getElementById('connection-badge');
        const cardStatus = document.getElementById('card-connection-status');
        const statusTexto = document.getElementById('status-conexao-texto');
        const sessaoInfo = document.getElementById('status-sessao-info');

        if (!badge || !statusTexto) return;

        const dot = badge.querySelector('.status-dot');
        const text = badge.querySelector('.status-text');
        const indicator = statusTexto.querySelector('.status-indicator');

        // Limpa classes anteriores
        dot.className = 'status-dot';
        indicator.className = 'status-indicator';

        const status = data.status || 'UNKNOWN';

        if (status === 'CONNECTED') {
            dot.classList.add('status-connected');
            indicator.classList.add('status-connected');
            text.textContent = 'Conectado';
            statusTexto.innerHTML = '<span class="status-indicator status-connected"></span> Conectado';
            sessaoInfo.textContent = data.session ? `Sessao: ${data.session}` : '-';
            estadoConexao.conectado = true;
            estadoConexao.sessao = data.session;
        } else if (status === 'QRCODE' || status === 'STARTING') {
            dot.classList.add('status-checking');
            indicator.classList.add('status-checking');
            text.textContent = 'Aguardando';
            statusTexto.innerHTML = '<span class="status-indicator status-checking"></span> Aguardando QRCode';
            sessaoInfo.textContent = 'Escaneie o QRCode';
            estadoConexao.conectado = false;
        } else {
            dot.classList.add('status-disconnected');
            indicator.classList.add('status-disconnected');
            text.textContent = 'Desconectado';
            statusTexto.innerHTML = '<span class="status-indicator status-disconnected"></span> Desconectado';
            sessaoInfo.textContent = 'Clique em "Conexão" no menu';
            estadoConexao.conectado = false;
        }
    }

    // ========================================
    // CONTADOR DE ENVIOS
    // ========================================

    function atualizarContador(total) {
        estadoEnvio.totalHoje = total;

        const contadorAtual = document.getElementById('contador-envios-atual');
        const progressBar = document.getElementById('contador-progress-bar');
        const contadorMensagem = document.getElementById('contador-mensagem');
        const iconWrapper = document.getElementById('contador-icon-wrapper');
        const contadorIcone = document.getElementById('contador-icone');

        if (!contadorAtual) return;

        contadorAtual.textContent = total;
        const percentual = Math.min((total / 150) * 100, 100);
        progressBar.style.width = `${percentual}%`;

        // Reset classes
        progressBar.className = 'progress-bar-mini';
        iconWrapper.className = 'stat-icon-wrapper';

        if (total <= 150) {
            iconWrapper.style.background = 'rgba(25, 135, 84, 0.1)';
            iconWrapper.style.color = '#198754';
            contadorIcone.className = 'bi bi-check-circle fs-5';
            contadorMensagem.innerHTML = '<i class="bi bi-check-circle me-1"></i>Dentro do limite recomendado';
            contadorMensagem.className = 'stat-message text-success';
        } else if (total <= 200) {
            progressBar.classList.add('warning');
            iconWrapper.style.background = 'rgba(255, 193, 7, 0.1)';
            iconWrapper.style.color = '#ffc107';
            contadorIcone.className = 'bi bi-exclamation-triangle fs-5';
            contadorMensagem.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Atenção: Limite recomendado excedido';
            contadorMensagem.className = 'stat-message text-warning';
        } else {
            progressBar.classList.add('danger');
            iconWrapper.style.background = 'rgba(220, 53, 69, 0.1)';
            iconWrapper.style.color = '#dc3545';
            contadorIcone.className = 'bi bi-exclamation-circle fs-5';
            contadorMensagem.innerHTML = '<i class="bi bi-exclamation-circle me-1"></i>RISCO: Delay aumentado (+10s)';
            contadorMensagem.className = 'stat-message text-danger fw-bold';
        }
    }

    // ========================================
    // PREVIEW WHATSAPP
    // ========================================

    function atualizarPreview() {
        const mensagem = document.getElementById('mensagem-modal').value;
        const previewText = document.getElementById('preview-text');
        const previewTime = document.getElementById('preview-time');

        if (!previewText) return;

        // Formata mensagem com estilos WhatsApp
        let textoFormatado = mensagem || 'Sua mensagem aparecera aqui...';

        // Converte *texto* para negrito visual (simula)
        textoFormatado = textoFormatado.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
        // Converte _texto_ para italico
        textoFormatado = textoFormatado.replace(/_(.*?)_/g, '<em>$1</em>');

        previewText.innerHTML = textoFormatado;
        previewTime.textContent = getCurrentTime();
    }

    function atualizarPreviewImagem(file) {
        const previewImage = document.getElementById('preview-image');
        if (!previewImage) return;

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                previewImage.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        } else {
            previewImage.src = '';
            previewImage.classList.add('d-none');
        }
    }

    // ========================================
    // LOGS HUMANIZADOS
    // ========================================

    function parsearLogs(logsText) {
        if (!logsText) return [];

        const lines = logsText.split('\n').filter(line => line.trim());
        const parsed = [];
        let enviados = 0;
        let erros = 0;

        for (const line of lines) {
            // Tenta detectar padrao: [HH:MM:SS] TELEFONE - STATUS
            // ou padrao: TELEFONE - mensagem
            const timeMatch = line.match(/\[(\d{2}:\d{2}:\d{2})\]/);
            const time = timeMatch ? timeMatch[1] : '';

            let status = 'info';
            let phone = '';
            let message = line;

            // Detecta sucesso
            if (line.includes('OK') || line.includes('sucesso') || line.includes('Enviado') || line.includes('enviada')) {
                status = 'success';
                enviados++;
                // Tenta extrair telefone
                const phoneMatch = line.match(/(\d{10,13})/);
                if (phoneMatch) phone = phoneMatch[1];
                message = 'Mensagem enviada';
            }
            // Detecta erro
            else if (line.includes('ERRO') || line.includes('falha') || line.includes('Falhou') || line.includes('erro') || line.includes('invalido')) {
                status = 'error';
                erros++;
                const phoneMatch = line.match(/(\d{10,13})/);
                if (phoneMatch) phone = phoneMatch[1];
                message = line.replace(/\[.*?\]/g, '').trim();
            }
            // Detecta warning
            else if (line.includes('Aguardando') || line.includes('delay') || line.includes('tentativa')) {
                status = 'warning';
                message = line.replace(/\[.*?\]/g, '').trim();
            }
            // Info geral
            else {
                message = line.replace(/\[.*?\]/g, '').trim();
            }

            parsed.push({ time, phone, message, status });
        }

        // Atualiza contadores
        estadoEnvio.enviados = enviados;
        estadoEnvio.erros = erros;

        return parsed;
    }

    function renderizarLogs(logs) {
        const logsList = document.getElementById('logs-list');
        const sentCount = document.getElementById('progress-sent-count');
        const failedCount = document.getElementById('progress-failed-count');
        const remainingCount = document.getElementById('progress-remaining-count');

        if (!logsList) return;

        if (!logs || logs.length === 0) {
            logsList.innerHTML = `
                <div class="log-item log-info">
                    <i class="bi bi-info-circle"></i>
                    <span class="log-message">Aguardando envios...</span>
                </div>
            `;
            return;
        }

        let html = '';
        for (const log of logs) {
            const iconClass = log.status === 'success' ? 'bi-check-circle-fill' :
                              log.status === 'error' ? 'bi-x-circle-fill' :
                              log.status === 'warning' ? 'bi-exclamation-triangle-fill' : 'bi-info-circle';

            const phoneHtml = log.phone ? `<span class="log-phone">${mascaraTelefone(log.phone)}</span>` : '';
            const timeHtml = log.time ? `<span class="log-time">${log.time}</span>` : '';

            html += `
                <div class="log-item log-${log.status}">
                    <i class="bi ${iconClass}"></i>
                    ${phoneHtml}
                    <span class="log-message">${log.message}</span>
                    ${timeHtml}
                </div>
            `;
        }

        logsList.innerHTML = html;

        // Auto-scroll
        logsList.scrollTop = logsList.scrollHeight;

        // Atualiza contadores
        if (sentCount) sentCount.textContent = estadoEnvio.enviados;
        if (failedCount) failedCount.textContent = estadoEnvio.erros;
        if (remainingCount) remainingCount.textContent = estadoEnvio.restantes;
    }

    // ========================================
    // TEMPLATES
    // ========================================

    async function carregarTemplates() {
        const templatesList = document.getElementById('templates-list');
        if (!templatesList) return;

        try {
            const response = await fetch('/tarefas-envio/templates/', {
                method: 'GET',
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Erro ao carregar templates');

            const data = await response.json();
            renderizarTemplates(data.templates || []);

        } catch (error) {
            console.error('Erro ao carregar templates:', error);
            templatesList.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-exclamation-circle"></i> Erro ao carregar templates
                </div>
            `;
        }
    }

    function renderizarTemplates(templates) {
        const templatesList = document.getElementById('templates-list');
        if (!templatesList) return;

        if (!templates || templates.length === 0) {
            templatesList.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="bi bi-inbox"></i> Nenhum template disponível
                    <br><small>Crie templates em "Tarefas de Envio"</small>
                </div>
            `;
            return;
        }

        let html = '';
        for (const template of templates) {
            // Remove tags HTML para preview
            const previewText = template.mensagem_html
                ? template.mensagem_html.replace(/<[^>]+>/g, '').substring(0, 60)
                : '';

            html += `
                <div class="template-item" data-id="${template.id}" data-mensagem="${encodeURIComponent(template.mensagem_html || '')}">
                    <div class="template-name">${template.nome}</div>
                    <div class="template-category">${template.categoria || 'Geral'}</div>
                    ${previewText ? `<div class="template-preview">${previewText}...</div>` : ''}
                </div>
            `;
        }

        templatesList.innerHTML = html;

        // Event listeners para selecao
        templatesList.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function() {
                const mensagem = decodeURIComponent(this.dataset.mensagem);
                // Converte HTML para texto simples
                const div = document.createElement('div');
                div.innerHTML = mensagem;
                const textoLimpo = div.textContent || div.innerText || '';

                document.getElementById('mensagem-modal').value = textoLimpo;
                document.getElementById('templates-dropdown').classList.add('d-none');
                atualizarPreview();

                // Atualiza contador de caracteres
                const charCount = document.getElementById('char-count-modal');
                if (charCount) {
                    charCount.textContent = `${textoLimpo.length} caracteres`;
                }
            });
        });
    }

    // ========================================
    // SINCRONIZACAO DE ESTADO
    // ========================================

    async function sincronizarEstado() {
        try {
            const response = await fetch('/status-envio/', {
                method: 'GET',
                credentials: 'same-origin'
            });

            if (!response.ok) throw new Error('Erro ao obter status');

            const data = await response.json();
            estadoEnvio.emProgresso = data.em_progresso;
            estadoEnvio.pausado = data.pausado;
            estadoEnvio.totalHoje = data.total_hoje;

            atualizarContador(data.total_hoje);
            atualizarBotoes();

        } catch (error) {
            console.error('Erro ao sincronizar estado:', error);
        }
    }

    function atualizarBotoes() {
        const btnEnviar = document.getElementById('botao-enviar-modal');
        const btnParar = document.getElementById('botao-parar-modal');
        const btnRetomar = document.getElementById('botao-retomar-modal');
        const btnLimpar = document.getElementById('limpar-console-modal');

        if (!btnEnviar || !btnParar || !btnRetomar) return;

        if (estadoEnvio.emProgresso && !estadoEnvio.pausado) {
            btnEnviar.classList.add('d-none');
            btnParar.classList.remove('d-none');
            btnRetomar.classList.add('d-none');
            if (btnLimpar) btnLimpar.disabled = true;
        } else if (estadoEnvio.pausado) {
            btnEnviar.classList.add('d-none');
            btnParar.classList.add('d-none');
            btnRetomar.classList.remove('d-none');
            if (btnLimpar) btnLimpar.disabled = true;
        } else {
            btnEnviar.classList.remove('d-none');
            btnParar.classList.add('d-none');
            btnRetomar.classList.add('d-none');
            if (btnLimpar) btnLimpar.disabled = false;
        }
    }

    // ========================================
    // POLLING DE LOGS
    // ========================================

    function iniciarPollingLogs() {
        if (pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async () => {
            try {
                const response = await fetch('/obter-logs-wpp/', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (!response.ok) return;

                const data = await response.json();
                const logs = parsearLogs(data.logs);
                renderizarLogs(logs);

            } catch (error) {
                console.error('Erro ao buscar logs:', error);
            }
        }, 2000);
    }

    function pararPollingLogs() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    // ========================================
    // VALIDACAO
    // ========================================

    function validarFormulário(formData) {
        const tipoEnvio = formData.get('options');
        const mensagem = formData.get('mensagem');
        const telefones = formData.get('telefones');

        if (!tipoEnvio || tipoEnvio === '') {
            Swal.fire({
                icon: 'warning',
                title: 'Campo obrigatorio',
                text: 'Selecione um tipo de envio',
                confirmButtonColor: '#25d366'
            });
            return false;
        }

        if (!mensagem || mensagem.trim().length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo obrigatorio',
                text: 'Digite uma mensagem',
                confirmButtonColor: '#25d366'
            });
            return false;
        }

        if (mensagem.length > 4096) {
            Swal.fire({
                icon: 'warning',
                title: 'Mensagem muito longa',
                text: 'A mensagem deve ter no máximo 4096 caracteres',
                confirmButtonColor: '#25d366'
            });
            return false;
        }

        if (tipoEnvio === 'avulso') {
            if (!telefones || telefones.size === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Arquivo necessário',
                    text: 'Para envio avulso, selecione um arquivo de telefones (.txt)',
                    confirmButtonColor: '#25d366'
                });
                return false;
            }

            const fileName = telefones.name || '';
            if (!fileName.toLowerCase().endsWith('.txt')) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Formato inválido',
                    text: 'O arquivo de telefones deve ser .txt',
                    confirmButtonColor: '#25d366'
                });
                return false;
            }
        }

        // Verifica conexão
        if (!estadoConexao.conectado) {
            Swal.fire({
                icon: 'warning',
                title: 'WhatsApp desconectado',
                text: 'Conecte seu WhatsApp antes de enviar mensagens',
                confirmButtonColor: '#25d366'
            });
            return false;
        }

        return true;
    }

    // ========================================
    // HANDLERS DE ENVIO
    // ========================================

    async function enviarMensagens() {
        const form = document.getElementById('form-wpp-modal');
        const formData = new FormData(form);

        if (!validarFormulário(formData)) return;

        const btnEnviar = document.getElementById('botao-enviar-modal');
        const btnRetomar = document.getElementById('botao-retomar-modal');
        const btnAtivo = btnEnviar.classList.contains('d-none') ? btnRetomar : btnEnviar;
        const textoOriginal = btnAtivo.innerHTML;

        try {
            btnAtivo.disabled = true;
            btnAtivo.innerHTML = '<span class="loading-spinner me-2"></span>Processando...';

            Swal.fire({
                title: 'Iniciando Envio',
                html: '<div class="text-center"><div class="spinner-border text-success mb-3"></div><p class="mb-0">Preparando mensagens...</p></div>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });

            const startTime = Date.now();

            const response = await fetch('/enviar-mensagem/', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });

            const data = await response.json();

            if (!response.ok) {
                Swal.close();
                btnAtivo.disabled = false;
                btnAtivo.innerHTML = textoOriginal;

                if (response.status === 409) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Envio em Progresso',
                        text: 'Já existe um envio em progresso. Aguarde ou pause o envio atual.',
                        confirmButtonColor: '#25d366'
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erro ao Enviar',
                        html: `<code>${JSON.stringify(data.error)}</code>`,
                        confirmButtonColor: '#dc3545'
                    });
                }
                return;
            }

            // Garante loading mínimo de 2s
            const elapsed = Date.now() - startTime;
            if (elapsed < 2000) {
                await new Promise(resolve => setTimeout(resolve, 2000 - elapsed));
            }

            Swal.close();
            btnAtivo.disabled = false;
            btnAtivo.innerHTML = textoOriginal;

            // Mostra console
            document.getElementById('form-wpp-modal').style.display = 'none';
            document.getElementById('console-modal').style.display = 'block';

            // Inicia polling
            iniciarPollingLogs();
            sincronizarEstado();

            if (statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(sincronizarEstado, 5000);

            // Toast de sucesso
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Envio iniciado!',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });

        } catch (error) {
            console.error('Erro ao enviar:', error);
            Swal.close();
            btnAtivo.disabled = false;
            btnAtivo.innerHTML = textoOriginal;

            Swal.fire({
                icon: 'error',
                title: 'Erro de Conexao',
                text: 'Nao foi possivel conectar ao servidor',
                confirmButtonColor: '#dc3545'
            });
        }
    }

    async function pararEnvio() {
        const btnParar = document.getElementById('botao-parar-modal');
        const textoOriginal = btnParar.innerHTML;

        try {
            btnParar.disabled = true;
            btnParar.innerHTML = '<span class="loading-spinner me-2"></span>Pausando...';

            const response = await fetch('/parar-envio/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCSRFToken() },
                credentials: 'same-origin'
            });

            const data = await response.json();

            btnParar.disabled = false;
            btnParar.innerHTML = textoOriginal;

            if (!response.ok) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro ao Pausar',
                    text: data.error || 'Erro desconhecido',
                    confirmButtonColor: '#dc3545'
                });
                return;
            }

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'info',
                title: 'Envio pausado',
                showConfirmButton: false,
                timer: 2000
            });

            estadoEnvio.pausado = true;
            atualizarBotoes();

        } catch (error) {
            console.error('Erro ao pausar:', error);
            btnParar.disabled = false;
            btnParar.innerHTML = textoOriginal;
        }
    }

    // ========================================
    // CONTROLE DE CAMPOS
    // ========================================

    function atualizarCamposVisiveis() {
        const tipoEnvio = document.getElementById('options-modal');
        const campoTelefones = document.getElementById('campo-telefones');
        const campoImagem = document.getElementById('campo-imagem');
        const campoMensagem = document.getElementById('campo-mensagem');
        const previewWrapper = document.getElementById('preview-wrapper');
        const botoesControle = document.getElementById('botoes-controle');
        const inputTelefones = document.getElementById('telefones-modal');

        if (!tipoEnvio) return;

        const tipo = tipoEnvio.value;

        // Esconde tudo primeiro
        [campoTelefones, campoImagem, campoMensagem, previewWrapper, botoesControle].forEach(el => {
            if (el) el.classList.add('d-none');
        });
        if (inputTelefones) inputTelefones.removeAttribute('required');

        // Mostra campos baseado no tipo
        if (tipo === 'ativos' || tipo === 'cancelados') {
            campoImagem.classList.remove('d-none');
            campoMensagem.classList.remove('d-none');
            previewWrapper.classList.remove('d-none');
            botoesControle.classList.remove('d-none');
        } else if (tipo === 'avulso') {
            campoTelefones.classList.remove('d-none');
            campoImagem.classList.remove('d-none');
            campoMensagem.classList.remove('d-none');
            previewWrapper.classList.remove('d-none');
            botoesControle.classList.remove('d-none');
            inputTelefones.setAttribute('required', 'required');
        }
    }

    // ========================================
    // UPLOAD HANDLERS
    // ========================================

    function setupUploadArea(areaId, inputId, isImage = false) {
        const area = document.getElementById(areaId);
        const input = document.getElementById(inputId);

        if (!area || !input) return;

        // Drag & Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            area.addEventListener(eventName, () => area.classList.add('dragover'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, () => area.classList.remove('dragover'));
        });

        area.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                input.files = files;
                handleFileSelect(area, files[0], isImage);
            }
        });

        input.addEventListener('change', () => {
            if (input.files && input.files.length > 0) {
                handleFileSelect(area, input.files[0], isImage);
            }
        });

        // Botao remover
        const removeBtn = area.querySelector('.remove-file');
        if (removeBtn) {
            removeBtn.addEventListener('click', e => {
                e.preventDefault();
                e.stopPropagation();
                input.value = '';
                area.querySelector('.upload-placeholder').classList.remove('d-none');
                area.querySelector('.upload-preview').classList.add('d-none');

                if (isImage) {
                    atualizarPreviewImagem(null);
                }
            });
        }
    }

    function handleFileSelect(area, file, isImage) {
        const placeholder = area.querySelector('.upload-placeholder');
        const preview = area.querySelector('.upload-preview');
        const fileName = area.querySelector('.file-name');

        placeholder.classList.add('d-none');
        preview.classList.remove('d-none');
        fileName.textContent = file.name;

        if (isImage) {
            const thumbnail = area.querySelector('.image-thumbnail');
            const reader = new FileReader();
            reader.onload = e => {
                thumbnail.src = e.target.result;
            };
            reader.readAsDataURL(file);
            atualizarPreviewImagem(file);
        }
    }

    // ========================================
    // INICIALIZACAO
    // ========================================

    document.addEventListener('DOMContentLoaded', function() {
        // Tipo de envio
        const tipoEnvioSelect = document.getElementById('options-modal');
        if (tipoEnvioSelect) {
            tipoEnvioSelect.addEventListener('change', atualizarCamposVisiveis);
        }

        // Contador de caracteres e preview
        const mensagemTextarea = document.getElementById('mensagem-modal');
        const charCount = document.getElementById('char-count-modal');

        if (mensagemTextarea) {
            mensagemTextarea.addEventListener('input', function() {
                const count = this.value.length;
                if (charCount) {
                    charCount.textContent = `${count} caractere${count !== 1 ? 's' : ''}`;
                    charCount.classList.toggle('text-danger', count > 4096);
                }

                // Debounce preview
                clearTimeout(previewTimeout);
                previewTimeout = setTimeout(atualizarPreview, 300);
            });
        }

        // Setup upload areas
        setupUploadArea('upload-area-telefones', 'telefones-modal', false);
        setupUploadArea('upload-area-imagem', 'imagem-modal', true);

        // Botoes de controle
        const btnEnviar = document.getElementById('botao-enviar-modal');
        const btnParar = document.getElementById('botao-parar-modal');
        const btnRetomar = document.getElementById('botao-retomar-modal');

        if (btnEnviar) btnEnviar.addEventListener('click', enviarMensagens);
        if (btnParar) btnParar.addEventListener('click', pararEnvio);
        if (btnRetomar) btnRetomar.addEventListener('click', enviarMensagens);

        // Botao Ver Logs
        const btnVerLogs = document.getElementById('botao-ver-logs-modal');
        if (btnVerLogs) {
            btnVerLogs.addEventListener('click', function() {
                document.getElementById('form-wpp-modal').style.display = 'none';
                document.getElementById('console-modal').style.display = 'block';
                iniciarPollingLogs();
                sincronizarEstado();

                if (statusInterval) clearInterval(statusInterval);
                statusInterval = setInterval(sincronizarEstado, 5000);
            });
        }

        // Botao Voltar
        const btnVoltar = document.getElementById('botao-voltar-modal');
        if (btnVoltar) {
            btnVoltar.addEventListener('click', function() {
                document.getElementById('console-modal').style.display = 'none';
                document.getElementById('form-wpp-modal').style.display = 'block';
                pararPollingLogs();
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
            });
        }

        // Botao Limpar Console
        const btnLimpar = document.getElementById('limpar-console-modal');
        if (btnLimpar) {
            btnLimpar.addEventListener('click', async function() {
                const result = await Swal.fire({
                    title: 'Limpar Logs?',
                    text: 'Esta ação irá deletar o arquivo de log',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sim, limpar!',
                    cancelButtonText: 'Cancelar'
                });

                if (!result.isConfirmed) return;

                try {
                    const response = await fetch('/limpar-log-wpp/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken(),
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin'
                    });

                    if (response.ok) {
                        renderizarLogs([]);
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Logs limpos!',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                } catch (error) {
                    console.error('Erro ao limpar logs:', error);
                }
            });
        }

        // Templates
        const btnTemplates = document.getElementById('btn-templates-modal');
        const templatesDropdown = document.getElementById('templates-dropdown');
        const closeTemplates = document.getElementById('close-templates');

        if (btnTemplates && templatesDropdown) {
            btnTemplates.addEventListener('click', function() {
                templatesDropdown.classList.toggle('d-none');
                if (!templatesDropdown.classList.contains('d-none')) {
                    carregarTemplates();
                }
            });
        }

        if (closeTemplates) {
            closeTemplates.addEventListener('click', () => {
                templatesDropdown.classList.add('d-none');
            });
        }

        // Search templates
        const searchTemplate = document.getElementById('search-template');
        if (searchTemplate) {
            searchTemplate.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                const items = document.querySelectorAll('.template-item');
                items.forEach(item => {
                    const name = item.querySelector('.template-name').textContent.toLowerCase();
                    item.style.display = name.includes(query) ? 'block' : 'none';
                });
            });
        }

        // Modal events
        const modal = document.getElementById('modalEnviosWhatsapp');
        if (modal) {
            modal.addEventListener('hidden.bs.modal', function() {
                // Reset form
                const form = document.getElementById('form-wpp-modal');
                if (form) form.reset();

                // Reset char counter
                if (charCount) charCount.textContent = '0 caracteres';

                // Reset preview
                const previewText = document.getElementById('preview-text');
                if (previewText) previewText.textContent = 'Sua mensagem aparecerá aqui...';
                atualizarPreviewImagem(null);

                // Reset upload areas
                document.querySelectorAll('.upload-area').forEach(area => {
                    const placeholder = area.querySelector('.upload-placeholder');
                    const preview = area.querySelector('.upload-preview');
                    if (placeholder) placeholder.classList.remove('d-none');
                    if (preview) preview.classList.add('d-none');
                });

                // Hide console, show form
                document.getElementById('console-modal').style.display = 'none';
                document.getElementById('form-wpp-modal').style.display = 'block';

                // Hide all conditional fields
                ['campo-telefones', 'campo-imagem', 'campo-mensagem', 'preview-wrapper', 'botoes-controle'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('d-none');
                });

                // Hide templates dropdown
                if (templatesDropdown) templatesDropdown.classList.add('d-none');

                // Stop polling
                pararPollingLogs();
                if (statusInterval) {
                    clearInterval(statusInterval);
                    statusInterval = null;
                }
                if (connectionInterval) {
                    clearInterval(connectionInterval);
                    connectionInterval = null;
                }
            });

            modal.addEventListener('shown.bs.modal', function() {
                // Verifica conexão e sincroniza estado
                verificarConexao();
                sincronizarEstado();
                atualizarCamposVisiveis();

                // Polling de conexao a cada 30s
                if (connectionInterval) clearInterval(connectionInterval);
                connectionInterval = setInterval(verificarConexao, 30000);
            });
        }
    });

    // Funcao global para abrir modal
    window.modalEnviosWhatsapp = function() {
        const modal = new bootstrap.Modal(document.getElementById('modalEnviosWhatsapp'));
        modal.show();
    };

})();
</script>
