{% load static %}

<div class="d-flex flex-row flex-column gap-3">
    <div id="accordionExample1">
        <ul class="timeline list-unstyled d-flex flex-column mb-0" id="lista-planos-indicacao">
            <!-- Items dos PLANOS serão inseridos aqui pelo JS -->
        </ul>
        
        <ul class="timeline list-unstyled d-flex flex-column mt-0" id="lista-horarios-envios">
            <!-- Items dos HORARIOS serão inseridos aqui pelo JS -->
        </ul>
    </div>
</div>

<script>
    // PLANOS
    // FUNÇÃO PARA OBTER DADOS DO BACKEND COM "GET"
    document.addEventListener('DOMContentLoaded', function() {
        buscarTodosOsPlanos();
        buscarHorariosEnvios();
    });

    function buscarTodosOsPlanos() {
        fetch("/edit-referral-plan/", { credentials: "same-origin" })
            .then(response => parseJsonResponse(response, "carregamento dos planos de indicação"))
            .then(data => {
                if (data.error) {
                    console.error("[Planos de indicação] Backend devolveu erro lógico", data.error);
                    Swal.fire("Erro", data.error, "error");
                    return;
                }
                // Container da lista
                const lista = document.getElementById('lista-planos-indicacao');
                lista.innerHTML = '';

                const sessao_wpp = data.sessao_wpp;

                data.planos.forEach((plano, idx) => {
                    const collapseId = `collapse${plano.id}`;
                    // Monta o HTML
                    const item = `
                    <li class="timeline-event mt-2" data-plano-tipo="${plano.tipo_plano}">
                        <div class="card timeline-event-card">
                            <div class="card-body">
                                <div class="d-flex flex-lg-row flex-column align-items-lg-center gap-3 justify-content-between">
                                    <div>
                                        <a
                                            href="#"
                                            class="d-flex flex-row gap-2 collapsed text-inherit"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#${collapseId}"
                                            aria-expanded="false"
                                            aria-controls="${collapseId}"
                                        >
                                            <i data-feather="chevron-right" class="icon-xs chevron-down mt-1 text-primary"></i>
                                            <div class="d-flex flex-md-row flex-column align-items-md-center gap-md-2">
                                                <h4 class="card-title mb-0" style="cursor:pointer;">
                                                    ${plano.nome_display}
                                                </h4>
                                            </div>
                                        </a>
                                    </div>
                                    <div class="d-flex flex-row gap-2">
                                        <span id="status-plano-${plano.id}">
                                            ${plano.status
                                            ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                                            : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>'}
                                        </span>
                                    </div>
                                </div>
                                <div id="${collapseId}"
                                    class="accordion-collapse collapse get-collapse-plans"
                                    data-bs-parent="#accordionExample1"
                                    data-plano-id="${plano.id}"
                                >
                                    <div class="d-flex flex-column mt-4">
                                        <p class="card-text">
                                            ${plano.descricao}
                                            <a href="#">Saiba mais</a>
                                        </p>
                                        <p class="fs-6 mb-0">
                                            <strong>Exemplo:</strong>
                                            ${plano.exemplo}
                                        </p>
                                        <br>
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text">R$</span>
                                                <input type="text" class="form-control"
                                                    id="valor_indicacao_${plano.id}"
                                                    name="valor_indicacao"
                                                    value="${plano.valor}"
                                                    placeholder="Valor desconto"
                                                    required style="max-width: 150px;"
                                                    ${plano.status ? "disabled" : ""}>
                                            </div>
                                            ${plano.tipo_plano === 'desconto_progressivo' ? `
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text" title="Limite de indicações com desconto (0 = ilimitado)">Limite</span>
                                                <input type="number" class="form-control"
                                                    id="limite_indicacoes_${plano.id}"
                                                    name="limite_indicacoes"
                                                    value="${plano.limite_indicacoes || 0}"
                                                    placeholder="0"
                                                    min="0"
                                                    style="max-width: 100px;"
                                                    ${plano.status ? "disabled" : ""}>
                                            </div>
                                            ` : ''}
                                            <button
                                                class="btn btn-confirmar-acao ${plano.status ? "btn-danger" : "btn-primary"}"
                                                type="button"
                                                data-plano-id="${plano.id}"
                                                data-nome="${plano.nome_display}"
                                                data-status="${plano.status ? "on" : "off"}"
                                                data-sessao-wpp="${sessao_wpp ? "true" : ""}"
                                                onclick="togglePlanoAtivo(this)"
                                                id="btn-ativar-indicacao-${plano.id}"
                                            >
                                                ${plano.status ? "Desativar" : "Ativar"}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                    lista.insertAdjacentHTML('beforeend', item);
                });

                if (window.feather) window.feather.replace();
            })
            .catch((err) => {
                console.error("[Planos de indicação] Erro ao buscar dados", err);
                Swal.fire("Erro", err.message || "Erro ao buscar planos.", "error");
            });
    }

    // PLANOS
    // FUNÇÃO PARA PROCESSAR AÇÕES DE "POST"
    function togglePlanoAtivo(botao) {
        const planoId = botao.getAttribute('data-plano-id');
        const nomeDisplay = botao.getAttribute('data-nome');
        const statusAtual = botao.getAttribute('data-status');
        const inputValor = document.getElementById('valor_indicacao_' + planoId);
        const inputLimite = document.getElementById('limite_indicacoes_' + planoId);
        let valor = inputValor ? inputValor.value : "0";
        let limite_indicacoes = inputLimite ? parseInt(inputLimite.value) || 0 : 0;
        const valor_minimo = 5.00;
        const sessao_wpp = botao.getAttribute('data-sessao-wpp');

        const novoAtivo = (statusAtual === "off");

        // --- Validação: se for ativar, valor deve ser > 0 ---
        if (novoAtivo && (isNaN(valor) || parseFloat(valor) <= 0)) {
            Swal.fire("Atenção", "Informe um valor MAIOR que zero para ativar este Plano.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Validação: se for ativar, deve ter uma sessão do Wpp ativa ---
        if (novoAtivo && (!sessao_wpp || sessao_wpp === "false")) {
            Swal.fire("Atenção", "Você ainda não salvou a sua sessão do WhatsApp. Vá até o Menu Principal e faça conexão.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Se DESATIVAR, define o valor para ZERO no envio ---
        if (!novoAtivo) {
            valor = "0";
        }

        let tipo_plano = "desconto";
        if (nomeDisplay.toLowerCase().includes("dinheiro")) tipo_plano = "dinheiro";
        else if (nomeDisplay.toLowerCase().includes("anuidade")) tipo_plano = "anuidade";

        botao.disabled = true;
        if (typeof setButtonLoading === 'function') {
            setButtonLoading(botao, true);
        } else {
            botao.textContent = "Salvando...";
        }

        const payload = {
            id: planoId,
            nome: tipo_plano,
            tipo_plano: tipo_plano,
            valor: valor,
            valor_minimo_mensalidade: valor_minimo,
            limite_indicacoes: limite_indicacoes,
            status: novoAtivo
        };

        const textoAnterior = statusAtual === "off" ? "Ativar" : "Desativar";
        const classeAnterior = statusAtual === "off" ? "btn-primary" : "btn-danger";
        const statusSpan = document.getElementById('status-plano-' + planoId);
        const valorAnterior = inputValor ? inputValor.value : "";
        const limiteAnterior = inputLimite ? inputLimite.value : "0";
        const inputDesabilitadoAnterior = inputValor ? inputValor.disabled : false;
        const inputLimiteDesabilitadoAnterior = inputLimite ? inputLimite.disabled : false;

        fetch("/edit-referral-plan/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(payload)
        })
        .then(response => parseJsonResponse(response, "atualização do plano de indicação"))
        .then(data => {
            if (!data.success) {
                console.error("[Planos de indicação] Resposta sem sucesso", data);
                throw new Error(data.error || "Erro ao atualizar plano.");
            }

            botao.setAttribute("data-status", novoAtivo ? "on" : "off");
            botao.textContent = novoAtivo ? "Desativar" : "Ativar";
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(novoAtivo ? "btn-danger" : "btn-primary");

            if (inputValor && data.plano && data.plano.valor !== undefined) {
                inputValor.value = data.plano.valor;
                inputValor.disabled = novoAtivo;
            }

            if (inputLimite && data.plano && data.plano.limite_indicacoes !== undefined) {
                inputLimite.value = data.plano.limite_indicacoes;
                inputLimite.disabled = novoAtivo;
            }

            if (!novoAtivo && inputValor) {
                inputValor.value = "0";
            }

            if (!novoAtivo && inputLimite) {
                inputLimite.value = "0";
            }

            if (statusSpan) {
                statusSpan.innerHTML = novoAtivo
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }

            Swal.fire("Sucesso", "Plano atualizado!", "success");
        })
        .catch((error) => {
            console.error("[Planos de indicação] Falha ao atualizar", error);
            Swal.fire("Erro", error.message || "Erro de comunicação.", "error");

            botao.setAttribute("data-status", statusAtual);
            botao.textContent = textoAnterior;
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(classeAnterior);

            if (inputValor) {
                inputValor.disabled = inputDesabilitadoAnterior;
                if (!inputValor.disabled) {
                    inputValor.value = valorAnterior;
                }
            }

            if (inputLimite) {
                inputLimite.disabled = inputLimiteDesabilitadoAnterior;
                if (!inputLimite.disabled) {
                    inputLimite.value = limiteAnterior;
                }
            }

            if (statusSpan) {
                statusSpan.innerHTML = statusAtual === "on"
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }
        })
        .finally(() => {
            botao.disabled = false;
        });
    }

    // Função utilitária para CSRF
    function getCookie(name) {
        if (name === "csrftoken") {
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken && metaToken.content) {
                return metaToken.content;
            }
        }

        if (!document.cookie || document.cookie === "") {
            return null;
        }

        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }

        return null;
    }

    function parseJsonResponse(response, context) {
        const contentType = response.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
            return response.json().then((data) => {
                if (!response.ok) {
                    console.error(`[${context}] Resposta com erro`, { status: response.status, data });
                    const message = data.error || data.message || `Falha ao processar ${context}.`;
                    throw new Error(message);
                }

                return data;
            });
        }

        return response.text().then((text) => {
            console.error(`[${context}] Resposta não JSON`, {
                status: response.status,
                preview: text.slice(0, 300),
            });
            throw new Error("Resposta inesperada do servidor.");
        });
    }

    // HORARIOS
    function buscarHorariosEnvios() {
        fetch("/edit-horario-envios/", { credentials: "same-origin" })
            .then(response => parseJsonResponse(response, "carregamento dos horários de envio"))
            .then(data => {
                if (data.error) {
                    console.error("[Horários de envio] Backend devolveu erro lógico", data.error);
                    Swal.fire("Erro", data.error, "error");
                    return;
                }

                const sessao_wpp = data.sessao_wpp;

                const lista = document.getElementById('lista-horarios-envios');
                if (!lista) return;
                lista.innerHTML = '';

                data.horarios.forEach(horario => {
                    const collapseId = `collapseHorario${horario.id}`;
                    const isInputDisabled = horario.status ? 'disabled' : '';
                    const btnClass = horario.status ? 'btn-danger' : 'btn-primary';
                    const btnText = horario.status ? 'Desativar' : 'Ativar';
                    const statusHtml = horario.status
                        ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                        : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';

                    const item = `
                        <li class="timeline-event mt-2">
                            <div class="card timeline-event-card">
                                <div class="card-body">
                                    <div class="d-flex flex-lg-row flex-column align-items-lg-center gap-3 justify-content-between">
                                        <div>
                                            <a
                                                href="#"
                                                class="d-flex flex-row gap-2 collapsed text-inherit"
                                                data-bs-toggle="collapse"
                                                data-bs-target="#${collapseId}"
                                                aria-expanded="false"
                                                aria-controls="${collapseId}"
                                            >
                                                <i data-feather="chevron-right" class="icon-xs chevron-down mt-1 text-primary"></i>
                                                <div class="d-flex flex-md-row flex-column align-items-md-center gap-md-2">
                                                    <h4 class="card-title mb-0" style="cursor:pointer;">
                                                        ${horario.nome_display}
                                                    </h4>
                                                </div>
                                            </a>
                                        </div>
                                        <div class="d-flex flex-row gap-2">
                                            <span id="status-horario-${horario.id}">
                                                ${statusHtml}
                                            </span>
                                        </div>
                                    </div>
                                    <div id="${collapseId}"
                                        class="accordion-collapse collapse get-collapse-horario"
                                        data-bs-parent="#accordionExample1"
                                        data-horario-id="${horario.id}"
                                    >
                                        <div class="d-flex flex-column mt-4">
                                            <p class="card-text">
                                                ${horario.descricao}
                                                <a href="#">Saiba mais</a>
                                            </p>
                                            <p class="fs-6 mb-0">
                                                <strong>Exemplo:</strong>
                                                ${horario.exemplo}
                                            </p>
                                            <br>
                                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                                <div class="input-group input-group-sm">
                                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                    <input type="time" class="form-control"
                                                        id="horario_envio_${horario.id}"
                                                        name="horario_envio"
                                                        value="${horario.horario || ""}"
                                                        placeholder="hh:mm"
                                                        style="max-width: 120px;"
                                                        ${isInputDisabled}>
                                                </div>
                                                <button
                                                    class="btn btn-confirmar-acao ${btnClass}"
                                                    type="button"
                                                    data-horario-id="${horario.id}"
                                                    data-status="${horario.status ? "on" : "off"}"
                                                    data-sessao-wpp="${sessao_wpp ? "true" : ""}"
                                                    onclick="toggleHorarioAtivo(this)"
                                                    id="btn-ativar-horario-${horario.id}"
                                                >
                                                    ${btnText}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `;
                    lista.insertAdjacentHTML('beforeend', item);
                });

                if (window.feather) window.feather.replace();
            })
            .catch((err) => {
                console.error("[Horários de envio] Erro ao buscar dados", err);
                Swal.fire("Erro", err.message || "Erro ao buscar horários.", "error");
            });
    }

    // Função para ativar/desativar um horário
    function toggleHorarioAtivo(botao) {
        const horarioId = botao.getAttribute('data-horario-id');
        const statusAtual = botao.getAttribute('data-status'); // "on" ou "off"
        const inputHorario = document.getElementById('horario_envio_' + horarioId);
        let horarioValue = inputHorario ? inputHorario.value : "";
        const sessao_wpp = botao.getAttribute('data-sessao-wpp'); //True ou False

        const novoStatus = (statusAtual === "off");
        botao.disabled = true;
        if (typeof setButtonLoading === 'function') {
            setButtonLoading(botao, true);
        } else {
            botao.textContent = "Salvando...";
        }

        // --- Validação: se for ativar, precisa ter sessão WPP ---
        if (novoStatus && (!sessao_wpp || sessao_wpp === "false")) {
            Swal.fire("Atenção", "Você ainda não salvou a sua sessão do WhatsApp. Vá até o Menu Principal e faça conexão.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Validação: se for ativar, input não pode estar vazio ---
        if (novoStatus && (!horarioValue || horarioValue.trim() === "")) {
            Swal.fire("Atenção", "Informe um horário antes de ativar.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // Ao desativar, limpar valor antes de enviar
        if (!novoStatus) {
            horarioValue = "";
        }

        // Payload
        const payload = {
            id: horarioId,
            status: novoStatus,
            horario: horarioValue,
        };

        const textoAnterior = statusAtual === "off" ? "Ativar" : "Desativar";
        const classeAnterior = statusAtual === "off" ? "btn-primary" : "btn-danger";
        const statusSpan = document.getElementById('status-horario-' + horarioId);
        const valorAnterior = inputHorario ? inputHorario.value : "";
        const inputDesabilitadoAnterior = inputHorario ? inputHorario.disabled : false;

        fetch("/edit-horario-envios/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(payload)
        })
        .then(response => parseJsonResponse(response, "atualização do horário de envio"))
        .then(data => {
            if (!data.success) {
                console.error("[Horários de envio] Resposta sem sucesso", data);
                throw new Error(data.error || "Erro ao atualizar horário.");
            }

            botao.setAttribute("data-status", novoStatus ? "on" : "off");
            botao.textContent = novoStatus ? "Desativar" : "Ativar";
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(novoStatus ? "btn-danger" : "btn-primary");

            if (inputHorario) {
                inputHorario.disabled = novoStatus;
                if (!novoStatus) {
                    inputHorario.value = "";
                }
            }

            if (statusSpan) {
                statusSpan.innerHTML = novoStatus
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }

            Swal.fire("Sucesso", "Horário atualizado!", "success");
        })
        .catch((error) => {
            console.error("[Horários de envio] Falha ao atualizar", error);
            Swal.fire("Erro", error.message || "Erro de comunicação.", "error");

            botao.setAttribute("data-status", statusAtual);
            botao.textContent = textoAnterior;
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(classeAnterior);

            if (inputHorario) {
                inputHorario.disabled = inputDesabilitadoAnterior;
                inputHorario.value = valorAnterior;
            }

            if (statusSpan) {
                statusSpan.innerHTML = statusAtual === "on"
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }
        })
        .finally(() => {
            botao.disabled = false;
        });
    }
</script>
