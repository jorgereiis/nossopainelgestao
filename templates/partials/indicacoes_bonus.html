{% load static %}

<style>
/* Timeline com ﾃｭcones ﾃ esquerda */
.timeline {
    margin-bottom: 0 !important;
}
.timeline .timeline-event {
    position: relative;
    padding-bottom: 0.75rem;
    padding-top: 0;
    margin: 0;
}
.timeline .timeline-event::before {
    content: "";
    position: absolute;
    top: 2.75rem;
    left: 1.1rem;
    bottom: -0.75rem;
    width: 1px;
    background-color: var(--bs-gray-300, #dee2e6);
}
/* Esconder linha apenas no ﾃｺltimo item da ﾃｺltima lista */
#lista-reject-call .timeline-event:last-child::before {
    display: none;
}
.timeline .timeline-event .timeline-event-icon {
    position: absolute;
    top: 0.75rem;
    left: 0;
    z-index: 1;
}
.timeline .timeline-event .timeline-event-icon .icon-shape {
    width: 2.25rem;
    height: 2.25rem;
    min-width: 2.25rem;
    min-height: 2.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
}
.timeline .timeline-event .timeline-event-card {
    margin-left: 3rem;
}
.timeline .timeline-event .timeline-event-card .card-title {
    font-size: 0.875rem;
    font-weight: 600;
}

/* Status ON/OFF sempre ﾃ direita sem quebra */
.timeline .timeline-event .status-badge {
    white-space: nowrap;
    flex-shrink: 0;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Rotaﾃｧﾃ｣o do chevron ao expandir */
.timeline .timeline-event .chevron-toggle {
    transition: transform 0.2s ease-in-out;
}
.timeline .timeline-event a[aria-expanded="true"] .chevron-toggle {
    transform: rotate(90deg);
}

/* Container cinza para conteﾃｺdo expandido */
.timeline .config-content-box {
    background-color: var(--bs-gray-100, #f8f9fa);
    border: 1px solid var(--bs-gray-200, #e9ecef);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
    font-size: 0.8125rem;
}
.timeline .config-content-box .card-text {
    font-size: 0.8125rem;
    color: var(--bs-gray-600, #6c757d);
    margin-bottom: 0.75rem;
}
.timeline .config-content-box .form-check-label {
    font-size: 0.8125rem;
}

/* Inputs e botﾃｵes menores */
.timeline .config-content-box .input-group-sm .form-control,
.timeline .config-content-box .input-group-sm .input-group-text {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}
.timeline .config-content-box .btn-sm-config {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
    font-weight: 500;
}

/* Header do card mais compacto */
.timeline .timeline-event .card-body {
    padding: 0.875rem 1rem;
}

/* Balﾃ｣o de mensagem estilo WhatsApp */
.message-preview-balloon {
    background-color: #dcf8c6;
    border-radius: 0.5rem;
    padding: 0.625rem 0.75rem;
    margin-bottom: 0.75rem;
    position: relative;
    font-size: 0.75rem;
    line-height: 1.4;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.message-preview-balloon::before {
    content: "";
    position: absolute;
    top: 0;
    right: -8px;
    border-width: 8px;
    border-style: solid;
    border-color: #dcf8c6 transparent transparent transparent;
}
.message-preview-balloon .msg-label {
    font-size: 0.625rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.message-preview-balloon .msg-content {
    color: #303030;
    white-space: pre-line;
}
</style>

<div class="d-flex flex-column">
    <div id="accordionExample1">
        <ul class="timeline list-unstyled mb-0" id="lista-planos-indicacao">
            <!-- Items dos PLANOS serﾃ｣o inseridos aqui pelo JS -->
        </ul>

        <ul class="timeline list-unstyled mb-0" id="lista-horarios-envios">
            <!-- Items dos HORARIOS serﾃ｣o inseridos aqui pelo JS -->
        </ul>

        <!-- Seﾃｧﾃ｣o: Rejeiﾃｧﾃ｣o de Chamadas -->
        <ul class="timeline list-unstyled mb-0" id="lista-reject-call">
            <li class="timeline-event">
                <div class="timeline-event-icon">
                    <div class="icon-shape icon-md text-danger-emphasis bg-danger-subtle rounded-circle">
                        <i data-feather="phone-off" class="icon-xs"></i>
                    </div>
                </div>
                <div class="card timeline-event-card">
                    <div class="card-body">
                        <div class="d-flex flex-row align-items-center justify-content-between">
                            <a
                                href="#"
                                class="d-flex flex-row gap-2 align-items-center collapsed text-inherit flex-grow-1"
                                data-bs-toggle="collapse"
                                data-bs-target="#collapseRejectCall"
                                aria-expanded="false"
                                aria-controls="collapseRejectCall"
                            >
                                <i data-feather="chevron-right" class="icon-xs chevron-toggle text-primary"></i>
                                <h4 class="card-title mb-0" style="cursor:pointer;">
                                    Rejeiﾃｧﾃ｣o de Chamadas
                                </h4>
                            </a>
                            <span id="status-reject-call" class="status-badge">
                                OFF <i class="bi bi-x-circle-fill text-danger"></i>
                            </span>
                        </div>
                        <div id="collapseRejectCall"
                            class="accordion-collapse collapse"
                            data-bs-parent="#accordionExample1"
                        >
                            <div class="config-content-box">
                                <p class="card-text mb-2">
                                    Configure a rejeiﾃｧﾃ｣o automﾃ｡tica de chamadas recebidas no WhatsApp.
                                </p>

                                <!-- Preview da mensagem -->
                                <div class="message-preview-balloon">
                                    <div class="msg-label"><i class="bi bi-chat-dots me-1"></i>Mensagem enviada</div>
                                    <div class="msg-content">圻 <strong>Nﾃグ ATENDEMOS CHAMADAS</strong> 圻

Estaremos lhe atendendo em alguns instantes.

Enquanto isso, informe aqui como podemos ajudﾃ｡-lo(a).</div>
                                </div>

                                <!-- Checkbox horﾃ｡rios -->
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox"
                                           id="rejectCallUseHorarios"
                                           onchange="toggleRejectCallHorarios(this)"
                                           style="cursor: pointer;">
                                    <label class="form-check-label" for="rejectCallUseHorarios">
                                        Definir horﾃ｡rio especﾃｭfico
                                    </label>
                                </div>

                                <!-- Inputs de horﾃ｡rio (ocultos inicialmente) -->
                                <div id="rejectCallHorariosInputs" style="display: none;">
                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                <input type="time" class="form-control"
                                                       id="rejectCallHorarioInicio" value="08:00">
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                <input type="time" class="form-control"
                                                       id="rejectCallHorarioFim" value="18:00">
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-2">
                                        <i class="bi bi-info-circle"></i> Suporta horﾃ｡rios que atravessam meia-noite
                                    </p>
                                </div>

                                <!-- Botﾃ｣o Ativar/Desativar -->
                                <div class="d-flex justify-content-end mt-2">
                                    <button
                                        class="btn btn-primary btn-sm-config"
                                        type="button"
                                        id="btn-toggle-reject-call"
                                        data-status="off"
                                        onclick="toggleRejectCallStatus(this)"
                                    >
                                        Ativar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</div>

<script>
    // PLANOS
    // FUNﾃﾃグ PARA OBTER DADOS DO BACKEND COM "GET"
    document.addEventListener('DOMContentLoaded', function() {
        buscarTodosOsPlanos();
        buscarHorariosEnvios();
    });

    function buscarTodosOsPlanos() {
        fetch("/edit-referral-plan/", { credentials: "same-origin" })
            .then(response => parseJsonResponse(response, "carregamento dos planos de indicaﾃｧﾃ｣o"))
            .then(data => {
                if (data.error) {
                    console.error("[Planos de indicaﾃｧﾃ｣o] Backend devolveu erro lﾃｳgico", data.error);
                    Swal.fire("Erro", data.error, "error");
                    return;
                }
                // Container da lista
                const lista = document.getElementById('lista-planos-indicacao');
                lista.innerHTML = '';

                const sessao_wpp = data.sessao_wpp;

                data.planos.forEach((plano, idx) => {
                    const collapseId = `collapse${plano.id}`;
                    // Monta o HTML
                    const item = `
                    <li class="timeline-event" data-plano-tipo="${plano.tipo_plano}">
                        <div class="timeline-event-icon">
                            <div class="icon-shape icon-md text-success-emphasis bg-success-subtle rounded-circle">
                                <i data-feather="gift" class="icon-xs"></i>
                            </div>
                        </div>
                        <div class="card timeline-event-card">
                            <div class="card-body">
                                <div class="d-flex flex-row align-items-center justify-content-between">
                                    <a
                                        href="#"
                                        class="d-flex flex-row gap-2 align-items-center collapsed text-inherit flex-grow-1"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#${collapseId}"
                                        aria-expanded="false"
                                        aria-controls="${collapseId}"
                                    >
                                        <i data-feather="chevron-right" class="icon-xs chevron-toggle text-primary"></i>
                                        <h4 class="card-title mb-0" style="cursor:pointer;">
                                            ${plano.nome_display}
                                        </h4>
                                    </a>
                                    <span id="status-plano-${plano.id}" class="status-badge">
                                        ${plano.status
                                        ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                                        : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>'}
                                    </span>
                                </div>
                                <div id="${collapseId}"
                                    class="accordion-collapse collapse get-collapse-plans"
                                    data-bs-parent="#accordionExample1"
                                    data-plano-id="${plano.id}"
                                >
                                    <div class="config-content-box">
                                        <p class="card-text mb-2">
                                            ${plano.descricao}
                                        </p>
                                        <p class="small text-muted mb-2">
                                            <strong>Ex:</strong> ${plano.exemplo}
                                        </p>
                                        <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center">
                                            <div class="input-group input-group-sm" style="width: auto;">
                                                <span class="input-group-text">R$</span>
                                                <input type="text" class="form-control"
                                                    id="valor_indicacao_${plano.id}"
                                                    name="valor_indicacao"
                                                    value="${plano.valor}"
                                                    placeholder="Valor"
                                                    required style="width: 70px;"
                                                    ${plano.status ? "disabled" : ""}>
                                            </div>
                                            ${plano.tipo_plano === 'desconto_progressivo' ? `
                                            <div class="input-group input-group-sm" style="width: auto;">
                                                <span class="input-group-text" title="Limite (0 = ilimitado)">Lim</span>
                                                <input type="number" class="form-control"
                                                    id="limite_indicacoes_${plano.id}"
                                                    name="limite_indicacoes"
                                                    value="${plano.limite_indicacoes || 0}"
                                                    min="0"
                                                    style="width: 60px;"
                                                    ${plano.status ? "disabled" : ""}>
                                            </div>
                                            ` : ''}
                                            <button
                                                class="btn btn-sm-config ${plano.status ? "btn-danger" : "btn-primary"}"
                                                type="button"
                                                data-plano-id="${plano.id}"
                                                data-nome="${plano.nome_display}"
                                                data-status="${plano.status ? "on" : "off"}"
                                                data-sessao-wpp="${sessao_wpp ? "true" : ""}"
                                                onclick="togglePlanoAtivo(this)"
                                                id="btn-ativar-indicacao-${plano.id}"
                                            >
                                                ${plano.status ? "Desativar" : "Ativar"}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    `;
                    lista.insertAdjacentHTML('beforeend', item);
                });

                if (window.feather) window.feather.replace();
            })
            .catch((err) => {
                console.error("[Planos de indicaﾃｧﾃ｣o] Erro ao buscar dados", err);
                Swal.fire("Erro", err.message || "Erro ao buscar planos.", "error");
            });
    }

    // PLANOS
    // FUNﾃﾃグ PARA PROCESSAR Aﾃﾃ髭S DE "POST"
    function togglePlanoAtivo(botao) {
        const planoId = botao.getAttribute('data-plano-id');
        const nomeDisplay = botao.getAttribute('data-nome');
        const statusAtual = botao.getAttribute('data-status');
        const inputValor = document.getElementById('valor_indicacao_' + planoId);
        const inputLimite = document.getElementById('limite_indicacoes_' + planoId);
        let valor = inputValor ? inputValor.value : "0";
        let limite_indicacoes = inputLimite ? parseInt(inputLimite.value) || 0 : 0;
        const valor_minimo = 5.00;
        const sessao_wpp = botao.getAttribute('data-sessao-wpp');

        const novoAtivo = (statusAtual === "off");

        // --- Validaﾃｧﾃ｣o: se for ativar, valor deve ser > 0 ---
        if (novoAtivo && (isNaN(valor) || parseFloat(valor) <= 0)) {
            Swal.fire("Atenﾃｧﾃ｣o", "Informe um valor MAIOR que zero para ativar este Plano.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Validaﾃｧﾃ｣o: se for ativar, deve ter uma sessﾃ｣o do Wpp ativa ---
        if (novoAtivo && (!sessao_wpp || sessao_wpp === "false")) {
            Swal.fire("Atenﾃｧﾃ｣o", "Vocﾃｪ ainda nﾃ｣o salvou a sua sessﾃ｣o do WhatsApp. Vﾃ｡ atﾃｩ o Menu Principal e faﾃｧa conexﾃ｣o.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Se DESATIVAR, define o valor para ZERO no envio ---
        if (!novoAtivo) {
            valor = "0";
        }

        let tipo_plano = "desconto";
        if (nomeDisplay.toLowerCase().includes("dinheiro")) tipo_plano = "dinheiro";
        else if (nomeDisplay.toLowerCase().includes("anuidade")) tipo_plano = "anuidade";

        botao.disabled = true;
        if (typeof setButtonLoading === 'function') {
            setButtonLoading(botao, true);
        } else {
            botao.textContent = "Salvando...";
        }

        const payload = {
            id: planoId,
            nome: tipo_plano,
            tipo_plano: tipo_plano,
            valor: valor,
            valor_minimo_mensalidade: valor_minimo,
            limite_indicacoes: limite_indicacoes,
            status: novoAtivo
        };

        const textoAnterior = statusAtual === "off" ? "Ativar" : "Desativar";
        const classeAnterior = statusAtual === "off" ? "btn-primary" : "btn-danger";
        const statusSpan = document.getElementById('status-plano-' + planoId);
        const valorAnterior = inputValor ? inputValor.value : "";
        const limiteAnterior = inputLimite ? inputLimite.value : "0";
        const inputDesabilitadoAnterior = inputValor ? inputValor.disabled : false;
        const inputLimiteDesabilitadoAnterior = inputLimite ? inputLimite.disabled : false;

        fetch("/edit-referral-plan/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(payload)
        })
        .then(response => parseJsonResponse(response, "atualizaﾃｧﾃ｣o do plano de indicaﾃｧﾃ｣o"))
        .then(data => {
            if (!data.success) {
                console.error("[Planos de indicaﾃｧﾃ｣o] Resposta sem sucesso", data);
                throw new Error(data.error || "Erro ao atualizar plano.");
            }

            botao.setAttribute("data-status", novoAtivo ? "on" : "off");
            botao.textContent = novoAtivo ? "Desativar" : "Ativar";
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(novoAtivo ? "btn-danger" : "btn-primary");

            if (inputValor && data.plano && data.plano.valor !== undefined) {
                inputValor.value = data.plano.valor;
                inputValor.disabled = novoAtivo;
            }

            if (inputLimite && data.plano && data.plano.limite_indicacoes !== undefined) {
                inputLimite.value = data.plano.limite_indicacoes;
                inputLimite.disabled = novoAtivo;
            }

            if (!novoAtivo && inputValor) {
                inputValor.value = "0";
            }

            if (!novoAtivo && inputLimite) {
                inputLimite.value = "0";
            }

            if (statusSpan) {
                statusSpan.innerHTML = novoAtivo
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }

            Swal.fire("Sucesso", "Plano atualizado!", "success");
        })
        .catch((error) => {
            console.error("[Planos de indicaﾃｧﾃ｣o] Falha ao atualizar", error);
            Swal.fire("Erro", error.message || "Erro de comunicaﾃｧﾃ｣o.", "error");

            botao.setAttribute("data-status", statusAtual);
            botao.textContent = textoAnterior;
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(classeAnterior);

            if (inputValor) {
                inputValor.disabled = inputDesabilitadoAnterior;
                if (!inputValor.disabled) {
                    inputValor.value = valorAnterior;
                }
            }

            if (inputLimite) {
                inputLimite.disabled = inputLimiteDesabilitadoAnterior;
                if (!inputLimite.disabled) {
                    inputLimite.value = limiteAnterior;
                }
            }

            if (statusSpan) {
                statusSpan.innerHTML = statusAtual === "on"
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }
        })
        .finally(() => {
            botao.disabled = false;
        });
    }

    // Funﾃｧﾃ｣o utilitﾃ｡ria para CSRF
    function getCookie(name) {
        if (name === "csrftoken") {
            const metaToken = document.querySelector('meta[name="csrf-token"]');
            if (metaToken && metaToken.content) {
                return metaToken.content;
            }
        }

        if (!document.cookie || document.cookie === "") {
            return null;
        }

        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
                return decodeURIComponent(cookie.substring(name.length + 1));
            }
        }

        return null;
    }

    function parseJsonResponse(response, context) {
        const contentType = response.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
            return response.json().then((data) => {
                if (!response.ok) {
                    console.error(`[${context}] Resposta com erro`, { status: response.status, data });
                    const message = data.error || data.message || `Falha ao processar ${context}.`;
                    throw new Error(message);
                }

                return data;
            });
        }

        return response.text().then((text) => {
            console.error(`[${context}] Resposta nﾃ｣o JSON`, {
                status: response.status,
                preview: text.slice(0, 300),
            });
            throw new Error("Resposta inesperada do servidor.");
        });
    }

    // HORARIOS
    function buscarHorariosEnvios() {
        fetch("/edit-horario-envios/", { credentials: "same-origin" })
            .then(response => parseJsonResponse(response, "carregamento dos horﾃ｡rios de envio"))
            .then(data => {
                if (data.error) {
                    console.error("[Horﾃ｡rios de envio] Backend devolveu erro lﾃｳgico", data.error);
                    Swal.fire("Erro", data.error, "error");
                    return;
                }

                const sessao_wpp = data.sessao_wpp;

                const lista = document.getElementById('lista-horarios-envios');
                if (!lista) return;
                lista.innerHTML = '';

                data.horarios.forEach(horario => {
                    const collapseId = `collapseHorario${horario.id}`;
                    const isInputDisabled = horario.status ? 'disabled' : '';
                    const btnClass = horario.status ? 'btn-danger' : 'btn-primary';
                    const btnText = horario.status ? 'Desativar' : 'Ativar';
                    const statusHtml = horario.status
                        ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                        : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';

                    const item = `
                        <li class="timeline-event">
                            <div class="timeline-event-icon">
                                <div class="icon-shape icon-md text-warning-emphasis bg-warning-subtle rounded-circle">
                                    <i data-feather="clock" class="icon-xs"></i>
                                </div>
                            </div>
                            <div class="card timeline-event-card">
                                <div class="card-body">
                                    <div class="d-flex flex-row align-items-center justify-content-between">
                                        <a
                                            href="#"
                                            class="d-flex flex-row gap-2 align-items-center collapsed text-inherit flex-grow-1"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#${collapseId}"
                                            aria-expanded="false"
                                            aria-controls="${collapseId}"
                                        >
                                            <i data-feather="chevron-right" class="icon-xs chevron-toggle text-primary"></i>
                                            <h4 class="card-title mb-0" style="cursor:pointer;">
                                                ${horario.nome_display}
                                            </h4>
                                        </a>
                                        <span id="status-horario-${horario.id}" class="status-badge">
                                            ${statusHtml}
                                        </span>
                                    </div>
                                    <div id="${collapseId}"
                                        class="accordion-collapse collapse get-collapse-horario"
                                        data-bs-parent="#accordionExample1"
                                        data-horario-id="${horario.id}"
                                    >
                                        <div class="config-content-box">
                                            <p class="card-text mb-2">
                                                ${horario.descricao}
                                            </p>
                                            <p class="small text-muted mb-2">
                                                <strong>Ex:</strong> ${horario.exemplo}
                                            </p>
                                            <div class="d-flex flex-wrap gap-2 justify-content-end align-items-center">
                                                <div class="input-group input-group-sm" style="width: auto;">
                                                    <span class="input-group-text"><i class="bi bi-clock"></i></span>
                                                    <input type="time" class="form-control"
                                                        id="horario_envio_${horario.id}"
                                                        name="horario_envio"
                                                        value="${horario.horario || ""}"
                                                        style="width: 100px;"
                                                        ${isInputDisabled}>
                                                </div>
                                                <button
                                                    class="btn btn-sm-config ${btnClass}"
                                                    type="button"
                                                    data-horario-id="${horario.id}"
                                                    data-status="${horario.status ? "on" : "off"}"
                                                    data-sessao-wpp="${sessao_wpp ? "true" : ""}"
                                                    onclick="toggleHorarioAtivo(this)"
                                                    id="btn-ativar-horario-${horario.id}"
                                                >
                                                    ${btnText}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </li>
                    `;
                    lista.insertAdjacentHTML('beforeend', item);
                });

                if (window.feather) window.feather.replace();
            })
            .catch((err) => {
                console.error("[Horﾃ｡rios de envio] Erro ao buscar dados", err);
                Swal.fire("Erro", err.message || "Erro ao buscar horﾃ｡rios.", "error");
            });
    }

    // Funﾃｧﾃ｣o para ativar/desativar um horﾃ｡rio
    function toggleHorarioAtivo(botao) {
        const horarioId = botao.getAttribute('data-horario-id');
        const statusAtual = botao.getAttribute('data-status'); // "on" ou "off"
        const inputHorario = document.getElementById('horario_envio_' + horarioId);
        let horarioValue = inputHorario ? inputHorario.value : "";
        const sessao_wpp = botao.getAttribute('data-sessao-wpp'); //True ou False

        const novoStatus = (statusAtual === "off");
        botao.disabled = true;
        if (typeof setButtonLoading === 'function') {
            setButtonLoading(botao, true);
        } else {
            botao.textContent = "Salvando...";
        }

        // --- Validaﾃｧﾃ｣o: se for ativar, precisa ter sessﾃ｣o WPP ---
        if (novoStatus && (!sessao_wpp || sessao_wpp === "false")) {
            Swal.fire("Atenﾃｧﾃ｣o", "Vocﾃｪ ainda nﾃ｣o salvou a sua sessﾃ｣o do WhatsApp. Vﾃ｡ atﾃｩ o Menu Principal e faﾃｧa conexﾃ｣o.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // --- Validaﾃｧﾃ｣o: se for ativar, input nﾃ｣o pode estar vazio ---
        if (novoStatus && (!horarioValue || horarioValue.trim() === "")) {
            Swal.fire("Atenﾃｧﾃ｣o", "Informe um horﾃ｡rio antes de ativar.", "warning");
            botao.disabled = false;
            botao.textContent = "Ativar";
            return;
        }

        // Ao desativar, limpar valor antes de enviar
        if (!novoStatus) {
            horarioValue = "";
        }

        // Payload
        const payload = {
            id: horarioId,
            status: novoStatus,
            horario: horarioValue,
        };

        const textoAnterior = statusAtual === "off" ? "Ativar" : "Desativar";
        const classeAnterior = statusAtual === "off" ? "btn-primary" : "btn-danger";
        const statusSpan = document.getElementById('status-horario-' + horarioId);
        const valorAnterior = inputHorario ? inputHorario.value : "";
        const inputDesabilitadoAnterior = inputHorario ? inputHorario.disabled : false;

        fetch("/edit-horario-envios/", {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(payload)
        })
        .then(response => parseJsonResponse(response, "atualizaﾃｧﾃ｣o do horﾃ｡rio de envio"))
        .then(data => {
            if (!data.success) {
                console.error("[Horﾃ｡rios de envio] Resposta sem sucesso", data);
                throw new Error(data.error || "Erro ao atualizar horﾃ｡rio.");
            }

            botao.setAttribute("data-status", novoStatus ? "on" : "off");
            botao.textContent = novoStatus ? "Desativar" : "Ativar";
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(novoStatus ? "btn-danger" : "btn-primary");

            if (inputHorario) {
                inputHorario.disabled = novoStatus;
                if (!novoStatus) {
                    inputHorario.value = "";
                }
            }

            if (statusSpan) {
                statusSpan.innerHTML = novoStatus
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }

            Swal.fire("Sucesso", "Horﾃ｡rio atualizado!", "success");
        })
        .catch((error) => {
            console.error("[Horﾃ｡rios de envio] Falha ao atualizar", error);
            Swal.fire("Erro", error.message || "Erro de comunicaﾃｧﾃ｣o.", "error");

            botao.setAttribute("data-status", statusAtual);
            botao.textContent = textoAnterior;
            botao.classList.remove("btn-primary", "btn-danger");
            botao.classList.add(classeAnterior);

            if (inputHorario) {
                inputHorario.disabled = inputDesabilitadoAnterior;
                inputHorario.value = valorAnterior;
            }

            if (statusSpan) {
                statusSpan.innerHTML = statusAtual === "on"
                    ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                    : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
            }
        })
        .finally(() => {
            botao.disabled = false;
        });
    }

    // ========== REJEIﾃﾃグ DE CHAMADAS ==========

    document.addEventListener('DOMContentLoaded', function() {
        buscarConfigRejectCall();
    });

    async function buscarConfigRejectCall() {
        try {
            const response = await fetch('/edit-reject-call-config/', {
                method: 'GET',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await parseJsonResponse(response, 'carregamento config reject-call');

            if (data.success) {
                const config = data.config;
                const statusSpan = document.getElementById('status-reject-call');
                const btnToggle = document.getElementById('btn-toggle-reject-call');
                const useHorariosCheckbox = document.getElementById('rejectCallUseHorarios');
                const horariosInputs = document.getElementById('rejectCallHorariosInputs');
                const inputInicio = document.getElementById('rejectCallHorarioInicio');
                const inputFim = document.getElementById('rejectCallHorarioFim');

                // Status visual
                if (statusSpan) {
                    statusSpan.innerHTML = config.reject_call_enabled
                        ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                        : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
                }

                // Botﾃ｣o
                if (btnToggle) {
                    btnToggle.setAttribute('data-status', config.reject_call_enabled ? 'on' : 'off');
                    btnToggle.textContent = config.reject_call_enabled ? 'Desativar' : 'Ativar';
                    btnToggle.classList.remove('btn-primary', 'btn-danger');
                    btnToggle.classList.add(config.reject_call_enabled ? 'btn-danger' : 'btn-primary');
                }

                // Horﾃ｡rios
                if (config.reject_call_horario_inicio && config.reject_call_horario_fim) {
                    if (useHorariosCheckbox) useHorariosCheckbox.checked = true;
                    if (horariosInputs) horariosInputs.style.display = 'block';
                    if (inputInicio) inputInicio.value = config.reject_call_horario_inicio;
                    if (inputFim) inputFim.value = config.reject_call_horario_fim;
                } else {
                    if (useHorariosCheckbox) useHorariosCheckbox.checked = false;
                    if (horariosInputs) horariosInputs.style.display = 'none';
                }

                // Desabilitar inputs se ativo
                if (inputInicio) inputInicio.disabled = config.reject_call_enabled;
                if (inputFim) inputFim.disabled = config.reject_call_enabled;
                if (useHorariosCheckbox) useHorariosCheckbox.disabled = config.reject_call_enabled;

                if (window.feather) window.feather.replace();
            }
        } catch (error) {
            console.error('[Reject-Call] Erro ao buscar config:', error);
        }
    }

    function toggleRejectCallHorarios(checkbox) {
        const horariosInputs = document.getElementById('rejectCallHorariosInputs');
        if (horariosInputs) {
            horariosInputs.style.display = checkbox.checked ? 'block' : 'none';
        }
    }

    async function toggleRejectCallStatus(botao) {
        const statusAtual = botao.getAttribute('data-status');
        const novoStatus = (statusAtual === 'off');
        const statusSpan = document.getElementById('status-reject-call');
        const useHorariosCheckbox = document.getElementById('rejectCallUseHorarios');
        const inputInicio = document.getElementById('rejectCallHorarioInicio');
        const inputFim = document.getElementById('rejectCallHorarioFim');

        botao.disabled = true;
        botao.textContent = 'Salvando...';

        // Montar payload
        const payload = {
            reject_call_enabled: novoStatus
        };

        // Se ativando e tem horﾃ｡rios definidos, incluir no payload
        if (novoStatus && useHorariosCheckbox?.checked && inputInicio?.value && inputFim?.value) {
            payload.reject_call_horario_inicio = inputInicio.value;
            payload.reject_call_horario_fim = inputFim.value;
        } else if (!novoStatus) {
            // Ao desativar, limpar horﾃ｡rios
            payload.reject_call_horario_inicio = null;
            payload.reject_call_horario_fim = null;
        }

        try {
            const response = await fetch('/edit-reject-call-config/', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(payload)
            });
            const data = await parseJsonResponse(response, 'salvar config reject-call');

            if (data.success) {
                // Atualizar UI
                botao.setAttribute('data-status', novoStatus ? 'on' : 'off');
                botao.textContent = novoStatus ? 'Desativar' : 'Ativar';
                botao.classList.remove('btn-primary', 'btn-danger');
                botao.classList.add(novoStatus ? 'btn-danger' : 'btn-primary');

                if (statusSpan) {
                    statusSpan.innerHTML = novoStatus
                        ? 'ON <i class="bi bi-check-circle-fill text-success"></i>'
                        : 'OFF <i class="bi bi-x-circle-fill text-danger"></i>';
                }

                // Desabilitar/habilitar inputs
                if (inputInicio) inputInicio.disabled = novoStatus;
                if (inputFim) inputFim.disabled = novoStatus;
                if (useHorariosCheckbox) useHorariosCheckbox.disabled = novoStatus;

                Swal.fire({
                    icon: 'success',
                    title: 'Salvo!',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                throw new Error(data.message || 'Erro ao salvar configuraﾃｧﾃｵes.');
            }
        } catch (error) {
            console.error('[Reject-Call] Erro ao salvar:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: error.message || 'Falha ao salvar configuraﾃｧﾃｵes.'
            });
            // Reverter botﾃ｣o
            botao.textContent = statusAtual === 'on' ? 'Desativar' : 'Ativar';
        } finally {
            botao.disabled = false;
        }
    }
</script>
