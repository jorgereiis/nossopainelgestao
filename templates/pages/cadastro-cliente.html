{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
  {% include 'partials/head.html' %}
  <title>Cadastrar Cliente | Nosso Painel - Gestão Simplificada</title>
</head>

<!-- body -->
<body class="bg-light">
  <div id="db-wrapper">
    <!-- navbar vertical -->
    {% include 'partials/navbar-vertical.html' %}
    <!-- page content -->
    <div id="page-content">
      {% include 'partials/header.html' %}
      <!-- Container fluid -->
      <div class="container-fluid p-6">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-12">
            <!-- Page header -->
            <div class="border-bottom pb-4 mb-4 d-flex justify-content-between align-items-start">
              <div>
                <h3 class="mb-0 fw-bold">Cadastro de Cliente</h3>
                <p class="text-muted mb-0">Cadastre os dados básicos do cliente. A assinatura pode ser criada posteriormente.</p>
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal-todos-clientes">
                <i class="bi bi-people me-1"></i>Ver todos os clientes
              </button>
            </div>
          </div>
          <!-- col -->
          <div class="row mb-8">
            <div class="col-xl-4 col-lg-4 col-md-12 col-12">
              <div class="mb-4 mb-lg-0">
                <h4 class="mb-1">Dados Básicos</h4>
                <p class="mb-0 fs-5 text-muted">Preencha os dados do cliente.</p>

                <!-- Card de Informação -->
                <div class="card border-0 shadow-sm mt-4" style="background: linear-gradient(135deg, #e8f5e9 0%, #e3f2fd 100%);">
                  <div class="card-body">
                    <div class="mb-3">
                      <h4 class="mb-0 fw-bold" style="color: #2e7d32; font-size: 1.4rem;">&#128100; Cadastro Básico</h4>
                    </div>

                    <p class="text-muted small mb-3">
                      Este formulário permite cadastrar apenas os <strong>dados básicos</strong> do cliente, sem criar uma assinatura imediatamente.
                    </p>

                    <div class="mb-3">
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <p class="text-muted mb-0 small">Nome, telefone, e-mail, CPF e anotações</p>
                      </div>
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
                        <p class="text-muted mb-0 small"><strong>Não</strong> cria mensalidade</p>
                      </div>
                      <div class="d-flex align-items-start">
                        <i class="bi bi-x-circle-fill text-danger me-2 mt-1"></i>
                        <p class="text-muted mb-0 small"><strong>Não</strong> envia mensagem de confirmação</p>
                      </div>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex align-items-start">
                      <i class="bi bi-arrow-right-circle-fill text-primary me-2 mt-1"></i>
                      <p class="text-muted mb-0 small">
                        Após o cadastro, você pode criar uma assinatura para este cliente na página de <strong>Cadastro Assinatura</strong>.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Link para cadastro de assinatura -->
                <div class="mt-3 p-3 bg-light rounded">
                  <p class="text-muted small mb-2">
                    <i class="bi bi-lightning-fill text-warning me-1"></i>
                    <strong>Dica:</strong> Precisa cadastrar o cliente já com a assinatura completa?
                  </p>
                  <a href="{% url 'cadastro-assinatura' %}" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-clipboard-check me-1"></i>Ir para Cadastro Assinatura
                  </a>
                </div>
              </div>
            </div>

            <div class="col-xl-7 col-lg-8 col-md-12 col-12" id="div-principal">
              <!-- card -->
              <div class="card shadow-sm border-0 cadastro-form-card">
                <!-- card body -->
                <div class="card-body p-4">
                  <div class="mb-4 pb-3 border-bottom">
                    <h4 class="mb-1 fw-bold d-flex align-items-center">
                      <i class="bi bi-person-plus-fill text-primary me-2"></i>
                      Dados do Cliente
                    </h4>
                    <small class="text-muted">Apenas dados básicos - sem assinatura</small>
                  </div>

                  {% if error_message %}
                  <div class="alert alert-danger fade show mb-4" role="alert">
                    <div class="d-flex align-items-start">
                      <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                      <div>{{ error_message|safe }}</div>
                    </div>
                  </div>
                  {% endif %}

                  {% if success_message %}
                  <div class="alert alert-success fade show mb-4" role="alert">
                    <div class="d-flex align-items-start">
                      <i class="bi bi-check-circle-fill me-2 mt-1"></i>
                      <div>{{ success_message|safe }}</div>
                    </div>
                  </div>
                  {% endif %}

                  <form method="POST" id="cadastro-cliente-form">
                    {% csrf_token %}

                    <!-- Nome -->
                    <div class="mb-4">
                      <label for="nome" class="form-label fw-semibold">
                        <i class="bi bi-person-fill text-primary me-2"></i>Nome do cliente <span class="text-danger">*</span>
                      </label>
                      <input type="text" class="form-control form-control-lg" placeholder="Digite o nome completo do cliente" id="nome" name="nome"
                        autocomplete="off" required>
                      <small class="text-muted">Nome completo do cliente</small>
                    </div>

                    <!-- Telefone -->
                    <div class="mb-4">
                      <label for="telefone" class="form-label fw-semibold">
                        <i class="bi bi-telephone-fill text-success me-2"></i>Telefone <span class="text-danger">*</span>
                      </label>
                      <input type="tel" id="telefone" name="telefone" class="form-control form-control-lg" autocomplete="off" required>
                      <small class="text-muted">Número de telefone com DDD (precisa ter WhatsApp)</small>
                    </div>

                    <!-- Email -->
                    <div class="mb-4">
                      <label for="email" class="form-label fw-semibold">
                        <i class="bi bi-envelope-fill text-info me-2"></i>E-mail <span class="badge bg-light text-muted">Opcional</span>
                      </label>
                      <input type="email" class="form-control form-control-lg" placeholder="email@exemplo.com" id="email" name="email"
                        autocomplete="off">
                      <small class="text-muted">E-mail do cliente (opcional)</small>
                    </div>

                    <!-- CPF -->
                    <div class="mb-4">
                      <label for="cpf" class="form-label fw-semibold">
                        <i class="bi bi-card-text text-secondary me-2"></i>CPF <span class="badge bg-light text-muted">Opcional</span>
                      </label>
                      <input type="text" class="form-control form-control-lg" placeholder="000.000.000-00" id="cpf" name="cpf"
                        autocomplete="off" maxlength="14">
                      <small class="text-muted">CPF do cliente (opcional)</small>
                    </div>

                    <!-- Anotações -->
                    <div class="mb-4">
                      <label for="notas" class="form-label fw-semibold">
                        <i class="bi bi-sticky-fill text-warning me-2"></i>Anotações <span class="badge bg-light text-muted">Opcional</span>
                      </label>
                      <textarea class="form-control form-control-lg" placeholder="Observações sobre o cliente..." id="notas" name="notas" rows="3"></textarea>
                      <small class="text-muted">Observações importantes sobre o cliente</small>
                    </div>

                    <!-- Botão -->
                    <div class="d-grid gap-2 mt-5">
                      <button type="submit" class="btn btn-primary btn-lg" id="btn-cadastrar-cliente">
                        <i class="bi bi-check-lg me-2"></i>Cadastrar Cliente
                      </button>
                    </div>

                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Ver todos os clientes -->
  <div class="modal fade" id="modal-todos-clientes" tabindex="-1" aria-labelledby="modal-todos-clientes-label" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header border-0" style="background: linear-gradient(135deg, #624bff 0%, #4a37d9 100%);">
          <h5 class="modal-title text-white" id="modal-todos-clientes-label">
            <i class="bi bi-people-fill me-2"></i>Todos os Clientes
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Campo de pesquisa -->
          <div class="p-3 bg-white border-bottom sticky-top shadow-sm">
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-light border-end-0 rounded-start-pill">
                <i class="bi bi-search text-muted"></i>
              </span>
              <input type="text" class="form-control border-start-0 rounded-end-pill bg-light" id="pesquisa-clientes"
                     placeholder="Pesquisar por nome ou telefone..." autocomplete="off">
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <span class="badge bg-primary rounded-pill px-3 py-2" id="contador-clientes">
                <i class="bi bi-people me-1"></i>Carregando...
              </span>
              <small class="text-muted">
                <i class="bi bi-sort-down me-1"></i>Mais recentes primeiro
              </small>
            </div>
          </div>
          <!-- Lista de clientes -->
          <div id="lista-todos-clientes" style="max-height: 450px; overflow-y: auto;">
            <div class="text-center py-5">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p class="text-muted mt-2 mb-0">Carregando clientes...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Confirmar Remoção de Cliente -->
  <div class="modal fade" id="modal-confirmar-remocao" tabindex="-1" aria-labelledby="modal-confirmar-remocao-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-body text-center p-4">
          <!-- Ícone de alerta -->
          <div class="mb-3">
            <div class="d-inline-flex align-items-center justify-content-center rounded-circle"
                 style="width: 64px; height: 64px; background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);">
              <i class="bi bi-exclamation-triangle text-warning" style="font-size: 1.8rem;"></i>
            </div>
          </div>

          <!-- Título -->
          <h5 class="fw-bold mb-2">Remover Cliente</h5>

          <!-- Mensagem -->
          <p class="text-muted mb-1">Tem certeza que deseja remover</p>
          <p class="fw-semibold mb-3" id="nome-cliente-remover"></p>

          <small class="text-danger d-block mb-4">
            <i class="bi bi-info-circle me-1"></i>Esta ação não pode ser desfeita.
          </small>

          <!-- Botões -->
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-light flex-fill" data-bs-dismiss="modal">
              Cancelar
            </button>
            <button type="button" class="btn btn-danger flex-fill" id="btn-confirmar-remocao">
              <i class="bi bi-trash me-1"></i>Remover
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Cliente Cadastrado com Sucesso -->
  <div class="modal fade" id="modal-cliente-cadastrado" tabindex="-1" aria-labelledby="modal-cliente-cadastrado-label"
       aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 pb-0">
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body text-center pt-0 px-4 pb-4">
          <!-- Ícone de sucesso -->
          <div class="mb-4">
            <div class="d-inline-flex align-items-center justify-content-center rounded-circle"
                 style="width: 80px; height: 80px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);">
              <i class="bi bi-check-lg text-success" style="font-size: 2.5rem;"></i>
            </div>
          </div>

          <!-- Título -->
          <h4 class="fw-bold text-success mb-3">Cliente Cadastrado!</h4>

          <!-- Mensagem -->
          <p class="text-muted mb-4">
            O cliente foi cadastrado com sucesso. Para que ele possa ser <strong>gerenciado pelo sistema</strong>,
            é necessário criar uma <strong>assinatura</strong>, associando-o a um servidor e definindo seu plano.
          </p>

          <!-- Informação adicional -->
          <div class="bg-light rounded-3 p-3 mb-4">
            <div class="d-flex align-items-start text-start">
              <i class="bi bi-info-circle-fill text-primary me-2 mt-1"></i>
              <small class="text-muted">
                Sem uma assinatura, o cliente ficará apenas com os dados básicos cadastrados,
                sem mensalidades ou acesso ao serviço.
              </small>
            </div>
          </div>

          <!-- Botão de ação -->
          <a href="{% url 'cadastro-assinatura' %}" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-clipboard-check me-2"></i>Criar Assinatura para o Cliente
          </a>

          <button type="button" class="btn btn-link text-muted mt-2" data-bs-dismiss="modal">
            Cadastrar outro cliente
          </button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Loading com 3 pontos animados */
    .loading-dots {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }
    .loading-dots span {
      width: 8px;
      height: 8px;
      background-color: #fff;
      border-radius: 50%;
      animation: wave 1.2s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes wave {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-8px);
      }
    }

    /* Estilos do modal de clientes */
    #modal-todos-clientes .cliente-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    #modal-todos-clientes .cliente-item:hover {
      background-color: #f8f9ff;
      border-left-color: #624bff;
    }
    #modal-todos-clientes .cliente-logo {
      width: 44px;
      height: 44px;
      object-fit: cover;
      border-radius: 50%;
      background: #f8f9fa;
      padding: 2px;
      border: 2px solid #e9ecef;
    }
    #modal-todos-clientes .cliente-nome {
      font-weight: 600;
      color: #212529;
      margin-bottom: 2px;
    }
    #modal-todos-clientes .cliente-telefone {
      font-size: 0.8rem;
      color: #6c757d;
    }
    #modal-todos-clientes .cliente-data {
      font-size: 0.75rem;
      color: #adb5bd;
    }
    #modal-todos-clientes .status-badge {
      font-size: 0.7rem;
      padding: 0.35em 0.65em;
      font-weight: 600;
    }
    #pesquisa-clientes:focus {
      box-shadow: none;
      background-color: #fff !important;
    }
    #modal-todos-clientes .btn-remover-cliente {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      opacity: 0.7;
      transition: all 0.2s ease;
    }
    #modal-todos-clientes .btn-remover-cliente:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    #modal-todos-clientes .cliente-item:hover .btn-remover-cliente {
      opacity: 1;
    }
  </style>

  {% include 'partials/scripts.html' %}

  <!-- Formatação de telefone -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/css/intlTelInput.css">
  <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/intlTelInput.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Exibir modal de sucesso se cliente foi cadastrado
      {% if success_message %}
      const modalClienteCadastrado = new bootstrap.Modal(document.getElementById('modal-cliente-cadastrado'));
      modalClienteCadastrado.show();
      {% endif %}

      // Inicializar telefone internacional
      const telefoneInput = document.querySelector("#telefone");
      if (telefoneInput) {
        const iti = window.intlTelInput(telefoneInput, {
          initialCountry: "br",
          preferredCountries: ["br", "us", "pt"],
          separateDialCode: true,
          utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/utils.js",
        });

        // Máscaras de telefone por país
        function aplicarMascaraTelefone(input, countryCode) {
          let value = input.value.replace(/\D/g, '');

          if (countryCode === 'br') {
            // Brasil: (99) 99999-9999 ou (99) 9999-9999
            if (value.length > 11) value = value.slice(0, 11);
            if (value.length > 10) {
              value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
              value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
              value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            } else if (value.length > 0) {
              value = value.replace(/(\d{0,2})/, '($1');
            }
          } else if (countryCode === 'us') {
            // EUA: (999) 999-9999
            if (value.length > 10) value = value.slice(0, 10);
            if (value.length > 6) {
              value = value.replace(/(\d{3})(\d{3})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 3) {
              value = value.replace(/(\d{3})(\d{0,3})/, '($1) $2');
            } else if (value.length > 0) {
              value = value.replace(/(\d{0,3})/, '($1');
            }
          } else if (countryCode === 'pt') {
            // Portugal: 999 999 999
            if (value.length > 9) value = value.slice(0, 9);
            if (value.length > 6) {
              value = value.replace(/(\d{3})(\d{3})(\d{0,3})/, '$1 $2 $3');
            } else if (value.length > 3) {
              value = value.replace(/(\d{3})(\d{0,3})/, '$1 $2');
            }
          }

          input.value = value.trim();
        }

        // Aplicar máscara ao digitar
        telefoneInput.addEventListener('input', function() {
          const countryData = iti.getSelectedCountryData();
          aplicarMascaraTelefone(this, countryData.iso2);
        });

        // Limpar e reaplicar máscara ao mudar de país
        telefoneInput.addEventListener('countrychange', function() {
          const countryData = iti.getSelectedCountryData();
          const rawValue = this.value.replace(/\D/g, '');
          this.value = rawValue;
          aplicarMascaraTelefone(this, countryData.iso2);
        });

        // Ao submeter, formatar telefone e mostrar loading
        document.getElementById('cadastro-cliente-form').addEventListener('submit', function(e) {
          const fullNumber = iti.getNumber();
          if (fullNumber) {
            telefoneInput.value = fullNumber;
          }

          // Mostrar loading no botão
          const btn = document.getElementById('btn-cadastrar-cliente');
          if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span>';
          }
        });
      }

      // Formatação de CPF
      const cpfInput = document.getElementById('cpf');
      if (cpfInput) {
        cpfInput.addEventListener('input', function(e) {
          let value = e.target.value.replace(/\D/g, '');
          if (value.length > 11) value = value.slice(0, 11);
          if (value.length > 9) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, '$1.$2.$3-$4');
          } else if (value.length > 6) {
            value = value.replace(/(\d{3})(\d{3})(\d{1,3})/, '$1.$2.$3');
          } else if (value.length > 3) {
            value = value.replace(/(\d{3})(\d{1,3})/, '$1.$2');
          }
          e.target.value = value;
        });
      }

      // ========== Modal: Ver todos os clientes ==========
      const modalClientes = document.getElementById('modal-todos-clientes');
      let todosClientes = [];
      let clientesCarregados = false;

      if (modalClientes) {
        modalClientes.addEventListener('show.bs.modal', function() {
          if (!clientesCarregados) {
            carregarClientes();
          }
        });
      }

      async function carregarClientes() {
        try {
          const response = await fetch('/api/clientes/lista-todos/', {
            credentials: 'same-origin'
          });
          if (!response.ok) throw new Error('Erro ao carregar clientes');
          const data = await response.json();
          todosClientes = data.clientes || [];
          clientesCarregados = true;
          renderizarClientes(todosClientes);
        } catch (error) {
          console.error('Erro ao carregar clientes:', error);
          document.getElementById('lista-todos-clientes').innerHTML = `
            <div class="text-center py-5 text-danger">
              <i class="bi bi-exclamation-triangle fs-1"></i>
              <p class="mt-2 mb-0">Erro ao carregar clientes</p>
            </div>
          `;
        }
      }

      function renderizarClientes(clientes) {
        const container = document.getElementById('lista-todos-clientes');
        const contador = document.getElementById('contador-clientes');

        if (clientes.length === 0) {
          container.innerHTML = `
            <div class="text-center py-5 text-muted">
              <i class="bi bi-search fs-1 d-block mb-3 opacity-50"></i>
              <p class="mb-1 fw-semibold">Nenhum cliente encontrado</p>
              <small>Tente outro termo de pesquisa</small>
            </div>
          `;
          contador.innerHTML = '<i class="bi bi-people me-1"></i>0 clientes';
          return;
        }

        contador.innerHTML = `<i class="bi bi-people me-1"></i>${clientes.length} cliente${clientes.length !== 1 ? 's' : ''}`;

        let html = '<div class="list-group list-group-flush">';
        clientes.forEach(cliente => {
          let statusClass, statusBg, statusText;
          if (cliente.cancelado) {
            statusClass = 'text-white';
            statusBg = 'bg-danger';
            statusText = 'Cancelado';
          } else if (cliente.tem_assinatura) {
            statusClass = 'text-white';
            statusBg = 'bg-success';
            statusText = 'Ativo';
          } else {
            statusClass = 'text-dark';
            statusBg = 'bg-warning';
            statusText = 'Sem assinatura';
          }

          const dataAdesao = cliente.data_adesao ? cliente.data_adesao : '-';
          const servidorNome = cliente.servidor_nome ? cliente.servidor_nome : '';

          // Botão de remover só aparece para clientes sem assinatura e não cancelados
          const podeRemover = !cliente.tem_assinatura && !cliente.cancelado;
          const btnRemover = podeRemover ? `
            <button type="button" class="btn btn-outline-danger btn-sm btn-remover-cliente"
                    data-id="${cliente.id}" data-nome="${cliente.nome}" title="Remover cliente">
              <i class="bi bi-trash"></i>
            </button>
          ` : '';

          html += `
            <div class="list-group-item cliente-item d-flex align-items-center py-3 px-3" data-cliente-id="${cliente.id}">
              <img src="${cliente.logo_servidor}" alt="Logo" class="cliente-logo me-3"
                   onerror="this.src='/static/assets/images/logo-apps/default.png'">
              <div class="flex-grow-1 min-width-0">
                <div class="d-flex align-items-center justify-content-between mb-1">
                  <span class="cliente-nome text-truncate">${cliente.nome}</span>
                  <div class="d-flex align-items-center gap-2">
                    <span class="status-badge ${statusBg} ${statusClass} rounded-pill">${statusText}</span>
                    ${btnRemover}
                  </div>
                </div>
                <div class="d-flex align-items-center gap-3">
                  <span class="cliente-telefone">
                    <i class="bi bi-whatsapp text-success me-1"></i>${cliente.telefone}
                  </span>
                  ${servidorNome ? `<span class="cliente-telefone"><i class="bi bi-hdd me-1"></i>${servidorNome}</span>` : ''}
                </div>
                <span class="cliente-data">
                  <i class="bi bi-calendar3 me-1"></i>Adesão: ${dataAdesao}
                </span>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;

        // Bind eventos de remover
        bindEventosRemover();
      }

      // Variáveis para o modal de confirmação
      let clienteParaRemover = null;
      let btnClienteParaRemover = null;
      const modalConfirmarRemocao = new bootstrap.Modal(document.getElementById('modal-confirmar-remocao'));

      function bindEventosRemover() {
        document.querySelectorAll('.btn-remover-cliente').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            clienteParaRemover = this.dataset.id;
            btnClienteParaRemover = this;

            // Atualizar nome no modal
            document.getElementById('nome-cliente-remover').textContent = `"${this.dataset.nome}"?`;

            // Exibir modal de confirmação
            modalConfirmarRemocao.show();
          });
        });
      }

      // Handler para confirmar remoção
      document.getElementById('btn-confirmar-remocao').addEventListener('click', function() {
        if (clienteParaRemover && btnClienteParaRemover) {
          modalConfirmarRemocao.hide();
          removerCliente(clienteParaRemover, btnClienteParaRemover);
        }
      });

      async function removerCliente(clienteId, btnElement) {
        const itemElement = btnElement.closest('.cliente-item');

        // Desabilitar botão e mostrar loading
        btnElement.disabled = true;
        btnElement.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
          const response = await fetch(`/api/clientes/${clienteId}/remover/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();

          if (data.success) {
            // Animação de remoção
            itemElement.style.transition = 'all 0.3s ease';
            itemElement.style.opacity = '0';
            itemElement.style.transform = 'translateX(-20px)';

            setTimeout(() => {
              itemElement.remove();
              // Atualizar contador
              const total = document.querySelectorAll('.cliente-item').length;
              document.getElementById('contador-clientes').innerHTML =
                `<i class="bi bi-people me-1"></i>${total} cliente${total !== 1 ? 's' : ''}`;

              // Atualizar array local
              todosClientes = todosClientes.filter(c => c.id != clienteId);

              // Mostrar mensagem se lista ficou vazia
              if (total === 0) {
                document.getElementById('lista-todos-clientes').innerHTML = `
                  <div class="text-center py-5 text-muted">
                    <i class="bi bi-people fs-1 d-block mb-3 opacity-50"></i>
                    <p class="mb-1 fw-semibold">Nenhum cliente cadastrado</p>
                  </div>
                `;
              }
            }, 300);
          } else {
            alert(data.error || 'Erro ao remover cliente');
            btnElement.disabled = false;
            btnElement.innerHTML = '<i class="bi bi-trash"></i>';
          }
        } catch (error) {
          console.error('Erro ao remover cliente:', error);
          alert('Erro ao remover cliente. Tente novamente.');
          btnElement.disabled = false;
          btnElement.innerHTML = '<i class="bi bi-trash"></i>';
        }
      }

      // Pesquisa em tempo real
      const inputPesquisa = document.getElementById('pesquisa-clientes');
      if (inputPesquisa) {
        inputPesquisa.addEventListener('input', function() {
          const termo = this.value.toLowerCase().trim();
          if (!termo) {
            renderizarClientes(todosClientes);
            return;
          }
          const filtrados = todosClientes.filter(c =>
            c.nome.toLowerCase().includes(termo) ||
            c.telefone.includes(termo)
          );
          renderizarClientes(filtrados);
        });
      }
    });
  </script>

</body>
</html>
