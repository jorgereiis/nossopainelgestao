{% load static %}

<!DOCTYPE html>
<html lang="pt-BR">

<head>
  {% include 'partials/head.html' %}
  <title>Formas de Pagamento | Nosso Painel - Gestao IPTV</title>
  <style>
    /* Cards de Instituicao */
    .instituicao-card {
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
    }
    .instituicao-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }
    .instituicao-card.selected {
      border-color: #0d6efd;
      box-shadow: 0 0 0 4px rgba(13,110,253,0.15);
    }
    .instituicao-card .card-body {
      padding: 1.5rem;
    }
    .instituicao-logo {
      width: 80px;
      height: 80px;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .instituicao-logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .instituicao-logo i {
      font-size: 2rem;
    }
    .badge-api {
      font-size: 0.65rem;
      padding: 0.35em 0.65em;
    }

    /* Form Container */
    .form-container {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 20px;
      padding: 2rem;
    }
    .form-section {
      background: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    }
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e9ecef;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .section-title i {
      color: #0d6efd;
    }

    /* Tipo Pagamento Pills */
    .tipo-pagamento-pills {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .tipo-pagamento-pill {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      border: 2px solid #dee2e6;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
    }
    .tipo-pagamento-pill:hover {
      border-color: #0d6efd;
      background: #f8f9ff;
    }
    .tipo-pagamento-pill.selected {
      border-color: #0d6efd;
      background: #0d6efd;
      color: #fff;
    }
    .tipo-pagamento-pill.selected i {
      color: #fff;
    }
    .tipo-pagamento-pill input {
      display: none;
    }

    /* Steps Indicator */
    .steps-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
    }
    .step {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #adb5bd;
      font-weight: 500;
    }
    .step.active {
      color: #0d6efd;
    }
    .step.completed {
      color: #198754;
    }
    .step-number {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      background: #e9ecef;
    }
    .step.active .step-number {
      background: #0d6efd;
      color: #fff;
    }
    .step.completed .step-number {
      background: #198754;
      color: #fff;
    }
    .step-connector {
      width: 60px;
      height: 2px;
      background: #e9ecef;
      margin: 0 1rem;
    }
    .step-connector.completed {
      background: #198754;
    }

    /* Table Styles */
    .formas-table {
      border-radius: 12px;
      overflow: hidden;
    }
    .formas-table .table {
      margin-bottom: 0;
    }
    .formas-table th {
      background: #f8f9fa;
      font-weight: 600;
      border-bottom: 2px solid #e9ecef;
    }
    .instituicao-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .instituicao-badge.fastdepix {
      background: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
      color: #fff;
    }
    .instituicao-badge.mercado-pago {
      background: linear-gradient(135deg, #009ee3 0%, #0077b6 100%);
      color: #fff;
    }
    .instituicao-badge.efi-bank {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: #fff;
    }
    .instituicao-badge.manual {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: #fff;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      color: #dee2e6;
      margin-bottom: 1rem;
    }

    /* Animations */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Alert customizado por instituicao */
    .alert-instituicao {
      border: none;
      border-radius: 12px;
      border-left: 4px solid;
      transition: all 0.3s ease;
    }
    .alert-instituicao.fastdepix {
      background: linear-gradient(135deg, #e6faf8 0%, #c5f0ec 100%);
      border-left-color: #4ECDC4;
      color: #1a5c57;
    }
    .alert-instituicao.mercado_pago {
      background: linear-gradient(135deg, #e6f3fb 0%, #cce5f7 100%);
      border-left-color: #009ee3;
      color: #0a4d6e;
    }
    .alert-instituicao.efi_bank {
      background: linear-gradient(135deg, #fef3eb 0%, #fde4d4 100%);
      border-left-color: #F37021;
      color: #7a3810;
    }
    .alert-instituicao.manual {
      background: linear-gradient(135deg, #f1f3f5 0%, #e1e4e8 100%);
      border-left-color: #6c757d;
      color: #495057;
    }

    /* Loading dots animation for buttons */
    .loading-dots {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .loading-dots span {
      width: 8px;
      height: 8px;
      background-color: #fff;
      border-radius: 50%;
      animation: wave 1.2s ease-in-out infinite;
    }
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes wave {
      0%, 60%, 100% {
        transform: translateY(0);
      }
      30% {
        transform: translateY(-8px);
      }
    }

    /* Cards de Tipo de Cobranca FastDePix */
    .tipo-cobranca-card {
      display: block;
      position: relative;
      padding: 1.25rem;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      background: #fff;
      height: 100%;
    }
    .tipo-cobranca-card:hover {
      border-color: #adb5bd;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transform: translateY(-2px);
    }
    .tipo-cobranca-card.recomendado {
      border-color: #198754;
      background: linear-gradient(135deg, rgba(25,135,84,0.03) 0%, rgba(25,135,84,0.08) 100%);
    }
    .tipo-cobranca-radio {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .tipo-cobranca-card:has(.tipo-cobranca-radio:checked) {
      border-color: #0d6efd;
      background: linear-gradient(135deg, rgba(13,110,253,0.03) 0%, rgba(13,110,253,0.08) 100%);
      box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
    }
    .tipo-cobranca-card.recomendado:has(.tipo-cobranca-radio:checked) {
      border-color: #198754;
      background: linear-gradient(135deg, rgba(25,135,84,0.05) 0%, rgba(25,135,84,0.12) 100%);
      box-shadow: 0 0 0 3px rgba(25,135,84,0.2);
    }
    .tipo-cobranca-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 0.75rem;
    }
    .tipo-cobranca-badge {
      position: absolute;
      top: -10px;
      right: 12px;
      background: #198754;
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tipo-cobranca-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: #6c757d;
      transition: all 0.2s ease;
    }
    .tipo-cobranca-card:has(.tipo-cobranca-radio:checked) .tipo-cobranca-icon {
      background: #0d6efd;
      color: white;
    }
    .tipo-cobranca-card.recomendado:has(.tipo-cobranca-radio:checked) .tipo-cobranca-icon {
      background: #198754;
      color: white;
    }
    .tipo-cobranca-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .tipo-cobranca-titulo {
      font-weight: 600;
      font-size: 1rem;
      color: #212529;
    }
    .tipo-cobranca-desc {
      font-size: 0.8rem;
      color: #6c757d;
      line-height: 1.4;
    }
    .tipo-cobranca-check {
      position: absolute;
      top: 12px;
      left: 12px;
      font-size: 1.25rem;
      color: #0d6efd;
      opacity: 0;
      transform: scale(0.5);
      transition: all 0.2s ease;
    }
    .tipo-cobranca-card.recomendado .tipo-cobranca-check {
      color: #198754;
    }
    .tipo-cobranca-card:has(.tipo-cobranca-radio:checked) .tipo-cobranca-check {
      opacity: 1;
      transform: scale(1);
    }

    /* Card Premium - Painel do Cliente */
    .tipo-cobranca-card.premium {
      border: 2px solid #ffc107;
      background: linear-gradient(135deg, rgba(255,193,7,0.05) 0%, rgba(255,193,7,0.12) 100%);
      position: relative;
      overflow: visible;
    }
    .tipo-cobranca-card.premium::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #ffc107, #ffdb4d, #ffc107);
      border-radius: 10px 10px 0 0;
    }
    .tipo-cobranca-card.premium:hover {
      border-color: #e0a800;
      box-shadow: 0 8px 24px rgba(255,193,7,0.25);
    }
    .tipo-cobranca-card.premium:has(.tipo-cobranca-radio:checked) {
      border-color: #ffc107;
      box-shadow: 0 0 0 3px rgba(255,193,7,0.3), 0 8px 24px rgba(255,193,7,0.2);
    }
    .tipo-cobranca-content-premium {
      padding: 0.5rem;
    }
    .tipo-cobranca-badge-premium {
      position: absolute;
      top: -12px;
      left: 20px;
      background: linear-gradient(135deg, #ffc107 0%, #ffdb4d 100%);
      color: #212529;
      font-size: 0.75rem;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(255,193,7,0.4);
    }
    .tipo-cobranca-icon-premium {
      width: 64px;
      height: 64px;
      min-width: 64px;
      border-radius: 16px;
      background: linear-gradient(135deg, #ffc107 0%, #ffdb4d 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      color: #212529;
    }
    .tipo-cobranca-info-premium {
      flex: 1;
    }
    .tipo-cobranca-titulo-premium {
      font-weight: 700;
      font-size: 1.15rem;
      color: #212529;
      display: block;
    }
    .tipo-cobranca-subtitulo {
      font-size: 0.85rem;
      color: #6c757d;
      display: block;
      margin-bottom: 0.5rem;
    }
    .tipo-cobranca-features {
      list-style: none;
      padding: 0;
      margin: 0;
      font-size: 0.8rem;
      color: #495057;
    }
    .tipo-cobranca-features li {
      margin-bottom: 0.25rem;
    }
    .tipo-cobranca-card.premium .tipo-cobranca-check {
      color: #ffc107;
    }

    /* Limitacoes nas opcoes basicas */
    .tipo-cobranca-limitacao {
      display: block;
      font-size: 0.7rem;
      color: #dc3545;
      margin-top: 0.5rem;
      padding: 4px 8px;
      background: rgba(220,53,69,0.1);
      border-radius: 4px;
    }

    /* Cards desabilitados */
    .tipo-cobranca-card.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      pointer-events: none;
      filter: grayscale(40%);
    }
    .tipo-cobranca-card.disabled:hover {
      transform: none;
      box-shadow: none;
    }
    .tipo-cobranca-badge-disabled {
      position: absolute;
      top: -10px;
      right: 12px;
      background: #6c757d;
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>

<body class="bg-light">
  <div id="db-wrapper">
    <!-- navbar vertical -->
    {% include 'partials/navbar-vertical.html' %}
    <!-- page content -->
    <div id="page-content">
      {% include 'partials/header.html' %}
      <!-- Container fluid -->
      <div class="container-fluid p-6">

        <!-- Page Header -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h2 class="mb-1 fw-bold">Formas de Pagamento</h2>
                <p class="text-muted mb-0">Configure suas formas de pagamento e integracoes bancarias</p>
              </div>
              {% if request.user.is_staff %}
              <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalInstituicoes">
                  <i class="bi bi-gear me-2"></i>Gerenciar Instituicoes
                </button>
                <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalLimites">
                  <i class="bi bi-speedometer2 me-2"></i>Gerenciar Limites
                </button>
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Alertas FastDePix -->
        {% if alertas_fastdepix.tem_alertas %}
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-warning">
              <div class="card-header bg-warning bg-opacity-10 border-bottom-0">
                <h5 class="card-title mb-0 text-warning">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  Alertas de Configuracao FastDePix
                </h5>
              </div>
              <div class="card-body">
                {% if alertas_fastdepix.planos_sem_link %}
                <div class="alert alert-danger mb-3">
                  <h6 class="alert-heading">
                    <i class="bi bi-x-circle me-2"></i>
                    Planos sem Link de Pagamento
                  </h6>
                  <p class="mb-2">Os seguintes planos nao possuem link FastDePix configurado:</p>
                  <ul class="mb-0">
                    {% for item in alertas_fastdepix.planos_sem_link %}
                    <li>
                      <strong>{{ item.plano_nome }}</strong> - R$ {{ item.plano_valor|floatformat:2 }}
                      <small class="text-muted">(Conta: {{ item.conta_nome }})</small>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}

                {% if alertas_fastdepix.planos_valor_divergente %}
                <div class="alert alert-warning mb-0">
                  <h6 class="alert-heading">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    Planos com Valor Alterado
                  </h6>
                  <p class="mb-2">Os seguintes planos tiveram o valor alterado. Verifique se o link de pagamento esta com o valor correto:</p>
                  <ul class="mb-0">
                    {% for item in alertas_fastdepix.planos_valor_divergente %}
                    <li>
                      <strong>{{ item.plano_nome }}</strong>:
                      <span class="text-decoration-line-through text-muted">R$ {{ item.valor_configurado|floatformat:2 }}</span>
                      <i class="bi bi-arrow-right mx-1"></i>
                      <span class="text-success fw-bold">R$ {{ item.valor_atual|floatformat:2 }}</span>
                      <small class="text-muted">(Conta: {{ item.conta_nome }})</small>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}

                <div class="mt-3">
                  <p class="text-muted mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    Para resolver, edite a Forma de Pagamento FastDePix correspondente e atualize os links.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="row">
          <!-- Coluna do Formulario -->
          <div class="col-xl-7 col-lg-8 col-md-12 mb-4">
            <div class="form-container">
              <!-- Steps Indicator -->
              <div class="steps-indicator">
                <div class="step active" id="step1-indicator">
                  <span class="step-number">1</span>
                  <span class="d-none d-sm-inline">Instituicao</span>
                </div>
                <div class="step-connector"></div>
                <div class="step" id="step2-indicator">
                  <span class="step-number">2</span>
                  <span class="d-none d-sm-inline">Configuracao</span>
                </div>
              </div>

              <form method="POST" id="formCadastroFormaPgto" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- STEP 1: Selecao de Instituicao -->
                <div id="step1" class="fade-in">
                  <div class="form-section">
                    <h5 class="section-title">
                      <i class="bi bi-bank2"></i>
                      Selecione a Instituicao Bancaria
                    </h5>

                    <div class="row g-3">
                      {% for inst in instituicoes %}
                      <div class="col-md-6">
                        <div class="instituicao-card h-100" data-instituicao="{{ inst.tipo_integracao }}" data-nome="{{ inst.nome }}">
                          <div class="card-body text-center">
                            <div class="instituicao-logo {% if inst.tipo_integracao == 'mercado_pago' or inst.tipo_integracao == 'manual' %}bg-light{% endif %} mx-auto">
                              {% if inst.tipo_integracao == 'fastdepix' %}
                                <img src="{% static 'assets/images/logo-apps/depix-logo.jpeg' %}" alt="{{ inst.nome }}" class="img-fluid rounded">
                              {% elif inst.tipo_integracao == 'mercado_pago' %}
                                <img src="{% static 'assets/images/logo-apps/mercadopago-logo.png' %}" alt="{{ inst.nome }}" class="img-fluid rounded" style="opacity: 0.85;">
                              {% elif inst.tipo_integracao == 'efi_bank' %}
                                <img src="{% static 'assets/images/logo-apps/efibank-logo.png' %}" alt="{{ inst.nome }}" class="img-fluid rounded">
                              {% else %}
                                <img src="{% static 'assets/images/logo-apps/default.png' %}" alt="{{ inst.nome }}" class="img-fluid" style="opacity: 0.7;">
                              {% endif %}
                            </div>
                            <h6 class="fw-bold mb-1">{{ inst.nome }}</h6>
                            <p class="text-muted small mb-2">
                              {% if inst.tipo_integracao == 'fastdepix' %}PIX e Stablecoin
                              {% elif inst.tipo_integracao == 'mercado_pago' %}PIX, Cartao, Boleto
                              {% elif inst.tipo_integracao == 'efi_bank' %}PIX, Cartao, Boleto
                              {% else %}Cadastro manual
                              {% endif %}
                            </p>
                            {% if inst.tipo_integracao == 'fastdepix' %}
                              <span class="badge badge-api" style="background-color: #4ECDC4; color: #fff;">API Integrada</span>
                            {% elif inst.tipo_integracao == 'mercado_pago' %}
                              <span class="badge bg-info badge-api">API Integrada</span>
                            {% elif inst.tipo_integracao == 'efi_bank' %}
                              <span class="badge badge-api" style="background-color: #F37021; color: #fff;">API Integrada</span>
                            {% else %}
                              <span class="badge bg-secondary badge-api">Sem API</span>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                      {% empty %}
                      <div class="col-12">
                        <div class="alert alert-warning text-center">
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          Nenhuma instituicao bancaria ativa. Ative pelo menos uma no menu "Gerenciar Instituicoes".
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>

                <!-- STEP 2: Configuracao -->
                <div id="step2" class="d-none fade-in">
                  <!-- Voltar -->
                  <button type="button" class="btn btn-link text-muted mb-3 p-0" id="btnVoltar">
                    <i class="bi bi-arrow-left me-2"></i>Voltar para selecao
                  </button>

                  <!-- Header da Instituicao Selecionada -->
                  <div class="alert alert-instituicao mb-4" id="alertInstituicao">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-gear me-2" id="iconInstituicao"></i>
                      <span>Configurando: <strong id="nomeInstituicaoSelecionada"></strong></span>
                    </div>
                  </div>

                  <!-- Tipo de Pagamento -->
                  <div class="form-section">
                    <h5 class="section-title">
                      <i class="bi bi-wallet2"></i>
                      Tipo de Pagamento
                    </h5>

                    <div class="tipo-pagamento-pills" id="tiposPagamento">
                      <!-- PIX sempre disponivel -->
                      <label class="tipo-pagamento-pill selected">
                        <input type="radio" name="nome" value="PIX" checked>
                        <img src="{% static 'assets/images/svg/pix.png' %}" width="20" height="20" alt="PIX">
                        <span>PIX</span>
                      </label>
                      <!-- Cartao (apenas MP e Efi) -->
                      <label class="tipo-pagamento-pill d-none" id="pillCartao">
                        <input type="radio" name="nome" value="Cartao de Credito">
                        <i class="bi bi-credit-card text-warning"></i>
                        <span>Cartao</span>
                      </label>
                      <!-- Boleto (apenas MP e Efi) -->
                      <label class="tipo-pagamento-pill d-none" id="pillBoleto">
                        <input type="radio" name="nome" value="Boleto">
                        <i class="bi bi-upc-scan text-danger"></i>
                        <span>Boleto</span>
                      </label>
                    </div>
                  </div>

                  <!-- Configurações - Outras Instituições (Manual) -->
                  <div class="form-section d-none" id="camposManual">
                    <h5 class="section-title">
                      <i class="bi bi-gear"></i>
                      <span id="tituloSecaoConfig">Configurações da Conta</span>
                    </h5>

                    <!-- Campos de configuração -->
                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome de Identificação <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeIdentificacao" name="nome_identificacao"
                               placeholder="Ex: Minha conta principal">
                        <small class="text-muted">Apelido para identificar esta configuração</small>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Conta <span class="text-danger">*</span></label>
                        <select class="form-select tipo-conta-select" id="tipoContaManual" data-instituicao="manual">
                          <option value="" disabled selected>Selecione o tipo de conta</option>
                          <option value="pf">Pessoa Física</option>
                          <option value="mei">MEI</option>
                        </select>
                      </div>
                    </div>

                    <!-- Nome da instituicao manual -->
                    <div class="row g-3 mb-3" id="campoInstituicaoManual">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome da Instituição <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="instituicaoNomeManual" name="instituicao_nome_manual"
                               placeholder="Ex: Nubank, Inter, etc">
                      </div>
                      <div class="col-md-6" id="campoBeneficiario">
                        <label class="form-label fw-semibold">Beneficiário <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="beneficiario" name="beneficiario"
                               placeholder="Nome do titular da conta">
                      </div>
                    </div>

                    <!-- Campos PIX -->
                    <div id="camposPix">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Tipo de Chave PIX <span class="text-danger">*</span></label>
                          <select class="form-select" id="tipoChavePix" name="tipo_chave_pix">
                            <option value="" disabled selected>Selecione</option>
                            <option value="cpf">CPF</option>
                            <option value="cnpj">CNPJ</option>
                            <option value="email">E-mail</option>
                            <option value="celular">Celular</option>
                            <option value="aleatoria">Chave Aleatória</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Chave PIX <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="chavePix" name="chave_pix"
                                 placeholder="Digite sua chave PIX">
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Hidden: Instituicao ID e Tipo Integracao -->
                  <input type="hidden" id="instituicaoId" name="instituicao">
                  <input type="hidden" id="tipoIntegracao" name="tipo_integracao">
                  <input type="hidden" id="tipoConta" name="tipo_conta">

                  <!-- Configurações - FastDePix -->
                  <div class="form-section d-none" id="camposFastDePix">
                    <h5 class="section-title">
                      <i class="bi bi-gear"></i>
                      Configurações FastDePix
                    </h5>

                    <!-- Campos de configuração -->
                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome de Identificação <span class="text-danger">*</span></label>
                        <input type="text" class="form-control nome-identificacao-api" id="nomeIdentificacaoFastDePix"
                               placeholder="Ex: Minha conta principal">
                        <small class="text-muted">Apelido para identificar esta configuração</small>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Conta <span class="text-danger">*</span></label>
                        <select class="form-select tipo-conta-select" id="tipoContaFastDePix" data-instituicao="fastdepix">
                          <option value="" disabled selected>Selecione o tipo de conta</option>
                          <option value="pf">Pessoa Física</option>
                        </select>
                        <small class="text-muted">FastDePix opera apenas com Pessoa Física</small>
                      </div>
                    </div>

                    <hr class="my-3">

                    <h6 class="fw-bold mb-3"><i class="bi bi-key me-2 text-warning"></i>Credenciais API</h6>

                    <!-- Toggle: Usar existente ou criar nova -->
                    <div class="btn-group w-100 mb-3" role="group">
                      <input type="radio" class="btn-check" name="modoCredencialFastDePix" id="credencialExistenteFastDePix" value="existente">
                      <label class="btn btn-outline-primary" for="credencialExistenteFastDePix">
                        <i class="bi bi-folder2-open me-2"></i>Usar Credencial Salva
                      </label>
                      <input type="radio" class="btn-check" name="modoCredencialFastDePix" id="credencialNovaFastDePix" value="nova" checked>
                      <label class="btn btn-outline-primary" for="credencialNovaFastDePix">
                        <i class="bi bi-plus-circle me-2"></i>Cadastrar Nova
                      </label>
                    </div>

                    <!-- Lista de credenciais existentes -->
                    <div id="listaCredenciaisFastDePix" class="d-none mb-3">
                      <label class="form-label fw-semibold">Selecione uma credencial</label>
                      <select class="form-select" id="selectCredencialFastDePix" name="credencial_id">
                        <option value="">Carregando...</option>
                      </select>
                      <small class="text-muted">Selecione uma credencial salva anteriormente</small>
                    </div>

                    <!-- Campos para nova credencial -->
                    <div id="camposNovaCredencialFastDePix">
                      <div class="alert alert-warning mb-3">
                        <i class="bi bi-shield-lock me-2"></i>
                        Obtenha sua API Key no <a href="https://fastdepix.space" target="_blank">Painel do FastDePix</a>
                      </div>
                      <div class="row g-3">
                        <div class="col-12">
                          <label class="form-label fw-semibold">API Key <span class="text-danger">*</span></label>
                          <input type="password" class="form-control" id="apiKey" name="api_key"
                                 placeholder="fdpx_xxxxxxxxxxxxx">
                          <small class="text-muted">Formato: fdpx_...</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Configuração de Cobranças - FastDePix -->
                  <div class="form-section d-none" id="configCobrancaFastDePix">
                    <h5 class="section-title">
                      <i class="bi bi-receipt"></i>
                      Configuracao de Cobrancas
                    </h5>

                    <!-- Seleção do tipo de cobrança -->
                    <div class="mb-4">
                      <label class="form-label fw-semibold">Tipo de Cobranca</label>

                      <!-- Opção 1: Painel do Cliente (Premium - Recomendado) -->
                      <div class="mb-3">
                        <label class="tipo-cobranca-card premium" for="tipoCobrancaPainel">
                          <input type="radio" name="tipoCobrancaFastDePix" value="painel_cliente"
                                 id="tipoCobrancaPainel" class="tipo-cobranca-radio" checked>
                          <div class="tipo-cobranca-content-premium">
                            <span class="tipo-cobranca-badge-premium">
                              <i class="bi bi-star-fill me-1"></i>Premium
                            </span>
                            <div class="d-flex align-items-start gap-3">
                              <div class="tipo-cobranca-icon-premium">
                                <i class="bi bi-person-badge"></i>
                              </div>
                              <div class="tipo-cobranca-info-premium">
                                <span class="tipo-cobranca-titulo-premium">Painel do Cliente</span>
                                <span class="tipo-cobranca-subtitulo">
                                  Painel exclusivo para o cliente acessar suas mensalidades e realizar pagamentos
                                </span>
                                <ul class="tipo-cobranca-features">
                                  <li><i class="bi bi-check2 text-success me-1"></i>Mensalidade em aberto em destaque</li>
                                  <li><i class="bi bi-check2 text-success me-1"></i>Historico de mensalidades anteriores</li>
                                  <li><i class="bi bi-check2 text-success me-1"></i>Perfil com dados pessoais do cliente</li>
                                </ul>
                              </div>
                            </div>
                            <div class="tipo-cobranca-check">
                              <i class="bi bi-check-circle-fill"></i>
                            </div>
                          </div>
                        </label>
                      </div>

                      <!-- Opções 2 e 3 lado a lado -->
                      <div class="row g-3">
                        <!-- Opção 2: Link FastDePix (Bloqueado) -->
                        <div class="col-md-6">
                          <label class="tipo-cobranca-card disabled" for="tipoCobrancaLink">
                            <input type="radio" name="tipoCobrancaFastDePix" value="link_fastdepix"
                                   id="tipoCobrancaLink" class="tipo-cobranca-radio" disabled>
                            <span class="tipo-cobranca-badge-disabled">Em breve</span>
                            <div class="tipo-cobranca-content">
                              <div class="tipo-cobranca-icon">
                                <i class="bi bi-link-45deg"></i>
                              </div>
                              <div class="tipo-cobranca-info">
                                <span class="tipo-cobranca-titulo">Link FastDePix</span>
                                <span class="tipo-cobranca-desc">
                                  Link personalizado para cada plano, enviado ao cliente.
                                </span>
                                <span class="tipo-cobranca-limitacao">
                                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                  Valores fixos por plano
                                </span>
                              </div>
                              <div class="tipo-cobranca-check">
                                <i class="bi bi-check-circle-fill"></i>
                              </div>
                            </div>
                          </label>
                        </div>

                        <!-- Opção 3: QR Code (Bloqueado) -->
                        <div class="col-md-6">
                          <label class="tipo-cobranca-card disabled" for="tipoCobrancaQrcode">
                            <input type="radio" name="tipoCobrancaFastDePix" value="qrcode"
                                   id="tipoCobrancaQrcode" class="tipo-cobranca-radio" disabled>
                            <span class="tipo-cobranca-badge-disabled">Em breve</span>
                            <div class="tipo-cobranca-content">
                              <div class="tipo-cobranca-icon">
                                <i class="bi bi-qr-code-scan"></i>
                              </div>
                              <div class="tipo-cobranca-info">
                                <span class="tipo-cobranca-titulo">QR Code + Copia e Cola</span>
                                <span class="tipo-cobranca-desc">
                                  Gerado via API no momento do envio da mensagem.
                                </span>
                                <span class="tipo-cobranca-limitacao">
                                  <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                  Valido por 20 minutos
                                </span>
                              </div>
                              <div class="tipo-cobranca-check">
                                <i class="bi bi-check-circle-fill"></i>
                              </div>
                            </div>
                          </label>
                        </div>
                      </div>
                    </div>

                    <!-- Container para links por plano (visível apenas se link_fastdepix) -->
                    <div id="containerLinksPlanos" class="mt-4 d-none">
                      <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Configure um link FastDePix para cada Plano de Adesao cadastrado.
                        Cada plano deve ter seu proprio link com o valor correspondente.
                      </div>

                      <div id="listaLinksPlanos">
                        <!-- Carregado via JavaScript -->
                        <div class="text-center text-muted py-4">
                          <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                          Carregando planos...
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Configurações - Mercado Pago -->
                  <div class="form-section d-none" id="camposMercadoPago">
                    <h5 class="section-title">
                      <i class="bi bi-gear"></i>
                      Configurações Mercado Pago
                    </h5>

                    <!-- Campos de configuração -->
                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome de Identificação <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeIdentificacaoMP"
                               placeholder="Ex: Minha conta principal">
                        <small class="text-muted">Apelido para identificar esta configuração</small>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Conta <span class="text-danger">*</span></label>
                        <select class="form-select tipo-conta-select" id="tipoContaMP" data-instituicao="mercado_pago">
                          <option value="" disabled selected>Selecione o tipo de conta</option>
                          <option value="pf">Pessoa Física</option>
                          <option value="mei">MEI</option>
                        </select>
                      </div>
                    </div>

                    <hr class="my-3">

                    <h6 class="fw-bold mb-3"><i class="bi bi-key me-2 text-warning"></i>Credenciais API</h6>

                    <!-- Toggle: Usar existente ou criar nova -->
                    <div class="btn-group w-100 mb-3" role="group">
                      <input type="radio" class="btn-check" name="modoCredencialMP" id="credencialExistenteMP" value="existente">
                      <label class="btn btn-outline-primary" for="credencialExistenteMP">
                        <i class="bi bi-folder2-open me-2"></i>Usar Credencial Salva
                      </label>
                      <input type="radio" class="btn-check" name="modoCredencialMP" id="credencialNovaMP" value="nova" checked>
                      <label class="btn btn-outline-primary" for="credencialNovaMP">
                        <i class="bi bi-plus-circle me-2"></i>Cadastrar Nova
                      </label>
                    </div>

                    <!-- Lista de credenciais existentes -->
                    <div id="listaCredenciaisMP" class="d-none mb-3">
                      <label class="form-label fw-semibold">Selecione uma credencial</label>
                      <select class="form-select" id="selectCredencialMP" name="credencial_id_mp">
                        <option value="">Carregando...</option>
                      </select>
                      <small class="text-muted">Selecione uma credencial salva anteriormente</small>
                    </div>

                    <!-- Campos para nova credencial -->
                    <div id="camposNovaCredencialMP">
                      <div class="alert alert-warning mb-3">
                        <i class="bi bi-shield-lock me-2"></i>
                        Obtenha suas credenciais em <a href="https://www.mercadopago.com.br/developers" target="_blank">Mercado Pago Developers</a>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Client ID <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="apiClientIdMP" name="api_client_id_mp"
                                 placeholder="Client ID">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Client Secret <span class="text-danger">*</span></label>
                          <input type="password" class="form-control" id="apiClientSecretMP" name="api_client_secret_mp"
                                 placeholder="Client Secret">
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Access Token <span class="text-danger">*</span></label>
                          <input type="password" class="form-control" id="apiAccessToken" name="api_access_token"
                                 placeholder="Access Token">
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Configurações - Efi Bank -->
                  <div class="form-section d-none" id="camposEfiBank">
                    <h5 class="section-title">
                      <i class="bi bi-gear"></i>
                      Configurações Efi Bank
                    </h5>

                    <!-- Campos de configuração -->
                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome de Identificação <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeIdentificacaoEfi"
                               placeholder="Ex: Minha conta principal">
                        <small class="text-muted">Apelido para identificar esta configuração</small>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Conta <span class="text-danger">*</span></label>
                        <select class="form-select tipo-conta-select" id="tipoContaEfi" data-instituicao="efi_bank">
                          <option value="" disabled selected>Selecione o tipo de conta</option>
                          <option value="pf">Pessoa Física</option>
                          <option value="mei">MEI</option>
                        </select>
                      </div>
                    </div>

                    <hr class="my-3">

                    <h6 class="fw-bold mb-3"><i class="bi bi-key me-2 text-warning"></i>Credenciais API</h6>

                    <!-- Toggle: Usar existente ou criar nova -->
                    <div class="btn-group w-100 mb-3" role="group">
                      <input type="radio" class="btn-check" name="modoCredencialEfi" id="credencialExistenteEfi" value="existente">
                      <label class="btn btn-outline-primary" for="credencialExistenteEfi">
                        <i class="bi bi-folder2-open me-2"></i>Usar Credencial Salva
                      </label>
                      <input type="radio" class="btn-check" name="modoCredencialEfi" id="credencialNovaEfi" value="nova" checked>
                      <label class="btn btn-outline-primary" for="credencialNovaEfi">
                        <i class="bi bi-plus-circle me-2"></i>Cadastrar Nova
                      </label>
                    </div>

                    <!-- Lista de credenciais existentes -->
                    <div id="listaCredenciaisEfi" class="d-none mb-3">
                      <label class="form-label fw-semibold">Selecione uma credencial</label>
                      <select class="form-select" id="selectCredencialEfi" name="credencial_id_efi">
                        <option value="">Carregando...</option>
                      </select>
                      <small class="text-muted">Selecione uma credencial salva anteriormente</small>
                    </div>

                    <!-- Campos para nova credencial -->
                    <div id="camposNovaCredencialEfi">
                      <div class="alert alert-warning mb-3">
                        <i class="bi bi-shield-lock me-2"></i>
                        Obtenha suas credenciais em <a href="https://dev.efipay.com.br" target="_blank">Efi Pay Developers</a>
                      </div>
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Client ID <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" id="apiClientIdEfi" name="api_client_id_efi"
                                 placeholder="Client ID">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label fw-semibold">Client Secret <span class="text-danger">*</span></label>
                          <input type="password" class="form-control" id="apiClientSecretEfi" name="api_client_secret_efi"
                                 placeholder="Client Secret">
                        </div>
                        <div class="col-12">
                          <label class="form-label fw-semibold">Certificado (.p12) <span class="text-danger">*</span></label>
                          <input type="file" class="form-control" id="apiCertificado" name="api_certificado" accept=".p12">
                          <small class="text-muted">Certificado de producao ou homologacao (.p12)</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Clientes Associados (visivel apos selecionar Tipo de Conta) -->
                  <div class="form-section d-none" id="secaoClientesAssociados">
                    <h5 class="section-title">
                      <i class="bi bi-people"></i>
                      Clientes Associados
                    </h5>
                    <p class="text-muted small mb-3">
                      Selecione os clientes que terão suas cobranças direcionadas para esta forma de pagamento.
                    </p>

                    <!-- Resumo para MEI (com Limite) - visível apenas para MEI -->
                    <div class="alert alert-info mb-3 d-none" id="alertLimiteMei">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                          <strong><i class="bi bi-speedometer2 me-1"></i>Limite Anual MEI:</strong>
                          <span id="limiteTotalDisplay">R$ 81.000,00</span>
                        </div>
                        <div>
                          <strong>Utilizado:</strong>
                          <span id="valorSelecionadoDisplayMei">R$ 0,00</span>
                          (<span id="percentualSelecionadoMei">0</span>%)
                        </div>
                      </div>
                      <!-- Slider Interativo para MEI -->
                      <div class="slider-container position-relative">
                        <input type="range" class="form-range slider-clientes" id="sliderClientesMei"
                               min="0" max="99" value="0" step="1"
                               style="height: 20px; cursor: grab;">
                        <div class="d-flex justify-content-between mt-1">
                          <small class="text-muted">0%</small>
                          <small class="text-muted fw-semibold" id="sliderValueDisplayMei">Arraste para selecionar clientes</small>
                          <small class="text-muted">99%</small>
                        </div>
                      </div>
                    </div>

                    <!-- Resumo para Pessoa Física (sem Limite) - visível apenas para PF -->
                    <div class="alert alert-success mb-3 d-none" id="alertPessoaFisica">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                          <strong><i class="bi bi-person-check me-1"></i>Pessoa Física</strong>
                          <small class="text-muted ms-2">(sem limite de valores)</small>
                        </div>
                        <div>
                          <strong>Total Selecionado:</strong>
                          <span id="valorSelecionadoDisplayPf">R$ 0,00</span>
                        </div>
                      </div>
                      <!-- Slider Interativo para PF (baseado em quantidade, não valor) -->
                      <div class="slider-container position-relative">
                        <input type="range" class="form-range slider-clientes-pf" id="sliderClientesPf"
                               min="0" max="100" value="0" step="1"
                               style="height: 20px; cursor: grab;">
                        <div class="d-flex justify-content-between mt-1">
                          <small class="text-muted">0%</small>
                          <small class="text-muted fw-semibold" id="sliderValueDisplayPf">Arraste para selecionar clientes</small>
                          <small class="text-muted">100%</small>
                        </div>
                      </div>
                    </div>

                    <!-- Estilos dos sliders e tabela -->
                    <style>
                      .slider-clientes, .slider-clientes-pf {
                        -webkit-appearance: none;
                        width: 100%;
                        height: 12px;
                        border-radius: 6px;
                        background: linear-gradient(to right, #0d6efd 0%, #e9ecef 0%);
                        outline: none;
                        transition: background 0.15s ease;
                      }
                      .slider-clientes::-webkit-slider-thumb, .slider-clientes-pf::-webkit-slider-thumb {
                        -webkit-appearance: none;
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: #0d6efd;
                        cursor: grab;
                        border: 3px solid #fff;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                        transition: transform 0.15s ease, box-shadow 0.15s ease;
                      }
                      .slider-clientes::-webkit-slider-thumb:hover, .slider-clientes-pf::-webkit-slider-thumb:hover {
                        transform: scale(1.1);
                        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                      }
                      .slider-clientes::-webkit-slider-thumb:active, .slider-clientes-pf::-webkit-slider-thumb:active {
                        cursor: grabbing;
                        transform: scale(1.15);
                      }
                      .slider-clientes::-moz-range-thumb, .slider-clientes-pf::-moz-range-thumb {
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        background: #0d6efd;
                        cursor: grab;
                        border: 3px solid #fff;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                      }
                      /* Slider PF usa cor verde (success) */
                      .slider-clientes-pf {
                        background: linear-gradient(to right, #198754 0%, #e9ecef 0%);
                      }
                      .slider-clientes-pf::-webkit-slider-thumb {
                        background: #198754;
                      }
                      .slider-clientes-pf::-moz-range-thumb {
                        background: #198754;
                      }
                      /* Cores de alerta para MEI */
                      .slider-clientes.slider-warning {
                        background: linear-gradient(to right, #ffc107 var(--slider-percent), #e9ecef var(--slider-percent));
                      }
                      .slider-clientes.slider-warning::-webkit-slider-thumb {
                        background: #ffc107;
                      }
                      .slider-clientes.slider-danger {
                        background: linear-gradient(to right, #dc3545 var(--slider-percent), #e9ecef var(--slider-percent));
                      }
                      .slider-clientes.slider-danger::-webkit-slider-thumb {
                        background: #dc3545;
                      }
                      /* Highlight de linhas selecionadas */
                      #listaClientesAssociacao tr {
                        transition: background-color 0.15s ease;
                      }
                      #listaClientesAssociacao tr:hover {
                        background-color: rgba(13, 110, 253, 0.08);
                      }
                      #listaClientesAssociacao tr.selected {
                        background-color: rgba(25, 135, 84, 0.12);
                      }
                      #listaClientesAssociacao tr.selected:hover {
                        background-color: rgba(25, 135, 84, 0.18);
                      }
                      /* Linhas bloqueadas (cliente já associado a outra conta) */
                      #listaClientesAssociacao tr.blocked-row {
                        background-color: rgba(108, 117, 125, 0.08);
                        opacity: 0.7;
                        cursor: not-allowed !important;
                      }
                      #listaClientesAssociacao tr.blocked-row:hover {
                        background-color: rgba(108, 117, 125, 0.12);
                      }
                      #listaClientesAssociacao tr.blocked-row .checkbox-cliente {
                        cursor: not-allowed;
                      }
                      /* Linhas marcadas para transferência */
                      #listaClientesAssociacao tr.transferencia-pendente {
                        background-color: rgba(13, 110, 253, 0.1) !important;
                        border-left: 3px solid #0d6efd;
                      }
                      #listaClientesAssociacao tr.transferencia-pendente:hover {
                        background-color: rgba(13, 110, 253, 0.15) !important;
                      }
                    </style>

                    <!-- Barra de Busca -->
                    <div class="input-group mb-3">
                      <span class="input-group-text"><i class="bi bi-search"></i></span>
                      <input type="text" class="form-control" id="buscaCliente" placeholder="Buscar cliente por nome...">
                    </div>

                    <!-- Lista de Clientes -->
                    <div class="cliente-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                      <table class="table table-hover table-sm mb-0">
                        <thead class="sticky-top bg-light">
                          <tr>
                            <th style="width: 40px;">
                              <input type="checkbox" class="form-check-input" id="selectAllClientes" title="Selecionar todos">
                            </th>
                            <th style="width: 80px;" class="text-center">Status</th>
                            <th>Cliente</th>
                            <th>Plano</th>
                            <th class="text-end">Valor Anual</th>
                          </tr>
                        </thead>
                        <tbody id="listaClientesAssociacao">
                          <tr>
                            <td colspan="5" class="text-center text-muted py-4">
                              <i class="bi bi-hourglass-split me-2"></i>Carregando clientes...
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Resumo de Selecao -->
                    <div class="card bg-light mt-3">
                      <div class="card-body py-2">
                        <div class="d-flex justify-content-center text-center gap-4 flex-wrap">
                          <div class="px-3">
                            <small class="text-muted d-block">Selecionados</small>
                            <strong id="totalClientesSelecionados">0</strong>
                          </div>
                          <div class="px-3">
                            <small class="text-muted d-block">Valor Anual</small>
                            <strong id="valorAnualTotal">R$ 0,00</strong>
                          </div>
                          <div class="px-3 d-none" id="colDisponivelCriacao">
                            <small class="text-muted d-block">Disponivel</small>
                            <strong id="valorDisponivelDisplay">R$ 81.000,00</strong>
                          </div>
                          <div class="px-3 d-none" id="colTransferencias">
                            <small class="text-primary d-block"><i class="bi bi-arrow-right-circle me-1"></i>Transferencias</small>
                            <strong class="text-primary" id="totalTransferencias">0</strong>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Campo hidden para IDs dos clientes selecionados -->
                    <input type="hidden" id="clientesAssociados" name="clientes_associados">
                    <!-- Campo hidden para IDs dos clientes a serem transferidos de outras contas -->
                    <input type="hidden" id="clientesParaTransferir" name="clientes_para_transferir">
                  </div>

                  <!-- Botao Submit -->
                  <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" name="cadastrar">
                      <i class="bi bi-check-circle me-2"></i>Cadastrar Forma de Pagamento
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Coluna da Lista -->
          <div class="col-xl-5 col-lg-4 col-md-12">
            <!-- Alerta: Clientes sem Forma de Pagamento -->
            {% if clientes_sem_forma_pgto > 0 %}
            <div class="alert alert-danger d-flex align-items-start mb-3 shadow-sm" role="alert">
              <i class="bi bi-exclamation-triangle-fill fs-4 me-3 mt-1"></i>
              <div>
                <h6 class="alert-heading mb-1 fw-bold">Atenção: Clientes sem Forma de Pagamento</h6>
                <p class="mb-1">
                  <strong>{{ clientes_sem_forma_pgto }}</strong> cliente(s) ativo(s) não estão associados a nenhuma forma de pagamento.
                </p>
                <small class="text-muted">
                  <i class="bi bi-info-circle me-1"></i>
                  Esses clientes não receberão notificações automáticas sobre vencimentos e pagamentos.
                </small>
              </div>
            </div>
            {% endif %}

            <div class="card border-0 shadow-sm formas-table">
              <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">
                  <i class="bi bi-list-ul me-2 text-primary"></i>Cadastros Existentes
                </h5>
              </div>
              <div class="card-body p-0">
                {% if formas_pgto %}
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th class="ps-4">Forma de Pagamento</th>
                        <th>Instituicao</th>
                        <th class="text-center" style="width: 100px;">Clientes</th>
                        <th class="text-center" style="width: 60px;">Acoes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for forma_pgto in formas_pgto %}
                      <tr>
                        <td class="ps-4">
                          <div class="d-flex align-items-center">
                            {% if 'PIX' in forma_pgto.nome|upper %}
                              <img src="{% static 'assets/images/svg/pix.png' %}" width="28" height="28" class="me-2">
                            {% elif 'CART' in forma_pgto.nome|upper %}
                              <i class="bi bi-credit-card text-warning me-2" style="font-size: 1.5rem;"></i>
                            {% elif 'BOLETO' in forma_pgto.nome|upper %}
                              <i class="bi bi-upc-scan text-danger me-2" style="font-size: 1.5rem;"></i>
                            {% else %}
                              <i class="bi bi-wallet2 text-success me-2" style="font-size: 1.5rem;"></i>
                            {% endif %}
                            <div>
                              <span class="fw-semibold">{{ forma_pgto.nome }}</span>
                              {% if forma_pgto.conta_bancaria %}
                              <small class="d-block text-muted">{{ forma_pgto.conta_bancaria.nome_identificacao }}</small>
                              {% elif forma_pgto.nome_identificacao %}
                              <small class="d-block text-muted">{{ forma_pgto.nome_identificacao }}</small>
                              {% endif %}
                            </div>
                          </div>
                        </td>
                        <td>
                          {% if forma_pgto.conta_bancaria %}
                            {% if forma_pgto.conta_bancaria.instituicao.tipo_integracao == 'fastdepix' %}
                              <span class="instituicao-badge fastdepix">
                                <i class="bi bi-lightning-charge-fill"></i>
                                FastDePix
                              </span>
                            {% elif forma_pgto.conta_bancaria.instituicao.tipo_integracao == 'mercado_pago' %}
                              <span class="instituicao-badge mercado-pago">
                                <i class="bi bi-shop"></i>
                                Mercado Pago
                              </span>
                            {% elif forma_pgto.conta_bancaria.instituicao.tipo_integracao == 'efi_bank' %}
                              <span class="instituicao-badge efi-bank">
                                <i class="bi bi-bank"></i>
                                Efi Bank
                              </span>
                            {% else %}
                              <span class="instituicao-badge manual">
                                <i class="bi bi-building"></i>
                                {{ forma_pgto.conta_bancaria.instituicao.nome }}
                              </span>
                            {% endif %}
                          {% elif forma_pgto.dados_bancarios and forma_pgto.dados_bancarios.instituicao %}
                            <span class="instituicao-badge manual">
                              <i class="bi bi-bank"></i>
                              {{ forma_pgto.dados_bancarios.instituicao }}
                            </span>
                          {% else %}
                            <span class="text-muted">-</span>
                          {% endif %}
                        </td>
                        <td class="text-center">
                          <span class="badge bg-primary rounded-pill">{{ forma_pgto.clientes_count|default:0 }}</span>
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-ver-detalhes"
                                    data-id="{{ forma_pgto.id }}"
                                    title="Ver detalhes">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary btn-editar"
                                    data-id="{{ forma_pgto.id }}"
                                    title="Editar">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger"
                                    onclick="confirmarExclusao({{ forma_pgto.id }}, '{{ forma_pgto.nome }}')"
                                    title="Excluir">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <div class="empty-state">
                  <i class="bi bi-inbox"></i>
                  <h6>Nenhum cadastro ainda</h6>
                  <p class="mb-0">Selecione uma instituicao ao lado para comecar</p>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Modals dentro do page-content -->
      <!-- Modal de Confirmacao de Exclusao -->
    <div class="modal fade" id="modalConfirmDelete" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold">
              <i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirmar Exclusao
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>Tem certeza que deseja excluir a forma de pagamento <strong id="nomeFormaPgtoExcluir"></strong>?</p>

            <!-- Alerta de clientes associados -->
            <div class="alert alert-danger d-none" id="alertClientesAssociados">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Atencao!</strong> Esta forma de pagamento possui
              <strong id="qtdClientesAssociados">0</strong> cliente(s) associado(s).
              <br><small>Transfira os clientes para outra forma de pagamento antes de excluir.</small>
            </div>

            <!-- Loading -->
            <div class="text-center d-none" id="loadingClientesCount">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Verificando...</span>
              </div>
              <span class="ms-2 text-muted">Verificando clientes associados...</span>
            </div>

            <p class="text-muted small mb-0" id="avisoExclusao">Esta acao nao pode ser desfeita.</p>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">
              <i class="bi bi-trash me-2"></i>Excluir
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ver Detalhes -->
    <div class="modal fade" id="modalVerDetalhes" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">
              <i class="bi bi-info-circle text-primary me-2"></i>Detalhes da Forma de Pagamento
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Loading -->
            <div id="detalhesLoading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-muted">Carregando...</p>
            </div>

            <!-- Conteudo -->
            <div id="detalhesConteudo" class="d-none">
              <!-- Header com badge da instituicao -->
              <div class="d-flex align-items-center mb-4 p-3 bg-light rounded-3">
                <div id="detalhesIcone" class="me-3"></div>
                <div>
                  <h5 class="mb-1 fw-bold" id="detalhesNome"></h5>
                  <span id="detalhesInstituicaoBadge"></span>
                </div>
              </div>

              <div class="row g-4">
                <!-- Dados da Conta -->
                <div class="col-md-6">
                  <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                      <h6 class="fw-bold mb-3"><i class="bi bi-person me-2 text-primary"></i>Dados da Conta</h6>
                      <div class="mb-2">
                        <small class="text-muted d-block">Nome de Identificacao</small>
                        <span id="detalhesNomeIdentificacao" class="fw-semibold">-</span>
                      </div>
                      <div class="mb-2" id="detalhesBeneficiarioContainer">
                        <small class="text-muted d-block">Beneficiario</small>
                        <span id="detalhesBeneficiario" class="fw-semibold">-</span>
                      </div>
                      <div class="mb-2">
                        <small class="text-muted d-block">Tipo de Conta</small>
                        <span id="detalhesTipoConta" class="fw-semibold">-</span>
                      </div>
                      <div id="detalhesLimiteMeiContainer" class="mb-2 d-none">
                        <small class="text-muted d-block">Limite Mensal (MEI)</small>
                        <span id="detalhesLimiteMei" class="fw-semibold">-</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dados PIX (oculto por padrao, mostrado apenas quando aplicavel) -->
                <div class="col-md-6 d-none" id="detalhesPixContainer">
                  <div class="card h-100 border-0 bg-light">
                    <div class="card-body">
                      <h6 class="fw-bold mb-3"><img src="{% static 'assets/images/svg/pix.png' %}" width="20" class="me-2">Dados PIX</h6>
                      <div class="mb-2">
                        <small class="text-muted d-block">Tipo de Chave</small>
                        <span id="detalhesTipoChavePix" class="fw-semibold">-</span>
                      </div>
                      <div class="mb-2">
                        <small class="text-muted d-block">Chave PIX</small>
                        <span id="detalhesChavePix" class="fw-semibold font-monospace">-</span>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Dados API (oculto por padrao, mostrado apenas para instituicoes com API) -->
                <div class="col-12 d-none" id="detalhesApiContainer">
                  <div class="card border-0 bg-light">
                    <div class="card-body">
                      <h6 class="fw-bold mb-3"><i class="bi bi-key me-2 text-warning"></i>Credenciais API</h6>
                      <div class="row">
                        <div class="col-md-6 mb-2">
                          <small class="text-muted d-block">Integracao</small>
                          <span id="detalhesIntegracao" class="fw-semibold">-</span>
                        </div>
                        <div class="col-md-6 mb-2">
                          <small class="text-muted d-block">Ambiente</small>
                          <span id="detalhesAmbiente" class="fw-semibold">-</span>
                        </div>
                        <div class="col-md-6 mb-2" id="detalhesApiKeyContainer">
                          <small class="text-muted d-block">API Key</small>
                          <span id="detalhesApiKey" class="fw-semibold font-monospace">***configurada***</span>
                        </div>
                        <div class="col-md-6 mb-2" id="detalhesClientIdContainer">
                          <small class="text-muted d-block">Client ID</small>
                          <span id="detalhesClientId" class="fw-semibold font-monospace">***configurado***</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-primary" id="btnEditarFromDetalhes">
              <i class="bi bi-pencil me-2"></i>Editar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Editar Forma de Pagamento -->
    <div class="modal fade" id="modalEditar" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <h5 class="modal-title fw-bold">
              <i class="bi bi-pencil-square text-primary me-2"></i>Editar Forma de Pagamento
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Loading -->
            <div id="editarLoading" class="text-center py-5">
              <div class="spinner-border text-primary" role="status"></div>
              <p class="mt-2 text-muted">Carregando...</p>
            </div>

            <!-- Formulario -->
            <form id="formEditar" class="d-none">
              <input type="hidden" id="editarFormaPgtoId" name="forma_pgto_id">
              <input type="hidden" id="editarContaBancariaId" name="conta_bancaria_id">
              <input type="hidden" id="editarTipoIntegracao" name="tipo_integracao">

              <!-- Header -->
              <div class="alert alert-instituicao mb-4" id="editarAlertInstituicao">
                <div class="d-flex align-items-center">
                  <i class="bi bi-gear me-2"></i>
                  <span>Editando: <strong id="editarNomeInstituicao"></strong></span>
                </div>
              </div>

              <!-- Alerta para formas de pagamento antigas sem conta bancária -->
              <div class="alert alert-warning d-none mb-4" id="editarAlertSemConta">
                <div class="d-flex align-items-start">
                  <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                  <div>
                    <strong>Forma de Pagamento Antiga</strong>
                    <p class="mb-0 small">Esta forma de pagamento foi criada antes da implementacao do novo sistema. Preencha os campos abaixo para atualizar os dados.</p>
                  </div>
                </div>
              </div>

              <!-- Seção Dados Bancarios (para formas antigas) -->
              <div class="d-none mb-4" id="editarDadosBancariosContainer">
                <div class="card border-0 shadow-sm">
                  <div class="card-header bg-light py-3">
                    <h6 class="mb-0 fw-bold">
                      <i class="bi bi-bank me-2 text-success"></i>Dados Bancarios
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <!-- Nome de Identificação -->
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Nome de Identificação <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editarNomeIdentificacaoDados" placeholder="Ex: PIX NuBank, PIX Bradesco...">
                      </div>
                      <!-- Tipo de Conta -->
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Conta</label>
                        <select class="form-select" id="editarTipoContaDados">
                          <option value="pf">Pessoa Física</option>
                          <option value="mei">MEI</option>
                        </select>
                      </div>
                      <!-- Tipo de Pagamento -->
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Tipo de Pagamento</label>
                        <select class="form-select" id="editarTipoPagamento">
                          <option value="PIX">PIX</option>
                          <option value="Cartao de Credito">Cartao de Credito</option>
                          <option value="Boleto">Boleto</option>
                        </select>
                      </div>
                      <!-- Instituição -->
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Instituicao</label>
                        <input type="text" class="form-control" id="editarInstituicaoDados" placeholder="Ex: Banco do Brasil, Nubank...">
                      </div>
                      <!-- Beneficiário (oculto para Boleto/Cartão) -->
                      <div class="col-md-6" id="editarBeneficiarioDadosContainer">
                        <label class="form-label fw-semibold">Beneficiario</label>
                        <input type="text" class="form-control" id="editarBeneficiarioDados" placeholder="Nome do beneficiario">
                      </div>
                      <!-- Tipo de Chave PIX (oculto para Boleto/Cartão) -->
                      <div class="col-md-6" id="editarTipoChaveDadosContainer">
                        <label class="form-label fw-semibold">Tipo de Chave PIX</label>
                        <select class="form-select" id="editarTipoChaveDados">
                          <option value="">Selecione...</option>
                          <option value="CPF">CPF</option>
                          <option value="CNPJ">CNPJ</option>
                          <option value="Email">Email</option>
                          <option value="Celular">Celular</option>
                          <option value="Aleatoria">Chave Aleatoria</option>
                        </select>
                      </div>
                      <!-- Chave PIX (oculto para Boleto/Cartão) -->
                      <div class="col-12" id="editarChavePixDadosContainer">
                        <label class="form-label fw-semibold">Chave PIX</label>
                        <input type="text" class="form-control" id="editarChavePixDados" placeholder="Informe a chave PIX">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row g-3" id="editarCamposContaBancaria">
                <!-- Dados basicos (oculto para formas antigas) -->
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Nome de Identificacao <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="editarNomeIdentificacao" name="nome_identificacao" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label fw-semibold">Tipo de Conta <span class="text-danger">*</span></label>
                  <select class="form-select" id="editarTipoConta" name="tipo_conta">
                    <option value="pf">Pessoa Fisica</option>
                    <option value="mei">MEI</option>
                  </select>
                  <small class="text-muted d-none" id="editarTipoContaHint">FastDePix opera apenas com Pessoa Fisica</small>
                </div>

                <!-- Beneficiario (oculto para APIs) -->
                <div class="col-md-6" id="editarBeneficiarioContainer">
                  <label class="form-label fw-semibold">Beneficiário <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="editarBeneficiario" name="beneficiario">
                </div>

                <!-- Limite MEI (apenas display informativo) -->
                <div class="col-md-6 d-none" id="editarLimiteMeiContainer">
                  <label class="form-label fw-semibold">Limite MEI Configurado</label>
                  <div class="form-control bg-light" id="editarLimiteMeiDisplay">
                    <i class="bi bi-info-circle me-2 text-info"></i>
                    <span id="editarLimiteValor">R$ 81.000,00</span>
                  </div>
                  <small class="text-muted">Limite global configurado pelo administrador</small>
                </div>

                <!-- Dados PIX (oculto para APIs) -->
                <div class="col-12 d-none" id="editarPixContainer">
                  <hr class="my-3">
                  <h6 class="fw-bold mb-3"><img src="{% static 'assets/images/svg/pix.png' %}" width="20" class="me-2">Dados PIX</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label fw-semibold">Tipo de Chave PIX</label>
                      <select class="form-select" id="editarTipoChavePix" name="tipo_chave_pix">
                        <option value="">Selecione</option>
                        <option value="cpf">CPF</option>
                        <option value="cnpj">CNPJ</option>
                        <option value="email">E-mail</option>
                        <option value="celular">Celular</option>
                        <option value="aleatoria">Chave Aleatória</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label fw-semibold">Chave PIX</label>
                      <input type="text" class="form-control" id="editarChavePix" name="chave_pix">
                    </div>
                  </div>
                </div>

                <!-- Credenciais API -->
                <div class="col-12" id="editarApiContainer">
                  <hr class="my-3">
                  <h6 class="fw-bold mb-3"><i class="bi bi-key me-2 text-warning"></i>Credenciais API</h6>

                  <!-- FastDePix -->
                  <div id="editarFastDePixFields" class="d-none">
                    <div class="row g-3">
                      <div class="col-12">
                        <label class="form-label fw-semibold">API Key</label>
                        <input type="password" class="form-control" id="editarApiKey" name="api_key" placeholder="Deixe em branco para manter a atual">
                        <small class="text-muted">Deixe em branco para manter a chave atual</small>
                      </div>
                    </div>
                  </div>

                  <!-- Mercado Pago -->
                  <div id="editarMercadoPagoFields" class="d-none">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Client ID</label>
                        <input type="text" class="form-control" id="editarClientIdMP" name="api_client_id">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Client Secret</label>
                        <input type="password" class="form-control" id="editarClientSecretMP" name="api_client_secret" placeholder="Deixe em branco para manter">
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-semibold">Access Token</label>
                        <input type="password" class="form-control" id="editarAccessTokenMP" name="api_access_token" placeholder="Deixe em branco para manter">
                      </div>
                    </div>
                  </div>

                  <!-- Efi Bank -->
                  <div id="editarEfiBankFields" class="d-none">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Client ID</label>
                        <input type="text" class="form-control" id="editarClientIdEfi" name="api_client_id_efi">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-semibold">Client Secret</label>
                        <input type="password" class="form-control" id="editarClientSecretEfi" name="api_client_secret_efi" placeholder="Deixe em branco para manter">
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-semibold">Novo Certificado (.p12)</label>
                        <input type="file" class="form-control" id="editarCertificado" name="api_certificado" accept=".p12">
                        <small class="text-muted">Deixe em branco para manter o certificado atual</small>
                      </div>
                    </div>
                  </div>

                </div>
              </div>

              <!-- Clientes Associados (para instituições com API e formas antigas) -->
              <div class="row g-3 d-none" id="editarClientesContainer">
                  <hr class="my-3">
                  <h6 class="fw-bold mb-3">
                    <i class="bi bi-people me-2 text-info"></i>Clientes Associados
                    <span class="badge bg-secondary ms-2" id="editarClientesCount">0</span>
                  </h6>
                  <p class="text-muted small mb-3">
                    Selecione os clientes que terão suas cobranças direcionadas para esta forma de pagamento.
                  </p>

                  <!-- Resumo do Limite (MEI) com Slider -->
                  <div class="alert alert-info mb-3 d-none" id="editarAlertLimiteMei">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <strong><i class="bi bi-speedometer2 me-1"></i>Limite Anual MEI:</strong>
                        <span id="editarLimiteTotalDisplay">R$ 81.000,00</span>
                      </div>
                      <div>
                        <strong>Utilizado:</strong>
                        <span id="editarValorUtilizado">R$ 0,00</span>
                        (<span id="editarPercentualUtilizado">0</span>%)
                      </div>
                    </div>
                    <!-- Slider Interativo para MEI -->
                    <div class="slider-container position-relative">
                      <input type="range" class="form-range slider-clientes-editar" id="sliderClientesMeiEditar"
                             min="0" max="99" value="0" step="1"
                             style="height: 20px; cursor: grab;">
                      <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">0%</small>
                        <small class="text-muted fw-semibold" id="sliderValueDisplayMeiEditar">Arraste para selecionar clientes</small>
                        <small class="text-muted">99%</small>
                      </div>
                    </div>
                  </div>

                  <!-- Resumo PF (sem limite) com Slider -->
                  <div class="alert alert-success mb-3 d-none" id="editarAlertPessoaFisica">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <strong><i class="bi bi-person-check me-1"></i>Pessoa Física</strong>
                        <small class="text-muted ms-2">(sem limite de valores)</small>
                      </div>
                      <div>
                        <strong>Total Selecionado:</strong>
                        <span id="editarValorTotalPf">R$ 0,00</span>
                      </div>
                    </div>
                    <!-- Slider Interativo para PF -->
                    <div class="slider-container position-relative">
                      <input type="range" class="form-range slider-clientes-pf-editar" id="sliderClientesPfEditar"
                             min="0" max="100" value="0" step="1"
                             style="height: 20px; cursor: grab;">
                      <div class="d-flex justify-content-between mt-1">
                        <small class="text-muted">0%</small>
                        <small class="text-muted fw-semibold" id="sliderValueDisplayPfEditar">Arraste para selecionar clientes</small>
                        <small class="text-muted">100%</small>
                      </div>
                    </div>
                  </div>

                  <!-- Estilos dos sliders para edição -->
                  <style>
                    .slider-clientes-editar, .slider-clientes-pf-editar {
                      -webkit-appearance: none;
                      width: 100%;
                      height: 12px;
                      border-radius: 6px;
                      background: linear-gradient(to right, #0d6efd 0%, #e9ecef 0%);
                      outline: none;
                      transition: background 0.15s ease;
                    }
                    .slider-clientes-editar::-webkit-slider-thumb, .slider-clientes-pf-editar::-webkit-slider-thumb {
                      -webkit-appearance: none;
                      width: 24px;
                      height: 24px;
                      border-radius: 50%;
                      background: #0d6efd;
                      cursor: grab;
                      border: 3px solid #fff;
                      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                      transition: transform 0.15s ease, box-shadow 0.15s ease;
                    }
                    .slider-clientes-editar::-webkit-slider-thumb:hover, .slider-clientes-pf-editar::-webkit-slider-thumb:hover {
                      transform: scale(1.1);
                      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
                    }
                    .slider-clientes-editar::-webkit-slider-thumb:active, .slider-clientes-pf-editar::-webkit-slider-thumb:active {
                      cursor: grabbing;
                      transform: scale(1.15);
                    }
                    .slider-clientes-editar::-moz-range-thumb, .slider-clientes-pf-editar::-moz-range-thumb {
                      width: 24px;
                      height: 24px;
                      border-radius: 50%;
                      background: #0d6efd;
                      cursor: grab;
                      border: 3px solid #fff;
                      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
                    }
                    .slider-clientes-pf-editar {
                      background: linear-gradient(to right, #198754 0%, #e9ecef 0%);
                    }
                    .slider-clientes-pf-editar::-webkit-slider-thumb {
                      background: #198754;
                    }
                    .slider-clientes-pf-editar::-moz-range-thumb {
                      background: #198754;
                    }
                    .slider-clientes-editar.slider-warning {
                      background: linear-gradient(to right, #ffc107 var(--slider-percent), #e9ecef var(--slider-percent));
                    }
                    .slider-clientes-editar.slider-warning::-webkit-slider-thumb {
                      background: #ffc107;
                    }
                    .slider-clientes-editar.slider-danger {
                      background: linear-gradient(to right, #dc3545 var(--slider-percent), #e9ecef var(--slider-percent));
                    }
                    .slider-clientes-editar.slider-danger::-webkit-slider-thumb {
                      background: #dc3545;
                    }
                    /* Highlight de linhas selecionadas na edição */
                    #editarListaClientes tr {
                      transition: background-color 0.15s ease;
                    }
                    #editarListaClientes tr:hover {
                      background-color: rgba(13, 110, 253, 0.08);
                    }
                    #editarListaClientes tr.selected {
                      background-color: rgba(25, 135, 84, 0.12);
                    }
                    #editarListaClientes tr.selected:hover {
                      background-color: rgba(25, 135, 84, 0.18);
                    }
                    /* Linhas bloqueadas (cliente já associado a outra conta) */
                    #editarListaClientes tr.blocked-row {
                      background-color: rgba(108, 117, 125, 0.08);
                      opacity: 0.7;
                    }
                    #editarListaClientes tr.blocked-row:hover {
                      background-color: rgba(108, 117, 125, 0.12);
                    }
                    /* Linhas marcadas para transferência */
                    #editarListaClientes tr.transferencia-pendente {
                      background-color: rgba(13, 110, 253, 0.1) !important;
                      border-left: 3px solid #0d6efd;
                    }
                    #editarListaClientes tr.transferencia-pendente:hover {
                      background-color: rgba(13, 110, 253, 0.15) !important;
                    }
                  </style>

                  <!-- Barra de Busca -->
                  <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="buscaClienteEditar" placeholder="Buscar cliente por nome...">
                  </div>

                  <!-- Lista de clientes -->
                  <div class="cliente-list-container" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                    <table class="table table-hover table-sm mb-0">
                      <thead class="sticky-top bg-light">
                        <tr>
                          <th style="width: 40px;">
                            <input type="checkbox" class="form-check-input" id="editarSelectAllClientes" title="Selecionar todos">
                          </th>
                          <th style="width: 80px;" class="text-center">Status</th>
                          <th>Cliente</th>
                          <th>Plano</th>
                          <th class="text-end">Valor Anual</th>
                        </tr>
                      </thead>
                      <tbody id="editarListaClientes">
                        <tr>
                          <td colspan="5" class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split me-2"></i>Carregando clientes...
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Resumo de seleção -->
                  <div class="card bg-light mt-3">
                    <div class="card-body py-2">
                      <div class="d-flex justify-content-center text-center gap-4 flex-wrap">
                        <div class="px-3">
                          <small class="text-muted d-block">Selecionados</small>
                          <strong id="editarTotalSelecionados">0</strong>
                        </div>
                        <div class="px-3">
                          <small class="text-muted d-block">Valor Anual</small>
                          <strong id="editarTotalValorAnual">R$ 0,00</strong>
                        </div>
                        <div class="px-3 d-none" id="colDisponivelEdicao">
                          <small class="text-muted d-block">Disponível</small>
                          <strong id="editarValorDisponivel">R$ 81.000,00</strong>
                        </div>
                        <div class="px-3 d-none" id="colTransferenciasEdicao">
                          <small class="text-primary d-block"><i class="bi bi-arrow-right-circle me-1"></i>Transferências</small>
                          <strong class="text-primary" id="editarTotalTransferencias">0</strong>
                        </div>
                      </div>
                    </div>
                  </div>

                  <input type="hidden" id="editarClientesAssociados" name="clientes_associados">
                  <input type="hidden" id="editarClientesParaTransferir" name="clientes_para_transferir">
              </div>

            </form>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-success" id="btnSalvarEdicao" style="min-width: 170px; min-height: 38px;">
              <i class="bi bi-check-circle me-2"></i>Salvar Alterações
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Gerenciar Instituicoes (Admin) -->
    {% if request.user.is_staff %}
    <div class="modal fade" id="modalInstituicoes" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-bank me-2"></i>Gerenciar Instituicoes Bancarias
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <!-- Formulario para adicionar nova instituicao -->
            <div class="card mb-4">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-plus-circle me-2"></i>Adicionar Nova Instituicao</h6>
              </div>
              <div class="card-body">
                <form id="formNovaInstituicao">
                  <div class="row g-3">
                    <div class="col-md-5">
                      <label class="form-label">Nome da Instituicao</label>
                      <input type="text" class="form-control" id="novaInstituicaoNome" required>
                    </div>
                    <div class="col-md-5">
                      <label class="form-label">Tipo de Integracao</label>
                      <select class="form-select" id="novaInstituicaoTipo">
                        <option value="manual">Manual (sem API)</option>
                        <option value="fastdepix">FastDePix (API)</option>
                        <option value="efi_bank">Efi Bank (API)</option>
                        <option value="mercado_pago">Mercado Pago (API)</option>
                      </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                      <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-plus"></i>
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>

            <!-- Lista de instituicoes -->
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Acoes</th>
                  </tr>
                </thead>
                <tbody id="listaInstituicoes">
                  {% for inst in todas_instituicoes %}
                  <tr data-id="{{ inst.id }}" class="{% if not inst.ativo %}text-muted{% endif %}">
                    <td>
                      <i class="bi bi-bank me-2 text-primary"></i>
                      {{ inst.nome }}
                    </td>
                    <td>
                      {% if inst.tipo_integracao == 'fastdepix' %}
                        <span class="badge bg-success">FastDePix (API)</span>
                      {% elif inst.tipo_integracao == 'efi_bank' %}
                        <span class="badge bg-warning text-dark">Efi Bank (API)</span>
                      {% elif inst.tipo_integracao == 'mercado_pago' %}
                        <span class="badge bg-info">Mercado Pago (API)</span>
                      {% else %}
                        <span class="badge bg-secondary">Manual</span>
                      {% endif %}
                    </td>
                    <td class="text-center">
                      <div class="form-check form-switch d-inline-block">
                        <input class="form-check-input toggle-instituicao" type="checkbox"
                               data-id="{{ inst.id }}" {% if inst.ativo %}checked{% endif %}>
                      </div>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-danger btn-excluir-instituicao"
                              data-id="{{ inst.id }}" data-nome="{{ inst.nome }}">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Modal Gerenciar Limites (Admin) -->
    {% if request.user.is_staff %}
    <div class="modal fade" id="modalLimites" tabindex="-1" aria-labelledby="modalLimitesLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-secondary text-white">
            <h5 class="modal-title" id="modalLimitesLabel">
              <i class="bi bi-speedometer2 me-2"></i>Configurar Limite MEI Global
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <form id="formConfigLimite">
              <div class="mb-3">
                <label class="form-label fw-semibold">Limite Anual MEI (R$)</label>
                <input type="number" class="form-control form-control-lg" id="limiteValorAnual"
                       value="81000" step="1000" min="0">
                <small class="text-muted">Valor maximo anual permitido para contas MEI</small>
              </div>

              <div class="mb-3">
                <label class="form-label fw-semibold">Margem de Seguranca (%)</label>
                <input type="number" class="form-control" id="limiteMargem" value="10" min="0" max="50">
                <small class="text-muted">Alerta sera exibido ao atingir esse percentual (ex: 10 = alerta em 90%)</small>
              </div>

              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                <strong>Resumo:</strong><br>
                - Alerta em: <span id="valorAlertaDisplay">R$ 72.900,00</span> (<span id="percentAlerta">90</span>%)<br>
                - Bloqueio em: <span id="valorBloqueioDisplay">R$ 80.190,00</span> (99%)
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="btnSalvarLimite">
              <i class="bi bi-check-circle me-2"></i>Salvar Configuracao
            </button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

      <!-- Includes de Modais Globais -->
      {% include 'partials/modal_whatsapp.html' %}
      {% include 'partials/modal_dns.html' %}
      {% include 'partials/modal_adminlogs.html' %}
      {% include 'partials/modal_userlogs.html' %}
      {% include 'partials/modais_globais.html' %}
      {% include 'partials/offcanvas_configuracoes.html' %}

      <!-- Footer dentro do page-content -->
      {% include 'partials/footer.html' %}

    </div>
    <!-- fim #page-content -->

    <!-- Scripts fora do page-content mas dentro do db-wrapper -->
    {% include 'partials/scripts.html' %}

  </div>
  <!-- fim #db-wrapper -->

  <!-- Alert success/error -->
  {% if success_message %}
  <script>
    $(document).ready(function () {
      Swal.fire({
        icon: 'success',
        title: 'Sucesso!',
        html: '{{success_message|safe}}',
        didClose: function () {
          window.location.href = '/admin/forma-pagamento/';
        }
      });
    });
  </script>
  {% elif error_message %}
  <script>
    $(document).ready(function () {
      Swal.fire({
        icon: 'error',
        title: 'Erro',
        html: '{{error_message|safe}}'
      });
    });
  </script>
  {% endif %}

  <script>
  // Função utilitária para loading em botões com pontos animados
  function setButtonLoading(btn, loading, originalHTML) {
    if (!btn) return;
    const $btn = $(btn);
    if (loading) {
      $btn.prop('disabled', true);
      $btn.data('original-html', $btn.html());
      $btn.html('<span class="loading-dots"><span></span><span></span><span></span></span>');
    } else {
      $btn.prop('disabled', false);
      $btn.html(originalHTML || $btn.data('original-html') || 'Salvar');
    }
  }

  $(document).ready(function() {
  // ========== Variaveis Globais ==========
  let instituicaoSelecionada = null;
  let tipoIntegracao = null;
  let formaPgtoIdExcluir = null;

  // Mapear IDs das instituicoes do banco
  const instituicoesDB = {
    {% for inst in instituicoes %}
    '{{ inst.tipo_integracao }}': {{ inst.id }},
    {% endfor %}
  };

  // ========== Selecao de Instituicao (Cards) ==========
  $('.instituicao-card').on('click', function() {
    // Remover selecao anterior
    $('.instituicao-card').removeClass('selected');
    // Adicionar selecao atual
    $(this).addClass('selected');

    // Guardar dados
    instituicaoSelecionada = $(this).data('nome');
    tipoIntegracao = $(this).data('instituicao');

    // Atualizar hidden fields
    $('#instituicaoId').val(instituicoesDB[tipoIntegracao] || '');
    $('#tipoIntegracao').val(tipoIntegracao);

    // Mostrar step 2
    setTimeout(() => {
      $('#step1').addClass('d-none');
      $('#step2').removeClass('d-none');

      // Atualizar indicadores
      $('#step1-indicator').removeClass('active').addClass('completed');
      $('#step1-indicator .step-number').html('<i class="bi bi-check"></i>');
      $('#step2-indicator').addClass('active');
      $('.step-connector').addClass('completed');

      // Atualizar nome da instituicao
      $('#nomeInstituicaoSelecionada').text(instituicaoSelecionada);

      // Configurar campos visiveis por instituicao
      configurarCamposPorInstituicao(tipoIntegracao);
    }, 150);
  });

  // ========== Botao Voltar ==========
  $('#btnVoltar').on('click', function() {
    $('#step2').addClass('d-none');
    $('#step1').removeClass('d-none');

    // Resetar indicadores
    $('#step1-indicator').addClass('active').removeClass('completed');
    $('#step1-indicator .step-number').text('1');
    $('#step2-indicator').removeClass('active');
    $('.step-connector').removeClass('completed');

    // Limpar selecao
    $('.instituicao-card').removeClass('selected');
    instituicaoSelecionada = null;
    tipoIntegracao = null;
  });

  // ========== Configurar Campos por Instituicao ==========
  function configurarCamposPorInstituicao(tipo) {
    // Ocultar todos os cards de configuração
    $('#camposFastDePix, #camposMercadoPago, #camposEfiBank, #camposManual, #configCobrancaFastDePix').addClass('d-none');

    // Resetar pills de tipo pagamento
    $('#pillCartao, #pillBoleto').addClass('d-none');
    $('.tipo-pagamento-pill').removeClass('selected');
    $('.tipo-pagamento-pill:first').addClass('selected');
    $('input[name="nome"][value="PIX"]').prop('checked', true);

    // Atualizar cor do alert conforme instituicao
    $('#alertInstituicao').removeClass('fastdepix mercado_pago efi_bank manual').addClass(tipo);

    // Ocultar seção de clientes associados (só mostra após selecionar tipo de conta)
    $('#secaoClientesAssociados').addClass('d-none');

    // Resetar seleção de tipo de conta
    $('.tipo-conta-select').val('');
    $('#tipoConta').val('');

    // Ocultar alertas de limite/pessoa física
    $('#alertLimiteMei, #alertPessoaFisica').addClass('d-none');

    switch(tipo) {
      case 'fastdepix':
        $('#camposFastDePix').removeClass('d-none');
        $('#configCobrancaFastDePix').removeClass('d-none');
        carregarPlanosParaLinks();
        break;

      case 'mercado_pago':
        $('#camposMercadoPago').removeClass('d-none');
        $('#pillCartao, #pillBoleto').removeClass('d-none');
        break;

      case 'efi_bank':
        $('#camposEfiBank').removeClass('d-none');
        $('#pillCartao, #pillBoleto').removeClass('d-none');
        break;

      case 'manual':
        $('#camposManual').removeClass('d-none');
        $('#instituicaoNomeManual').prop('required', true);
        break;
    }
  }

  // ========== Variável para controle do modo de conta (PF ou MEI) ==========
  let tipoContaAtual = null;

  // ========== Handler para mudança de Tipo de Conta ==========
  $(document).on('change', '.tipo-conta-select', function() {
    const tipoSelecionado = $(this).val();
    const instituicao = $(this).data('instituicao');

    tipoContaAtual = tipoSelecionado;

    // Sincronizar com campo hidden
    $('#tipoConta').val(tipoSelecionado);

    // Sincronizar nome de identificação com campo hidden
    let nomeIdentificacao = '';
    switch(instituicao) {
      case 'fastdepix':
        nomeIdentificacao = $('#nomeIdentificacaoFastDePix').val();
        break;
      case 'mercado_pago':
        nomeIdentificacao = $('#nomeIdentificacaoMP').val();
        break;
      case 'efi_bank':
        nomeIdentificacao = $('#nomeIdentificacaoEfi').val();
        break;
      case 'manual':
        nomeIdentificacao = $('#nomeIdentificacao').val();
        break;
    }
    // Se há um campo hidden para nome_identificacao, sincronizar
    // (O campo do formulário manual já tem name="nome_identificacao")

    if (tipoSelecionado) {
      // Mostrar seção de clientes associados
      $('#secaoClientesAssociados').removeClass('d-none');

      // Carregar clientes se ainda não carregados
      if (clientesAtivos.length === 0) {
        carregarClientesAtivos();
      }

      // Mostrar alerta apropriado (MEI com limite ou PF sem limite)
      if (tipoSelecionado === 'mei') {
        $('#alertLimiteMei').removeClass('d-none');
        $('#alertPessoaFisica').addClass('d-none');
        $('#colDisponivelCriacao').removeClass('d-none');
        // Carregar configuração de limite
        carregarConfigLimite();
      } else {
        $('#alertLimiteMei').addClass('d-none');
        $('#alertPessoaFisica').removeClass('d-none');
        $('#colDisponivelCriacao').addClass('d-none');
        // Sem limite para Pessoa Física
        limiteMeiGlobal = Infinity;
      }
    } else {
      // Ocultar seção de clientes se nenhum tipo selecionado
      $('#secaoClientesAssociados').addClass('d-none');
    }

    // Atualizar resumo
    atualizarResumoClientes();
  });

  // Sincronizar campos de nome de identificação ao digitar
  $(document).on('input', '#nomeIdentificacaoFastDePix, #nomeIdentificacaoMP, #nomeIdentificacaoEfi', function() {
    // Para APIs, o nome de identificação está em campos separados
    // Vamos sincronizar com o campo hidden no submit
  });

  // ========== Gestao de Clientes Associados ==========

  // Variaveis de controle
  let clientesAtivos = [];
  let clientesSelecionados = new Set();
  let clientesParaTransferir = new Set(); // Clientes que serão transferidos de outras contas
  let valorTotalSelecionado = 0;
  let limiteMeiGlobal = 81000;

  // Carregar configuracao de limite
  function carregarConfigLimite() {
    $.ajax({
      url: '/api/config-limite/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          limiteMeiGlobal = response.config.valor_anual;
          $('#limiteTotalDisplay').text(formatarMoedaBR(limiteMeiGlobal));
          $('#valorDisponivelDisplay').text(formatarMoedaBR(limiteMeiGlobal));
        }
      },
      error: function(xhr, status, error) {
        // Usar limite padrão em caso de erro
        console.warn('Erro ao carregar config limite, usando padrão:', error);
        limiteMeiGlobal = 81000;
        $('#limiteTotalDisplay').text(formatarMoedaBR(limiteMeiGlobal));
        $('#valorDisponivelDisplay').text(formatarMoedaBR(limiteMeiGlobal));
      }
    });
  }

  // Carregar clientes ativos
  function carregarClientesAtivos() {
    $('#listaClientesAssociacao').html(`
      <tr>
        <td colspan="4" class="text-center text-muted py-4">
          <i class="bi bi-hourglass-split me-2"></i>Carregando clientes...
        </td>
      </tr>
    `);

    $.ajax({
      url: '/api/clientes-ativos-associacao/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          clientesAtivos = response.clientes;
          renderizarListaClientes(clientesAtivos);
          // Inicializar slider
          atualizarSliderVisual(0);
        } else {
          $('#listaClientesAssociacao').html(`
            <tr>
              <td colspan="5" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-triangle me-2"></i>${response.error || 'Erro ao carregar clientes'}
              </td>
            </tr>
          `);
        }
      },
      error: function() {
        $('#listaClientesAssociacao').html(`
          <tr>
            <td colspan="5" class="text-center text-danger py-4">
              <i class="bi bi-exclamation-triangle me-2"></i>Erro ao carregar clientes
            </td>
          </tr>
        `);
      }
    });
  }

  function renderizarListaClientes(clientes) {
    if (clientes.length === 0) {
      $('#listaClientesAssociacao').html(`
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            <i class="bi bi-person-x me-2"></i>Nenhum cliente encontrado
          </td>
        </tr>
      `);
      return;
    }

    let html = '';
    clientes.forEach(function(cliente) {
      const valorPlano = cliente.valor_plano || 0;
      const pagamentosAno = cliente.pagamentos_ano || 12;

      // Verificar se cliente está bloqueado (já associado a outra conta)
      const bloqueado = cliente.bloqueado === true;
      const jaAssociadoEstaConta = cliente.ja_associado_esta_conta === true;
      const contaAssociada = cliente.conta_associada || '';

      // Se já está associado a esta conta, pré-selecionar
      if (jaAssociadoEstaConta && !clientesSelecionados.has(cliente.id)) {
        clientesSelecionados.add(cliente.id);
        valorTotalSelecionado += cliente.valor_anual;
      }

      const checked = clientesSelecionados.has(cliente.id) ? 'checked' : '';
      const selectedClass = clientesSelecionados.has(cliente.id) ? 'selected' : '';
      const blockedClass = bloqueado ? 'blocked-row' : '';
      const disabled = bloqueado ? 'disabled' : '';

      // Badge colorida por tipo de plano
      let badgeClass = 'bg-primary';
      if (cliente.plano === 'Anual') badgeClass = 'bg-success';
      else if (cliente.plano === 'Semestral') badgeClass = 'bg-info';
      else if (cliente.plano === 'Trimestral') badgeClass = 'bg-warning text-dark';
      else if (cliente.plano === 'Bimestral') badgeClass = 'bg-secondary';

      // Mostrar informação de conta associada se bloqueado
      let infoAssociacao = '';
      if (bloqueado && contaAssociada) {
        infoAssociacao = `
          <div class="small text-danger mt-1">
            <i class="bi bi-lock-fill me-1"></i>Associado a: <strong>${contaAssociada}</strong>
          </div>
        `;
      }

      // Badge de status do cliente
      const statusBadge = cliente.cancelado
        ? '<span class="badge bg-warning text-dark">Cancelado</span>'
        : '<span class="badge bg-success">Ativo</span>';

      html += `
        <tr class="${selectedClass} ${blockedClass}" data-cliente-id="${cliente.id}" data-bloqueado="${bloqueado}">
          <td>
            <input type="checkbox" class="form-check-input checkbox-cliente"
                   data-id="${cliente.id}"
                   data-valor-anual="${cliente.valor_anual}"
                   data-bloqueado="${bloqueado}"
                   ${checked} ${disabled}>
          </td>
          <td class="text-center">
            ${statusBadge}
          </td>
          <td>
            <div class="fw-semibold ${bloqueado ? 'text-muted' : ''}">${cliente.nome}</div>
            <small class="text-muted">${cliente.telefone || ''}</small>
            ${infoAssociacao}
          </td>
          <td>
            <span class="badge ${badgeClass} ${bloqueado ? 'opacity-50' : ''}">${cliente.plano || '-'}</span>
            <small class="text-muted d-block">${formatarMoedaBR(valorPlano)} × ${pagamentosAno}/ano</small>
          </td>
          <td class="text-end">
            <span class="${bloqueado ? 'text-muted' : 'text-success'} fw-semibold">${formatarMoedaBR(cliente.valor_anual)}</span>
            <small class="text-muted d-block">projetado/ano</small>
          </td>
        </tr>
      `;
    });
    $('#listaClientesAssociacao').html(html);

    // Atualizar resumo se houve pré-seleção de clientes
    atualizarResumoClientes();
    atualizarCampoHidden();
  }

  // Selecionar/deselecionar cliente ao clicar na linha
  $(document).on('click', '#listaClientesAssociacao tr', function(e) {
    // Se clicou diretamente no checkbox, deixa o comportamento padrão
    if ($(e.target).is('.checkbox-cliente')) {
      return;
    }

    // Se linha está bloqueada, oferecer opção de transferência
    if ($(this).hasClass('blocked-row')) {
      const contaAssociada = $(this).find('.text-danger strong').text();
      const clienteId = parseInt($(this).data('cliente-id'));
      const clienteNome = $(this).find('.fw-semibold').first().text().trim();
      const valorAnual = parseFloat($(this).find('.checkbox-cliente').data('valor-anual'));

      Swal.fire({
        icon: 'warning',
        title: 'Cliente Já Associado',
        html: `<strong>${clienteNome}</strong> já está associado à:<br><strong class="text-primary">"${contaAssociada}"</strong><br><br>Deseja transferi-lo para esta nova forma de pagamento?`,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-arrow-right-circle me-1"></i> Transferir',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0d6efd',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          // Verificar se pode adicionar (limite)
          const novoTotal = valorTotalSelecionado + valorAnual;
          const percentual = (novoTotal / limiteMeiGlobal) * 100;

          if (percentual >= 99) {
            Swal.fire({
              icon: 'error',
              title: 'Limite Atingido',
              text: 'Adicionar este cliente excederia o limite de 99%. Remova outros clientes primeiro.'
            });
            return;
          }

          // Marcar cliente para transferência
          clientesParaTransferir.add(clienteId);
          clientesSelecionados.add(clienteId);
          valorTotalSelecionado = novoTotal;

          // Atualizar visual da linha (remover bloqueio visual)
          const row = $(`#listaClientesAssociacao tr[data-cliente-id="${clienteId}"]`);
          row.removeClass('blocked-row').addClass('selected transferencia-pendente');
          row.find('.checkbox-cliente').prop('disabled', false).prop('checked', true);

          // Atualizar informação de associação para mostrar que será transferido
          row.find('.text-danger').html(`
            <i class="bi bi-arrow-right-circle-fill me-1 text-primary"></i>
            <span class="text-primary">Será transferido de: <strong>${contaAssociada}</strong></span>
          `);

          atualizarResumoClientes();
          atualizarCampoHidden();

          Swal.fire({
            icon: 'success',
            title: 'Cliente Marcado para Transferência',
            html: `<strong>${clienteNome}</strong> será transferido ao salvar esta forma de pagamento.`,
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
      return;
    }

    // Toggle do checkbox da linha
    const checkbox = $(this).find('.checkbox-cliente');
    if (checkbox.length && !checkbox.prop('disabled')) {
      checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
    }
  });

  // Adicionar cursor pointer nas linhas (exceto bloqueadas)
  $(document).on('mouseenter', '#listaClientesAssociacao tr', function() {
    if ($(this).hasClass('blocked-row')) {
      $(this).css('cursor', 'not-allowed');
    } else {
      $(this).css('cursor', 'pointer');
    }
  });

  // Selecionar/deselecionar cliente (handler do checkbox)
  $(document).on('change', '.checkbox-cliente', function() {
    const clienteId = parseInt($(this).data('id'));
    const valorAnual = parseFloat($(this).data('valor-anual'));
    const row = $(this).closest('tr');

    if ($(this).is(':checked')) {
      // Verificar se pode adicionar
      const novoTotal = valorTotalSelecionado + valorAnual;
      const percentual = (novoTotal / limiteMeiGlobal) * 100;

      if (percentual >= 99) {
        Swal.fire({
          icon: 'error',
          title: 'Limite Atingido',
          text: 'Voce atingiu 99% do limite. Nao e possivel adicionar mais clientes.'
        });
        $(this).prop('checked', false);
        return;
      }

      clientesSelecionados.add(clienteId);
      valorTotalSelecionado = novoTotal;
      row.addClass('selected');
    } else {
      clientesSelecionados.delete(clienteId);
      valorTotalSelecionado -= valorAnual;
      row.removeClass('selected');

      // Se estava marcado para transferência, restaurar estado bloqueado
      if (clientesParaTransferir.has(clienteId)) {
        clientesParaTransferir.delete(clienteId);

        // Encontrar dados do cliente para restaurar visual
        const cliente = clientesAtivos.find(c => c.id === clienteId);
        if (cliente && cliente.bloqueado) {
          row.addClass('blocked-row').removeClass('transferencia-pendente');
          row.find('.checkbox-cliente').prop('disabled', true);

          // Restaurar texto de conta associada
          const contaAssociada = cliente.conta_associada || '';
          row.find('.text-primary').parent().html(`
            <i class="bi bi-lock-fill me-1"></i>Associado a: <strong>${contaAssociada}</strong>
          `).removeClass('text-primary').addClass('text-danger');
        }
      }
    }

    atualizarResumoClientes();
    atualizarCampoHidden();
  });

  // Selecionar todos (apenas clientes não bloqueados)
  $('#selectAllClientes').on('change', function() {
    const checked = $(this).is(':checked');

    // Filtrar apenas clientes não bloqueados
    const clientesDisponiveis = clientesAtivos.filter(c => !c.bloqueado);

    if (checked) {
      // Calcular se cabe todos os clientes disponíveis
      let totalPotencial = 0;
      clientesDisponiveis.forEach(function(c) {
        totalPotencial += c.valor_anual;
      });

      if ((totalPotencial / limiteMeiGlobal) * 100 >= 99) {
        Swal.fire({
          icon: 'warning',
          title: 'Limite Excedido',
          text: 'Selecionar todos os clientes disponíveis excederia o limite. Selecione individualmente ou use o slider.'
        });
        $(this).prop('checked', false);
        return;
      }

      clientesSelecionados.clear();
      valorTotalSelecionado = 0;
      clientesDisponiveis.forEach(function(c) {
        clientesSelecionados.add(c.id);
        valorTotalSelecionado += c.valor_anual;
      });
    } else {
      clientesSelecionados.clear();
      valorTotalSelecionado = 0;
    }

    // Atualizar checkboxes e classes das linhas (apenas não bloqueadas)
    $('.checkbox-cliente').each(function() {
      if (!$(this).prop('disabled')) {
        $(this).prop('checked', checked);
        $(this).closest('tr').toggleClass('selected', checked);
      }
    });

    atualizarResumoClientes();
    atualizarCampoHidden();
  });

  // Filtrar clientes
  $('#buscaCliente').on('input', function() {
    const termo = $(this).val().toLowerCase();
    const filtrados = clientesAtivos.filter(function(c) {
      return c.nome.toLowerCase().includes(termo) ||
             (c.telefone && c.telefone.includes(termo));
    });
    renderizarListaClientes(filtrados);
  });

  function atualizarResumoClientes() {
    // Atualizar contador de clientes
    $('#totalClientesSelecionados').text(clientesSelecionados.size);
    $('#valorAnualTotal').text(formatarMoedaBR(valorTotalSelecionado));

    // Atualizar contador de transferências
    const totalTransferencias = clientesParaTransferir.size;
    $('#totalTransferencias').text(totalTransferencias);
    if (totalTransferencias > 0) {
      $('#colTransferencias').removeClass('d-none');
    } else {
      $('#colTransferencias').addClass('d-none');
    }

    // Atualizar conforme tipo de conta (MEI ou PF)
    if (tipoContaAtual === 'mei') {
      // MEI: com limite
      const percentual = (valorTotalSelecionado / limiteMeiGlobal) * 100;
      const valorDisponivel = limiteMeiGlobal - valorTotalSelecionado;

      $('#valorSelecionadoDisplayMei').text(formatarMoedaBR(valorTotalSelecionado));
      $('#percentualSelecionadoMei').text(percentual.toFixed(1));
      $('#valorDisponivelDisplay').text(formatarMoedaBR(valorDisponivel));

      // Cores de alerta para MEI
      if (percentual >= 90) {
        $('#alertLimiteMei').removeClass('alert-info alert-warning').addClass('alert-danger');
      } else if (percentual >= 70) {
        $('#alertLimiteMei').removeClass('alert-info alert-danger').addClass('alert-warning');
      } else {
        $('#alertLimiteMei').removeClass('alert-warning alert-danger').addClass('alert-info');
      }

      // Sincronizar slider MEI
      atualizarSliderVisualMei(percentual);
    } else {
      // Pessoa Física: sem limite
      $('#valorSelecionadoDisplayPf').text(formatarMoedaBR(valorTotalSelecionado));

      // Sincronizar slider PF (baseado em quantidade de clientes)
      const totalClientesDisponiveis = clientesAtivos.filter(c => !c.bloqueado).length;
      const percentualClientes = totalClientesDisponiveis > 0
        ? (clientesSelecionados.size / totalClientesDisponiveis) * 100
        : 0;
      atualizarSliderVisualPf(percentualClientes);
    }
  }

  function atualizarCampoHidden() {
    const ids = Array.from(clientesSelecionados).join(',');
    $('#clientesAssociados').val(ids);

    // Atualizar campo de clientes a serem transferidos
    const idsTransferir = Array.from(clientesParaTransferir).join(',');
    $('#clientesParaTransferir').val(idsTransferir);
  }

  // ========== Slider Interativo para Seleção de Clientes ==========

  // Atualizar visual do slider MEI (com limite)
  function atualizarSliderVisualMei(percentual) {
    const slider = $('#sliderClientesMei');
    slider.val(Math.min(percentual, 99));

    // Atualizar cor do gradiente do track
    const cor = percentual >= 90 ? '#dc3545' : (percentual >= 70 ? '#ffc107' : '#0d6efd');
    slider.css('background', `linear-gradient(to right, ${cor} ${percentual}%, #e9ecef ${percentual}%)`);

    // Atualizar texto do display
    if (clientesSelecionados.size === 0) {
      $('#sliderValueDisplayMei').text('Arraste para selecionar clientes');
    } else {
      $('#sliderValueDisplayMei').text(`${clientesSelecionados.size} cliente(s) - ${percentual.toFixed(1)}%`);
    }
  }

  // Atualizar visual do slider PF (sem limite, baseado em quantidade)
  function atualizarSliderVisualPf(percentual) {
    const slider = $('#sliderClientesPf');
    slider.val(Math.min(percentual, 100));

    // Slider PF sempre usa cor verde (success)
    slider.css('background', `linear-gradient(to right, #198754 ${percentual}%, #e9ecef ${percentual}%)`);

    // Atualizar texto do display
    if (clientesSelecionados.size === 0) {
      $('#sliderValueDisplayPf').text('Arraste para selecionar clientes');
    } else {
      $('#sliderValueDisplayPf').text(`${clientesSelecionados.size} cliente(s) selecionado(s)`);
    }
  }

  // Ordenar clientes por valor (menor para maior) para seleção incremental
  // Exclui clientes bloqueados (já associados a outra conta)
  function getClientesOrdenadosPorValor() {
    return [...clientesAtivos]
      .filter(c => !c.bloqueado) // Ignorar clientes já associados a outras contas
      .sort((a, b) => a.valor_anual - b.valor_anual);
  }

  // Selecionar clientes até atingir o valor alvo
  function selecionarClientesAteValor(valorAlvo) {
    const clientesOrdenados = getClientesOrdenadosPorValor();

    // Limpar seleção atual
    clientesSelecionados.clear();
    valorTotalSelecionado = 0;

    // Selecionar clientes até o valor alvo (máx 99%)
    const limiteMax = limiteMeiGlobal * 0.99;
    const alvoFinal = Math.min(valorAlvo, limiteMax);

    for (const cliente of clientesOrdenados) {
      const novoTotal = valorTotalSelecionado + cliente.valor_anual;
      if (novoTotal <= alvoFinal) {
        clientesSelecionados.add(cliente.id);
        valorTotalSelecionado = novoTotal;
      } else if (valorTotalSelecionado < alvoFinal) {
        // Tentar adicionar se ainda não atingiu o alvo e o cliente couber
        // (deixa de fora se ultrapassar muito)
        const diferenca = alvoFinal - valorTotalSelecionado;
        if (cliente.valor_anual <= diferenca * 1.5) { // margem de 50%
          clientesSelecionados.add(cliente.id);
          valorTotalSelecionado += cliente.valor_anual;
        }
      }
    }

    // Atualizar UI (checkboxes e classes das linhas)
    // Ignora clientes bloqueados (já associados a outras contas)
    $('.checkbox-cliente').each(function() {
      const id = parseInt($(this).data('id'));
      const $row = $(this).closest('tr');

      // Não alterar clientes bloqueados
      if ($row.hasClass('blocked-row')) {
        return;
      }

      const isSelected = clientesSelecionados.has(id);
      $(this).prop('checked', isSelected);
      $row.toggleClass('selected', isSelected);
    });

    atualizarResumoClientes();
    atualizarCampoHidden();
  }

  // Handler do slider MEI (com limite de valor)
  $('#sliderClientesMei').on('input', function() {
    const percentual = parseFloat($(this).val());
    const valorAlvo = (percentual / 100) * limiteMeiGlobal;

    // Atualizar display durante o arrasto
    $('#sliderValueDisplayMei').text(`Selecionando até ${percentual.toFixed(0)}%...`);

    selecionarClientesAteValor(valorAlvo);
  });

  $('#sliderClientesMei').on('mousedown touchstart', function() {
    $(this).css('cursor', 'grabbing');
  });

  $('#sliderClientesMei').on('mouseup touchend', function() {
    $(this).css('cursor', 'grab');
    const percentual = (valorTotalSelecionado / limiteMeiGlobal) * 100;
    if (clientesSelecionados.size === 0) {
      $('#sliderValueDisplayMei').text('Arraste para selecionar clientes');
    } else {
      $('#sliderValueDisplayMei').text(`${clientesSelecionados.size} cliente(s) - ${percentual.toFixed(1)}%`);
    }
  });

  // Handler do slider PF (sem limite, baseado em quantidade de clientes)
  $('#sliderClientesPf').on('input', function() {
    const percentual = parseFloat($(this).val());
    const clientesDisponiveis = clientesAtivos.filter(c => !c.bloqueado);
    const quantidadeAlvo = Math.round((percentual / 100) * clientesDisponiveis.length);

    // Atualizar display durante o arrasto
    $('#sliderValueDisplayPf').text(`Selecionando ${quantidadeAlvo} cliente(s)...`);

    selecionarClientesPorQuantidade(quantidadeAlvo);
  });

  $('#sliderClientesPf').on('mousedown touchstart', function() {
    $(this).css('cursor', 'grabbing');
  });

  $('#sliderClientesPf').on('mouseup touchend', function() {
    $(this).css('cursor', 'grab');
    if (clientesSelecionados.size === 0) {
      $('#sliderValueDisplayPf').text('Arraste para selecionar clientes');
    } else {
      $('#sliderValueDisplayPf').text(`${clientesSelecionados.size} cliente(s) selecionado(s)`);
    }
  });

  // Selecionar clientes por quantidade (para Pessoa Física)
  function selecionarClientesPorQuantidade(quantidade) {
    const clientesOrdenados = getClientesOrdenadosPorValor();

    // Limpar seleção atual
    clientesSelecionados.clear();
    valorTotalSelecionado = 0;

    // Selecionar os primeiros N clientes (ordenados por valor)
    for (let i = 0; i < Math.min(quantidade, clientesOrdenados.length); i++) {
      const cliente = clientesOrdenados[i];
      clientesSelecionados.add(cliente.id);
      valorTotalSelecionado += cliente.valor_anual;
    }

    // Atualizar UI (checkboxes e classes das linhas)
    $('.checkbox-cliente').each(function() {
      const id = parseInt($(this).data('id'));
      const $row = $(this).closest('tr');

      // Não alterar clientes bloqueados
      if ($row.hasClass('blocked-row')) {
        return;
      }

      const isSelected = clientesSelecionados.has(id);
      $(this).prop('checked', isSelected);
      $row.toggleClass('selected', isSelected);
    });

    atualizarResumoClientes();
    atualizarCampoHidden();
  }

  // ========== Toggle de Credenciais (Usar Existente / Cadastrar Nova) ==========

  // Cache de credenciais carregadas
  let credenciaisCache = {
    fastdepix: null,
    mercado_pago: null,
    efi_bank: null
  };

  // FastDePix
  $('input[name="modoCredencialFastDePix"]').on('change', function() {
    const modo = $(this).val();
    if (modo === 'existente') {
      $('#listaCredenciaisFastDePix').removeClass('d-none');
      $('#camposNovaCredencialFastDePix').addClass('d-none');
      carregarCredenciais('fastdepix', '#selectCredencialFastDePix');
    } else {
      $('#listaCredenciaisFastDePix').addClass('d-none');
      $('#camposNovaCredencialFastDePix').removeClass('d-none');
    }
  });

  // Mercado Pago
  $('input[name="modoCredencialMP"]').on('change', function() {
    const modo = $(this).val();
    if (modo === 'existente') {
      $('#listaCredenciaisMP').removeClass('d-none');
      $('#camposNovaCredencialMP').addClass('d-none');
      carregarCredenciais('mercado_pago', '#selectCredencialMP');
    } else {
      $('#listaCredenciaisMP').addClass('d-none');
      $('#camposNovaCredencialMP').removeClass('d-none');
    }
  });

  // Efi Bank
  $('input[name="modoCredencialEfi"]').on('change', function() {
    const modo = $(this).val();
    if (modo === 'existente') {
      $('#listaCredenciaisEfi').removeClass('d-none');
      $('#camposNovaCredencialEfi').addClass('d-none');
      carregarCredenciais('efi_bank', '#selectCredencialEfi');
    } else {
      $('#listaCredenciaisEfi').addClass('d-none');
      $('#camposNovaCredencialEfi').removeClass('d-none');
    }
  });

  // Carregar credenciais por tipo
  function carregarCredenciais(tipo, seletorSelect) {
    // Usar cache se disponivel
    if (credenciaisCache[tipo]) {
      preencherSelectCredenciais(seletorSelect, credenciaisCache[tipo]);
      return;
    }

    $(seletorSelect).html('<option value="">Carregando...</option>');

    $.ajax({
      url: '/api/credenciais/' + tipo + '/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          credenciaisCache[tipo] = response.credenciais;
          preencherSelectCredenciais(seletorSelect, response.credenciais);
        } else {
          $(seletorSelect).html('<option value="">Erro ao carregar</option>');
        }
      },
      error: function() {
        $(seletorSelect).html('<option value="">Erro ao carregar</option>');
      }
    });
  }

  function preencherSelectCredenciais(seletorSelect, credenciais) {
    if (credenciais.length === 0) {
      $(seletorSelect).html('<option value="">Nenhuma credencial salva</option>');
      return;
    }

    let options = '<option value="">Selecione uma credencial...</option>';
    credenciais.forEach(function(cred) {
      options += '<option value="' + cred.id + '">' + cred.nome_identificacao + '</option>';
    });
    $(seletorSelect).html(options);
  }

  // ========== Pills de Tipo Pagamento ==========
  $('.tipo-pagamento-pill').on('click', function() {
    $('.tipo-pagamento-pill').removeClass('selected');
    $(this).addClass('selected');

    // Instituicoes com API nao mostram campos PIX manuais
    const instituicoesComApi = ['fastdepix', 'mercado_pago', 'efi_bank'];
    if (instituicoesComApi.includes(tipoIntegracao)) {
      // API gerencia PIX automaticamente - manter campos ocultos
      return;
    }

    // Mostrar/ocultar campos PIX baseado no tipo selecionado (apenas instituicoes manuais)
    const tipoPagamento = $(this).find('input').val();
    if (tipoPagamento === 'PIX') {
      $('#camposPix').removeClass('d-none');
      $('#tipoChavePix, #chavePix').prop('required', true);
    } else {
      $('#camposPix').addClass('d-none');
      $('#tipoChavePix, #chavePix').prop('required', false);
    }
  });

  // ========== Tipo de Conta (MEI) ==========
  $('#tipoConta').on('change', function() {
    if ($(this).val() === 'mei') {
      $('#campoLimiteMei').removeClass('d-none');
      $('#limiteMensal').prop('required', true);
      $('#colDisponivelCriacao').removeClass('d-none');
    } else {
      $('#campoLimiteMei').addClass('d-none');
      $('#limiteMensal').prop('required', false);
      $('#colDisponivelCriacao').addClass('d-none');
    }
  });

  // ========== Exclusao de Forma de Pagamento ==========
  window.confirmarExclusao = function(id, nome) {
    formaPgtoIdExcluir = id;
    $('#nomeFormaPgtoExcluir').text(nome);

    // Resetar estado do modal
    $('#alertClientesAssociados').addClass('d-none');
    $('#loadingClientesCount').removeClass('d-none');
    $('#avisoExclusao').addClass('d-none');
    $('#btnConfirmarExclusao').prop('disabled', true).removeClass('disabled');

    // Mostrar modal
    new bootstrap.Modal(document.getElementById('modalConfirmDelete')).show();

    // Verificar quantidade de clientes associados via API
    $.ajax({
      url: '/api/forma-pagamento/' + id + '/clientes-count/',
      method: 'GET',
      success: function(response) {
        $('#loadingClientesCount').addClass('d-none');
        const count = response.count || 0;

        if (count > 0) {
          // Tem clientes: mostrar alerta e desabilitar botao
          $('#alertClientesAssociados').removeClass('d-none');
          $('#qtdClientesAssociados').text(count);
          $('#btnConfirmarExclusao').prop('disabled', true).addClass('disabled');
          $('#avisoExclusao').addClass('d-none');
        } else {
          // Sem clientes: permitir exclusao
          $('#alertClientesAssociados').addClass('d-none');
          $('#btnConfirmarExclusao').prop('disabled', false).removeClass('disabled');
          $('#avisoExclusao').removeClass('d-none');
        }
      },
      error: function() {
        // Em caso de erro, permitir (backend fara a validacao)
        $('#loadingClientesCount').addClass('d-none');
        $('#alertClientesAssociados').addClass('d-none');
        $('#btnConfirmarExclusao').prop('disabled', false).removeClass('disabled');
        $('#avisoExclusao').removeClass('d-none');
      }
    });
  };

  $('#btnConfirmarExclusao').on('click', function() {
    if (!formaPgtoIdExcluir) return;

    const btn = $(this);
    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...');

    $.ajax({
      url: '/deletar-formapgto/' + formaPgtoIdExcluir + '/',
      method: 'DELETE',
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      },
      success: function(response) {
        bootstrap.Modal.getInstance(document.getElementById('modalConfirmDelete')).hide();
        Swal.fire({
          icon: 'success',
          title: 'Excluido!',
          text: 'Forma de pagamento excluida com sucesso.',
          timer: 1500
        }).then(() => {
          window.location.reload();
        });
      },
      error: function(response) {
        btn.prop('disabled', false).html('<i class="bi bi-trash me-2"></i>Excluir');
        Swal.fire({
          icon: 'error',
          title: 'Nao foi possivel excluir',
          text: response.responseJSON?.error_delete || 'Erro ao excluir forma de pagamento.'
        });
      }
    });
  });

  // ========== Funcao Utilitaria (disponivel para todos) ==========
  function formatarMoedaBR(valor) {
    return 'R$ ' + valor.toLocaleString('pt-BR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  // ========== Modal Instituicoes (Admin) ==========
  {% if request.user.is_staff %}

  // Adicionar nova instituicao
  $('#formNovaInstituicao').on('submit', function(e) {
    e.preventDefault();

    const nome = $('#novaInstituicaoNome').val();
    const tipo = $('#novaInstituicaoTipo').val();

    $.ajax({
      url: '/api/instituicoes-bancarias/criar/',
      method: 'POST',
      data: JSON.stringify({ nome: nome, tipo_integracao: tipo }),
      contentType: 'application/json',
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      },
      success: function(response) {
        Swal.fire({
          icon: 'success',
          title: 'Sucesso!',
          text: 'Instituicao adicionada com sucesso!',
          timer: 1500
        }).then(() => {
          window.location.reload();
        });
      },
      error: function(response) {
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: response.responseJSON?.error || 'Erro ao adicionar instituicao'
        });
      }
    });
  });

  // Toggle status instituicao
  $(document).on('change', '.toggle-instituicao', function() {
    const checkbox = $(this);
    const id = checkbox.data('id');
    const row = checkbox.closest('tr');

    $.ajax({
      url: '/api/instituicoes-bancarias/' + id + '/toggle/',
      method: 'POST',
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      },
      success: function(response) {
        if (response.success) {
          row.toggleClass('text-muted', !response.ativo);
          Swal.fire({
            icon: 'success',
            title: response.ativo ? 'Ativada' : 'Desativada',
            text: 'Instituicao ' + (response.ativo ? 'ativada' : 'desativada') + ' com sucesso!',
            toast: true,
            position: 'top-end',
            timer: 2000,
            showConfirmButton: false
          });
        }
      },
      error: function() {
        checkbox.prop('checked', !checkbox.prop('checked'));
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: 'Erro ao alterar status da instituicao'
        });
      }
    });
  });

  // Recarregar pagina ao fechar modal de instituicoes (para atualizar os cards)
  $('#modalInstituicoes').on('hidden.bs.modal', function() {
    window.location.reload();
  });

  // Excluir instituicao
  $(document).on('click', '.btn-excluir-instituicao', function() {
    const id = $(this).data('id');
    const nome = $(this).data('nome');

    Swal.fire({
      title: 'Confirmar exclusao?',
      text: 'Deseja excluir a instituicao "' + nome + '"?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Sim, excluir!',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          url: '/api/instituicoes-bancarias/' + id + '/excluir/',
          method: 'DELETE',
          beforeSend: function(xhr) {
            xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
          },
          success: function(response) {
            Swal.fire({
              icon: 'success',
              title: 'Excluido!',
              text: 'Instituicao excluida com sucesso.',
              timer: 1500
            }).then(() => {
              $('tr[data-id="' + id + '"]').fadeOut(300, function() { $(this).remove(); });
            });
          },
          error: function(response) {
            Swal.fire({
              icon: 'error',
              title: 'Erro',
              text: response.responseJSON?.error || 'Erro ao excluir instituicao'
            });
          }
        });
      }
    });
  });

  // ========== Modal Gerenciar Limites (Admin) ==========
  let configLimiteAtual = {
    valor_anual: 81000,
    margem_seguranca: 10
  };

  // Carregar configuracao atual ao abrir modal
  $('#modalLimites').on('show.bs.modal', function() {
    $.ajax({
      url: '/api/config-limite/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          configLimiteAtual = response.config;
          $('#limiteValorAnual').val(response.config.valor_anual);
          $('#limiteMargem').val(response.config.margem_seguranca);
          atualizarDisplayLimites();
        }
      },
      error: function() {
        // Usar valores padrao
        atualizarDisplayLimites();
      }
    });
  });

  // Atualizar display ao alterar valores
  $('#limiteValorAnual, #limiteMargem').on('input', function() {
    atualizarDisplayLimites();
  });

  function atualizarDisplayLimites() {
    const valorAnual = parseFloat($('#limiteValorAnual').val()) || 81000;
    const margem = parseInt($('#limiteMargem').val()) || 10;
    const percentAlerta = 100 - margem;

    const valorAlerta = valorAnual * (percentAlerta / 100);
    const valorBloqueio = valorAnual * 0.99;

    $('#valorAlertaDisplay').text(formatarMoedaBR(valorAlerta));
    $('#valorBloqueioDisplay').text(formatarMoedaBR(valorBloqueio));
    $('#percentAlerta').text(percentAlerta);
  }

  // Salvar configuracao
  $('#btnSalvarLimite').on('click', function() {
    const valorAnual = parseFloat($('#limiteValorAnual').val());
    const margem = parseInt($('#limiteMargem').val());

    if (!valorAnual || valorAnual <= 0) {
      Swal.fire({
        icon: 'error',
        title: 'Erro',
        text: 'Informe um valor anual valido.'
      });
      return;
    }

    if (margem < 0 || margem > 50) {
      Swal.fire({
        icon: 'error',
        title: 'Erro',
        text: 'Margem de seguranca deve ser entre 0 e 50%.'
      });
      return;
    }

    $.ajax({
      url: '/api/config-limite/atualizar/',
      method: 'POST',
      data: JSON.stringify({
        valor_anual: valorAnual,
        margem_seguranca: margem
      }),
      contentType: 'application/json',
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      },
      success: function(response) {
        if (response.success) {
          Swal.fire({
            icon: 'success',
            title: 'Sucesso!',
            text: 'Configuracao de limite atualizada com sucesso!',
            timer: 1500
          }).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('modalLimites')).hide();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: response.error || 'Erro ao salvar configuracao.'
          });
        }
      },
      error: function(xhr) {
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: xhr.responseJSON?.error || 'Erro ao salvar configuracao.'
        });
      }
    });
  });

  {% endif %}

  // ========== Modal Ver Detalhes ==========
  let formaPgtoIdAtual = null;

  $(document).on('click', '.btn-ver-detalhes', function() {
    const id = $(this).data('id');
    formaPgtoIdAtual = id;

    // Mostrar loading, esconder conteudo
    $('#detalhesLoading').removeClass('d-none');
    $('#detalhesConteudo').addClass('d-none');

    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalVerDetalhes')).show();

    // Buscar detalhes via API
    $.ajax({
      url: '/api/forma-pagamento/' + id + '/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          preencherModalDetalhes(response);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: response.error || 'Erro ao carregar detalhes.'
          });
          bootstrap.Modal.getInstance(document.getElementById('modalVerDetalhes')).hide();
        }
      },
      error: function(xhr) {
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: xhr.responseJSON?.error || 'Erro ao carregar detalhes.'
        });
        bootstrap.Modal.getInstance(document.getElementById('modalVerDetalhes')).hide();
      }
    });
  });

  function preencherModalDetalhes(data) {
    const forma = data.forma_pgto;
    const conta = data.conta_bancaria;
    const inst = data.instituicao;

    // Resetar visibilidade dos containers para evitar dados de requisicoes anteriores
    $('#detalhesPixContainer').addClass('d-none');
    $('#detalhesApiContainer').addClass('d-none');
    $('#detalhesLimiteMeiContainer').addClass('d-none');
    $('#detalhesBeneficiarioContainer').removeClass('d-none'); // Mostrar por padrao, ocultar se for API

    // Resetar TODOS os valores de texto para evitar dados de requisicoes anteriores
    $('#detalhesNome').text('-');
    $('#detalhesNomeIdentificacao').text('-');
    $('#detalhesBeneficiario').text('-');
    $('#detalhesTipoConta').text('-');
    $('#detalhesLimiteMei').text('-');
    $('#detalhesTipoChavePix').text('-');
    $('#detalhesChavePix').text('-');
    $('#detalhesIntegracao').text('-');
    $('#detalhesAmbiente').text('-');
    $('#detalhesApiKey').text('-');
    $('#detalhesClientId').text('-');
    $('#detalhesInstituicaoBadge').html('');
    $('#detalhesIcone').html('');

    // Icone do tipo de pagamento
    let iconeHtml = '';
    if (forma.nome.toUpperCase().includes('PIX')) {
      iconeHtml = '<img src="{% static 'assets/images/svg/pix.png' %}" width="48" height="48">';
    } else if (forma.nome.toUpperCase().includes('CART')) {
      iconeHtml = '<i class="bi bi-credit-card text-warning" style="font-size: 3rem;"></i>';
    } else if (forma.nome.toUpperCase().includes('BOLETO')) {
      iconeHtml = '<i class="bi bi-upc-scan text-danger" style="font-size: 3rem;"></i>';
    } else {
      iconeHtml = '<i class="bi bi-wallet2 text-success" style="font-size: 3rem;"></i>';
    }
    $('#detalhesIcone').html(iconeHtml);

    // Nome e badge
    $('#detalhesNome').text(forma.nome + (conta ? ' - ' + conta.nome_identificacao : ''));

    let badgeClass = 'manual';
    let badgeIcon = 'bi-building';
    let badgeText = inst ? inst.nome : 'Manual';

    if (inst) {
      if (inst.tipo_integracao === 'fastdepix') {
        badgeClass = 'fastdepix';
        badgeIcon = 'bi-lightning-charge-fill';
        badgeText = 'FastDePix';
      } else if (inst.tipo_integracao === 'mercado_pago') {
        badgeClass = 'mercado-pago';
        badgeIcon = 'bi-shop';
        badgeText = 'Mercado Pago';
      } else if (inst.tipo_integracao === 'efi_bank') {
        badgeClass = 'efi-bank';
        badgeIcon = 'bi-bank';
        badgeText = 'Efi Bank';
      }
    }
    $('#detalhesInstituicaoBadge').html(
      '<span class="instituicao-badge ' + badgeClass + '">' +
        '<i class="bi ' + badgeIcon + '"></i> ' + badgeText +
      '</span>'
    );

    // Dados da conta
    if (conta) {
      $('#detalhesNomeIdentificacao').text(conta.nome_identificacao || '-');
      $('#detalhesBeneficiario').text(conta.beneficiario || '-');
      $('#detalhesTipoConta').text(conta.tipo_conta_display || '-');

      if (conta.tipo_conta === 'mei' && conta.limite_mensal) {
        $('#detalhesLimiteMeiContainer').removeClass('d-none');
        $('#detalhesLimiteMei').text('R$ ' + conta.limite_mensal.toLocaleString('pt-BR', {minimumFractionDigits: 2}));
      } else {
        $('#detalhesLimiteMeiContainer').addClass('d-none');
      }

      // Dados PIX (apenas para instituicoes manuais - APIs gerenciam isso internamente)
      const isManualInst = !inst || inst.tipo_integracao === 'manual';
      if (forma.nome.toUpperCase().includes('PIX') && isManualInst && conta.chave_pix) {
        $('#detalhesPixContainer').removeClass('d-none');
        $('#detalhesTipoChavePix').text(conta.tipo_chave_pix_display || '-');
        $('#detalhesChavePix').text(conta.chave_pix || '-');
      }
      // Se nao atende as condicoes, o container ja esta oculto pelo reset inicial

      // Ocultar Beneficiário para Boleto e Cartão (não usam esses campos)
      const nomeFormaUpperDetalhes = forma.nome.toUpperCase();
      const isBoletoOuCartaoDetalhes = nomeFormaUpperDetalhes.includes('BOLETO') || nomeFormaUpperDetalhes.includes('CART');
      if (isBoletoOuCartaoDetalhes) {
        $('#detalhesBeneficiarioContainer').addClass('d-none');
      }

      // Dados API (apenas para instituicoes com integracao)
      if (inst && inst.tipo_integracao !== 'manual') {
        // Para instituicoes com API, ocultar campos que sao gerenciados pela API
        $('#detalhesBeneficiarioContainer').addClass('d-none');

        $('#detalhesApiContainer').removeClass('d-none');
        $('#detalhesIntegracao').text(badgeText);
        $('#detalhesAmbiente').html('<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Producao</span>');

        // Mostrar campos de credenciais conforme integracao
        if (inst.tipo_integracao === 'fastdepix') {
          $('#detalhesApiKeyContainer').removeClass('d-none');
          $('#detalhesClientIdContainer').addClass('d-none');
          $('#detalhesApiKey').html(conta.has_api_key
            ? '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Configurada</span>'
            : '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Nao configurada</span>'
          );
        } else {
          $('#detalhesApiKeyContainer').addClass('d-none');
          $('#detalhesClientIdContainer').removeClass('d-none');
          $('#detalhesClientId').html(conta.has_client_id
            ? '<span class="text-success"><i class="bi bi-check-circle me-1"></i>Configurado</span>'
            : '<span class="text-danger"><i class="bi bi-x-circle me-1"></i>Nao configurado</span>'
          );
        }
      } else {
        $('#detalhesApiContainer').addClass('d-none');
      }
    }

    // Esconder loading, mostrar conteudo
    $('#detalhesLoading').addClass('d-none');
    $('#detalhesConteudo').removeClass('d-none');
  }

  // Botao Editar no modal de detalhes
  $('#btnEditarFromDetalhes').on('click', function() {
    bootstrap.Modal.getInstance(document.getElementById('modalVerDetalhes')).hide();
    setTimeout(() => {
      abrirModalEditar(formaPgtoIdAtual);
    }, 300);
  });

  // ========== Modal Editar ==========
  $(document).on('click', '.btn-editar', function() {
    const id = $(this).data('id');
    abrirModalEditar(id);
  });

  function abrirModalEditar(id) {
    formaPgtoIdAtual = id;

    // Mostrar loading, esconder formulario
    $('#editarLoading').removeClass('d-none');
    $('#formEditar').addClass('d-none');

    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalEditar')).show();

    // Buscar detalhes via API
    $.ajax({
      url: '/api/forma-pagamento/' + id + '/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          preencherModalEditar(response);
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: response.error || 'Erro ao carregar dados.'
          });
          bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
        }
      },
      error: function(xhr) {
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: xhr.responseJSON?.error || 'Erro ao carregar dados.'
        });
        bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
      }
    });
  }

  // Variáveis para o modal de edição
  let editarClientesSelecionados = new Set();
  let editarClientesParaTransferir = new Set();  // Clientes a serem transferidos de outras contas
  let editarClientesDisponiveis = [];
  let editarClientesOrdenados = [];  // Lista ordenada por valor anual para o slider
  let editarLimiteMeiGlobal = 81000;
  let editarValorTotalSelecionado = 0;
  let editarTipoIntegracaoAtual = 'manual';
  let editarTipoContaAtual = 'pf';
  let editarFormaPgtoIdAtual = null;  // ID da forma de pagamento sendo editada
  let editarFormaPgtoAntiga = false;  // Se é forma de pagamento antiga (sem conta bancária)

  function preencherModalEditar(data) {
    const forma = data.forma_pgto;
    const conta = data.conta_bancaria;
    const inst = data.instituicao;

    // Resetar variáveis
    editarClientesSelecionados = new Set();
    editarClientesParaTransferir = new Set();
    editarClientesOrdenados = [];
    editarValorTotalSelecionado = 0;
    editarFormaPgtoIdAtual = forma.id;
    editarFormaPgtoAntiga = !conta;  // Forma antiga se não tem conta bancária

    // Resetar campo de busca
    $('#buscaClienteEditar').val('');

    // ===== RESET COMPLETO DE TODOS OS CAMPOS =====
    // Inputs de texto
    $('#editarNomeIdentificacao').val('');
    $('#editarBeneficiario').val('');
    $('#editarTipoChavePix').val('');
    $('#editarChavePix').val('');
    $('#editarApiKey').val('');
    $('#editarClientId').val('');
    $('#editarClientSecret').val('');
    $('#editarAccessToken').val('');

    // Selects - restaurar opções padrão
    $('#editarTipoConta').html('<option value="pf">Pessoa Física</option><option value="mei">MEI</option>');
    $('#editarTipoConta').val('pf').prop('disabled', false);
    $('#editarTipoContaHint').addClass('d-none');
    editarTipoContaAtual = 'pf';

    // Containers - ocultar todos por padrão
    $('#editarBeneficiarioContainer').addClass('d-none');
    $('#editarPixContainer').addClass('d-none');
    $('#editarApiContainer').addClass('d-none');
    $('#editarClientesContainer').addClass('d-none');
    $('#editarLimiteMeiContainer').addClass('d-none');
    $('#editarFastDePixFields, #editarMercadoPagoFields, #editarEfiBankFields').addClass('d-none');
    $('#editarAlertSemConta').addClass('d-none');
    $('#editarAlertInstituicao').addClass('d-none'); // Será mostrado conforme o caso
    $('#editarDadosBancariosContainer').addClass('d-none');
    $('#editarCamposContaBancaria').removeClass('d-none'); // Mostrar por padrão
    $('#editarNomeIdentificacao').prop('required', true); // Restaurar required por padrão

    // Resetar campos de dados bancarios (formas antigas)
    $('#editarNomeIdentificacaoDados').val('');
    $('#editarTipoContaDados').val('pf');
    $('#editarTipoPagamento').val('PIX');
    $('#editarInstituicaoDados').val('');
    $('#editarBeneficiarioDados').val('');
    $('#editarTipoChaveDados').val('');
    $('#editarChavePixDados').val('');

    // Limpar lista de clientes
    $('#editarListaClientes').html('');
    $('#editarTotalSelecionados').text('0');
    $('#editarTotalValorAnual').text('R$ 0,00');

    // ===== FIM DO RESET =====

    // IDs
    $('#editarFormaPgtoId').val(forma.id);
    $('#editarContaBancariaId').val(conta ? conta.id : '');

    // Tipo de integração
    editarTipoIntegracaoAtual = inst ? inst.tipo_integracao : 'manual';
    $('#editarTipoIntegracao').val(editarTipoIntegracaoAtual);

    // Header com cor da instituição
    $('#editarAlertInstituicao').removeClass('fastdepix mercado_pago efi_bank manual').addClass(editarTipoIntegracaoAtual);
    $('#editarNomeInstituicao').text(inst ? inst.nome : 'Outra');

    // Instituições com API
    const instituicoesComApi = ['fastdepix', 'mercado_pago', 'efi_bank'];
    const temApi = instituicoesComApi.includes(editarTipoIntegracaoAtual);

    // Dados básicos
    if (conta) {
      // Garantir que o header da instituição esteja visível
      $('#editarAlertInstituicao').removeClass('d-none');

      $('#editarNomeIdentificacao').val(conta.nome_identificacao);
      $('#editarBeneficiario').val(conta.beneficiario || '');
      editarTipoContaAtual = conta.tipo_conta || 'pf';
      $('#editarTipoConta').val(editarTipoContaAtual);

      // Configurar select de Tipo de Conta por instituição
      if (editarTipoIntegracaoAtual === 'fastdepix') {
        // FastDePix: apenas Pessoa Física
        $('#editarTipoConta').html('<option value="pf">Pessoa Física</option>');
        $('#editarTipoConta').val('pf').prop('disabled', true);
        $('#editarTipoContaHint').removeClass('d-none');
        editarTipoContaAtual = 'pf';
      } else {
        // Outras instituições: PF e MEI
        $('#editarTipoConta').html('<option value="pf">Pessoa Física</option><option value="mei">MEI</option>');
        $('#editarTipoConta').val(editarTipoContaAtual).prop('disabled', false);
        $('#editarTipoContaHint').addClass('d-none');
      }

      // Beneficiário e PIX: ocultar para APIs e para Boleto/Cartão
      const nomeFormaUpper = forma.nome.toUpperCase();
      const isBoletoOuCartao = nomeFormaUpper.includes('BOLETO') || nomeFormaUpper.includes('CART');

      if (temApi || isBoletoOuCartao) {
        $('#editarBeneficiarioContainer').addClass('d-none');
        $('#editarPixContainer').addClass('d-none');
      } else {
        $('#editarBeneficiarioContainer').removeClass('d-none');
        // PIX: mostrar apenas se for PIX
        if (nomeFormaUpper.includes('PIX')) {
          $('#editarPixContainer').removeClass('d-none');
          $('#editarTipoChavePix').val(conta.tipo_chave_pix || '');
          $('#editarChavePix').val(conta.chave_pix || '');
        } else {
          $('#editarPixContainer').addClass('d-none');
        }
      }

      // Limite MEI: apenas display informativo
      atualizarExibicaoLimiteMeiEditar();

      // Clientes Associados: mostrar para APIs
      if (temApi) {
        $('#editarClientesContainer').removeClass('d-none');
        carregarClientesParaEdicao(forma.id);
      } else {
        $('#editarClientesContainer').addClass('d-none');
      }

      // Campos de API
      $('#editarFastDePixFields, #editarMercadoPagoFields, #editarEfiBankFields').addClass('d-none');

      if (temApi) {
        $('#editarApiContainer').removeClass('d-none');

        if (editarTipoIntegracaoAtual === 'fastdepix') {
          $('#editarFastDePixFields').removeClass('d-none');
          $('#editarApiKey').val('');
        } else if (editarTipoIntegracaoAtual === 'mercado_pago') {
          $('#editarMercadoPagoFields').removeClass('d-none');
        } else if (editarTipoIntegracaoAtual === 'efi_bank') {
          $('#editarEfiBankFields').removeClass('d-none');
        }
      } else {
        $('#editarApiContainer').addClass('d-none');
      }

      // Carregar limite global
      carregarLimiteGlobalEditar();
    } else {
      // ===== FORMA DE PAGAMENTO ANTIGA (SEM CONTA BANCÁRIA) =====
      // Mostrar alerta informativo
      $('#editarAlertSemConta').removeClass('d-none');

      // Mostrar instituição com o nome da forma de pagamento
      $('#editarAlertInstituicao').removeClass('d-none fastdepix mercado_pago efi_bank').addClass('manual');
      $('#editarNomeInstituicao').text(forma.nome);

      // Ocultar TODOS os campos de conta bancária (não aplicável para formas antigas)
      $('#editarCamposContaBancaria').addClass('d-none');
      $('#editarBeneficiarioContainer').addClass('d-none');
      $('#editarPixContainer').addClass('d-none');
      $('#editarApiContainer').addClass('d-none');
      // Remover required dos campos ocultos para evitar validação do navegador
      $('#editarNomeIdentificacao').prop('required', false);

      // Definir tipo de integração como manual
      editarTipoIntegracaoAtual = 'manual';
      $('#editarTipoIntegracao').val('manual');

      // ===== MOSTRAR E PREENCHER DADOS BANCARIOS =====
      $('#editarDadosBancariosContainer').removeClass('d-none');

      // Preencher nome de identificação e tipo de conta
      $('#editarNomeIdentificacaoDados').val(forma.nome_identificacao || forma.nome || '');
      $('#editarTipoContaDados').val(forma.tipo_conta || 'pf');

      // Selecionar tipo de pagamento atual
      $('#editarTipoPagamento').val(forma.nome);

      // Ocultar Beneficiário e PIX para Boleto e Cartão
      const tipoPgtoUpper = forma.nome.toUpperCase();
      const isBoletoOuCartaoDados = tipoPgtoUpper.includes('BOLETO') || tipoPgtoUpper.includes('CART');
      if (isBoletoOuCartaoDados) {
        $('#editarBeneficiarioDadosContainer').addClass('d-none');
        $('#editarTipoChaveDadosContainer').addClass('d-none');
        $('#editarChavePixDadosContainer').addClass('d-none');
      } else {
        $('#editarBeneficiarioDadosContainer').removeClass('d-none');
        $('#editarTipoChaveDadosContainer').removeClass('d-none');
        $('#editarChavePixDadosContainer').removeClass('d-none');
      }

      // Preencher dados bancarios se existirem
      const db = data.dados_bancarios;
      if (db) {
        $('#editarInstituicaoDados').val(db.instituicao || '');
        $('#editarBeneficiarioDados').val(db.beneficiario || '');
        $('#editarTipoChaveDados').val(db.tipo_chave || '');
        $('#editarChavePixDados').val(db.chave || '');
      } else {
        // Limpar campos se nao houver dados bancarios
        $('#editarInstituicaoDados').val('');
        $('#editarBeneficiarioDados').val('');
        $('#editarTipoChaveDados').val('');
        $('#editarChavePixDados').val('');
      }

      // Mostrar seção de Clientes Associados para formas antigas
      $('#editarClientesContainer').removeClass('d-none');
      // Para formas antigas: ocultar MEI, mostrar PF (sem limite)
      $('#editarAlertLimiteMei').addClass('d-none');
      $('#editarAlertPessoaFisica').removeClass('d-none');
      $('#colDisponivelEdicao').addClass('d-none');  // Ocultar "Disponível" (só MEI tem)
      // Carregar clientes
      carregarClientesParaEdicao(forma.id);
    }

    // Esconder loading, mostrar formulário
    $('#editarLoading').addClass('d-none');
    $('#formEditar').removeClass('d-none');
  }

  function atualizarExibicaoLimiteMeiEditar() {
    if (editarTipoContaAtual === 'mei') {
      $('#editarLimiteMeiContainer').removeClass('d-none');
      $('#editarAlertLimiteMei').removeClass('d-none');
      $('#editarAlertPessoaFisica').addClass('d-none');
      $('#colDisponivelEdicao').removeClass('d-none');
    } else {
      $('#editarLimiteMeiContainer').addClass('d-none');
      $('#editarAlertLimiteMei').addClass('d-none');
      $('#editarAlertPessoaFisica').removeClass('d-none');
      $('#colDisponivelEdicao').addClass('d-none');
    }
    atualizarResumoClientesEditar();
  }

  function carregarLimiteGlobalEditar() {
    $.ajax({
      url: '/api/config-limite/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          editarLimiteMeiGlobal = response.config.valor_anual;
          $('#editarLimiteValor').text(formatarMoedaBR(editarLimiteMeiGlobal));
          $('#editarLimiteTotalDisplay').text(formatarMoedaBR(editarLimiteMeiGlobal));
          $('#editarValorDisponivel').text(formatarMoedaBR(editarLimiteMeiGlobal - editarValorTotalSelecionado));
        }
      },
      error: function(xhr, status, error) {
        // Usar limite padrão em caso de erro
        console.warn('Erro ao carregar config limite para edição, usando padrão:', error);
        editarLimiteMeiGlobal = 81000;
        $('#editarLimiteValor').text(formatarMoedaBR(editarLimiteMeiGlobal));
        $('#editarLimiteTotalDisplay').text(formatarMoedaBR(editarLimiteMeiGlobal));
        $('#editarValorDisponivel').text(formatarMoedaBR(editarLimiteMeiGlobal - editarValorTotalSelecionado));
      }
    });
  }

  function carregarClientesParaEdicao(formaPgtoId) {
    $('#editarListaClientes').html(`
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          <i class="bi bi-hourglass-split me-2"></i>Carregando clientes...
        </td>
      </tr>
    `);

    $.ajax({
      url: '/api/clientes-ativos-associacao/',
      method: 'GET',
      data: { forma_pgto_id: formaPgtoId },
      success: function(response) {
        if (response.success) {
          editarClientesDisponiveis = response.clientes;
          // Ordenar por valor anual (maior primeiro) para o slider
          editarClientesOrdenados = [...response.clientes].sort((a, b) => (b.valor_anual || 0) - (a.valor_anual || 0));
          renderizarListaClientesEditar(response.clientes);
          // Posicionar slider baseado nos clientes já associados
          atualizarSliderEditar();
        }
      },
      error: function() {
        $('#editarListaClientes').html(`
          <tr>
            <td colspan="5" class="text-center text-danger py-4">
              <i class="bi bi-exclamation-triangle me-2"></i>Erro ao carregar clientes
            </td>
          </tr>
        `);
      }
    });
  }

  function renderizarListaClientesEditar(clientes, filtro = '', preservarSelecao = false) {
    const tbody = $('#editarListaClientes');
    tbody.empty();

    // Filtrar por nome se houver filtro
    let clientesFiltrados = clientes;
    if (filtro) {
      const filtroLower = filtro.toLowerCase();
      clientesFiltrados = clientes.filter(c => c.nome.toLowerCase().includes(filtroLower));
    }

    if (clientesFiltrados.length === 0) {
      tbody.html(`
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            ${filtro ? 'Nenhum cliente encontrado com esse nome' : 'Nenhum cliente disponível'}
          </td>
        </tr>
      `);
      return;
    }

    // Primeira renderização: calcular valores iniciais (não resetar se preservarSelecao = true)
    if (!filtro && !preservarSelecao) {
      editarClientesSelecionados = new Set();
      editarClientesParaTransferir = new Set();
      editarValorTotalSelecionado = 0;
    }

    clientesFiltrados.forEach(cliente => {
      const isAssociadoEstaConta = cliente.ja_associado_esta_conta;
      const bloqueado = cliente.bloqueado;
      const valorAnual = cliente.valor_anual || 0;
      const valorPlano = cliente.valor_plano || 0;
      const pagamentosAno = cliente.pagamentos_ano || 12;
      const plano = cliente.plano || '-';

      // Se está associado a esta conta, adicionar à seleção (apenas na primeira renderização)
      if (isAssociadoEstaConta && !filtro && !preservarSelecao) {
        editarClientesSelecionados.add(cliente.id);
        editarValorTotalSelecionado += valorAnual;
      }

      // Verificar se já foi marcado para transferência
      const isParaTransferir = editarClientesParaTransferir.has(cliente.id);
      const isSelected = editarClientesSelecionados.has(cliente.id);

      let rowClass = '';
      let checkboxHtml = '';
      let infoAssociacao = '';
      const checked = (isSelected || isParaTransferir) ? 'checked' : '';

      // Badge colorida por tipo de plano
      let badgeClass = 'bg-primary';
      if (plano === 'Anual') badgeClass = 'bg-success';
      else if (plano === 'Semestral') badgeClass = 'bg-info';
      else if (plano === 'Trimestral') badgeClass = 'bg-warning text-dark';
      else if (plano === 'Bimestral') badgeClass = 'bg-secondary';

      // Informações da conta associada
      const contaAssociada = cliente.conta_associada || '';

      if (bloqueado && !isParaTransferir) {
        // Cliente associado a OUTRA conta - mostrar como bloqueado mas permitir transferir
        rowClass = 'blocked-row';
        checkboxHtml = `
          <input type="checkbox" class="form-check-input editar-checkbox-cliente-bloqueado"
                 data-id="${cliente.id}" data-valor-anual="${valorAnual}"
                 data-conta-origem="${contaAssociada}"
                 title="Clique para transferir de: ${contaAssociada || 'outra conta'}">`;
        if (contaAssociada) {
          infoAssociacao = `
            <div class="small text-danger mt-1">
              <i class="bi bi-lock-fill me-1"></i>Associado a: <strong>${contaAssociada}</strong>
            </div>
          `;
        }
      } else if (isParaTransferir) {
        // Cliente marcado para transferência
        rowClass = 'transferencia-pendente selected';
        checkboxHtml = `
          <input type="checkbox" class="form-check-input editar-checkbox-cliente-bloqueado"
                 data-id="${cliente.id}" data-valor-anual="${valorAnual}"
                 data-conta-origem="${contaAssociada}" checked>`;
        infoAssociacao = `
          <div class="small text-primary mt-1">
            <i class="bi bi-arrow-right-circle-fill me-1"></i>
            Será transferido de: <strong>${contaAssociada}</strong>
          </div>
        `;
      } else if (isSelected) {
        // Cliente selecionado (inclui já associados que foram adicionados ao Set na carga inicial)
        rowClass = 'selected';
        checkboxHtml = `<input type="checkbox" class="form-check-input editar-checkbox-cliente" data-id="${cliente.id}" data-valor-anual="${valorAnual}" checked>`;
      } else {
        // Cliente disponível (sem associação)
        checkboxHtml = `<input type="checkbox" class="form-check-input editar-checkbox-cliente" data-id="${cliente.id}" data-valor-anual="${valorAnual}">`;
      }

      // Badge de status do cliente
      const statusBadge = cliente.cancelado
        ? '<span class="badge bg-warning text-dark">Cancelado</span>'
        : '<span class="badge bg-success">Ativo</span>';

      const row = $(`
        <tr class="${rowClass}" data-cliente-id="${cliente.id}" data-bloqueado="${bloqueado}">
          <td>${checkboxHtml}</td>
          <td class="text-center">${statusBadge}</td>
          <td>
            <div class="fw-semibold ${bloqueado && !isParaTransferir ? 'text-muted' : ''}">${cliente.nome}</div>
            <small class="text-muted">${cliente.telefone || ''}</small>
            ${infoAssociacao}
          </td>
          <td>
            <span class="badge ${badgeClass} ${bloqueado && !isParaTransferir ? 'opacity-50' : ''}">${plano}</span>
            <small class="text-muted d-block">${formatarMoedaBR(valorPlano)} × ${pagamentosAno}/ano</small>
          </td>
          <td class="text-end">
            <span class="${bloqueado && !isParaTransferir ? 'text-muted' : 'text-success'} fw-semibold">${formatarMoedaBR(valorAnual)}</span>
            <small class="text-muted d-block">projetado/ano</small>
          </td>
        </tr>
      `);

      tbody.append(row);
    });

    if (!filtro) {
      $('#editarClientesCount').text(editarClientesSelecionados.size + editarClientesParaTransferir.size);
      atualizarResumoClientesEditar();
      // Não chamar atualizarSliderEditar() aqui - chamado separadamente quando necessário
    }
  }

  function atualizarSliderEditar() {
    // Total de clientes selecionáveis (não bloqueados)
    const clientesSelecionaveis = editarClientesOrdenados.filter(c => !c.bloqueado);
    const totalSelecionaveis = clientesSelecionaveis.length;

    // Total de selecionados (incluindo já associados + novos + transferências)
    const totalSelecionados = editarClientesSelecionados.size + editarClientesParaTransferir.size;

    // Percentual baseado em selecionados / total de selecionáveis
    const percentual = totalSelecionaveis > 0 ? (totalSelecionados / totalSelecionaveis) * 100 : 0;

    if (editarTipoContaAtual === 'mei') {
      $('#sliderClientesMeiEditar').val(Math.min(percentual, 99));
      atualizarSliderVisualEditar('#sliderClientesMeiEditar', percentual, 'mei');
      $('#sliderValueDisplayMeiEditar').text(`${totalSelecionados} cliente(s) selecionado(s)`);
    } else {
      $('#sliderClientesPfEditar').val(percentual);
      atualizarSliderVisualEditar('#sliderClientesPfEditar', percentual, 'pf');
      $('#sliderValueDisplayPfEditar').text(`${totalSelecionados} cliente(s) selecionado(s)`);
    }
  }

  function atualizarSliderVisualEditar(selector, percentual, tipo) {
    const slider = $(selector);
    if (tipo === 'mei') {
      slider.removeClass('slider-warning slider-danger');
      let cor = '#0d6efd';
      if (percentual >= 90) {
        slider.addClass('slider-danger');
        cor = '#dc3545';
      } else if (percentual >= 70) {
        slider.addClass('slider-warning');
        cor = '#ffc107';
      }
      slider.css('background', `linear-gradient(to right, ${cor} ${percentual}%, #e9ecef ${percentual}%)`);
    } else {
      slider.css('background', `linear-gradient(to right, #198754 ${percentual}%, #e9ecef ${percentual}%)`);
    }
  }

  function atualizarResumoClientesEditar() {
    const totalSelecionados = editarClientesSelecionados.size + editarClientesParaTransferir.size;
    $('#editarTotalSelecionados').text(totalSelecionados);
    $('#editarTotalValorAnual').text(formatarMoedaBR(editarValorTotalSelecionado));
    $('#editarClientesCount').text(totalSelecionados);

    // Atualizar contador de transferências
    const totalTransferencias = editarClientesParaTransferir.size;
    $('#editarTotalTransferencias').text(totalTransferencias);
    if (totalTransferencias > 0) {
      $('#colTransferenciasEdicao').removeClass('d-none');
    } else {
      $('#colTransferenciasEdicao').addClass('d-none');
    }

    if (editarTipoContaAtual === 'mei') {
      const percentual = editarLimiteMeiGlobal > 0 ? (editarValorTotalSelecionado / editarLimiteMeiGlobal) * 100 : 0;
      $('#editarValorUtilizado').text(formatarMoedaBR(editarValorTotalSelecionado));
      $('#editarPercentualUtilizado').text(percentual.toFixed(1));
      $('#editarValorDisponivel').text(formatarMoedaBR(editarLimiteMeiGlobal - editarValorTotalSelecionado));
    } else {
      $('#editarValorTotalPf').text(formatarMoedaBR(editarValorTotalSelecionado));
    }

    // Atualizar campos hidden
    $('#editarClientesAssociados').val(Array.from(editarClientesSelecionados).join(','));
    $('#editarClientesParaTransferir').val(Array.from(editarClientesParaTransferir).join(','));
  }

  // Handler para checkbox de cliente na edição (clientes disponíveis)
  $(document).on('change', '.editar-checkbox-cliente', function() {
    const clienteId = parseInt($(this).data('id'));
    const valorAnual = parseFloat($(this).data('valor-anual')) || 0;
    const row = $(this).closest('tr');

    if ($(this).is(':checked')) {
      // Verificar limite MEI
      if (editarTipoContaAtual === 'mei') {
        const novoTotal = editarValorTotalSelecionado + valorAnual;
        const percentual = (novoTotal / editarLimiteMeiGlobal) * 100;

        if (percentual >= 99) {
          Swal.fire({
            icon: 'warning',
            title: 'Limite Atingido',
            text: 'Você atingiu 99% do limite MEI.'
          });
          $(this).prop('checked', false);
          return;
        }
      }

      editarClientesSelecionados.add(clienteId);
      editarValorTotalSelecionado += valorAnual;
      row.addClass('selected').removeClass('blocked-row');
    } else {
      editarClientesSelecionados.delete(clienteId);
      editarValorTotalSelecionado -= valorAnual;
      row.removeClass('selected');
    }

    atualizarResumoClientesEditar();
    atualizarSliderEditar();
  });

  // Handler para checkbox de cliente BLOQUEADO na edição (transferências)
  $(document).on('change', '.editar-checkbox-cliente-bloqueado', function() {
    const clienteId = parseInt($(this).data('id'));
    const valorAnual = parseFloat($(this).data('valor-anual')) || 0;
    const contaOrigem = $(this).data('conta-origem');
    const row = $(this).closest('tr');

    if ($(this).is(':checked')) {
      // Verificar limite MEI
      if (editarTipoContaAtual === 'mei') {
        const novoTotal = editarValorTotalSelecionado + valorAnual;
        const percentual = (novoTotal / editarLimiteMeiGlobal) * 100;

        if (percentual >= 99) {
          Swal.fire({
            icon: 'warning',
            title: 'Limite Atingido',
            text: 'Você atingiu 99% do limite MEI.'
          });
          $(this).prop('checked', false);
          return;
        }
      }

      // Confirmar transferência
      Swal.fire({
        icon: 'question',
        title: 'Transferir cliente?',
        html: `Este cliente está associado a <strong>${contaOrigem || 'outra forma de pagamento'}</strong>.<br>Deseja transferi-lo para esta forma de pagamento?`,
        showCancelButton: true,
        confirmButtonText: 'Sim, transferir',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0d6efd'
      }).then((result) => {
        if (result.isConfirmed) {
          editarClientesParaTransferir.add(clienteId);
          editarValorTotalSelecionado += valorAnual;
          row.removeClass('blocked-row').addClass('transferencia-pendente');
          row.find('small.text-warning').html('<i class="bi bi-arrow-right-circle me-1"></i>Será transferido').removeClass('text-warning').addClass('text-primary');
          row.find('td:last span').removeClass('text-muted').addClass('text-success');
          atualizarResumoClientesEditar();
          atualizarSliderEditar();
        } else {
          $(this).prop('checked', false);
        }
      });
    } else {
      // Remover da lista de transferências
      editarClientesParaTransferir.delete(clienteId);
      editarValorTotalSelecionado -= valorAnual;
      row.removeClass('transferencia-pendente').addClass('blocked-row');

      // Buscar info original do cliente
      const cliente = editarClientesDisponiveis.find(c => c.id === clienteId);
      if (cliente) {
        const contaInfo = cliente.conta_associada || 'Outra forma de pagamento';
        row.find('small.text-primary').html(`<i class="bi bi-lock me-1"></i>${contaInfo}`).removeClass('text-primary').addClass('text-warning');
      }
      row.find('td:last span').removeClass('text-success').addClass('text-muted');

      atualizarResumoClientesEditar();
      atualizarSliderEditar();
    }
  });

  // Selecionar todos os clientes na edição
  $('#editarSelectAllClientes').on('change', function() {
    const isChecked = $(this).is(':checked');
    $('.editar-checkbox-cliente:visible').each(function() {
      if ($(this).is(':checked') !== isChecked) {
        $(this).prop('checked', isChecked).trigger('change');
      }
    });
  });

  // Busca de clientes na edição
  $('#buscaClienteEditar').on('input', function() {
    const filtro = $(this).val().trim();
    renderizarListaClientesEditar(editarClientesDisponiveis, filtro);
  });

  // Slider MEI na edição - baseado no TOTAL de clientes selecionáveis
  $('#sliderClientesMeiEditar').on('input', function() {
    const percentualDesejado = parseInt($(this).val());
    // Clientes selecionáveis = não bloqueados
    const clientesSelecionaveis = editarClientesOrdenados.filter(c => !c.bloqueado);
    const quantidadeAlvo = Math.round((percentualDesejado / 100) * clientesSelecionaveis.length);

    // Atualizar display durante arrasto
    $('#sliderValueDisplayMeiEditar').text(`Selecionando ${quantidadeAlvo} cliente(s)...`);

    // Atualizar visual do slider (cor)
    atualizarSliderVisualEditar('#sliderClientesMeiEditar', percentualDesejado, 'mei');

    // Selecionar clientes por quantidade
    selecionarClientesPorQuantidadeEditar(quantidadeAlvo, 'mei');
  });

  // Slider PF na edição - baseado no TOTAL de clientes selecionáveis
  $('#sliderClientesPfEditar').on('input', function() {
    const percentualDesejado = parseInt($(this).val());
    // Clientes selecionáveis = não bloqueados
    const clientesSelecionaveis = editarClientesOrdenados.filter(c => !c.bloqueado);
    const quantidadeAlvo = Math.round((percentualDesejado / 100) * clientesSelecionaveis.length);

    // Atualizar display durante arrasto
    $('#sliderValueDisplayPfEditar').text(`Selecionando ${quantidadeAlvo} cliente(s)...`);

    // Atualizar visual do slider (cor)
    atualizarSliderVisualEditar('#sliderClientesPfEditar', percentualDesejado, 'pf');

    // Selecionar clientes por quantidade
    selecionarClientesPorQuantidadeEditar(quantidadeAlvo, 'pf');
  });

  // Handlers de interação visual para slider MEI na edição
  $('#sliderClientesMeiEditar').on('mousedown touchstart', function() {
    $(this).css('cursor', 'grabbing');
  });

  $('#sliderClientesMeiEditar').on('mouseup touchend', function() {
    $(this).css('cursor', 'grab');
    // Exibir soma: clientes já associados + novos selecionados
    const totalSelecionados = editarClientesSelecionados.size + editarClientesParaTransferir.size;
    $('#sliderValueDisplayMeiEditar').text(`${totalSelecionados} cliente(s) selecionado(s)`);
  });

  // Handlers de interação visual para slider PF na edição
  $('#sliderClientesPfEditar').on('mousedown touchstart', function() {
    $(this).css('cursor', 'grabbing');
  });

  $('#sliderClientesPfEditar').on('mouseup touchend', function() {
    $(this).css('cursor', 'grab');
    // Exibir soma: clientes já associados + novos selecionados
    const totalSelecionados = editarClientesSelecionados.size + editarClientesParaTransferir.size;
    $('#sliderValueDisplayPfEditar').text(`${totalSelecionados} cliente(s) selecionado(s)`);
  });

  // Selecionar/deselecionar cliente ao clicar na linha (edição)
  $(document).on('click', '#editarListaClientes tr', function(e) {
    // Se clicou diretamente no checkbox, deixa o comportamento padrão
    if ($(e.target).is('input[type="checkbox"]')) {
      return;
    }

    const bloqueado = $(this).data('bloqueado') === true || $(this).data('bloqueado') === 'true';
    const clienteId = parseInt($(this).data('cliente-id'));

    // Se linha está bloqueada, oferecer opção de transferência
    if ($(this).hasClass('blocked-row')) {
      const contaAssociada = $(this).find('.text-danger strong').text();
      const clienteNome = $(this).find('.fw-semibold').first().text().trim();
      const valorAnual = parseFloat($(this).find('.editar-checkbox-cliente-bloqueado').data('valor-anual'));

      Swal.fire({
        icon: 'warning',
        title: 'Cliente Já Associado',
        html: `<strong>${clienteNome}</strong> já está associado à:<br><strong class="text-primary">"${contaAssociada}"</strong><br><br>Deseja transferi-lo para esta forma de pagamento?`,
        showCancelButton: true,
        confirmButtonText: '<i class="bi bi-arrow-right-circle me-1"></i> Transferir',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#0d6efd',
        cancelButtonColor: '#6c757d'
      }).then((result) => {
        if (result.isConfirmed) {
          // Verificar limite MEI
          if (editarTipoContaAtual === 'mei') {
            const novoTotal = editarValorTotalSelecionado + valorAnual;
            const percentual = (novoTotal / editarLimiteMeiGlobal) * 100;

            if (percentual >= 99) {
              Swal.fire({
                icon: 'error',
                title: 'Limite Atingido',
                text: 'Adicionar este cliente excederia o limite de 99%. Remova outros clientes primeiro.'
              });
              return;
            }
          }

          // Marcar cliente para transferência
          editarClientesParaTransferir.add(clienteId);
          editarValorTotalSelecionado += valorAnual;

          // Atualizar visual da linha
          const row = $(`#editarListaClientes tr[data-cliente-id="${clienteId}"]`);
          row.removeClass('blocked-row').addClass('selected transferencia-pendente');
          row.find('.editar-checkbox-cliente-bloqueado').prop('checked', true);

          // Atualizar informação de associação
          row.find('.text-danger').html(`
            <i class="bi bi-arrow-right-circle-fill me-1 text-primary"></i>
            <span class="text-primary">Será transferido de: <strong>${contaAssociada}</strong></span>
          `).removeClass('text-danger');

          // Atualizar valor
          row.find('td:last span').removeClass('text-muted').addClass('text-success');

          atualizarResumoClientesEditar();
          atualizarSliderEditar();

          Swal.fire({
            icon: 'success',
            title: 'Cliente Marcado para Transferência',
            html: `<strong>${clienteNome}</strong> será transferido ao salvar esta forma de pagamento.`,
            timer: 2000,
            showConfirmButton: false
          });
        }
      });
      return;
    }

    // Toggle do checkbox da linha
    const checkbox = $(this).find('.editar-checkbox-cliente');
    if (checkbox.length && !checkbox.prop('disabled')) {
      checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
    }
  });

  // Adicionar cursor nas linhas da edição
  $(document).on('mouseenter', '#editarListaClientes tr', function() {
    if ($(this).hasClass('blocked-row')) {
      // Clientes bloqueados: cursor de "não permitido" mas ainda clicável para transferir
      $(this).css('cursor', 'not-allowed');
    } else {
      $(this).css('cursor', 'pointer');
    }
  });

  // Função para selecionar clientes pelo slider
  function selecionarClientesPorPercentualEditar(percentualDesejado, tipo) {
    // Resetar seleções (mantendo transferências)
    editarClientesSelecionados.clear();
    editarValorTotalSelecionado = 0;

    // Recalcular valor de transferências
    editarClientesParaTransferir.forEach(clienteId => {
      const cliente = editarClientesDisponiveis.find(c => c.id === clienteId);
      if (cliente) {
        editarValorTotalSelecionado += cliente.valor_anual || 0;
      }
    });

    // Clientes disponíveis (não bloqueados, ordenados por valor)
    const clientesDisponiveis = editarClientesOrdenados.filter(c => !c.bloqueado && !editarClientesParaTransferir.has(c.id));

    if (tipo === 'mei') {
      // Seleção baseada em valor até atingir o percentual do limite
      const valorLimite = (percentualDesejado / 100) * editarLimiteMeiGlobal;
      let valorAcumulado = editarValorTotalSelecionado;

      for (const cliente of clientesDisponiveis) {
        const valorAnual = cliente.valor_anual || 0;
        if (valorAcumulado + valorAnual <= valorLimite) {
          editarClientesSelecionados.add(cliente.id);
          valorAcumulado += valorAnual;
        }
      }
      editarValorTotalSelecionado = valorAcumulado;
    } else {
      // Seleção baseada em quantidade de clientes
      const qtdDesejada = Math.floor((percentualDesejado / 100) * clientesDisponiveis.length);
      for (let i = 0; i < qtdDesejada && i < clientesDisponiveis.length; i++) {
        const cliente = clientesDisponiveis[i];
        editarClientesSelecionados.add(cliente.id);
        editarValorTotalSelecionado += cliente.valor_anual || 0;
      }
    }

    // Re-renderizar preservando as seleções do slider
    const filtro = $('#buscaClienteEditar').val().trim();
    renderizarListaClientesEditar(editarClientesDisponiveis, filtro, true);
    atualizarResumoClientesEditar();
    // Não chamar atualizarSliderEditar() aqui - deixar o slider na posição do usuário
  }

  // Função para selecionar clientes por QUANTIDADE (slider controla total de selecionados)
  function selecionarClientesPorQuantidadeEditar(quantidadeAlvo, tipo) {
    // Clientes selecionáveis = não bloqueados (ordenados por valor)
    const clientesSelecionaveis = editarClientesOrdenados.filter(c => !c.bloqueado);

    // Limpar seleções anteriores
    editarClientesSelecionados.clear();
    editarValorTotalSelecionado = 0;

    // Selecionar a quantidade de clientes definida pelo slider
    for (let i = 0; i < quantidadeAlvo && i < clientesSelecionaveis.length; i++) {
      const cliente = clientesSelecionaveis[i];
      editarClientesSelecionados.add(cliente.id);
      editarValorTotalSelecionado += cliente.valor_anual || 0;
    }

    // Adicionar valor dos clientes de transferência (se houver)
    editarClientesParaTransferir.forEach(clienteId => {
      const cliente = editarClientesDisponiveis.find(c => c.id === clienteId);
      if (cliente) {
        editarValorTotalSelecionado += cliente.valor_anual || 0;
      }
    });

    // Re-renderizar preservando as seleções
    const filtro = $('#buscaClienteEditar').val().trim();
    renderizarListaClientesEditar(editarClientesDisponiveis, filtro, true);
    atualizarResumoClientesEditar();
  }

  // Tipo de conta change no modal editar
  $('#editarTipoConta').on('change', function() {
    editarTipoContaAtual = $(this).val();
    atualizarExibicaoLimiteMeiEditar();
    atualizarSliderEditar();
  });

  // Tipo de pagamento change no modal de dados legados
  $('#editarTipoPagamento').on('change', function() {
    const tipoPgto = $(this).val().toUpperCase();
    const isBoletoOuCartao = tipoPgto.includes('BOLETO') || tipoPgto.includes('CART');
    if (isBoletoOuCartao) {
      $('#editarBeneficiarioDadosContainer').addClass('d-none');
      $('#editarTipoChaveDadosContainer').addClass('d-none');
      $('#editarChavePixDadosContainer').addClass('d-none');
    } else {
      $('#editarBeneficiarioDadosContainer').removeClass('d-none');
      $('#editarTipoChaveDadosContainer').removeClass('d-none');
      $('#editarChavePixDadosContainer').removeClass('d-none');
    }
  });

  // Salvar edicao
  $('#btnSalvarEdicao').on('click', function() {
    const btn = $(this);
    const instituicoesComApi = ['fastdepix', 'mercado_pago', 'efi_bank'];
    const temApi = instituicoesComApi.includes(editarTipoIntegracaoAtual);

    // Validações - Nome de Identificação
    const nomeIdentificacao = editarFormaPgtoAntiga
      ? $('#editarNomeIdentificacaoDados').val()
      : $('#editarNomeIdentificacao').val();

    if (!nomeIdentificacao) {
      Swal.fire({
        icon: 'warning',
        title: 'Campo obrigatório',
        text: 'Por favor, preencha o Nome de Identificação.'
      });
      return;
    }

    // Validar se há clientes selecionados (obrigatório para TODAS as formas)
    const totalClientes = editarClientesSelecionados.size + editarClientesParaTransferir.size;
    if (totalClientes === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Clientes obrigatórios',
        text: 'É obrigatório manter ao menos um cliente associado à forma de pagamento.'
      });
      return;
    }

    // Ativar loading com pontos animados
    setButtonLoading(btn, true);

    // Coletar dados do formulario
    const dados = {
      nome_identificacao: $('#editarNomeIdentificacao').val(),
      tipo_conta: $('#editarTipoConta').val(),
    };

    // Apenas para instituições manuais: beneficiário e PIX
    if (!temApi) {
      dados.beneficiario = $('#editarBeneficiario').val();
      dados.tipo_chave_pix = $('#editarTipoChavePix').val();
      dados.chave_pix = $('#editarChavePix').val();
    }

    // Clientes associados e transferências (para APIs e formas antigas)
    dados.clientes_associados = Array.from(editarClientesSelecionados).join(',');
    if (editarClientesParaTransferir.size > 0) {
      dados.clientes_para_transferir = Array.from(editarClientesParaTransferir).join(',');
    }

    // ===== DADOS BANCARIOS (para formas antigas) =====
    if (editarFormaPgtoAntiga) {
      dados.nome_identificacao = $('#editarNomeIdentificacaoDados').val();
      dados.tipo_conta = $('#editarTipoContaDados').val();
      dados.tipo_pagamento = $('#editarTipoPagamento').val();
      dados.instituicao = $('#editarInstituicaoDados').val();
      dados.beneficiario = $('#editarBeneficiarioDados').val();
      dados.tipo_chave = $('#editarTipoChaveDados').val();
      dados.chave = $('#editarChavePixDados').val();
    }

    // Credenciais API (apenas se preenchidas)
    const apiKey = $('#editarApiKey').val();
    if (apiKey) dados.api_key = apiKey;

    const clientIdMP = $('#editarClientIdMP').val();
    if (clientIdMP) dados.api_client_id = clientIdMP;

    const clientSecretMP = $('#editarClientSecretMP').val();
    if (clientSecretMP) dados.api_client_secret = clientSecretMP;

    const accessTokenMP = $('#editarAccessTokenMP').val();
    if (accessTokenMP) dados.api_access_token = accessTokenMP;

    const clientIdEfi = $('#editarClientIdEfi').val();
    if (clientIdEfi) dados.api_client_id = clientIdEfi;

    const clientSecretEfi = $('#editarClientSecretEfi').val();
    if (clientSecretEfi) dados.api_client_secret = clientSecretEfi;

    // Determinar URL da API baseado no tipo de forma de pagamento
    const apiUrl = editarFormaPgtoAntiga
      ? '/api/forma-pagamento/' + formaPgtoIdAtual + '/atualizar-antiga/'
      : '/api/forma-pagamento/' + formaPgtoIdAtual + '/atualizar/';

    $.ajax({
      url: apiUrl,
      method: 'POST',
      data: JSON.stringify(dados),
      contentType: 'application/json',
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
      },
      success: function(response) {
        if (response.success) {
          bootstrap.Modal.getInstance(document.getElementById('modalEditar')).hide();
          Swal.fire({
            icon: 'success',
            title: 'Sucesso!',
            text: response.message || 'Forma de pagamento atualizada!',
            timer: 1500
          }).then(() => {
            window.location.reload();
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Erro',
            text: response.error || 'Erro ao salvar alterações.'
          });
          setButtonLoading(btn, false, '<i class="bi bi-check-circle me-2"></i>Salvar Alterações');
        }
      },
      error: function(xhr) {
        Swal.fire({
          icon: 'error',
          title: 'Erro',
          text: xhr.responseJSON?.error || 'Erro ao salvar alterações.'
        });
        setButtonLoading(btn, false, '<i class="bi bi-check-circle me-2"></i>Salvar Alterações');
      }
    });
  });

  // ========== Handler de Submit do Formulário ==========
  // ========== Configuracao de Cobrancas FastDePix ==========
  let planosUsuario = [];

  // Carregar planos quando FastDePix é selecionado
  function carregarPlanosParaLinks() {
    $('#listaLinksPlanos').html(`
      <div class="text-center text-muted py-3">
        <div class="spinner-border spinner-border-sm me-2"></div>
        Carregando planos...
      </div>
    `);

    $.ajax({
      url: '/api/planos/',
      method: 'GET',
      success: function(response) {
        if (response.success) {
          planosUsuario = response.planos;
          renderizarLinksPlanos();
        } else {
          $('#listaLinksPlanos').html(`
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Erro ao carregar planos.
            </div>
          `);
        }
      },
      error: function() {
        $('#listaLinksPlanos').html(`
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Erro ao carregar planos. Verifique sua conexao.
          </div>
        `);
      }
    });
  }

  // Renderizar lista de planos com campos de link
  function renderizarLinksPlanos() {
    const container = $('#listaLinksPlanos');
    container.empty();

    if (planosUsuario.length === 0) {
      container.html(`
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Nenhum Plano de Adesao cadastrado.
          <a href="/planos/" class="alert-link">Cadastre planos primeiro</a>.
        </div>
      `);
      return;
    }

    // Verificar se há planos com valor divergente
    const planosDivergentes = planosUsuario.filter(p => p.link_valor_divergente);
    if (planosDivergentes.length > 0) {
      container.append(`
        <div class="alert alert-warning mb-3">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Atencao!</strong> ${planosDivergentes.length} plano(s) tiveram o valor alterado desde a configuracao do link.
          Verifique se os links estao com os valores corretos.
        </div>
      `);
    }

    // Criar container com info
    container.append(`
      <div class="alert alert-info mb-3">
        <i class="bi bi-info-circle me-2"></i>
        Configure um link FastDePix para cada Plano de Adesao.
        <strong>Todos os links sao obrigatorios.</strong>
      </div>
    `);

    planosUsuario.forEach(plano => {
      const valorFormatado = parseFloat(plano.valor).toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      // Verificar se já tem link configurado
      const linkExistente = plano.link_url || '';
      const valorDivergente = plano.link_valor_divergente || false;

      // Alerta de valor divergente
      let alertaDivergente = '';
      if (valorDivergente) {
        const valorAnterior = parseFloat(plano.link_valor_configurado).toLocaleString('pt-BR', {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        });
        alertaDivergente = `
          <div class="alert alert-warning py-1 px-2 mt-2 mb-0 small">
            <i class="bi bi-exclamation-triangle me-1"></i>
            Valor alterado: era R$ ${valorAnterior}, agora e R$ ${valorFormatado}. Verifique o link!
          </div>
        `;
      }

      container.append(`
        <div class="row align-items-center mb-3 pb-3 border-bottom ${valorDivergente ? 'bg-warning bg-opacity-10' : ''}">
          <div class="col-md-4">
            <strong>${plano.nome}</strong>
            <small class="text-muted d-block">${plano.telas} tela(s) - R$ ${valorFormatado}</small>
            ${valorDivergente ? '<span class="badge bg-warning text-dark mt-1"><i class="bi bi-exclamation-triangle me-1"></i>Valor alterado</span>' : ''}
          </div>
          <div class="col-md-8">
            <input type="url" class="form-control link-plano-fastdepix ${valorDivergente ? 'border-warning' : ''}"
                   data-plano-id="${plano.id}"
                   data-plano-nome="${plano.nome}"
                   placeholder="https://app.fastdepix.com.br/..."
                   name="link_plano_${plano.id}"
                   value="${linkExistente}">
            ${alertaDivergente}
          </div>
        </div>
      `);
    });
  }

  // Toggle visibilidade do container de links conforme tipo de cobranca
  $('input[name="tipoCobrancaFastDePix"]').on('change', function() {
    if (this.value === 'link_fastdepix') {
      $('#containerLinksPlanos').removeClass('d-none');
    } else {
      $('#containerLinksPlanos').addClass('d-none');
    }
  });

  // Validar links antes de submeter (retorna true se ok, false se invalido)
  function validarLinksPlanosFastDePix() {
    // Verificar se é FastDePix
    if (tipoIntegracao !== 'fastdepix') {
      return true;
    }

    // Verificar se é link FastDePix (unica opcao que precisa de links)
    const tipoCobranca = $('input[name="tipoCobrancaFastDePix"]:checked').val();
    if (tipoCobranca !== 'link_fastdepix') {
      return true; // Painel do Cliente e QR Code nao precisam de links
    }

    // Verificar se há planos
    if (planosUsuario.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Nenhum plano cadastrado',
        text: 'Cadastre ao menos um Plano de Adesao antes de configurar links personalizados.'
      });
      return false;
    }

    // Verificar se todos os planos têm links
    const camposVazios = [];
    $('.link-plano-fastdepix').each(function() {
      if (!$(this).val().trim()) {
        const planoNome = $(this).data('plano-nome');
        camposVazios.push(planoNome);
      }
    });

    if (camposVazios.length > 0) {
      Swal.fire({
        icon: 'warning',
        title: 'Links obrigatorios',
        html: 'Informe o link FastDePix para os seguintes planos:<br><br><strong>' + camposVazios.join('<br>') + '</strong>'
      });
      return false;
    }

    return true;
  }

  $('#formCadastroFormaPgto').on('submit', function(e) {
    // Sincronizar nome de identificação de acordo com a instituição selecionada
    let nomeIdentificacaoValor = '';

    switch(tipoIntegracao) {
      case 'fastdepix':
        nomeIdentificacaoValor = $('#nomeIdentificacaoFastDePix').val();
        break;
      case 'mercado_pago':
        nomeIdentificacaoValor = $('#nomeIdentificacaoMP').val();
        break;
      case 'efi_bank':
        nomeIdentificacaoValor = $('#nomeIdentificacaoEfi').val();
        break;
      case 'manual':
        // Para manual, já está no campo correto com name="nome_identificacao"
        nomeIdentificacaoValor = $('#nomeIdentificacao').val();
        break;
    }

    // Atualizar o campo com name="nome_identificacao"
    $('#nomeIdentificacao').val(nomeIdentificacaoValor);

    // Garantir que o tipo de conta está sincronizado
    let tipoContaValor = '';
    switch(tipoIntegracao) {
      case 'fastdepix':
        tipoContaValor = $('#tipoContaFastDePix').val();
        break;
      case 'mercado_pago':
        tipoContaValor = $('#tipoContaMP').val();
        break;
      case 'efi_bank':
        tipoContaValor = $('#tipoContaEfi').val();
        break;
      case 'manual':
        tipoContaValor = $('#tipoContaManual').val();
        break;
    }
    $('#tipoConta').val(tipoContaValor);

    // Atualizar campo hidden de clientes antes do submit
    atualizarCampoHidden();

    // Validações básicas
    if (!nomeIdentificacaoValor) {
      e.preventDefault();
      Swal.fire({
        icon: 'warning',
        title: 'Campo obrigatório',
        text: 'Por favor, preencha o Nome de Identificação.'
      });
      return false;
    }

    if (!tipoContaValor) {
      e.preventDefault();
      Swal.fire({
        icon: 'warning',
        title: 'Campo obrigatório',
        text: 'Por favor, selecione o Tipo de Conta.'
      });
      return false;
    }

    // Validar se há clientes selecionados (obrigatório para TODAS as formas)
    if (clientesSelecionados.size === 0) {
      e.preventDefault();
      Swal.fire({
        icon: 'warning',
        title: 'Clientes obrigatórios',
        text: 'É obrigatório associar ao menos um cliente à forma de pagamento.'
      });
      return false;
    }

    // Validar links FastDePix se aplicável
    if (!validarLinksPlanosFastDePix()) {
      e.preventDefault();
      return false;
    }

    // Continuar com submit normal
    return true;
  });
});
  </script>
</body>
</html>
