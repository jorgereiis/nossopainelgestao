{% load static l10n %}

<!DOCTYPE html>
<html lang="en">

<head>
  {% include 'partials/head.html' %}
  <title>Planos de Ades√£o | Nosso Painel - Gest√£o Simplificada</title>
</head>

<body class="bg-light">
  <div id="db-wrapper">
    <!-- navbar vertical -->
    {% include 'partials/navbar-vertical.html' %}
    <!-- page content -->
    <div id="page-content">
      {% include 'partials/header.html' %}
      <!-- Container fluid -->
      <div class="container-fluid p-6">
        <div class="row">
          <div class="col-lg-12 col-md-12 col-12">
            <!-- Page header -->
            <div class="border-bottom pb-4 mb-4">
              <h3 class="mb-0 fw-bold">Cadastro de Plano de Ades√£o</h3>

            </div>
          </div>
          <!-- col -->
          <div class="row mb-8">
            <div class="col-xl-4 col-lg-4 col-md-12 col-12">
              <div class="mb-4 mb-lg-0">
                <h4 class="mb-1">Crie aqui seus Planos de Ades√£o</h4>
                <p class="mb-0 fs-5 text-muted">Configure os planos de assinatura que voc√™ oferece.</p>

                <!-- Card de Informa√ß√£o -->
                <div class="card border-0 shadow-sm mt-4" style="background: linear-gradient(135deg, #f3e5f5 0%, #fff8e1 100%);">
                  <div class="card-body">
                    <div class="mb-3">
                      <h4 class="mb-0 fw-bold" style="color: #7b1fa2; font-size: 1.4rem;">üìã O que s√£o Planos de Ades√£o?</h4>
                    </div>

                    <p class="text-muted small mb-3">
                      Planos de Ades√£o definem o <strong>valor e per√≠odo</strong> das assinaturas dos seus clientes.
                    </p>

                    <div class="mb-3">
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <p class="text-muted mb-0 small">Mensal, Trimestral, Semestral ou Anual</p>
                      </div>
                      <div class="d-flex align-items-start mb-2">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <p class="text-muted mb-0 small">Configure o n√∫mero de telas por plano</p>
                      </div>
                      <div class="d-flex align-items-start">
                        <i class="bi bi-megaphone-fill text-warning me-2 mt-1"></i>
                        <p class="text-muted mb-0 small">Campanhas promocionais com descontos</p>
                      </div>
                    </div>

                    <hr class="my-3">

                    <div class="d-flex align-items-start">
                      <i class="bi bi-lightbulb-fill text-warning me-2 mt-1"></i>
                      <p class="text-muted mb-0 small">
                        <strong>Dica:</strong> Voc√™ pode criar m√∫ltiplos planos do mesmo tipo com valores diferentes para atender p√∫blicos variados.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-4 col-lg-6 col-md-12 col-12">
              <!-- card -->
              <div class="card shadow-sm border-0 cadastro-form-card">
                <!-- card body -->
                <div class="card-body p-4">
                  <div class="mb-4 pb-3 border-bottom">
                    <h4 class="mb-1 fw-bold d-flex align-items-center">
                      <i class="bi bi-plus-circle-fill text-primary me-2"></i>
                      Formul√°rio de cadastro
                    </h4>
                    <small class="text-muted">Preencha os campos abaixo</small>
                  </div>

                  <form method="POST" id="form-create-plano">
                    <!-- row -->
                    {% csrf_token %}

                    <div class="mb-4">
                      <label for="nome" class="form-label fw-semibold">
                        <i class="bi bi-calendar-check-fill text-primary me-2"></i>Tipo de Plano
                      </label>
                      <select class="form-select form-select-lg" id="nome" name="nome">
                        <option value="Mensal">Mensal</option>
                        <option value="Bimestral">Bimestral</option>
                        <option value="Trimestral">Trimestral</option>
                        <option value="Semestral">Semestral</option>
                        <option value="Anual">Anual</option>
                      </select>
                      <small class="text-muted">Per√≠odo de validade do plano</small>
                    </div>

                    <div class="mb-4">
                      <label for="telas" class="form-label fw-semibold">
                        <i class="bi bi-tv-fill text-info me-2"></i>N√∫mero de Telas
                      </label>
                      <input type="number" class="form-control form-control-lg" id="telas" name="telas" min="1" step="1" placeholder="Ex: 1, 2, 3..." required>
                      <small class="text-muted">Quantidade de streams simult√¢neos e dispositivos permitidos</small>
                    </div>

                    <div class="mb-4">
                      <label for="valor" class="form-label fw-semibold">
                        <i class="bi bi-cash-coin text-success me-2"></i>Valor
                      </label>
                      <div class="input-group input-group-lg">
                        <span class="input-group-text">R$</span>
                        <input type="number" class="form-control" id="valor" name="valor" min="0" step="0.01" placeholder="0,00" required>
                      </div>
                      <small class="text-muted">Pre√ßo do plano em reais</small>
                    </div>

                    <!-- ‚≠ê FASE 2: Configura√ß√£o de Campanha Promocional (Redesign) -->
                    <div class="mb-4">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox"
                               id="campanha_ativa"
                               name="campanha_ativa">
                        <label class="form-check-label fw-semibold"
                               for="campanha_ativa">
                          <i class="bi bi-megaphone-fill text-warning me-2"></i>
                          Este plano possui Campanha Promocional
                        </label>
                      </div>
                      <small class="text-muted">
                        Marque para configurar uma campanha promocional para este plano
                      </small>
                    </div>

                    <!-- Campanha: Se√ß√£o expans√≠vel -->
                    <div id="campanha-config" style="display: none;" class="border rounded p-3 mb-4 bg-light">
                      <h6 class="fw-bold mb-3 text-warning">
                        <i class="bi bi-gear-fill me-2"></i>Configura√ß√£o da Campanha
                      </h6>

                      <!-- Tipo de Campanha -->
                      <div class="mb-3">
                        <label class="form-label fw-semibold">
                          <i class="bi bi-tag-fill text-info me-2"></i>Tipo de Campanha
                          <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                             data-bs-placement="right"
                             title="Escolha entre um valor fixo para todos os meses ou valores diferentes para cada m√™s da campanha">
                            <i class="bi bi-question-circle text-muted"></i>
                          </a>
                        </label>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="campanha_tipo" id="tipo_fixo" value="FIXO" checked>
                          <label class="form-check-label" for="tipo_fixo">
                            <strong>Desconto Fixo</strong> - Valor √∫nico para todas as mensalidades
                          </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="campanha_tipo" id="tipo_personalizado" value="PERSONALIZADO">
                          <label class="form-check-label" for="tipo_personalizado">
                            <strong>Desconto Personalizado</strong> - Valores progressivos por m√™s
                          </label>
                        </div>
                      </div>

                      <!-- Per√≠odo de Validade -->
                      <div class="row mb-3">
                        <div class="col-md-6">
                          <label for="campanha_data_inicio" class="form-label fw-semibold">
                            <i class="bi bi-calendar-check text-success me-2"></i>Data In√≠cio
                            <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                               data-bs-placement="right"
                               title="Data a partir da qual novos clientes poder√£o ser inscritos nesta campanha">
                              <i class="bi bi-question-circle text-muted"></i>
                            </a>
                          </label>
                          <input type="date" class="form-control" id="campanha_data_inicio" name="campanha_data_inicio">
                          <small class="text-muted">In√≠cio da validade para novos clientes</small>
                        </div>
                        <div class="col-md-6">
                          <label for="campanha_data_fim" class="form-label fw-semibold">
                            <i class="bi bi-calendar-x text-danger me-2"></i>Data Fim
                            <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                               data-bs-placement="right"
                               title="Data final para inscri√ß√£o de novos clientes. Deixe vazio para campanha sem prazo">
                              <i class="bi bi-question-circle text-muted"></i>
                            </a>
                          </label>
                          <input type="date" class="form-control" id="campanha_data_fim" name="campanha_data_fim">
                          <small class="text-muted">Fim da validade para novos clientes</small>
                        </div>
                      </div>

                      <!-- Quantidade de Pagamentos (Spinner Control) -->
                      <div class="mb-3">
                        <label for="campanha_duracao_meses" class="form-label fw-semibold">
                          <i class="bi bi-hourglass-split text-primary me-2"></i>Quantidade de pagamentos com desconto
                          <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                             data-bs-placement="right"
                             title="Quantos pagamentos (cobran√ßas) ter√£o desconto. Para plano Mensal: 3 pagamentos = 3 meses. Para plano Trimestral: 3 pagamentos = 9 meses. M√°ximo: 12 pagamentos.">
                            <i class="bi bi-question-circle text-muted"></i>
                          </a>
                        </label>
                        <div class="input-group" style="max-width: 200px;">
                          <button class="btn btn-outline-secondary" type="button" id="btn-duracao-minus" style="width: 45px;">
                            <i class="bi bi-dash-lg"></i>
                          </button>
                          <input type="number" class="form-control text-center fw-bold" id="campanha_duracao_meses"
                                 name="campanha_duracao_meses" min="1" max="12" value="1" readonly style="max-width: 80px;">
                          <button class="btn btn-outline-secondary" type="button" id="btn-duracao-plus" style="width: 45px;">
                            <i class="bi bi-plus-lg"></i>
                          </button>
                        </div>
                        <small class="text-muted">N√∫mero de cobran√ßas que ter√£o desconto (de 1 a 12 pagamentos)</small>
                      </div>

                      <!-- Valores: Desconto Fixo -->
                      <div id="valores-fixo" class="valores-campanha">
                        <div class="mb-3">
                          <label for="campanha_valor_fixo" class="form-label fw-semibold">
                            <i class="bi bi-cash-coin text-success me-2"></i>Valor Fixo com Desconto
                          </label>
                          <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="number" class="form-control" id="campanha_valor_fixo"
                                   name="campanha_valor_fixo" min="0" step="0.01" placeholder="0,00">
                          </div>
                          <small class="text-muted">Valor que ser√° cobrado durante toda a campanha</small>
                        </div>
                      </div>

                      <!-- Valores: Desconto Personalizado -->
                      <div id="valores-personalizado" class="valores-campanha" style="display: none;">
                        <p class="fw-semibold mb-2">
                          <i class="bi bi-graph-up text-warning me-2"></i>Valores Progressivos por M√™s
                          <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                             data-bs-placement="right"
                             title="Informe o valor de cada mensalidade. Os campos aparecem de acordo com o total de repeti√ß√µes selecionado">
                            <i class="bi bi-question-circle text-muted"></i>
                          </a>
                        </p>
                        <!-- Container din√¢mico para os campos de meses -->
                        <div class="row" id="campos-meses-container">
                          <!-- Os campos ser√£o gerados dinamicamente via JavaScript -->
                        </div>
                        <small class="text-muted">Preencha os valores para cada m√™s da campanha</small>
                      </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                      <button type="submit" class="btn btn-primary btn-lg btn-loading-ready" name="cadastrar" id="btn-cadastrar-plano">
                        <i class="bi bi-check-circle me-2"></i>Cadastrar Plano
                      </button>
                    </div>
                </div>
                </form>
              </div>
            </div>
          </div>

          <div class="row mb-8">
            <div class="col-md-12 col-12">
              <div class="mb-lg-6 border-bottom pb-4 mb-4">
                <h4 class="mb-1">Cadastros existentes</h4>
              </div>
            </div>
            <br>

            <!-- Modal de confirma√ß√£o de exclus√£o -->
            <div class="modal fade" id="confirm-delete-modal" tabindex="-1" role="dialog"
              aria-labelledby="confirm-delete-label">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="confirm-delete-label">Confirmar exclus√£o</h4>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Fechar">
                    </button>
                  </div>
                  <div class="modal-body">
                    <p>Tem certeza que deseja excluir o plano <span id="servidor-nome"></span>?</p>
                  </div>
                  <div class="modal-footer">
                    <div class="mensagem-erro" id="mensagem-erro"></div>
                    <form method="POST" id="delete-form">
                      {% csrf_token %}
                      <input type="hidden" name="plano_id" id="plano-id">
                      <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                      <button type="submit" class="btn btn-danger">Excluir</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de edi√ß√£o de planos -->
            <div class="modal fade" id="edit-plano-modal" tabindex="-1" role="dialog"
              aria-labelledby="edit-plano-label">
              <div class="modal-dialog" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h4 class="modal-title" id="edit-plano-label">Editar Plano</h4>
                    <button type="button" class="btn-close" data-dismiss="modal" aria-label="Fechar"></button>
                  </div>
                  <div class="modal-body">
                    <form method="POST" id="edit-plano-form">
                      {% csrf_token %}
                      <div class="form-group">
                        <label for="edit-plano-nome">Nome do Plano</label>
                        <select class="form-select" id="edit-plano-nome" name="nome">
                          <option value="Mensal">Mensal</option>
                          <option value="Bimestral">Bimestral</option>
                          <option value="Trimestral">Trimestral</option>
                          <option value="Semestral">Semestral</option>
                          <option value="Anual">Anual</option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label for="edit-plano-telas">Telas</label>
                        <input type="number" class="form-control" id="edit-plano-telas" name="telas" min="0" step="1" required>
                      </div>
                      <div class="form-group">
                        <label for="edit-plano-valor">Valor</label>
                        <div class="input-group">
                          <span class="input-group-text">R$</span>
                          <input type="text" class="form-control" id="edit-plano-valor" name="valor" min="0" step="1" required>
                        </div>
                      </div>
                      <!-- ‚≠ê FASE 2: Configura√ß√£o de Campanha -->
                      <div class="form-group mt-3">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox"
                                 id="edit-campanha-ativa"
                                 name="campanha_ativa">
                          <label class="form-check-label fw-semibold" for="edit-campanha-ativa">
                            <i class="bi bi-megaphone-fill text-warning me-2"></i>
                            Campanha Promocional
                          </label>
                        </div>
                      </div>

                      <!-- Campanha: Se√ß√£o expans√≠vel (Edit) -->
                      <div id="edit-campanha-config" style="display: none;" class="border rounded p-3 mt-3 bg-light">
                        <h6 class="fw-bold mb-3 text-warning small">
                          <i class="bi bi-gear-fill me-2"></i>Configura√ß√£o da Campanha
                        </h6>

                        <!-- Tipo -->
                        <div class="form-group mb-2">
                          <label class="form-label small fw-semibold">Tipo de Campanha</label>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="campanha_tipo" id="edit-tipo-fixo" value="FIXO" checked>
                            <label class="form-check-label small" for="edit-tipo-fixo">Desconto Fixo</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="campanha_tipo" id="edit-tipo-personalizado" value="PERSONALIZADO">
                            <label class="form-check-label small" for="edit-tipo-personalizado">Desconto Personalizado</label>
                          </div>
                        </div>

                        <!-- Datas -->
                        <div class="row mb-2">
                          <div class="col-6">
                            <label for="edit-campanha-data-inicio" class="form-label small fw-semibold">Data In√≠cio</label>
                            <input type="date" class="form-control form-control-sm" id="edit-campanha-data-inicio" name="campanha_data_inicio">
                          </div>
                          <div class="col-6">
                            <label for="edit-campanha-data-fim" class="form-label small fw-semibold">Data Fim</label>
                            <input type="date" class="form-control form-control-sm" id="edit-campanha-data-fim" name="campanha_data_fim">
                          </div>
                        </div>

                        <!-- Quantidade de Pagamentos -->
                        <div class="form-group mb-2">
                          <label for="edit-campanha-duracao" class="form-label small fw-semibold">
                            Quantidade de pagamentos com desconto
                            <a href="#" class="text-decoration-none ms-1" data-bs-toggle="tooltip"
                               title="Quantos pagamentos (cobran√ßas) ter√£o desconto. Ex: 3 pagamentos no plano Trimestral = 9 meses.">
                              <i class="bi bi-question-circle text-muted"></i>
                            </a>
                          </label>
                          <div class="input-group input-group-sm" style="max-width: 150px;">
                            <button class="btn btn-outline-secondary" type="button" id="btn-edit-duracao-minus">
                              <i class="bi bi-dash-lg"></i>
                            </button>
                            <input type="number" class="form-control text-center fw-bold" id="edit-campanha-duracao"
                                   name="campanha_duracao_meses" min="1" max="12" value="1" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="btn-edit-duracao-plus">
                              <i class="bi bi-plus-lg"></i>
                            </button>
                          </div>
                        </div>

                        <!-- Valores Fixo -->
                        <div id="edit-valores-fixo" class="edit-valores-campanha">
                          <div class="form-group mb-2">
                            <label for="edit-campanha-valor-fixo" class="form-label small fw-semibold">Valor Fixo com Desconto</label>
                            <div class="input-group input-group-sm">
                              <span class="input-group-text">R$</span>
                              <input type="number" class="form-control" id="edit-campanha-valor-fixo"
                                     name="campanha_valor_fixo" min="0" step="0.01">
                            </div>
                          </div>
                        </div>

                        <!-- Valores Personalizado -->
                        <div id="edit-valores-personalizado" class="edit-valores-campanha" style="display: none;">
                          <p class="small fw-semibold mb-1">Valores por M√™s</p>
                          <!-- Container din√¢mico para os campos de meses (EDIT) -->
                          <div class="row g-1" id="edit-campos-meses-container">
                            <!-- Os campos ser√£o gerados dinamicamente via JavaScript -->
                          </div>
                        </div>
                      </div>
                      <input type="hidden" name="plano_id" id="plano-id">
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" form="edit-plano-form" class="btn btn-primary">Salvar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Confirma√ß√£o do Plano -->
            <div class="modal fade" id="confirm-plano-modal" tabindex="-1" role="dialog"
              aria-labelledby="confirm-plano-label">
              <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h4 class="modal-title" id="confirm-plano-label">
                      <i class="bi bi-check-circle me-2"></i>Confira o resumo do Plano de Ades√£o antes de cadastrar
                    </h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                  </div>
                  <div class="modal-body">
                    <p class="text-muted mb-4">Voc√™ ainda pode editar as informa√ß√µes do seu Plano antes de emiti-lo.</p>

                    <!-- Resumo do Plano -->
                    <div class="card border-0 bg-light">
                      <div class="card-body">
                        <h5 class="card-title fw-bold mb-3">
                          <i class="bi bi-file-earmark-text me-2 text-primary"></i>Informa√ß√µes do Plano
                        </h5>
                        <div class="row">
                          <div class="col-md-4 mb-3">
                            <small class="text-muted d-block">Tipo de Plano</small>
                            <strong id="resumo-tipo-plano" class="fs-5">-</strong>
                          </div>
                          <div class="col-md-4 mb-3">
                            <small class="text-muted d-block">N√∫mero de Telas</small>
                            <strong id="resumo-telas" class="fs-5">-</strong>
                          </div>
                          <div class="col-md-4 mb-3">
                            <small class="text-muted d-block">Valor</small>
                            <strong id="resumo-valor" class="fs-5 text-success">-</strong>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Resumo da Campanha (se aplic√°vel) -->
                    <div class="card border-warning bg-warning-subtle mt-3" id="resumo-campanha-card" style="display: none;">
                      <div class="card-body">
                        <h5 class="card-title fw-bold mb-3 text-warning">
                          <i class="bi bi-megaphone-fill me-2"></i>Campanha Promocional
                        </h5>
                        <div class="row mb-3">
                          <div class="col-md-6 mb-2">
                            <small class="text-muted d-block">Tipo de Campanha</small>
                            <strong id="resumo-campanha-tipo">-</strong>
                          </div>
                          <div class="col-md-6 mb-2">
                            <small class="text-muted d-block">Quantidade de Pagamentos</small>
                            <strong id="resumo-campanha-duracao">-</strong>
                          </div>
                        </div>
                        <div class="row mb-3">
                          <div class="col-md-6 mb-2">
                            <small class="text-muted d-block">Data In√≠cio</small>
                            <strong id="resumo-campanha-inicio">-</strong>
                          </div>
                          <div class="col-md-6 mb-2">
                            <small class="text-muted d-block">Data Fim</small>
                            <strong id="resumo-campanha-fim">-</strong>
                          </div>
                        </div>
                        <div id="resumo-campanha-valores">
                          <!-- Valores da campanha ser√£o inseridos aqui -->
                        </div>
                      </div>
                    </div>

                    <!-- Resumo Narrativo Final -->
                    <div class="alert alert-info border-info mt-3 mb-0" role="alert">
                      <h6 class="alert-heading fw-bold mb-2">
                        <i class="bi bi-info-circle-fill me-2"></i>Resumo da Configura√ß√£o
                      </h6>
                      <p class="mb-0" id="resumo-narrativo" style="font-size: 0.95rem; line-height: 1.6;">
                        <!-- Texto narrativo ser√° gerado dinamicamente -->
                      </p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                      <i class="bi bi-pencil me-2"></i>Editar
                    </button>
                    <button type="button" class="btn btn-primary btn-loading-ready" id="btn-confirmar-cadastro">
                      <i class="bi bi-check-circle me-2"></i>Confirmar Cadastro
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-12">
              <!-- card -->
              <div class="card">
                <div class="table-responsive">
                  <table class="table table-sm text-nowrap mb-0 table-hover align-middle" id="planosTable">
                    <thead class="table-light">
                      <tr>
                        <th class="fw-bold text-start ps-4" style="min-width: 150px;">Plano</th>
                        <th class="fw-bold text-center" style="width: 100px;">Tipo</th>
                        <th class="fw-bold text-center" style="width: 70px;">Telas</th>
                        <th class="fw-bold text-center" style="width: 100px;">Valor Base</th>
                        <th class="fw-bold text-center" style="width: 110px;">Valor Promo</th>
                        <th class="fw-bold text-center" style="width: 90px;">Pagamentos</th>
                        <th class="fw-bold text-center" style="width: 110px;">In√≠cio</th>
                        <th class="fw-bold text-center" style="width: 110px;">Fim</th>
                        <th class="fw-bold text-center" style="width: 80px;">A√ß√µes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for plano in planos_mensalidades %}
                      <!-- COME√áO DA LINHA -->
                      <tr>
                        <!-- Plano -->
                        <td class="ps-4">
                          <div class="lh-sm">
                            <h6 class="mb-0 fw-semibold text-capitalize text-dark"
                                style="font-size: 0.95rem; transition: color 0.2s ease;">
                              {{plano.nome}}
                            </h6>
                            <small class="text-muted d-block" style="font-size: 0.7rem;">
                              <i class="bi bi-calendar-check me-1"></i>Plano de assinatura
                            </small>
                          </div>
                        </td>

                        <!-- Tipo -->
                        <td class="text-center">
                          {% if plano.campanha_ativa %}
                            {% now "Y-m-d" as hoje %}
                            {% if plano.campanha_data_inicio and plano.campanha_data_fim %}
                              {% if plano.campanha_data_inicio|date:"Y-m-d" <= hoje and hoje <= plano.campanha_data_fim|date:"Y-m-d" %}
                                <!-- Campanha ATIVA e VIGENTE -->
                                <span class="badge bg-warning-subtle text-warning border border-warning"
                                      style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                  <i class="bi bi-megaphone-fill me-1"></i>Campanha
                                </span>
                              {% else %}
                                <!-- Campanha ATIVA mas FORA DA VIG√äNCIA -->
                                <span class="badge bg-secondary-subtle text-secondary border border-secondary"
                                      style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                  <i class="bi bi-megaphone me-1"></i>Campanha
                                </span>
                              {% endif %}
                            {% else %}
                              <!-- Campanha ATIVA sem datas definidas -->
                              <span class="badge bg-warning-subtle text-warning border border-warning"
                                    style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                                <i class="bi bi-megaphone-fill me-1"></i>Campanha
                              </span>
                            {% endif %}
                            {% if plano.campanha_tipo %}
                              <br><small class="text-muted" style="font-size: 0.65rem;">
                                {% if plano.campanha_tipo == 'FIXO' %}Fixo{% else %}Personalizado{% endif %}
                              </small>
                            {% endif %}
                          {% else %}
                            <span class="badge bg-secondary-subtle text-secondary border border-secondary"
                                  style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                              <i class="bi bi-check-circle-fill me-1"></i>Regular
                            </span>
                          {% endif %}
                        </td>

                        <!-- Telas -->
                        <td class="text-center">
                          <span class="badge bg-primary-subtle text-primary border border-primary" style="font-size: 0.8rem; padding: 0.35rem 0.7rem;">
                            <i class="bi bi-tv me-1"></i>{{plano.telas}}
                          </span>
                        </td>

                        <!-- Valor Base -->
                        <td class="text-center">
                          <span class="fw-semibold text-dark" style="font-size: 0.85rem;">
                            R$ {{plano.valor}}
                          </span>
                        </td>

                        <!-- Valor Promocional -->
                        <td class="text-center">
                          {% if plano.campanha_ativa %}
                            {% if plano.campanha_tipo == 'FIXO' %}
                              <span class="fw-semibold text-success" style="font-size: 0.85rem;">
                                R$ {{plano.campanha_valor_fixo|default:"-"}}
                              </span>
                            {% else %}
                              <span class="badge bg-info-subtle text-info" style="font-size: 0.7rem;">
                                Vari√°vel
                              </span>
                            {% endif %}
                          {% else %}
                            <span class="text-muted" style="font-size: 0.8rem;">-</span>
                          {% endif %}
                        </td>

                        <!-- Repeti√ß√µes/Pagamentos -->
                        <td class="text-center">
                          {% if plano.campanha_ativa %}
                            {% with info=plano.get_campanha_duracao_display %}
                              <span class="badge bg-light text-dark border" style="font-size: 0.75rem;"
                                    data-bs-toggle="tooltip"
                                    data-bs-html="true"
                                    title="{{ plano.get_campanha_valores_tooltip }}">
                                {{ info.texto_curto }}
                              </span>
                            {% endwith %}
                          {% else %}
                            <span class="text-muted" style="font-size: 0.8rem;">-</span>
                          {% endif %}
                        </td>

                        <!-- In√≠cio Campanha -->
                        <td class="text-center">
                          {% if plano.campanha_ativa and plano.campanha_data_inicio %}
                            <small style="font-size: 0.75rem;">
                              {{plano.campanha_data_inicio|date:'d/m/Y'}}
                            </small>
                          {% else %}
                            <span class="text-muted" style="font-size: 0.8rem;">-</span>
                          {% endif %}
                        </td>

                        <!-- Fim Campanha -->
                        <td class="text-center">
                          {% if plano.campanha_ativa and plano.campanha_data_fim %}
                            <small style="font-size: 0.75rem;">
                              {{plano.campanha_data_fim|date:'d/m/Y'}}
                            </small>
                          {% else %}
                            <span class="text-muted" style="font-size: 0.8rem;">-</span>
                          {% endif %}
                        </td>

                        <!-- Dropdown da tabela -->
                        <td class="text-center">
                          <div class="dropdown table-dropdown-actions">
                            <button
                              class="btn btn-sm btn-light rounded-circle d-inline-flex align-items-center justify-content-center border"
                              type="button"
                              id="dropdownMenuButton-{{ plano.id }}"
                              data-bs-toggle="dropdown"
                              aria-expanded="false"
                              style="width: 36px; height: 36px; padding: 0;">
                              <i class="bi bi-three-dots-vertical text-muted"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="dropdownMenuButton-{{ plano.id }}">
                              <li>
                                <button class="dropdown-item"
                                  type="button"
                                  data-servidor="{{plano.id}}"
                                  data-nome="{{plano.nome}}"
                                  data-telas="{{plano.telas}}"
                                  data-valor="{{plano.valor}}"
                                  data-campanha-ativa="{{plano.campanha_ativa|yesno:'true,false'}}"
                                  data-campanha-tipo="{{plano.campanha_tipo|default:''}}"
                                  data-campanha-data-inicio="{{plano.campanha_data_inicio|date:'Y-m-d'|default:''}}"
                                  data-campanha-data-fim="{{plano.campanha_data_fim|date:'Y-m-d'|default:''}}"
                                  data-campanha-duracao="{{plano.campanha_duracao_meses|default:''}}"
                                  data-campanha-valor-fixo="{{plano.campanha_valor_fixo|unlocalize|default:''}}"
                                  data-campanha-valor-mes-1="{{plano.campanha_valor_mes_1|unlocalize|default:''}}"
                                  data-campanha-valor-mes-2="{{plano.campanha_valor_mes_2|unlocalize|default:''}}"
                                  data-campanha-valor-mes-3="{{plano.campanha_valor_mes_3|unlocalize|default:''}}"
                                  data-campanha-valor-mes-4="{{plano.campanha_valor_mes_4|unlocalize|default:''}}"
                                  data-campanha-valor-mes-5="{{plano.campanha_valor_mes_5|unlocalize|default:''}}"
                                  data-campanha-valor-mes-6="{{plano.campanha_valor_mes_6|unlocalize|default:''}}"
                                  data-campanha-valor-mes-7="{{plano.campanha_valor_mes_7|unlocalize|default:''}}"
                                  data-campanha-valor-mes-8="{{plano.campanha_valor_mes_8|unlocalize|default:''}}"
                                  data-campanha-valor-mes-9="{{plano.campanha_valor_mes_9|unlocalize|default:''}}"
                                  data-campanha-valor-mes-10="{{plano.campanha_valor_mes_10|unlocalize|default:''}}"
                                  data-campanha-valor-mes-11="{{plano.campanha_valor_mes_11|unlocalize|default:''}}"
                                  data-campanha-valor-mes-12="{{plano.campanha_valor_mes_12|unlocalize|default:''}}"
                                  onclick="exibirModalEdicao(this)">
                                  <i class="bi bi-pencil me-2 text-primary"></i>Editar Plano
                                </button>
                              </li>
                              <li><hr class="dropdown-divider"></li>
                              <li>
                                <button class="dropdown-item"
                                  type="button"
                                  data-plano="{{plano.id}}"
                                  data-nome="{{plano.nome}}"
                                  onclick="exibirModalConfirmacaoExclusao(this)">
                                  <i class="bi bi-trash me-2 text-danger"></i>Excluir Plano
                                </button>
                              </li>
                            </ul>
                          </div>
                        </td>
                        {% endfor %}

                      </tr>
                      <!-- T√âRMINO DA LINHA -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>

      <!-- Scripts -->
      {% include 'partials/modal_whatsapp.html' %}
      {% include 'partials/modal_dns.html' %}
      {% include 'partials/modal_adminlogs.html' %}
      {% include 'partials/modal_userlogs.html' %}
      <!-- Modais Globais -->
      {% include 'partials/modais_globais.html' %}

      <!-- Offcanvas de Configura√ß√µes -->
      {% include 'partials/offcanvas_configuracoes.html' %}

      {% include 'partials/footer.html' %}
      {% include 'partials/scripts.html' %}

      <!-- Alert success -->
      {% if success_message %}
      <script>
        console.log(window.location.origin)
        $(document).ready(function () {
          var currentUrl = window.location.origin;
          var newPath = '/cadastro-plano-adesao/';
          var newUrl = currentUrl + newPath;
          swal.fire({
            icon: 'success',
            title: 'Cadastro realizado',
            html: '{{success_message|safe}}',
            didClose: function () {
              window.location.href = newUrl;
            }
          });
        });
      </script>

      {% elif success_update == True %}
      <script>
        console.log(window.location.origin)
        $(document).ready(function () {
          var currentUrl = window.location.origin;
          var newPath = '/cadastro-plano-adesao/';
          var newUrl = currentUrl + newPath;
          swal.fire({
            icon: 'success',
            title: 'Cadastro atualizado',
            text: 'Servidor editado com sucesso!',
            didClose: function () {
              window.location.href = newUrl;
            }
          });
        });
      </script>

      <!-- Alert error -->
      {% elif error_message %}
      <script>
        console.log(window.location.origin)
        $(document).ready(function () {
          var currentUrl = window.location.origin;
          var newPath = '/cadastro-plano-adesao/';
          var newUrl = currentUrl + newPath;
          swal.fire({
            icon: 'error',
            title: 'Oops...',
            html: '{{error_message|safe}}',
            didClose: function () {
              window.location.href = newUrl;
            }
          });
        });
      </script>
      {% endif %}

</body>

</html>

<script>
  function exibirModalConfirmacaoExclusao(botao) {
    var plano_id = $(botao).data('plano');
    var plano_nome = $(botao).data('nome');
    $('#confirm-delete-modal #plano-id').val(plano_id);
    $('#confirm-delete-modal #plano-nome').text(plano_nome);
    $('#confirm-delete-modal').modal('show');

    // Ouve o envio do formul√°rio
    $('#delete-form').on('submit', function (event) {
      event.preventDefault(); // Impede o envio padr√£o do formul√°rio

      // Obt√©m o ID do servidor a ser exclu√≠do
      var plano_id = $('#plano-id').val();

      // Faz a solicita√ß√£o DELETE para a URL apropriada
      $.ajax({
        url: '/deletar-plano-adesao/' + plano_id + '/',
        method: 'DELETE',
        beforeSend: function (xhr) {
          xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
        },
        success: function (response) {
          // Fecha o modal e recarrega a p√°gina
          $('#confirm-delete-modal').modal('hide');
          window.location.reload();
        },
        error: function (response) {
          // Lida com o erro de exclus√£o
          var mensagem_erro = response.responseJSON.error_delete;
          $('#mensagem-erro').text(mensagem_erro);
        }
      });
    });
  }

  $('#confirm-delete-modal').on('click', '.btn-close, .btn-secondary', function () {
    $('#confirm-delete-modal').modal('hide');
  });

</script>

<script>
  // Fun√ß√£o utilit√°ria para loading em bot√µes (copiada de dashboard.js)
  function setButtonLoading(btn, loading, originalHTML) {
    if (!btn) return;
    if (loading) {
      btn.disabled = true;
      btn.dataset.originalHtml = btn.innerHTML;
      btn.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span>';
    } else {
      btn.disabled = false;
      btn.innerHTML = originalHTML || btn.dataset.originalHtml || 'Salvar';
    }
  }

  // ‚≠ê FASE 2.5: Enhanced Campaign Logic with Spinner, Dynamic Fields, and Confirmation Modal
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const campanhaCheckbox = document.getElementById('campanha_ativa');
    const campanhaConfig = document.getElementById('campanha-config');
    const tipoFixo = document.getElementById('tipo_fixo');
    const tipoPersonalizado = document.getElementById('tipo_personalizado');
    const valoresFixo = document.getElementById('valores-fixo');
    const valoresPersonalizado = document.getElementById('valores-personalizado');
    const duracaoInput = document.getElementById('campanha_duracao_meses');
    const camposMesesContainer = document.getElementById('campos-meses-container');

    // Toggle campaign config visibility
    if (campanhaCheckbox) {
      const dataInicioInput = document.getElementById('campanha_data_inicio');
      const dataFimInput = document.getElementById('campanha_data_fim');
      const valorFixoInput = document.getElementById('campanha_valor_fixo');

      campanhaCheckbox.addEventListener('change', function() {
        campanhaConfig.style.display = this.checked ? 'block' : 'none';

        // ‚≠ê Set required attribute on date fields when campaign is active
        if (this.checked) {
          dataInicioInput.setAttribute('required', 'required');
          dataFimInput.setAttribute('required', 'required');
        } else {
          dataInicioInput.removeAttribute('required');
          dataFimInput.removeAttribute('required');
          valorFixoInput.removeAttribute('required');
        }
      });
    }

    // Toggle value inputs based on campaign type
    if (tipoFixo && tipoPersonalizado) {
      const valorFixoInput = document.getElementById('campanha_valor_fixo');

      tipoFixo.addEventListener('change', function() {
        if (this.checked) {
          valoresFixo.style.display = 'block';
          valoresPersonalizado.style.display = 'none';

          // ‚≠ê Set required on valor fixo when this type is selected
          if (campanhaCheckbox.checked) {
            valorFixoInput.setAttribute('required', 'required');
          }
          // Remove required from month fields
          const monthInputs = document.querySelectorAll('[id^="campanha_valor_mes_"]');
          monthInputs.forEach(input => input.removeAttribute('required'));
        }
      });

      tipoPersonalizado.addEventListener('change', function() {
        if (this.checked) {
          valoresFixo.style.display = 'none';
          valoresPersonalizado.style.display = 'block';
          gerarCamposMeses(parseInt(duracaoInput.value) || 1);

          // ‚≠ê Remove required from valor fixo
          valorFixoInput.removeAttribute('required');
          // Set required on month fields if campaign is active
          if (campanhaCheckbox.checked) {
            const duracao = parseInt(duracaoInput.value) || 1;
            for (let i = 1; i <= duracao; i++) {
              const monthInput = document.getElementById(`campanha_valor_mes_${i}`);
              if (monthInput) {
                monthInput.setAttribute('required', 'required');
              }
            }
          }
        }
      });
    }

    // ‚≠ê NOVO: Spinner control for duration (CREATE form)
    const btnDuracaoPlus = document.getElementById('btn-duracao-plus');
    const btnDuracaoMinus = document.getElementById('btn-duracao-minus');

    if (btnDuracaoPlus) {
      btnDuracaoPlus.addEventListener('click', function() {
        let currentValue = parseInt(duracaoInput.value) || 1;
        if (currentValue < 12) {
          duracaoInput.value = currentValue + 1;
          if (tipoPersonalizado.checked) {
            gerarCamposMeses(currentValue + 1);
          }
        }
      });
    }

    if (btnDuracaoMinus) {
      btnDuracaoMinus.addEventListener('click', function() {
        let currentValue = parseInt(duracaoInput.value) || 1;
        if (currentValue > 1) {
          duracaoInput.value = currentValue - 1;
          if (tipoPersonalizado.checked) {
            gerarCamposMeses(currentValue - 1);
          }
        }
      });
    }

    // ‚≠ê NOVO: Dynamic field generation for personalized discount
    function gerarCamposMeses(numMeses) {
      camposMesesContainer.innerHTML = '';

      // Preserve existing values if any
      const existingValues = {};
      for (let i = 1; i <= 12; i++) {
        const existingInput = document.querySelector(`input[name="campanha_valor_mes_${i}"]`);
        if (existingInput) {
          existingValues[i] = existingInput.value;
        }
      }

      for (let i = 1; i <= numMeses; i++) {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-2';

        const label = document.createElement('label');
        label.className = 'form-label small';
        label.textContent = `M√™s ${i}`;
        label.setAttribute('for', `campanha_valor_mes_${i}`);

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group input-group-sm';

        const span = document.createElement('span');
        span.className = 'input-group-text';
        span.textContent = 'R$';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.id = `campanha_valor_mes_${i}`;
        input.name = `campanha_valor_mes_${i}`;
        input.min = '0';
        input.step = '0.01';
        input.placeholder = '0,00';
        input.value = existingValues[i] || '';

        // ‚≠ê Set required if campaign is active and tipo personalizado is selected
        if (campanhaCheckbox && campanhaCheckbox.checked && tipoPersonalizado && tipoPersonalizado.checked) {
          input.setAttribute('required', 'required');
        }

        inputGroup.appendChild(span);
        inputGroup.appendChild(input);
        col.appendChild(label);
        col.appendChild(inputGroup);
        camposMesesContainer.appendChild(col);
      }
    }

    // Initialize fields with default value (1 month)
    if (duracaoInput) {
      gerarCamposMeses(parseInt(duracaoInput.value) || 1);
    }

    // ‚≠ê FASE 2: Campaign show/hide logic for EDIT form
    const editCampanhaCheckbox = document.getElementById('edit-campanha-ativa');
    const editCampanhaConfig = document.getElementById('edit-campanha-config');
    const editTipoFixo = document.getElementById('edit-tipo-fixo');
    const editTipoPersonalizado = document.getElementById('edit-tipo-personalizado');
    const editValoresFixo = document.getElementById('edit-valores-fixo');
    const editValoresPersonalizado = document.getElementById('edit-valores-personalizado');
    const editDuracaoInput = document.getElementById('edit-campanha-duracao');
    const editCamposMesesContainer = document.getElementById('edit-campos-meses-container');

    // Toggle campaign config visibility in edit modal
    if (editCampanhaCheckbox) {
      editCampanhaCheckbox.addEventListener('change', function() {
        editCampanhaConfig.style.display = this.checked ? 'block' : 'none';
      });
    }

    // Toggle value inputs based on campaign type in edit modal
    if (editTipoFixo && editTipoPersonalizado) {
      editTipoFixo.addEventListener('change', function() {
        if (this.checked) {
          editValoresFixo.style.display = 'block';
          editValoresPersonalizado.style.display = 'none';
        }
      });

      editTipoPersonalizado.addEventListener('change', function() {
        if (this.checked) {
          editValoresFixo.style.display = 'none';
          editValoresPersonalizado.style.display = 'block';
          gerarCamposMesesEdit(parseInt(editDuracaoInput.value) || 1);
        }
      });
    }

    // ‚≠ê NOVO: Spinner control for duration (EDIT form)
    const btnEditDuracaoPlus = document.getElementById('btn-edit-duracao-plus');
    const btnEditDuracaoMinus = document.getElementById('btn-edit-duracao-minus');

    if (btnEditDuracaoPlus) {
      btnEditDuracaoPlus.addEventListener('click', function() {
        let currentValue = parseInt(editDuracaoInput.value) || 1;
        if (currentValue < 12) {
          editDuracaoInput.value = currentValue + 1;
          if (editTipoPersonalizado.checked) {
            gerarCamposMesesEdit(currentValue + 1);
          }
        }
      });
    }

    if (btnEditDuracaoMinus) {
      btnEditDuracaoMinus.addEventListener('click', function() {
        let currentValue = parseInt(editDuracaoInput.value) || 1;
        if (currentValue > 1) {
          editDuracaoInput.value = currentValue - 1;
          if (editTipoPersonalizado.checked) {
            gerarCamposMesesEdit(currentValue - 1);
          }
        }
      });
    }

    // ‚≠ê NOVO: Dynamic field generation for EDIT modal
    function gerarCamposMesesEdit(numMeses) {
      editCamposMesesContainer.innerHTML = '';

      // Preserve existing values if any
      const existingValues = {};
      for (let i = 1; i <= 12; i++) {
        const existingInput = document.querySelector(`#edit-campanha-valor-mes-${i}`);
        if (existingInput) {
          existingValues[i] = existingInput.value;
        }
      }

      for (let i = 1; i <= numMeses; i++) {
        const col = document.createElement('div');
        col.className = 'col-4';

        const label = document.createElement('label');
        label.className = 'form-label small';
        label.textContent = `M√™s ${i}`;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group input-group-sm';

        const span = document.createElement('span');
        span.className = 'input-group-text';
        span.textContent = 'R$';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.id = `edit-campanha-valor-mes-${i}`;
        input.name = `campanha_valor_mes_${i}`;
        input.min = '0';
        input.step = '0.01';
        input.value = existingValues[i] || '';

        inputGroup.appendChild(span);
        inputGroup.appendChild(input);
        col.appendChild(label);
        col.appendChild(inputGroup);
        editCamposMesesContainer.appendChild(col);
      }
    }

    // ‚≠ê NOVO: Intercept form submission and show confirmation modal
    const createPlanoForm = document.getElementById('form-create-plano');
    if (createPlanoForm) {
      // Track which button was clicked (fallback for browsers without e.submitter)
      let clickedButton = null;
      const formButtons = createPlanoForm.querySelectorAll('button[type="submit"], input[type="submit"]');
      formButtons.forEach(button => {
        button.addEventListener('click', function() {
          clickedButton = this;
        });
      });

      createPlanoForm.addEventListener('submit', function(e) {
        // Get submitter with fallback for older browsers
        const submitter = e.submitter || clickedButton;

        // Only intercept if it's the create form (has cadastrar button)
        if (submitter && submitter.name === 'cadastrar') {
          e.preventDefault();

          // Validate campaign fields if campaign is active
          if (!validarCampanha()) {
            return false;
          }

          mostrarModalConfirmacao();
        }
      });
    }

    // ‚≠ê NOVO: Validate campaign fields
    function validarCampanha() {
      const campanhaAtiva = document.getElementById('campanha_ativa').checked;

      if (!campanhaAtiva) {
        return true; // No validation needed if campaign is inactive
      }

      const tipoFixo = document.getElementById('tipo_fixo').checked;
      const dataInicio = document.getElementById('campanha_data_inicio').value;
      const dataFim = document.getElementById('campanha_data_fim').value;
      const duracao = document.getElementById('campanha_duracao_meses').value;

      // Validate dates
      if (!dataInicio) {
        alert('Por favor, informe a Data de In√≠cio da campanha.');
        document.getElementById('campanha_data_inicio').focus();
        return false;
      }

      if (!dataFim) {
        alert('Por favor, informe a Data de Fim da campanha.');
        document.getElementById('campanha_data_fim').focus();
        return false;
      }

      // Validate campaign values based on type
      if (tipoFixo) {
        const valorFixo = document.getElementById('campanha_valor_fixo').value;
        if (!valorFixo || parseFloat(valorFixo) <= 0) {
          alert('Por favor, informe o Valor Fixo da Mensalidade para a campanha.');
          document.getElementById('campanha_valor_fixo').focus();
          return false;
        }
      } else {
        // Validate personalized values
        const numMeses = parseInt(duracao) || 1;
        for (let i = 1; i <= numMeses; i++) {
          const valorMes = document.getElementById(`campanha_valor_mes_${i}`);
          if (!valorMes || !valorMes.value || parseFloat(valorMes.value) <= 0) {
            alert(`Por favor, informe o valor para o M√™s ${i} da campanha.`);
            if (valorMes) valorMes.focus();
            return false;
          }
        }
      }

      return true;
    }

    // ‚≠ê NOVO: Populate and show confirmation modal
    function mostrarModalConfirmacao() {
      // Get form values
      const tipoPlano = document.getElementById('nome').value;
      const telas = document.getElementById('telas').value;
      const valor = document.getElementById('valor').value;
      const campanhaAtiva = document.getElementById('campanha_ativa').checked;

      // ‚≠ê FIX: Declare campaign variables outside if block to avoid ReferenceError
      const tipoFixoChecked = document.getElementById('tipo_fixo').checked;
      const duracao = document.getElementById('campanha_duracao_meses').value;
      const dataInicio = document.getElementById('campanha_data_inicio').value;
      const dataFim = document.getElementById('campanha_data_fim').value;

      // Populate basic info
      document.getElementById('resumo-tipo-plano').textContent = tipoPlano;
      document.getElementById('resumo-telas').textContent = telas;
      document.getElementById('resumo-valor').textContent = `R$ ${parseFloat(valor).toFixed(2)}`;

      // Handle campaign info
      const resumoCampanhaCard = document.getElementById('resumo-campanha-card');
      if (campanhaAtiva) {
        resumoCampanhaCard.style.display = 'block';

        document.getElementById('resumo-campanha-tipo').textContent = tipoFixoChecked ? 'Desconto Fixo' : 'Desconto Personalizado';

        // ‚≠ê NOVO: Calcular dura√ß√£o real baseado no tipo de plano
        const multiplicadores = {
          'mensal': 1,
          'bimestral': 2,
          'trimestral': 3,
          'semestral': 6,
          'anual': 12
        };
        const planoTipo = tipoPlano.toLowerCase().split(' ')[0];
        const multiplicador = multiplicadores[planoTipo] || 1;
        const mesesReais = parseInt(duracao) * multiplicador;

        let textoDuracao = `${duracao} pagamento${duracao == 1 ? '' : 's'}`;
        if (multiplicador > 1) {
          textoDuracao += ` (~${mesesReais} meses)`;
        }
        document.getElementById('resumo-campanha-duracao').textContent = textoDuracao;

        document.getElementById('resumo-campanha-inicio').textContent = dataInicio ? new Date(dataInicio + 'T00:00:00').toLocaleDateString('pt-BR') : 'N√£o definido';
        document.getElementById('resumo-campanha-fim').textContent = dataFim ? new Date(dataFim + 'T00:00:00').toLocaleDateString('pt-BR') : 'Sem prazo';

        // Display campaign values
        const resumoValoresContainer = document.getElementById('resumo-campanha-valores');
        resumoValoresContainer.innerHTML = '';

        if (tipoFixoChecked) {
          const valorFixo = document.getElementById('campanha_valor_fixo').value;
          resumoValoresContainer.innerHTML = `
            <div class="alert alert-warning mb-0">
              <strong>Valor Fixo com Desconto:</strong> R$ ${parseFloat(valorFixo || 0).toFixed(2)} por m√™s
            </div>
          `;
        } else {
          let valoresHtml = '<div class="alert alert-warning mb-0"><strong>Valores por Pagamento:</strong><ul class="mb-0 mt-2">';
          for (let i = 1; i <= parseInt(duracao); i++) {
            const valorMes = document.getElementById(`campanha_valor_mes_${i}`).value;
            valoresHtml += `<li>Pagamento ${i}: R$ ${parseFloat(valorMes || 0).toFixed(2)}</li>`;
          }
          valoresHtml += '</ul></div>';
          resumoValoresContainer.innerHTML = valoresHtml;
        }
      } else {
        resumoCampanhaCard.style.display = 'none';
      }

      // Generate narrative summary
      gerarResumoNarrativo(tipoPlano, telas, valor, campanhaAtiva, tipoFixoChecked, duracao, dataInicio, dataFim);

      // Show modal
      const confirmModal = new bootstrap.Modal(document.getElementById('confirm-plano-modal'));
      confirmModal.show();
    }

    // ‚≠ê NOVO: Generate dynamic narrative summary
    function gerarResumoNarrativo(tipoPlano, telas, valor, campanhaAtiva, tipoFixo, duracao, dataInicio, dataFim) {
      const resumoNarrativo = document.getElementById('resumo-narrativo');
      let texto = '';

      // Build base plan description
      const telasTexto = telas == 1 ? '1 tela' : `${telas} telas`;
      const valorFormatado = parseFloat(valor).toFixed(2);

      if (campanhaAtiva) {
        // With campaign
        const tipoDesconto = tipoFixo ? 'Desconto Fixo' : 'Desconto Personalizado';

        // ‚≠ê NOVO: Calcular dura√ß√£o real baseado no tipo de plano
        const multiplicadores = {
          'mensal': 1,
          'bimestral': 2,
          'trimestral': 3,
          'semestral': 6,
          'anual': 12
        };
        const planoTipo = tipoPlano.toLowerCase().split(' ')[0];
        const multiplicador = multiplicadores[planoTipo] || 1;
        const mesesReais = parseInt(duracao) * multiplicador;

        let duracaoTexto = duracao == 1 ? '1 pagamento com desconto' : `${duracao} pagamentos com desconto`;
        if (multiplicador > 1) {
          duracaoTexto += ` (aproximadamente ${mesesReais} meses)`;
        }

        // Format dates
        const dataInicioFormatada = dataInicio ? new Date(dataInicio + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
        const dataFimFormatada = dataFim ? new Date(dataFim + 'T00:00:00').toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';

        // Get campaign values info
        let valorInfo = '';
        if (tipoFixo) {
          const valorFixo = document.getElementById('campanha_valor_fixo').value;
          valorInfo = `de <strong>R$ ${parseFloat(valorFixo).toFixed(2)}</strong> por m√™s`;
        } else {
          valorInfo = 'com <strong>valores vari√°veis</strong> para cada m√™s';
        }

        texto = `O Plano "<strong>${tipoPlano}</strong>" ser√° criado com <strong>${telasTexto}</strong>, ` +
                `tendo o <strong>valor base de R$ ${valorFormatado}</strong>, com uma <strong class="text-warning">campanha ativa</strong> ` +
                `do tipo "<strong>${tipoDesconto}</strong>" ${valorInfo} que ir√° gerar <strong>${duracaoTexto}</strong> ` +
                `ao longo dos pr√≥ximos pagamentos dos clientes que forem associados a ela.`;

        if (dataInicioFormatada && dataFimFormatada) {
          texto += ` O prazo para adicionar novos clientes que poder√£o se beneficiar dessa campanha ser√° ` +
                   `de <strong>${dataInicioFormatada}</strong> a <strong>${dataFimFormatada}</strong>.`;
        } else if (dataInicioFormatada) {
          texto += ` Novos clientes poder√£o se beneficiar dessa campanha a partir de <strong>${dataInicioFormatada}</strong>.`;
        }

        // Add detail about progressive values if personalized
        if (!tipoFixo) {
          const valoresMeses = [];
          for (let i = 1; i <= parseInt(duracao); i++) {
            const valorMes = document.getElementById(`campanha_valor_mes_${i}`).value;
            valoresMeses.push(`R$ ${parseFloat(valorMes).toFixed(2)}`);
          }

          if (valoresMeses.length > 0) {
            texto += ` <br><small class="text-muted">Os valores por pagamento ser√£o: ${valoresMeses.join(', ')}.</small>`;
          }
        }

        // Add comparison with base value
        if (tipoFixo) {
          const valorFixo = parseFloat(document.getElementById('campanha_valor_fixo').value);
          const valorBase = parseFloat(valor);
          if (valorFixo < valorBase) {
            const desconto = valorBase - valorFixo;
            const percentualDesconto = ((desconto / valorBase) * 100).toFixed(0);
            texto += ` <br><small class="text-success fw-bold">Economia: R$ ${desconto.toFixed(2)} por pagamento (~${percentualDesconto}% de desconto).</small>`;
          }
        }

      } else {
        // Without campaign
        texto = `O Plano "<strong>${tipoPlano}</strong>" ser√° criado com <strong>${telasTexto}</strong> e ` +
                `<strong>valor mensal de R$ ${valorFormatado}</strong>. Este √© um plano <strong>regular</strong>, ` +
                `sem campanhas promocionais ativas. Todos os clientes associados a este plano pagar√£o o valor base.`;
      }

      resumoNarrativo.innerHTML = texto;
    }

    // ‚≠ê NOVO: Confirm button handler
    const btnConfirmarCadastro = document.getElementById('btn-confirmar-cadastro');
    if (btnConfirmarCadastro) {
      btnConfirmarCadastro.addEventListener('click', function() {
        // Ativar loading no bot√£o de confirma√ß√£o
        setButtonLoading(btnConfirmarCadastro, true);

        // Close modal and submit form
        const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirm-plano-modal'));
        confirmModal.hide();

        // Get form reference
        const form = document.getElementById('form-create-plano');

        // Create a hidden input to bypass the modal check
        const bypassInput = document.createElement('input');
        bypassInput.type = 'hidden';
        bypassInput.name = 'bypass_modal';
        bypassInput.value = 'true';
        form.appendChild(bypassInput);

        // Submit the form
        form.submit();
      });
    }

    // Restaurar ao voltar (bfcache)
    window.addEventListener('pageshow', function(e) {
      if (e.persisted) {
        const btnCadastrar = document.getElementById('btn-cadastrar-plano');
        const btnConfirmar = document.getElementById('btn-confirmar-cadastro');
        if (btnCadastrar) setButtonLoading(btnCadastrar, false, '<i class="bi bi-check-circle me-2"></i>Cadastrar Plano');
        if (btnConfirmar) setButtonLoading(btnConfirmar, false, '<i class="bi bi-check-circle me-2"></i>Confirmar Cadastro');
      }
    });
  });

  function exibirModalEdicao(botao) {
    const planoId = botao.dataset.servidor;
    const planoNome = botao.dataset.nome;
    const planoValor = botao.dataset.valor;
    const planoTelas = botao.dataset.telas;

    // ‚≠ê FASE 2.5: Campaign data
    const campanhaAtiva = botao.dataset.campanhaAtiva === 'true';
    const campanhaTipo = botao.dataset.campanhaTipo || 'FIXO';
    const campanhaDataInicio = botao.dataset.campanhaDataInicio || '';
    const campanhaDataFim = botao.dataset.campanhaDataFim || '';
    const campanhaDuracao = botao.dataset.campanhaDuracao || '1';
    const campanhaValorFixo = botao.getAttribute('data-campanha-valor-fixo') || '';

    // Get all month values (up to 12)
    const valoresMes = [];
    for (let i = 1; i <= 12; i++) {
      valoresMes[i] = botao.getAttribute(`data-campanha-valor-mes-${i}`) || '';
    }

    const form = document.querySelector("#edit-plano-form");
    form.action = `/editar-plano-adesao/${planoId}/`;
    form.querySelector("#edit-plano-nome").value = planoNome;
    form.querySelector("#edit-plano-valor").value = planoValor;
    form.querySelector("#edit-plano-telas").value = planoTelas;
    form.querySelector("#plano-id").value = planoId;

    // ‚≠ê FASE 2.5: Set campaign fields
    const editCampanhaCheckbox = form.querySelector("#edit-campanha-ativa");
    const editCampanhaConfig = document.getElementById('edit-campanha-config');
    editCampanhaCheckbox.checked = campanhaAtiva;
    editCampanhaConfig.style.display = campanhaAtiva ? 'block' : 'none';

    // Set campaign dates and duration
    form.querySelector("#edit-campanha-data-inicio").value = campanhaDataInicio;
    form.querySelector("#edit-campanha-data-fim").value = campanhaDataFim;
    form.querySelector("#edit-campanha-duracao").value = campanhaDuracao;

    // Set campaign value fixo
    form.querySelector("#edit-campanha-valor-fixo").value = campanhaValorFixo;

    // Set campaign type and generate dynamic fields if needed
    const editTipoFixo = form.querySelector("#edit-tipo-fixo");
    const editTipoPersonalizado = form.querySelector("#edit-tipo-personalizado");
    const editCamposMesesContainer = document.getElementById('edit-campos-meses-container');

    if (campanhaTipo === 'PERSONALIZADO') {
      editTipoPersonalizado.checked = true;
      document.getElementById('edit-valores-fixo').style.display = 'none';
      document.getElementById('edit-valores-personalizado').style.display = 'block';

      // Generate dynamic fields for edit modal
      const numMeses = parseInt(campanhaDuracao) || 1;
      editCamposMesesContainer.innerHTML = '';

      for (let i = 1; i <= numMeses; i++) {
        const col = document.createElement('div');
        col.className = 'col-4';

        const label = document.createElement('label');
        label.className = 'form-label small';
        label.textContent = `M√™s ${i}`;

        const inputGroup = document.createElement('div');
        inputGroup.className = 'input-group input-group-sm';

        const span = document.createElement('span');
        span.className = 'input-group-text';
        span.textContent = 'R$';

        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.id = `edit-campanha-valor-mes-${i}`;
        input.name = `campanha_valor_mes_${i}`;
        input.min = '0';
        input.step = '0.01';
        input.value = valoresMes[i] || '';

        inputGroup.appendChild(span);
        inputGroup.appendChild(input);
        col.appendChild(label);
        col.appendChild(inputGroup);
        editCamposMesesContainer.appendChild(col);
      }
    } else {
      editTipoFixo.checked = true;
      document.getElementById('edit-valores-fixo').style.display = 'block';
      document.getElementById('edit-valores-personalizado').style.display = 'none';
    }

    const modal = new bootstrap.Modal(document.querySelector("#edit-plano-modal"));
    modal.show();
  }

  $('#edit-plano-modal').on('click', '.btn-close, .btn-secondary', function () {
    $('#edit-plano-modal').modal('hide');
  });
</script>
