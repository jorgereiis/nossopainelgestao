{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }} | Nosso Painel{% endblock %}

{% block extra_css %}
<!-- Quill Editor CSS -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
    /* ============================================
       PREMIUM CARDS - Estilo Dashboard
       ============================================ */
    .premium-card {
        background: #fff;
        border-radius: 1rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: none;
        position: relative;
        overflow: hidden;
        transition: box-shadow 0.3s ease;
    }
    .premium-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    }
    .premium-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(180deg, var(--card-accent-start, #754ffe) 0%, var(--card-accent-end, #5a3fd6) 100%);
    }
    .premium-card.card-info::before {
        --card-accent-start: #0dcaf0;
        --card-accent-end: #0aa2c0;
    }
    .premium-card.card-success::before {
        --card-accent-start: #198754;
        --card-accent-end: #157347;
    }
    .premium-card.card-warning::before {
        --card-accent-start: #ffc107;
        --card-accent-end: #e0a800;
    }
    .premium-card .card-header {
        background: transparent;
        border-bottom: 1px solid #f1f5f9;
        padding: 1.25rem 1.5rem;
    }
    .premium-card .card-header h5 {
        font-size: 1rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .premium-card .card-body {
        padding: 1.5rem;
    }

    /* ============================================
       ALCANCE PREVIEW - Badge Premium
       ============================================ */
    .alcance-badge {
        background: linear-gradient(135deg, #f0ebff 0%, #e8e0ff 100%);
        border-radius: 0.75rem;
        padding: 1rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: all 0.3s ease;
    }
    .alcance-badge.loading {
        opacity: 0.7;
    }
    .alcance-badge .alcance-numero {
        font-size: 2rem;
        font-weight: 700;
        color: #754ffe;
        line-height: 1;
    }
    .alcance-badge .alcance-label {
        font-size: 0.875rem;
        color: #64748b;
    }
    .alcance-badge .alcance-icon {
        width: 48px;
        height: 48px;
        background: #754ffe;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 1.25rem;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .alcance-badge.updating .alcance-numero {
        animation: pulse 1s ease-in-out infinite;
    }

    /* ============================================
       TIPO DE AGENDAMENTO - Toggle Pills
       ============================================ */
    .agendamento-toggle {
        display: flex;
        background: #f1f5f9;
        border-radius: 0.75rem;
        padding: 0.25rem;
        gap: 0.25rem;
    }
    .agendamento-toggle label {
        flex: 1;
        text-align: center;
        padding: 0.75rem 1rem;
        border-radius: 0.625rem;
        cursor: pointer;
        font-weight: 500;
        color: #64748b;
        transition: all 0.2s ease;
        margin: 0;
    }
    .agendamento-toggle label:hover {
        color: #334155;
    }
    .agendamento-toggle input {
        display: none;
    }
    .agendamento-toggle input:checked + label {
        background: #754ffe;
        color: #fff;
        box-shadow: 0 2px 8px rgba(117, 79, 254, 0.3);
    }

    /* ============================================
       DIAS DA SEMANA - Botoes Modernos
       ============================================ */
    .dias-semana-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
    }
    @media (max-width: 767px) {
        .dias-semana-grid {
            grid-template-columns: repeat(4, 1fr);
        }
    }
    @media (max-width: 400px) {
        .dias-semana-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    .dia-btn {
        aspect-ratio: 1;
        max-width: 60px;
        width: 100%;
        border: 2px solid #e2e8f0;
        border-radius: 50%;
        background: #fff;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: #64748b;
        user-select: none;
    }
    .dia-btn:hover {
        border-color: #754ffe;
        transform: scale(1.05);
        background: #f8f5ff;
    }
    .dia-btn.active {
        background: linear-gradient(135deg, #754ffe 0%, #5a3fd6 100%);
        border-color: #754ffe;
        color: #fff;
        box-shadow: 0 4px 12px rgba(117, 79, 254, 0.3);
    }
    .dia-btn input {
        display: none;
    }
    .dia-btn .dia-sigla {
        font-size: 0.875rem;
        font-weight: 700;
    }

    /* ============================================
       CONFLITO ALERT
       ============================================ */
    .conflito-alert {
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 1px solid #f59e0b;
        border-radius: 0.75rem;
        padding: 1rem;
        display: none;
    }
    .conflito-alert.show {
        display: block;
        animation: shake 0.5s ease-in-out;
    }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    .conflito-alert .conflito-titulo {
        font-weight: 600;
        color: #92400e;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .conflito-alert .conflito-lista {
        font-size: 0.875rem;
        color: #78350f;
    }

    /* ============================================
       QUILL EDITOR CUSTOMIZADO
       ============================================ */
    #editor-container {
        height: 180px;
        background: #fff;
        border-radius: 0 0 0.75rem 0.75rem;
    }
    .ql-toolbar.ql-snow {
        border-radius: 0.75rem 0.75rem 0 0;
        border-color: #e2e8f0;
        background: #f8fafc;
    }
    .ql-container.ql-snow {
        border-color: #e2e8f0;
        border-radius: 0 0 0.75rem 0.75rem;
        font-size: 0.9375rem;
    }

    /* ============================================
       PREVIEW WHATSAPP - Estilo Premium
       ============================================ */
    .whatsapp-preview-container {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background: #fff;
    }
    .whatsapp-preview-container .whatsapp-chat-header {
        background: #075e54 !important;
        padding: 0.75rem 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    .whatsapp-preview-container .chat-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255,255,255,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
    }
    .whatsapp-preview-container .chat-info {
        display: flex;
        flex-direction: column;
    }
    .whatsapp-preview-container .chat-name {
        color: #fff;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .whatsapp-preview-container .chat-status {
        color: #25d366;
        font-size: 0.75rem;
    }
    .whatsapp-chat-body {
        background: linear-gradient(135deg, #e5ddd5 0%, #d6cfc6 100%);
        background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c8c0b5' fill-opacity='0.3'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        padding: 1rem;
        min-height: 150px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    .whatsapp-bubble {
        background: #dcf8c6;
        border-radius: 8px 8px 0 8px;
        padding: 0.5rem 0.75rem;
        max-width: 85%;
        position: relative;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .whatsapp-bubble::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border: 8px solid transparent;
        border-left-color: #dcf8c6;
        border-bottom-color: #dcf8c6;
    }
    .preview-image {
        max-width: 100%;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }
    .preview-text {
        margin: 0;
        font-size: 0.9rem;
        color: #303030;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .message-meta {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 0.15rem;
        margin-top: 0.25rem;
    }
    .message-time {
        font-size: 0.65rem;
        color: rgba(0,0,0,0.45);
    }
    .message-check {
        color: #53bdeb;
        font-size: 0.75rem;
    }

    /* ============================================
       RESUMO DINAMICO
       ============================================ */
    .resumo-card {
        background: linear-gradient(135deg, #f8f5ff 0%, #f0ebff 100%);
        border-radius: 0.75rem;
        padding: 1rem;
    }
    .resumo-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(117, 79, 254, 0.1);
    }
    .resumo-item:last-child {
        border-bottom: none;
    }
    .resumo-label {
        color: #64748b;
        font-size: 0.875rem;
    }
    .resumo-valor {
        font-weight: 600;
        color: #1e293b;
        font-size: 0.875rem;
    }

    /* ============================================
       IMAGEM PREVIEW
       ============================================ */
    .imagem-upload-area {
        border: 2px dashed #e2e8f0;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        background: #f8fafc;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .imagem-upload-area:hover {
        border-color: #754ffe;
        background: #f8f5ff;
    }
    .imagem-upload-area.has-image {
        border-style: solid;
        border-color: #754ffe;
    }
    .imagem-preview-thumb {
        max-width: 150px;
        max-height: 150px;
        border-radius: 0.5rem;
        object-fit: cover;
    }

    /* ============================================
       TEMPLATES MODAL
       ============================================ */
    .template-item {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .template-item:hover {
        border-color: #754ffe;
        background: #f8f5ff;
    }
    .template-categoria-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        background: #e2e8f0;
        color: #64748b;
    }

    /* ============================================
       STICKY PREVIEW
       ============================================ */
    @media (min-width: 992px) {
        .preview-sticky {
            position: sticky;
            top: 100px;
        }
    }
    @media (max-width: 991px) {
        .preview-column {
            order: -1;
            margin-bottom: 1.5rem;
        }
    }

    /* ============================================
       DATA ENVIO UNICO
       ============================================ */
    .data-envio-unico-container {
        display: none;
    }
    .data-envio-unico-container.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    .dias-semana-container {
        display: block;
    }
    .dias-semana-container.hide {
        display: none;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================
       FORM CONTROL MELHORADO
       ============================================ */
    .form-control-lg {
        border-radius: 0.5rem;
        border-color: #e2e8f0;
        padding: 0.75rem 1rem;
    }
    .form-control-lg:focus {
        border-color: #754ffe;
        box-shadow: 0 0 0 3px rgba(117, 79, 254, 0.1);
    }
    .form-select-lg {
        border-radius: 0.5rem;
        border-color: #e2e8f0;
        padding: 0.75rem 1rem;
    }
    .form-select-lg:focus {
        border-color: #754ffe;
        box-shadow: 0 0 0 3px rgba(117, 79, 254, 0.1);
    }

    /* ============================================
       SECTION HEADERS
       ============================================ */
    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    .section-header .section-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.125rem;
    }
    .section-header .section-icon.icon-primary {
        background: linear-gradient(135deg, #f0ebff 0%, #e8e0ff 100%);
        color: #754ffe;
    }
    .section-header .section-icon.icon-info {
        background: linear-gradient(135deg, #e0f7ff 0%, #cceeff 100%);
        color: #0dcaf0;
    }
    .section-header .section-icon.icon-success {
        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        color: #198754;
    }
    .section-header .section-title {
        font-weight: 600;
        font-size: 0.9375rem;
        color: #1e293b;
        margin: 0;
    }
    .section-header .section-subtitle {
        font-size: 0.8125rem;
        color: #64748b;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4 p-lg-6">
    <!-- Page header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-2">
                            <li class="breadcrumb-item"><a href="{% url 'tarefas-envio-lista' %}" class="text-decoration-none">Tarefas de Envio</a></li>
                            <li class="breadcrumb-item active">{{ titulo }}</li>
                        </ol>
                    </nav>
                    <h3 class="mb-0 fw-bold">{{ titulo }}</h3>
                </div>
                <a href="{% url 'tarefas-envio-lista' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" id="form-tarefa">
        {% csrf_token %}

        <!-- Mensagens e Erros -->
        {% if messages %}
        <div class="row mb-3">
            <div class="col-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {% if form.non_field_errors %}
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-danger" role="alert">
                    <strong><i class="bi bi-exclamation-triangle me-2"></i>Erro:</strong>
                    {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <!-- ==============================
                 COLUNA PRINCIPAL - FORMULARIO
                 ============================== -->
            <div class="col-lg-7 col-xl-8 mb-4">

                <!-- CARD 1: INFORMACOES BASICAS -->
                <div class="premium-card card-info mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle text-info"></i> Informacões Básicas</h5>
                    </div>
                    <div class="card-body">
                        <!-- Nome da Tarefa -->
                        <div class="mb-4">
                            <div class="section-header">
                                <div class="section-icon icon-primary">
                                    <i class="bi bi-tag-fill"></i>
                                </div>
                                <div>
                                    <p class="section-title">Nome da Tarefa <span class="text-danger">*</span></p>
                                    <p class="section-subtitle">Nome identificador para esta tarefa</p>
                                </div>
                            </div>
                            {{ form.nome }}
                            {% if form.nome.errors %}
                            <div class="text-danger small mt-1"><i class="bi bi-exclamation-circle me-1"></i>{{ form.nome.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Tipo de Envio + Preview Alcance -->
                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <div class="section-header">
                                    <div class="section-icon icon-info">
                                        <i class="bi bi-people-fill"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Público-Alvo <span class="text-danger">*</span></p>
                                        <p class="section-subtitle">Quem receberá as mensagens</p>
                                    </div>
                                </div>
                                {{ form.tipo_envio }}
                                {% if form.tipo_envio.errors %}
                                <div class="text-danger small mt-1">{{ form.tipo_envio.errors.0 }}</div>
                                {% endif %}

                                <!-- Dias desde Cancelamento (exibido quando tipo=cancelados) -->
                                <div id="dias-cancelamento-container" class="mt-3" style="display: none;">
                                    <div class="alert alert-warning py-2 mb-2">
                                        <small><i class="bi bi-info-circle me-1"></i>
                                        Defina quantos dias desde o cancelamento para incluir o cliente. Por exemplo, o cliente deverá estar cancelado há mais de 10 dias para estar associado a essa Tarefa.</small>
                                    </div>
                                    <div class="input-group">
                                        {{ form.dias_cancelamento }}
                                        <span class="input-group-text">dias</span>
                                    </div>
                                    {% if form.dias_cancelamento.errors %}
                                    <div class="text-danger small mt-1">{{ form.dias_cancelamento.errors.0 }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 mb-4">
                                <div class="section-header">
                                    <div class="section-icon icon-success">
                                        <i class="bi bi-broadcast"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Alcance Estimado</p>
                                        <p class="section-subtitle">Clientes que serão atingidos</p>
                                    </div>
                                </div>
                                <div class="alcance-badge" id="alcance-badge">
                                    <div class="alcance-icon">
                                        <i class="bi bi-people"></i>
                                    </div>
                                    <div>
                                        <div class="alcance-numero" id="alcance-numero">-</div>
                                        <div class="alcance-label" id="alcance-label">Selecione o público</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 2: AGENDAMENTO -->
                <div class="premium-card card-success mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-calendar-check text-success"></i> Agendamento</h5>
                    </div>
                    <div class="card-body">
                        <!-- Tipo de Agendamento Toggle -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-2">Tipo de Agendamento</label>
                            <div class="agendamento-toggle">
                                <input type="radio" name="tipo_agendamento" value="recorrente" id="tipo_recorrente"
                                       {% if not form.tipo_agendamento.value or form.tipo_agendamento.value == 'recorrente' %}checked{% endif %}>
                                <label for="tipo_recorrente">
                                    <i class="bi bi-arrow-repeat me-1"></i> Recorrente
                                </label>
                                <input type="radio" name="tipo_agendamento" value="unico" id="tipo_unico"
                                       {% if form.tipo_agendamento.value == 'unico' %}checked{% endif %}>
                                <label for="tipo_unico">
                                    <i class="bi bi-calendar-event me-1"></i> Envio Único
                                </label>
                            </div>
                            <small class="text-muted d-block mt-2">
                                <strong>Recorrente:</strong> repete nos dias/período selecionados |
                                <strong>Único:</strong> executa apenas uma vez na data específica
                            </small>
                        </div>

                        <!-- Dias da Semana (Recorrente) -->
                        <div class="mb-4 dias-semana-container" id="dias-semana-container">
                            <div class="section-header">
                                <div class="section-icon icon-success">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <div>
                                    <p class="section-title">Dias da Semana <span class="text-danger">*</span></p>
                                    <p class="section-subtitle">Selecione quando a tarefa será executada</p>
                                </div>
                            </div>
                            <div class="dias-semana-grid">
                                {% for value, label in form.dias_semana.field.choices %}
                                <label class="dia-btn {% if value|stringformat:'s' in form.dias_semana.value %}active{% endif %}">
                                    <input type="checkbox" name="dias_semana" value="{{ value }}"
                                           {% if value|stringformat:'s' in form.dias_semana.value %}checked{% endif %}>
                                    <span class="dia-sigla">{{ label|slice:":3" }}</span>
                                </label>
                                {% endfor %}
                            </div>
                            {% if form.dias_semana.errors %}
                            <div class="text-danger small mt-2">{{ form.dias_semana.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Data Envio Unico -->
                        <div class="mb-4 data-envio-unico-container {% if form.tipo_agendamento.value == 'unico' %}show{% endif %}" id="data-envio-container">
                            <div class="section-header">
                                <div class="section-icon icon-success">
                                    <i class="bi bi-calendar-date"></i>
                                </div>
                                <div>
                                    <p class="section-title">Data do Envio <span class="text-danger">*</span></p>
                                    <p class="section-subtitle">Selecione a data específica para envio</p>
                                </div>
                            </div>
                            {{ form.data_envio_unico }}
                            {% if form.data_envio_unico.errors %}
                            <div class="text-danger small mt-2">{{ form.data_envio_unico.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Periodo do Mes e Horario -->
                        <div class="row">
                            <!-- Periodo do Mes (oculto para ENVIO UNICO) -->
                            <div class="col-md-6 mb-4 mb-md-0" id="periodo-mes-container">
                                <div class="section-header">
                                    <div class="section-icon icon-primary">
                                        <i class="bi bi-calendar-range"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Período do Mês <span class="text-danger">*</span></p>
                                        <p class="section-subtitle">Intervalo de dias do mês</p>
                                    </div>
                                </div>
                                {{ form.periodo_mes }}
                                {% if form.periodo_mes.errors %}
                                <div class="text-danger small mt-1">{{ form.periodo_mes.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6" id="horario-container">
                                <div class="section-header">
                                    <div class="section-icon icon-info">
                                        <i class="bi bi-clock"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Horário <span class="text-danger">*</span></p>
                                        <p class="section-subtitle">Hora de início dos envios</p>
                                    </div>
                                </div>
                                <div class="input-group">
                                    {{ form.horario }}
                                    <button type="button" class="btn btn-outline-secondary" id="btn-sugestao-horarios"
                                            data-bs-toggle="tooltip" title="Ver sugestões de horários">
                                        <i class="bi bi-lightbulb-fill"></i>
                                    </button>
                                </div>
                                {% if form.horario.errors %}
                                <div class="text-danger small mt-1">{{ form.horario.errors.0 }}</div>
                                {% endif %}
                                <!-- Sugestoes de Horarios -->
                                <div id="sugestoes-horarios" class="mt-2 d-none">
                                    <div class="card bg-light border-0">
                                        <div class="card-body py-2 px-3">
                                            <h6 class="small fw-bold mb-2"><i class="bi bi-lightbulb text-warning me-1"></i>Horários Sugeridos</h6>
                                            <div id="lista-sugestoes"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Alerta de Conflito -->
                        <div class="conflito-alert mt-4" id="conflito-alert">
                            <div class="conflito-titulo">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                Possível Conflito de Horário
                            </div>
                            <div class="conflito-lista" id="conflito-lista">
                                <!-- Preenchido via JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD 3: MENSAGEM -->
                <div class="premium-card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="bi bi-chat-square-text text-primary"></i> Mensagem</h5>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-templates">
                            <i class="bi bi-file-earmark-text me-1"></i> Templates
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Imagem -->
                        <div class="mb-4">
                            <div class="section-header">
                                <div class="section-icon icon-primary">
                                    <i class="bi bi-image"></i>
                                </div>
                                <div>
                                    <p class="section-title">Imagem <span class="badge bg-light text-muted ms-1">Opcional</span></p>
                                    <p class="section-subtitle">JPG, PNG, GIF, WEBP - Max 5MB</p>
                                </div>
                            </div>

                            <div class="imagem-upload-area {% if editando and object.imagem %}has-image{% endif %}" id="imagem-upload-area">
                                {% if editando and object.imagem %}
                                <div id="imagem-atual-container">
                                    <img src="{{ object.imagem.url }}" alt="Imagem atual" class="imagem-preview-thumb" id="imagem-atual">
                                    <p class="small text-muted mb-0 mt-2">Clique para alterar</p>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="btn-remover-imagem">
                                        <i class="bi bi-trash me-1"></i>Remover
                                    </button>
                                </div>
                                {% endif %}
                                <div id="imagem-placeholder" class="{% if editando and object.imagem %}d-none{% endif %}">
                                    <i class="bi bi-cloud-arrow-up fs-1 text-muted"></i>
                                    <p class="mb-0 text-muted">Clique ou arraste uma imagem</p>
                                </div>
                                <div class="d-none" id="nova-imagem-preview">
                                    <img src="" alt="Preview" class="imagem-preview-thumb">
                                    <p class="small text-muted mb-0 mt-2">Nova imagem selecionada</p>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="btn-remover-nova-imagem">
                                        <i class="bi bi-x me-1"></i>Cancelar
                                    </button>
                                </div>
                            </div>
                            <input type="file" class="d-none" id="id_imagem" name="imagem"
                                   accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                            {% if form.imagem.errors %}
                            <div class="text-danger small mt-2">{{ form.imagem.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Editor de Mensagem -->
                        <div class="mb-4">
                            <div class="section-header">
                                <div class="section-icon icon-info">
                                    <i class="bi bi-pencil-square"></i>
                                </div>
                                <div>
                                    <p class="section-title">Texto da Mensagem <span class="text-danger">*</span></p>
                                    <p class="section-subtitle">Use negrito e itálico para destacar</p>
                                </div>
                            </div>
                            <div id="editor-container"></div>
                            {{ form.mensagem }}
                            {% if form.mensagem.errors %}
                            <div class="text-danger small mt-2">{{ form.mensagem.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Salvar como Template -->
                        <div class="text-end">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-salvar-template">
                                <i class="bi bi-bookmark-plus me-1"></i> Salvar como Template
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CARD 4: CONFIGURACOES AVANCADAS -->
                <div class="premium-card card-warning mb-4">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#configAvancadas" role="button">
                        <h5 class="d-flex justify-content-between align-items-center w-100">
                            <span><i class="bi bi-gear text-warning"></i> Configurações Avançadas</span>
                            <i class="bi bi-chevron-down" id="config-chevron"></i>
                        </h5>
                    </div>
                    <div class="collapse {% if form.filtro_estados.value or form.pausado_ate.value %}show{% endif %}" id="configAvancadas">
                        <div class="card-body">
                            <!-- Segmentacao por Estados -->
                            <div class="mb-4" id="secao-filtro-estados">
                                <div class="section-header">
                                    <div class="section-icon icon-info">
                                        <i class="bi bi-geo-alt-fill"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Segmentação por Estados</p>
                                        <p class="section-subtitle">Deixe vazio para enviar para todos</p>
                                    </div>
                                </div>
                                <div class="row">
                                    {% for value, label in form.filtro_estados.field.choices %}
                                    <div class="col-6 col-md-4 col-lg-3 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input filtro-estado-check" type="checkbox"
                                                   name="filtro_estados" value="{{ value }}" id="uf_{{ value }}"
                                                   {% if value in form.filtro_estados.value %}checked{% endif %}>
                                            <label class="form-check-label small" for="uf_{{ value }}">{{ value }}</label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Pausar Ate -->
                            <div>
                                <div class="section-header">
                                    <div class="section-icon icon-primary">
                                        <i class="bi bi-pause-circle-fill"></i>
                                    </div>
                                    <div>
                                        <p class="section-title">Pausar a Tarefa Até...</p>
                                        <p class="section-subtitle">
                                            É uma funcionalidade de pausa temporária automática. 
                                            Defina uma data/hora futura e a tarefa ficará inativa até esse momento. 
                                            Quando a data passar, a tarefa voltará a executar automaticamente sem intervenção manual.
                                            Isso é útil para férias, feriados ou períodos específicos em que você não deseja que as tarefas sejam enviadas.
                                        </p>
                                    </div>
                                </div>
                                {{ form.pausado_ate }}
                                {% if object.pausado_ate %}
                                <div class="alert alert-warning mt-2 mb-0 py-2 px-3 d-flex align-items-center justify-content-between">
                                    <span>
                                        <i class="bi bi-pause-circle me-2"></i>
                                        Pausada ate: <strong>{{ object.pausado_ate|date:"d/m/Y H:i" }}</strong>
                                    </span>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="$('#id_pausado_ate').val('');">
                                        <i class="bi bi-play-circle me-1"></i>Remover
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STATUS E BOTOES -->
                <div class="premium-card">
                    <div class="card-body">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                            <!-- Switch Ativo -->
                            <div class="form-check form-switch">
                                {{ form.ativo }}
                                <label class="form-check-label fw-semibold" for="id_ativo">
                                    <i class="bi bi-power me-1"></i> Tarefa Ativa
                                </label>
                            </div>
                            <!-- Botoes -->
                            <div class="d-flex gap-2">
                                <a href="{% url 'tarefas-envio-lista' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-lg me-1"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="bi bi-check-lg me-1"></i> {{ botao_submit }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==============================
                 COLUNA LATERAL - PREVIEW
                 ============================== -->
            <div class="col-lg-5 col-xl-4 preview-column">
                <div class="preview-sticky">
                    <!-- Preview WhatsApp - Estilo Premium -->
                    <div class="whatsapp-preview-container mb-4">
                        <!-- Header do Chat -->
                        <div class="whatsapp-chat-header">
                            <div class="chat-avatar">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div class="chat-info">
                                <span class="chat-name">Cliente</span>
                                <span class="chat-status">online</span>
                            </div>
                        </div>
                        <!-- Corpo do Chat -->
                        <div class="whatsapp-chat-body">
                            <div class="whatsapp-bubble" id="preview-bubble">
                                <img class="preview-image d-none" id="preview-imagem" src="" alt="Preview imagem">
                                <p class="preview-text" id="preview-texto">Digite sua mensagem...</p>
                                <span class="message-meta">
                                    <span class="message-time" id="preview-time">12:00</span>
                                    <span class="message-check"><i class="bi bi-check2-all"></i></span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Resumo Dinamico -->
                    <div class="premium-card">
                        <div class="card-header">
                            <h5><i class="bi bi-list-check text-primary"></i> Resumo da Tarefa</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="resumo-card m-3">
                                <div class="resumo-item">
                                    <span class="resumo-label">Público</span>
                                    <span class="resumo-valor" id="resumo-publico">-</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="resumo-label">Agendamento</span>
                                    <span class="resumo-valor" id="resumo-agendamento">-</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="resumo-label">Horário</span>
                                    <span class="resumo-valor" id="resumo-horario">-</span>
                                </div>
                                <div class="resumo-item">
                                    <span class="resumo-label">Status</span>
                                    <span class="resumo-valor" id="resumo-status">
                                        <span class="badge bg-success">Ativa</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Templates -->
<div class="modal fade" id="templatesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Templates de Mensagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templates-loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Carregando templates...</p>
                </div>
                <div id="templates-empty" class="text-center py-4 d-none">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-2 text-muted">Nenhum template salvo ainda</p>
                </div>
                <div id="templates-lista" class="d-none">
                    <!-- Preenchido via JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Aviso: Tarefa em Execução -->
<div class="modal fade" id="modalEmExecucao" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10 border-warning">
                <h5 class="modal-title text-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Tarefa em Execução
                </h5>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-start gap-3">
                    <div class="flex-shrink-0">
                        <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-send-fill text-warning fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <p class="mb-2">
                            <strong>Esta tarefa está enviando mensagens neste momento.</strong>
                        </p>
                        <p class="text-muted mb-0">
                            As alterações que você fez serão salvas, porém <strong>só terão efeito nos próximos envios</strong>
                            agendados no calendário. O envio atual continuará com as configurações anteriores.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" id="btn-confirmar-salvar-execucao">
                    <i class="bi bi-check-lg me-1"></i>Entendi, Salvar Mesmo Assim
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Editor JS -->
<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
$(document).ready(function() {
    // ============================================
    // VARIAVEIS GLOBAIS
    // ============================================
    let debounceAlcance = null;
    let debounceConflito = null;
    const tarefaId = '{{ object.pk|default:"" }}';
    const tarefaEmExecucao = {{ tarefa_em_execucao|yesno:"true,false" }};
    let confirmouSalvarEmExecucao = false;

    // ============================================
    // QUILL EDITOR
    // ============================================
    const quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'Digite sua mensagem aqui...',
        modules: {
            toolbar: [['bold', 'italic']]
        }
    });

    // Carrega conteudo existente
    const conteudoExistente = $('#id_mensagem').val();
    if (conteudoExistente) {
        quill.root.innerHTML = conteudoExistente;
    }

    // Sincroniza Quill com campo hidden
    quill.on('text-change', function() {
        const html = quill.root.innerHTML;
        $('#id_mensagem').val(html);
        atualizarPreview();
    });

    // ============================================
    // TIPO DE AGENDAMENTO TOGGLE
    // ============================================
    function atualizarExibicaoPorAgendamento() {
        const tipo = $('input[name="tipo_agendamento"]:checked').val();
        if (tipo === 'unico') {
            $('#dias-semana-container').addClass('hide');
            $('#data-envio-container').addClass('show');
            $('#periodo-mes-container').hide();  // Oculta periodo do mes
            $('#horario-container').removeClass('col-md-6').addClass('col-md-12');  // Horario ocupa linha toda
        } else {
            $('#dias-semana-container').removeClass('hide');
            $('#data-envio-container').removeClass('show');
            $('#periodo-mes-container').show();  // Mostra periodo do mes
            $('#horario-container').removeClass('col-md-12').addClass('col-md-6');  // Volta ao tamanho normal
        }
        atualizarResumo();
    }

    $('input[name="tipo_agendamento"]').on('change', atualizarExibicaoPorAgendamento);

    // Inicializa estado ao carregar
    atualizarExibicaoPorAgendamento();

    // ============================================
    // DIAS DA SEMANA
    // ============================================
    $('.dia-btn input[type="checkbox"]').on('change', function() {
        const $label = $(this).closest('.dia-btn');
        $label.toggleClass('active', $(this).is(':checked'));
        verificarConflito();
        atualizarResumo();
    });

    // ============================================
    // CONTROLE DE EXIBICAO POR TIPO DE ENVIO
    // ============================================
    function atualizarExibicaoPorTipo() {
        const tipoEnvio = $('#id_tipo_envio').val();

        // Dias de cancelamento: apenas para tipo cancelados
        if (tipoEnvio === 'cancelados') {
            $('#dias-cancelamento-container').show();
        } else {
            $('#dias-cancelamento-container').hide();
        }

        // Card de configuracoes avancadas: ocultar para leads (avulso)
        if (tipoEnvio === 'avulso') {
            // Oculta segmentacao por estados para leads
            $('#secao-filtro-estados').hide();
        } else {
            // Mostra segmentacao por estados para ativos e cancelados
            $('#secao-filtro-estados').show();
        }
    }

    // ============================================
    // PREVIEW DE ALCANCE
    // ============================================
    function carregarAlcance() {
        const tipoEnvio = $('#id_tipo_envio').val();
        if (!tipoEnvio) {
            $('#alcance-numero').text('-');
            $('#alcance-label').text('Selecione o publico');
            return;
        }

        const estados = [];
        $('.filtro-estado-check:checked').each(function() {
            estados.push($(this).val());
        });

        const diasCancelamento = $('#id_dias_cancelamento').val() || 10;

        $('#alcance-badge').addClass('loading updating');

        clearTimeout(debounceAlcance);
        debounceAlcance = setTimeout(function() {
            $.ajax({
                url: '{% url "tarefas-envio-preview-alcance" %}',
                method: 'GET',
                data: {
                    tipo_envio: tipoEnvio,
                    'filtro_estados[]': estados,
                    dias_cancelamento: diasCancelamento
                },
                success: function(response) {
                    if (response.success) {
                        $('#alcance-numero').text(response.total.toLocaleString('pt-BR'));
                        // Label dinamico baseado no tipo (usa response do backend)
                        if (response.tipo_envio === 'avulso') {
                            $('#alcance-label').text('leads cadastrados');
                        } else {
                            $('#alcance-label').text('clientes serao atingidos');
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Erro ao carregar alcance:', status, error);
                    $('#alcance-numero').text('-');
                    $('#alcance-label').text('Erro ao calcular');
                },
                complete: function() {
                    $('#alcance-badge').removeClass('loading updating');
                }
            });
        }, 300);
    }

    $('#id_tipo_envio').on('change', function() {
        atualizarExibicaoPorTipo();
        carregarAlcance();
        atualizarResumo();
    });

    $('.filtro-estado-check').on('change', carregarAlcance);
    $('#id_dias_cancelamento').on('change', carregarAlcance);

    // Carrega estado inicial
    atualizarExibicaoPorTipo();
    carregarAlcance();

    // ============================================
    // VERIFICAR CONFLITO DE HORARIO
    // ============================================
    function verificarConflito() {
        const horario = $('#id_horario').val();
        const diasSelecionados = [];
        $('input[name="dias_semana"]:checked').each(function() {
            diasSelecionados.push($(this).val());
        });

        if (!horario || diasSelecionados.length === 0) {
            $('#conflito-alert').removeClass('show');
            return;
        }

        clearTimeout(debounceConflito);
        debounceConflito = setTimeout(function() {
            $.ajax({
                url: '{% url "tarefas-envio-verificar-conflito" %}',
                method: 'GET',
                data: {
                    horario: horario,
                    'dias_semana[]': diasSelecionados,
                    tarefa_id: tarefaId
                },
                success: function(response) {
                    if (response.success && response.tem_conflito) {
                        let html = '<ul class="mb-0 ps-3">';
                        response.conflitos.forEach(function(c) {
                            html += `<li><strong>${c.nome}</strong> (${c.tipo_envio}) - ${c.dias_conflito.join(', ')}</li>`;
                        });
                        html += '</ul>';
                        html += '<small class="d-block mt-2">Você pode continuar, mas as tarefas serão executadas simultaneamente.</small>';
                        $('#conflito-lista').html(html);
                        $('#conflito-alert').addClass('show');
                    } else {
                        $('#conflito-alert').removeClass('show');
                    }
                }
            });
        }, 500);
    }

    $('#id_horario').on('change', function() {
        verificarConflito();
        atualizarResumo();
    });

    // ============================================
    // UPLOAD DE IMAGEM
    // ============================================
    $('#imagem-upload-area').on('click', function(e) {
        if (!$(e.target).is('button') && !$(e.target).closest('button').length) {
            $('#id_imagem').click();
        }
    });

    $('#id_imagem').on('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#imagem-placeholder').addClass('d-none');
                $('#imagem-atual-container').addClass('d-none');
                $('#nova-imagem-preview').removeClass('d-none').find('img').attr('src', e.target.result);
                $('#imagem-upload-area').addClass('has-image');
                // Remove o campo imagem-clear se existir (importante para substituir imagem)
                $('input[name="imagem-clear"]').remove();
                atualizarPreview();
            };
            reader.readAsDataURL(file);
        }
    });

    $('#btn-remover-imagem').on('click', function(e) {
        e.stopPropagation();
        $('#imagem-atual-container').addClass('d-none');
        $('#imagem-placeholder').removeClass('d-none');
        $('#imagem-upload-area').removeClass('has-image');
        $('<input>').attr({type: 'hidden', name: 'imagem-clear', value: 'true'}).appendTo('#form-tarefa');
        atualizarPreview();
    });

    $('#btn-remover-nova-imagem').on('click', function(e) {
        e.stopPropagation();
        $('#id_imagem').val('');
        $('#nova-imagem-preview').addClass('d-none');
        {% if editando and object.imagem %}
        $('#imagem-atual-container').removeClass('d-none');
        {% else %}
        $('#imagem-placeholder').removeClass('d-none');
        $('#imagem-upload-area').removeClass('has-image');
        {% endif %}
        atualizarPreview();
    });

    // ============================================
    // PREVIEW WHATSAPP
    // ============================================
    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
    }

    function atualizarPreview() {
        const html = quill.root.innerHTML;
        let texto = html;
        texto = texto.replace(/<p>/g, '');
        texto = texto.replace(/<\/p>/g, '\n');
        texto = texto.replace(/<strong>(.*?)<\/strong>/g, '*$1*');
        texto = texto.replace(/<b>(.*?)<\/b>/g, '*$1*');
        texto = texto.replace(/<em>(.*?)<\/em>/g, '_$1_');
        texto = texto.replace(/<i>(.*?)<\/i>/g, '_$1_');
        texto = texto.replace(/<[^>]+>/g, '');
        texto = texto.replace(/&nbsp;/g, ' ');
        texto = texto.replace(/\n{3,}/g, '\n\n');
        texto = texto.trim();

        if (texto) {
            // Formata *texto* como negrito e _texto_ como itálico para exibição
            let textoFormatado = texto.replace(/\n/g, '<br>');
            textoFormatado = textoFormatado.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
            textoFormatado = textoFormatado.replace(/_(.*?)_/g, '<em>$1</em>');
            $('#preview-texto').html(textoFormatado);
        } else {
            $('#preview-texto').text('Digite sua mensagem...');
        }

        // Atualiza hora do preview
        $('#preview-time').text(getCurrentTime());

        // Imagem
        const novaImagem = $('#nova-imagem-preview img').attr('src');
        const imagemAtual = $('#imagem-atual').attr('src');
        const imagemAtualVisivel = !$('#imagem-atual-container').hasClass('d-none');

        if (novaImagem && !$('#nova-imagem-preview').hasClass('d-none')) {
            $('#preview-imagem').attr('src', novaImagem).removeClass('d-none');
        } else if (imagemAtual && imagemAtualVisivel) {
            $('#preview-imagem').attr('src', imagemAtual).removeClass('d-none');
        } else {
            $('#preview-imagem').addClass('d-none');
        }
    }

    // ============================================
    // RESUMO DINAMICO
    // ============================================
    function atualizarResumo() {
        // Publico
        const tipoEnvio = $('#id_tipo_envio option:selected').text();
        $('#resumo-publico').text(tipoEnvio || '-');

        // Agendamento
        const tipoAgendamento = $('input[name="tipo_agendamento"]:checked').val();
        if (tipoAgendamento === 'unico') {
            const data = $('#id_data_envio_unico').val();
            if (data) {
                const d = new Date(data + 'T00:00:00');
                $('#resumo-agendamento').text(d.toLocaleDateString('pt-BR'));
            } else {
                $('#resumo-agendamento').text('Único (selecione data)');
            }
        } else {
            const diasSelecionados = [];
            const DIAS = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab', 'Dom'];
            $('input[name="dias_semana"]:checked').each(function() {
                diasSelecionados.push(DIAS[parseInt($(this).val())]);
            });
            $('#resumo-agendamento').text(diasSelecionados.length ? diasSelecionados.join(', ') : '-');
        }

        // Horario
        const horario = $('#id_horario').val();
        $('#resumo-horario').text(horario || '-');

        // Status
        const ativo = $('#id_ativo').is(':checked');
        if (ativo) {
            $('#resumo-status').html('<span class="badge bg-success">Ativa</span>');
        } else {
            $('#resumo-status').html('<span class="badge bg-secondary">Inativa</span>');
        }
    }

    $('#id_ativo').on('change', atualizarResumo);
    $('#id_data_envio_unico').on('change', atualizarResumo);

    // Atualiza resumo inicial
    atualizarResumo();
    atualizarPreview();

    // ============================================
    // SUGESTOES DE HORARIOS
    // ============================================
    $('#btn-sugestao-horarios').on('click', function() {
        const $btn = $(this);
        const $container = $('#sugestoes-horarios');
        const $lista = $('#lista-sugestoes');

        if (!$container.hasClass('d-none')) {
            $container.addClass('d-none');
            return;
        }

        $btn.prop('disabled', true);
        $lista.html('<span class="text-muted"><i class="bi bi-hourglass-split me-1"></i>Carregando...</span>');
        $container.removeClass('d-none');

        $.ajax({
            url: '{% url "tarefas-envio-sugestao-horarios" %}',
            method: 'GET',
            success: function(response) {
                if (response.success && response.sugestoes) {
                    let html = '';
                    response.sugestoes.forEach(function(s) {
                        html += `
                            <div class="d-flex align-items-center justify-content-between py-1 border-bottom">
                                <button type="button" class="btn btn-sm btn-outline-primary btn-aplicar-horario" data-horario="${s.horario}">
                                    ${s.horario}
                                </button>
                                <small class="text-muted ms-2">${s.motivo}</small>
                            </div>
                        `;
                    });
                    $lista.html(html);
                }
            },
            complete: function() {
                $btn.prop('disabled', false);
            }
        });
    });

    $(document).on('click', '.btn-aplicar-horario', function() {
        $('#id_horario').val($(this).data('horario'));
        $('#sugestoes-horarios').addClass('d-none');
        verificarConflito();
        atualizarResumo();
    });

    // ============================================
    // TEMPLATES
    // ============================================
    $('#btn-templates').on('click', function() {
        const modal = new bootstrap.Modal('#templatesModal');
        modal.show();

        $('#templates-loading').removeClass('d-none');
        $('#templates-empty, #templates-lista').addClass('d-none');

        $.ajax({
            url: '{% url "tarefas-envio-templates" %}',
            method: 'GET',
            success: function(response) {
                $('#templates-loading').addClass('d-none');

                if (response.success && response.total > 0) {
                    let html = '';
                    Object.keys(response.categorias).forEach(function(cat) {
                        const categoria = response.categorias[cat];
                        html += `<h6 class="fw-bold text-muted mb-2 mt-3">${categoria.nome}</h6>`;
                        categoria.templates.forEach(function(t) {
                            html += `
                                <div class="template-item mb-2" data-mensagem="${encodeURIComponent(t.mensagem_html)}">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>${t.nome}</strong>
                                            ${t.descricao ? `<p class="small text-muted mb-0">${t.descricao}</p>` : ''}
                                        </div>
                                        ${t.tem_imagem ? '<i class="bi bi-image text-muted"></i>' : ''}
                                    </div>
                                </div>
                            `;
                        });
                    });
                    $('#templates-lista').html(html).removeClass('d-none');
                } else {
                    $('#templates-empty').removeClass('d-none');
                }
            }
        });
    });

    $(document).on('click', '.template-item', function() {
        const mensagem = decodeURIComponent($(this).data('mensagem'));
        quill.root.innerHTML = mensagem;
        $('#id_mensagem').val(mensagem);
        atualizarPreview();
        bootstrap.Modal.getInstance('#templatesModal').hide();
    });

    // Salvar como Template
    $('#btn-salvar-template').on('click', function() {
        const mensagem = quill.root.innerHTML;
        const textoLimpo = quill.getText().trim();

        if (!textoLimpo) {
            Swal.fire('Atencao', 'Digite uma mensagem antes de salvar como template.', 'warning');
            return;
        }

        Swal.fire({
            title: 'Salvar como Template',
            html: `
                <div class="mb-3 text-start">
                    <label class="form-label">Nome do Template</label>
                    <input type="text" id="swal-nome" class="form-control" placeholder="Ex: Promoção de Natal">
                </div>
                <div class="mb-3 text-start">
                    <label class="form-label">Categoria</label>
                    <select id="swal-categoria" class="form-select">
                        <option value="geral">Geral</option>
                        <option value="promocao">Promoção</option>
                        <option value="lembrete">Lembrete</option>
                        <option value="boas_vindas">Boas-vindas</option>
                        <option value="cobranca">Cobrança</option>
                    </select>
                </div>
                <div class="text-start">
                    <label class="form-label">Descrição (opcional)</label>
                    <input type="text" id="swal-descricao" class="form-control" placeholder="Breve descrição">
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Salvar',
            cancelButtonText: 'Cancelar',
            preConfirm: () => {
                const nome = $('#swal-nome').val().trim();
                if (!nome) {
                    Swal.showValidationMessage('Digite um nome para o template');
                    return false;
                }
                return {
                    nome: nome,
                    categoria: $('#swal-categoria').val(),
                    descricao: $('#swal-descricao').val().trim(),
                    mensagem: mensagem
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: '{% url "tarefas-envio-template-salvar" %}',
                    method: 'POST',
                    contentType: 'application/json',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    data: JSON.stringify(result.value),
                    success: function(response) {
                        if (response.success) {
                            Swal.fire('Salvo!', response.message, 'success');
                        } else {
                            Swal.fire('Erro', response.error, 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Erro', 'Erro ao salvar template', 'error');
                    }
                });
            }
        });
    });

    // ============================================
    // SUBMIT DO FORMULARIO
    // ============================================
    $('#form-tarefa').on('submit', function(e) {
        const html = quill.root.innerHTML;
        $('#id_mensagem').val(html);

        const tipoAgendamento = $('input[name="tipo_agendamento"]:checked').val();

        if (tipoAgendamento === 'recorrente') {
            const diasSelecionados = $('input[name="dias_semana"]:checked').length;
            if (diasSelecionados === 0) {
                e.preventDefault();
                Swal.fire('Atencao', 'Selecione pelo menos um dia da semana.', 'warning');
                return false;
            }
        } else {
            const dataEnvio = $('#id_data_envio_unico').val();
            if (!dataEnvio) {
                e.preventDefault();
                Swal.fire('Atencao', 'Selecione a data para envio único.', 'warning');
                return false;
            }
        }

        // Verifica se tarefa está em execução e usuário ainda não confirmou
        if (tarefaEmExecucao && !confirmouSalvarEmExecucao) {
            e.preventDefault();
            $('#modalEmExecucao').modal('show');
            return false;
        }

        return true;
    });

    // Handler do botão de confirmação do modal de execução
    $('#btn-confirmar-salvar-execucao').on('click', function() {
        confirmouSalvarEmExecucao = true;
        $('#modalEmExecucao').modal('hide');
        $('#form-tarefa').submit();
    });

    // ============================================
    // COLLAPSE CHEVRON ANIMATION
    // ============================================
    $('#configAvancadas').on('show.bs.collapse', function() {
        $('#config-chevron').css('transform', 'rotate(180deg)');
    }).on('hide.bs.collapse', function() {
        $('#config-chevron').css('transform', 'rotate(0deg)');
    });

    // ============================================
    // INICIALIZACOES
    // ============================================
    if (typeof feather !== 'undefined') {
        feather.replace();
    }

    // Inicializa tooltip
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Trigger inicial para tipo de agendamento
    $('input[name="tipo_agendamento"]:checked').trigger('change');
});
</script>
{% endblock %}
