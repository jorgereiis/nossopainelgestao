{% comment %} Lista de notifica√ß√µes para o dropdown {% endcomment %}
<ul class="list-group list-group-flush notification-list-scroll">
  {% if notificacoes_sistema %}
    {% for n in notificacoes_sistema %}
      <li class="list-group-item {% if n.prioridade == 'critica' %}bg-danger bg-opacity-10{% elif n.prioridade == 'alta' %}bg-warning bg-opacity-10{% else %}bg-info bg-opacity-10{% endif %}">
        <div class="d-flex justify-content-between align-items-start">
          <div class="text-decoration-none">
            <h6 class="mb-1">
              {% if n.prioridade == 'critica' %}
                <span class="badge bg-danger me-2">Cr√≠tico</span>
              {% elif n.prioridade == 'alta' %}
                <span class="badge bg-warning text-dark me-2">Alerta</span>
              {% elif n.tipo == 'mudanca_plano' %}
                <span class="badge bg-info me-2">Plano</span>
              {% else %}
                <span class="badge bg-secondary me-2">Info</span>
              {% endif %}
              {{ n.titulo }}
            </h6>
            <p class="mb-0 fs-6 text-muted">{{ n.mensagem|truncatewords:20 }}</p>
            <small class="text-muted">{{ n.criada_em|timesince }} atr√°s</small>
          </div>
          <button type="button" class="btn btn-sm btn-outline-secondary ms-2 btn-marcar-lida"
                  data-notif-id="{{ n.id }}" title="Marcar como lida">
            <i class="bi bi-check"></i>
          </button>
        </div>
      </li>
    {% endfor %}
  {% endif %}

  {% if notif_items %}
    {% for m in notif_items %}
      <li class="list-group-item bg-light">
        <a href="#" class="text-muted text-decoration-none">
          <h6 class="mb-1">
            <span class="badge bg-danger me-2">Vencida</span>
            {{ m.cliente.nome }}
            &mdash; <span class="badge {% if m.cliente.forma_pgto.nome == 'Cart√£o de Cr√©dito' %}bg-primary{% else %}bg-warning text-dark{% endif %}">
                {{ m.cliente.forma_pgto.nome }}
              </span>
          </h6>
          <p class="mb-0 fs-6">
            Venceu em <strong>{{ m.dt_vencimento|date:"d/m/Y" }}</strong>.
            Plano: <strong>{{ m.cliente.plano.nome }}</strong>.
            Valor: <strong>R$ {{ m.valor }}</strong>.
          </p>
        </a>
      </li>
    {% endfor %}
  {% endif %}

  {% if not notif_items and not notificacoes_sistema %}
    <li class="list-group-item text-center text-muted">Nenhuma notifica√ß√£o üôÇ</li>
  {% endif %}
</ul>

<script>
  // Marcar notifica√ß√£o do sistema como lida
  $(document).on('click', '.btn-marcar-lida', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const btn = $(this);
    const notifId = btn.data('notif-id');

    $.ajax({
      url: '/api/notificacoes/' + notifId + '/marcar-lida/',
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      },
      success: function() {
        btn.closest('li').fadeOut(300, function() {
          $(this).remove();
          // Atualizar contagem
          if (typeof refreshBadge === 'function') refreshBadge();
        });
      }
    });
  });
</script>
