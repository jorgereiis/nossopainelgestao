{% extends 'base.html' %}
{% load static %}
{% now "Y" as now %}

{% block title %}Dashboard | Nosso Painel - Gestão Simplificada{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
<!-- Estilos de dropdown movidos para dashboard.css (.table-dropdown-item) -->
{% endblock %}

{% block modals %}
    {% include 'partials/modal_whatsapp.html' %}
    {% include 'partials/modal_dns.html' %}
    {% include 'partials/modal_adminlogs.html' %}
    {% include 'partials/modal_userlogs.html' %}
    {% include 'notificacoes/modal.html' %}
    {% include 'partials/modal_confirm_cancelamento.html' %}
    {% include 'partials/modal_confirm_pagamento.html' %}
    {% include 'partials/modal_info_cliente.html' %}
    {% include 'partials/modal_confirm_delete_app.html' %}
    {% include 'partials/modal_create_app.html' %}
    {% include 'partials/modal_edit_cliente.html' %}
    {% include 'partials/modal_edit_revendedor.html' %}
    {% include 'partials/modal_create_revendedor.html' %}
    {% include 'partials/modal_aviso_limite.html' %}
    {% include 'partials/modal_alertas_fastdepix.html' %}
{% endblock %}

{% block content %}
    <!-- Faixa superior -->
                <div class="bg-primary pt-10 pb-21"></div>
                <div class="container-fluid mt-n22 px-6">
                    <div class="row">
                        <div class="col-12">
                            <!-- Page header -->
                            <div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="mb-2 mb-lg-0">
                                        <input id="data_criacao_user" value="{{data_criacao_user}}" hidden>
                                        <h2 class="mb-0  text-white">Boas-vindas, {{ nome_user }} 
                                            <i class="bi bi-eye" id="eye"></i>
                                        </h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                    <!-- LINHA DE CARDS: 1/2/4/5 por breakpoint -->
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 row-cols-xl-5 g-4 mt-6">
                        <div class="col objeto">
                            <!-- card superior 1 -->
                            <div class="card dashboard-stat-card">
                                <div class="card-body">
                                    <div class="card-header-row">
                                        <h4>Clientes</h4>
                                        <div class="card-icon-badge">
                                            <i class="bi bi-people-fill"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="stat-value values1_h1" data-value="{{ total_clientes }}">{{ total_clientes }}</div>
                                        <div class="stat-info">
                                            <span><i class="bi bi-tv me-1"></i><span class="text-dark value_tela_span" data-value="{{ total_telas_ativas }}">{{ total_telas_ativas }}</span> telas ativas</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col objeto">
                            <!-- card superior 2 -->
                            <div class="card dashboard-stat-card">
                                <div class="card-body">
                                    <div class="card-header-row">
                                        <h4>Recebido no mês</h4>
                                        <div class="card-icon-badge">
                                            <i class="bi bi-wallet2"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="stat-value values2_h1" data-value="{{ valor_total_pago }}">{{ valor_total_pago }}</div>
                                        <div class="stat-info">
                                            {% if valor_total_pago_qtd > 0 %}
                                            <span><i class="bi bi-hand-thumbs-up text-success me-1"></i><span class="text-dark values2_span" data-value="{{ valor_total_pago_qtd }}">{{ valor_total_pago_qtd }}</span> pago(s) neste mês</span>
                                            {% else %}
                                            <span><span class="text-dark values2_span" data-value="{{ valor_total_pago_qtd }}">{{ valor_total_pago_qtd }}</span> sem pagamentos</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col objeto">
                            <!-- card superior 3 -->
                            <div class="card dashboard-stat-card">
                                <div class="card-body">
                                    <div class="card-header-row">
                                        <h4>À receber no mês</h4>
                                        <div class="card-icon-badge">
                                            <i class="bi bi-cash-coin"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="stat-value values3_h1" data-value="{{ valor_total_receber }}">{{ valor_total_receber }}</div>
                                        <div class="stat-info">
                                            {% if valor_total_receber_qtd > 0 %}
                                            <span><i class="bi bi-exclamation-triangle text-warning me-1"></i><span class="text-dark values3_span" data-value="{{ valor_total_receber_qtd }}">{{ valor_total_receber_qtd }}</span> à vencer</span>
                                            {% else %}
                                            <span><span class="text-dark values3_span" data-value="{{ valor_total_receber_qtd }}">{{ valor_total_receber_qtd }}</span> sem vencimentos</span>
                                            {% endif %}
                                            {% if clientes_em_atraso > 0 %}
                                            <span><i class="bi bi-hand-thumbs-down text-danger me-1"></i><span class="text-dark values1_span" data-value="{{ clientes_em_atraso }}">{{ clientes_em_atraso }}</span> em atraso</span>
                                            {% else %}
                                            <span><span class="text-dark values1_span" data-value="{{ clientes_em_atraso }}">{{ clientes_em_atraso }}</span> sem atrasos</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col objeto">
                            <!-- card superior 4 -->
                            <div class="card dashboard-stat-card">
                                <div class="card-body">
                                    <div class="card-header-row">
                                        <h4>Resumo planos</h4>
                                        <div class="card-icon-badge">
                                            <i class="bi bi-bar-chart-line-fill"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="stat-plans">
                                            {% for p in planos_resumo %}
                                            <p>{{ p.qtd }} <span class="fw-bold text-primary">{{ p.nome|title }}</span> ({{ p.pct|floatformat:0 }}%)</p>
                                            {% empty %}
                                            <p class="text-muted">Nenhum plano cadastrado.</p>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col objeto">
                            <!-- card superior 5 -->
                            <div class="card dashboard-stat-card">
                                <div class="card-body">
                                    <div class="card-header-row">
                                        <h5>Adesões / Cancelamentos</h5>
                                        <div class="card-icon-badge">
                                            <i class="bi bi-arrow-left-right"></i>
                                        </div>
                                    </div>
                                    <div class="card-content">
                                        <div class="stat-dual">
                                            <div class="stat-dual-values">
                                                <h2>{{novos_clientes_qtd}}</h2>
                                                <h2>{{clientes_cancelados_qtd}}</h2>
                                            </div>
                                            <div class="stat-dual-labels">
                                                <p><i class="bi bi-arrow-up-short text-success"></i><span class="text-success">Novos</span></p>
                                                <p><i class="bi bi-arrow-down-short text-danger"></i><span class="text-danger">Cancelados</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-4 mt-6">
                        <div class="col-12 col-lg-7 col-xl-7 objeto">
                            <div class="card mapa-clientes-card h-100">
                                <div class="card-body">
                                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3">
                                        <div>
                                            <h4 class="mb-1">Clientes ativos por estado</h4>
                                            <p class="text-muted small mb-0 fs-6">Passe o mouse sobre o mapa para explorar os estados.</p>
                                        </div>
                                        <div id="mapa-clientes-summary" class="d-flex flex-wrap gap-2 small text-muted">
                                            <span class="mapa-summary-chip mapa-total-chip" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modal-clientes-estados" title="Clique para ver detalhes">
                                                Total: <strong>0</strong>
                                            </span>
                                            <span class="mapa-summary-chip mapa-exterior-chip" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#modal-clientes-exterior" title="Clique para ver detalhes">
                                                Exterior: <strong>0</strong>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-8">
                                            <div id="mapa-clientes" class="mapa-clientes-canvas">
                                                <div class="mapa-clientes-loading">Carregando mapa...</div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-4">
                                            <div id="mapa-top5" class="mapa-top5-container">
                                                <div class="mapa-top5-loading text-muted small">Carregando...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Clientes por Estado -->
                        <div class="modal fade" id="modal-clientes-estados" tabindex="-1" aria-labelledby="modal-clientes-estados-label" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modal-clientes-estados-label">
                                            <i class="bi bi-geo-alt me-2"></i>Clientes por Estado
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                    </div>
                                    <div class="modal-body p-0" style="max-height: 400px; overflow-y: auto;">
                                        <div id="lista-clientes-estados">
                                            <div class="text-center text-muted py-3">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                Carregando...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal Clientes no Exterior -->
                        <div class="modal fade" id="modal-clientes-exterior" tabindex="-1" aria-labelledby="modal-clientes-exterior-label" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="modal-clientes-exterior-label">
                                            <i class="bi bi-globe me-2"></i>Clientes no Exterior
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div id="lista-clientes-exterior">
                                            <div class="text-center text-muted py-3">
                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                Carregando...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-lg-5 col-xl-5 objeto">
                            <div class="card clientes-servidor-card h-100">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-2 mb-3">
                                        <div>
                                            <h4 class="mb-1">Clientes por servidor</h4>
                                            <p class="text-muted small mb-0 fs-6">Selecione um servidor para ver os aplicativos mais usados.</p>
                                        </div>
                                        <div>
                                            <select id="clientes-servidor-select" class="form-select form-select-sm"></select>
                                        </div>
                                    </div>
                                    <div id="clientes-servidor-chart" class="clientes-servidor-canvas flex-grow-1">
                                        <div class="clientes-servidor-loading">Carregando gráfico...</div>
                                        <div class="clientes-servidor-empty d-none">Nenhum cliente encontrado para o filtro selecionado.</div>
                                        <canvas class="clientes-servidor-canvas-element d-none"></canvas>
                                        <div class="clientes-servidor-legend d-none"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Alerta: Clientes sem Forma de Pagamento -->
                    {% if clientes_sem_forma_pgto > 0 %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="alert alert-danger d-flex align-items-start shadow-sm" role="alert">
                                <i class="bi bi-exclamation-triangle-fill fs-4 me-3 mt-1"></i>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-1 fw-bold">Atenção: Clientes sem Forma de Pagamento</h6>
                                    <p class="mb-1">
                                        <strong>{{ clientes_sem_forma_pgto }}</strong> cliente(s) ativo(s) não estão associados a nenhuma forma de pagamento.
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Esses clientes não receberão notificações automáticas sobre vencimentos e pagamentos.
                                    </small>
                                </div>
                                <a href="{% url 'cadastro-forma-pagamento' %}" class="btn btn-outline-danger btn-sm ms-3 align-self-center">
                                    <i class="bi bi-gear me-1"></i>Configurar
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- row  -->
                    <div class="row mt-2 g-4 align-items-stretch">
                        <div class="col-12">
                            <div class="card card-dashboard-tabs h-100">
                                <div class="dashboard-tabs-surface">
                                    <ul class="nav nav-tabs dashboard-tabs" id="dashboard-table-tabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="tab-renovacoes" data-bs-toggle="tab" data-bs-target="#pane-renovacoes" type="button" role="tab" aria-controls="pane-renovacoes" aria-selected="true">
                                                <span class="dashboard-tab-icon tab-icon-renovacoes">
                                                    <i class="bi bi-arrow-repeat"></i>
                                                </span>
                                                <span class="dashboard-tab-label">Renovações</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="tab-evolucao" data-bs-toggle="tab" data-bs-target="#pane-evolucao" type="button" role="tab" aria-controls="pane-evolucao" aria-selected="false">
                                                <span class="dashboard-tab-icon tab-icon-evolucao">
                                                    <i class="bi bi-graph-up"></i>
                                                </span>
                                                <span class="dashboard-tab-label">Evolu&ccedil;&atilde;o do Patrim&ocirc;nio</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="tab-adesao-cancelamentos" data-bs-toggle="tab" data-bs-target="#pane-adesao-cancelamentos" type="button" role="tab" aria-controls="pane-adesao-cancelamentos" aria-selected="false">
                                                <span class="dashboard-tab-icon tab-icon-adesao">
                                                    <i class="bi bi-bar-chart-steps"></i>
                                                </span>
                                                <span class="dashboard-tab-label">Ades&atilde;o e Cancelamentos</span>
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="tab-receita-anual" data-bs-toggle="tab" data-bs-target="#pane-receita-anual" type="button" role="tab" aria-controls="pane-receita-anual" aria-selected="false">
                                                <span class="dashboard-tab-icon tab-icon-receita">
                                                    <i class="bi bi-cash-stack"></i>
                                                </span>
                                                <span class="dashboard-tab-label">Receita Anual</span>
                                            </button>
                                        </li>
                                        {% if user.is_superuser %}
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="tab-revendedores" data-bs-toggle="tab" data-bs-target="#pane-revendedores" type="button" role="tab" aria-controls="pane-revendedores" aria-selected="false">
                                                <span class="dashboard-tab-icon tab-icon-revendedores">
                                                    <i class="bi bi-people-fill"></i>
                                                </span>
                                                <span class="dashboard-tab-label">Revendedores</span>
                                            </button>
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                                <div class="dashboard-tab-content w-100">
                                    <div class="tab-content" id="dashboard-table-tabs-content">
                                        <div class="tab-pane fade show active" id="pane-renovacoes" role="tabpanel" aria-labelledby="tab-renovacoes">
                                            <div class="dashboard-tab-body">
                                                <div class="dashboard-search mb-4">
                                                    <input type="text" name="q" class="form-control" placeholder="Pesquisar"
                                                        aria-label="Pesquisar" aria-describedby="button-pesquisar" id="searchInput"
                                                        autocomplete="off">
                                                </div>
                                                <div id="tabela-container">
                                                    {% include 'partials/table-clients.html' %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="pane-evolucao" role="tabpanel" aria-labelledby="tab-evolucao">
                                            <div class="dashboard-tab-body">
                                                <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center gap-3 mb-4">
                                                    <form id="filtro-grafico" class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                                        <label for="evolucao-period-select" class="fw-semibold text-muted small text-uppercase mb-0">Per&iacute;odo</label>
                                                        <select id="evolucao-period-select" class="form-select form-select-sm">
                                                            <option value="all">Desde o in&iacute;cio</option>
                                                            <option value="12" selected>12 Meses</option>
                                                            <option value="24">2 Anos</option>
                                                            <option value="60">5 Anos</option>
                                                            <option value="120">10 Anos</option>
                                                        </select>
                                                    </form>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-center flex-column flex-md-row gap-4 position-relative" id="evolucao-chart-wrapper" style="min-height: 320px;">
                                                    <canvas id="evolucaoChart" style="width:100%; height:320px"></canvas>
                                                    <div id="evolucao-empty-state" class="text-muted small d-none text-center">
                                                        Nenhum dado disponível para o período selecionado.
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="pane-adesao-cancelamentos" role="tabpanel" aria-labelledby="tab-adesao-cancelamentos">
                                            <div class="dashboard-tab-body">
                                                <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center gap-3 mb-4">
                                                    <form id="adesao-cancelamentos-filter" class="d-flex flex-column flex-sm-row align-items-sm-center gap-3 flex-wrap">
                                                        <div class="d-flex flex-column">
                                                            <label for="adesao-cancelamentos-mode" class="fw-semibold text-muted small text-uppercase mb-0">Vis&atilde;o</label>
                                                            <select id="adesao-cancelamentos-mode" class="form-select form-select-sm">
                                                                <option value="monthly" selected>Mensal</option>
                                                                <option value="annual">Anual</option>
                                                                <option value="lifetime">Desde o in&iacute;cio</option>
                                                            </select>
                                                        </div>
                                                        <div class="d-flex flex-column" id="adesao-cancelamentos-month-group">
                                                            <label for="adesao-cancelamentos-month" class="fw-semibold text-muted small text-uppercase mb-0">M&ecirc;s</label>
                                                            <select id="adesao-cancelamentos-month" class="form-select form-select-sm">
                                                                <option value="1">Janeiro</option>
                                                                <option value="2">Fevereiro</option>
                                                                <option value="3">Mar&ccedil;o</option>
                                                                <option value="4">Abril</option>
                                                                <option value="5">Maio</option>
                                                                <option value="6">Junho</option>
                                                                <option value="7">Julho</option>
                                                                <option value="8">Agosto</option>
                                                                <option value="9">Setembro</option>
                                                                <option value="10">Outubro</option>
                                                                <option value="11">Novembro</option>
                                                                <option value="12">Dezembro</option>
                                                            </select>
                                                        </div>
                                                        <div class="d-flex flex-column" id="adesao-cancelamentos-year-group">
                                                            <label for="adesao-cancelamentos-year" class="fw-semibold text-muted small text-uppercase mb-0">Ano</label>
                                                            <select id="adesao-cancelamentos-year" class="form-select form-select-sm"></select>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-center flex-column flex-md-row gap-4 position-relative" id="adesao-cancel-chart-wrapper" style="min-height: 320px;">
                                                    <canvas id="adesaoCancelChart" style="width:100%; height:320px"></canvas>
                                                    <div id="adesao-cancel-empty" class="text-muted small d-none text-center">
                                                        Nenhum dado disponível para o filtro selecionado.
                                                    </div>
                                                </div>
                                                <div id="adesao-cancel-summary" class="text-muted small text-center mt-3"></div>
                                            </div>
                                        </div>
                                        <div class="tab-pane fade" id="pane-receita-anual" role="tabpanel" aria-labelledby="tab-receita-anual">
                                            <div class="dashboard-tab-body">
                                                <div class="d-flex flex-column flex-xl-row align-items-start align-items-xl-center gap-3 mb-4">
                                                    <form id="receita-anual-filter" class="d-flex flex-column flex-sm-row align-items-sm-center gap-3 flex-wrap">
                                                        <div class="d-flex flex-column">
                                                            <label for="receita-anual-periodo" class="fw-semibold text-muted small text-uppercase mb-0">Per&iacute;odo</label>
                                                            <select id="receita-anual-periodo" class="form-select form-select-sm">
                                                                <option value="current" selected>Ano atual</option>
                                                                <option value="last5">&Uacute;ltimos 5 anos</option>
                                                                <option value="all">Todos os anos</option>
                                                            </select>
                                                        </div>
                                                    </form>
                                                </div>
                                                <div class="row">
                                                    <div class="col-12 col-lg-8">
                                                        <div class="d-flex align-items-center justify-content-center flex-column flex-md-row gap-4 position-relative" id="receita-anual-chart-wrapper" style="min-height: 320px;">
                                                            <canvas id="receitaAnualChart" style="width:100%; height:320px"></canvas>
                                                            <div id="receita-anual-empty" class="text-muted small d-none text-center">
                                                                Nenhum dado dispon&iacute;vel para o per&iacute;odo selecionado.
                                                            </div>
                                                            <div id="receita-anual-loading" class="text-muted small text-center">
                                                                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                                Carregando dados...
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-12 col-lg-4 mt-4 mt-lg-0">
                                                        <div class="card border-0 bg-light h-100">
                                                            <div class="card-body">
                                                                <h6 class="card-title text-muted text-uppercase small fw-semibold mb-3">
                                                                    <i class="bi bi-list-ul me-2"></i>Resumo por Forma de Pagamento
                                                                </h6>
                                                                <div id="receita-anual-summary">
                                                                    <div class="text-muted small text-center py-3">
                                                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                                        Carregando...
                                                                    </div>
                                                                </div>
                                                                <hr class="my-3">
                                                                <div id="receita-anual-total" class="d-flex justify-content-between align-items-center">
                                                                    <span class="fw-semibold text-muted small text-uppercase">Total Geral</span>
                                                                    <span class="fw-bold text-primary fs-5">-</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% if user.is_superuser %}
                                        <div class="tab-pane fade" id="pane-revendedores" role="tabpanel" aria-labelledby="tab-revendedores">
                                            <div class="dashboard-tab-body">
                                                <div class="d-flex gap-2 mb-4">
                                                    <div class="dashboard-search flex-grow-1">
                                                        <input type="text" class="form-control"
                                                               id="searchRevendedores"
                                                               placeholder="Buscar por nome ou usu&aacute;rio..."
                                                               autocomplete="off">
                                                    </div>
                                                    <button type="button" class="btn btn-success" onclick="abrirModalCriarRevendedor()">
                                                        <i class="bi bi-plus-lg me-1"></i>Novo
                                                    </button>
                                                </div>
                                                <div id="tabela-revendedores-container">
                                                    {% include 'partials/table-revendedores.html' %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- row  -->
{% endblock %}

{% block extra_js %}
<!-- Componentes reutilizáveis da tabela -->
<script src="{% static 'dashboard/js/components/table-sortable.js' %}"></script>
<script src="{% static 'dashboard/js/components/dashboard-table-manager.js' %}"></script>

<!-- Dashboard principal -->
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>

<!-- Receita Anual -->
<script src="{% static 'assets/js/receita_anual.js' %}"></script>

<!-- Inicialização do gerenciador da tabela -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Dashboard] Inicializando DashboardTableManager...');

    // Cria e inicializa o gerenciador da tabela
    const tableManager = new DashboardTableManager();
    const initialized = tableManager.init();

    if (initialized) {
        // Expõe globalmente para uso em callbacks de modais
        window.dashboardTableManager = tableManager;
        console.log('[Dashboard] DashboardTableManager inicializado com sucesso');
    } else {
        console.error('[Dashboard] Falha ao inicializar DashboardTableManager');
    }

    // ========== VARIÁVEIS GLOBAIS PARA MODAL DE EDIÇÃO ==========
    // Dispositivos e aplicativos disponíveis (para geração dinâmica de cards)
    window.dispositivosGlobal = {{ dispositivos_json|safe }};
    window.aplicativosGlobal = {{ aplicativos_json|safe }};
    console.log('[Dashboard] Variáveis globais carregadas:', {
        dispositivos: window.dispositivosGlobal.length,
        aplicativos: window.aplicativosGlobal.length
    });
});
</script>

{% if user.is_superuser %}
<!-- JavaScript para aba Revendedores -->
<script>
$(document).ready(function() {
    // ========== BUSCA DE REVENDEDORES ==========
    let searchRevendedoresTimeout;

    $('#searchRevendedores').on('input', function() {
        clearTimeout(searchRevendedoresTimeout);
        const q = $(this).val();
        searchRevendedoresTimeout = setTimeout(() => buscarRevendedores(q), 300);
    });

    // Busca com paginação
    window.buscarRevendedores = function(q = '', page = 1) {
        const perPage = $('#per-page-revendedores').val() || 10;
        const $container = $('#tabela-revendedores-container');

        $container.css('opacity', '0.5');

        $.get('{% url "revendedores-busca" %}', {
            q: q,
            page: page,
            per_page: perPage
        }).done(function(html) {
            $container.html(html).css('opacity', '1');
            // Reinicializa tooltips
            $container.find('[data-bs-toggle="tooltip"]').tooltip();
        }).fail(function() {
            $container.css('opacity', '1');
            Swal.fire('Erro', 'Falha ao buscar revendedores', 'error');
        });
    };

    // Atualiza quando muda registros por página
    $(document).on('change', '#per-page-revendedores', function() {
        buscarRevendedores($('#searchRevendedores').val(), 1);
    });

    // ========== AÇÕES DE REVENDEDOR ==========

    // Editar revendedor
    window.editarRevendedor = function(userId) {
        // Busca dados do revendedor
        fetch(`/revendedores/${userId}/dados/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const r = data.revendedor;
                    $('#edit-revendedor-id').val(r.id);
                    $('#edit-revendedor-username').val(r.username);
                    $('#edit-revendedor-first-name').val(r.first_name);
                    $('#edit-revendedor-last-name').val(r.last_name);
                    $('#edit-revendedor-email').val(r.email);

                    // Reseta campos de senha
                    $('#edit-revendedor-alterar-senha').prop('checked', false);
                    $('#edit-revendedor-senha-fields').hide();
                    $('#edit-revendedor-nova-senha').val('');
                    $('#edit-revendedor-confirmar-senha').val('');

                    // Abre modal
                    const modal = new bootstrap.Modal(document.getElementById('modal-edit-revendedor'));
                    modal.show();
                } else {
                    Swal.fire('Erro', data.message || 'Erro ao carregar dados', 'error');
                }
            })
            .catch(err => {
                console.error('Erro ao carregar dados do revendedor:', err);
                Swal.fire('Erro', 'Falha na comunicação com o servidor', 'error');
            });
    };

    // Salvar edição do revendedor
    window.salvarRevendedor = function() {
        const userId = $('#edit-revendedor-id').val();
        const alterarSenha = $('#edit-revendedor-alterar-senha').is(':checked');

        const payload = {
            first_name: $('#edit-revendedor-first-name').val().trim(),
            last_name: $('#edit-revendedor-last-name').val().trim(),
            email: $('#edit-revendedor-email').val().trim()
        };

        // Validação de primeiro nome
        if (!payload.first_name) {
            Swal.fire('Atenção', 'O primeiro nome é obrigatório', 'warning');
            return;
        }

        // Validação de senha
        if (alterarSenha) {
            const novaSenha = $('#edit-revendedor-nova-senha').val();
            const confirmarSenha = $('#edit-revendedor-confirmar-senha').val();

            if (!novaSenha) {
                Swal.fire('Atenção', 'Digite a nova senha', 'warning');
                return;
            }
            if (novaSenha.length < 6) {
                Swal.fire('Atenção', 'A senha deve ter no mínimo 6 caracteres', 'warning');
                return;
            }
            if (novaSenha !== confirmarSenha) {
                Swal.fire('Atenção', 'As senhas não conferem', 'warning');
                return;
            }
            payload.nova_senha = novaSenha;
        }

        // Desabilita botão
        const $btn = $('#btn-salvar-revendedor');
        const btnText = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Salvando...');

        fetch(`/revendedores/${userId}/editar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            $btn.prop('disabled', false).html(btnText);

            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modal-edit-revendedor')).hide();
                Swal.fire({
                    title: 'Sucesso',
                    text: data.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                buscarRevendedores(); // Atualiza tabela
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        })
        .catch(err => {
            $btn.prop('disabled', false).html(btnText);
            console.error('Erro ao salvar revendedor:', err);
            Swal.fire('Erro', 'Falha ao salvar', 'error');
        });
    };

    // Toggle para mostrar/ocultar campos de senha
    $(document).on('change', '#edit-revendedor-alterar-senha', function() {
        $('#edit-revendedor-senha-fields').toggle(this.checked);
        if (!this.checked) {
            $('#edit-revendedor-nova-senha').val('');
            $('#edit-revendedor-confirmar-senha').val('');
        }
    });

    // ========== CRIAR REVENDEDOR ==========
    window.abrirModalCriarRevendedor = function() {
        // Limpa campos
        $('#form-create-revendedor')[0].reset();

        // Abre modal
        const modal = new bootstrap.Modal(document.getElementById('modal-create-revendedor'));
        modal.show();
    };

    window.criarRevendedor = function() {
        const username = $('#create-revendedor-username').val().trim();
        const firstName = $('#create-revendedor-first-name').val().trim();
        const lastName = $('#create-revendedor-last-name').val().trim();
        const email = $('#create-revendedor-email').val().trim();
        const senha = $('#create-revendedor-senha').val();
        const confirmarSenha = $('#create-revendedor-confirmar-senha').val();

        // Validações
        if (!username) {
            Swal.fire('Atenção', 'Username é obrigatório', 'warning');
            return;
        }

        if (!/^[a-zA-Z0-9_]+$/.test(username)) {
            Swal.fire('Atenção', 'Username deve conter apenas letras, números e underscores', 'warning');
            return;
        }

        if (!firstName) {
            Swal.fire('Atenção', 'Primeiro nome é obrigatório', 'warning');
            return;
        }

        if (!senha) {
            Swal.fire('Atenção', 'Senha é obrigatória', 'warning');
            return;
        }

        if (senha.length < 6) {
            Swal.fire('Atenção', 'A senha deve ter no mínimo 6 caracteres', 'warning');
            return;
        }

        if (senha !== confirmarSenha) {
            Swal.fire('Atenção', 'As senhas não conferem', 'warning');
            return;
        }

        const payload = {
            username: username,
            first_name: firstName,
            last_name: lastName,
            email: email,
            senha: senha
        };

        const $btn = $('#btn-criar-revendedor');
        const btnText = $btn.html();
        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>Criando...');

        fetch('/revendedores/criar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            $btn.prop('disabled', false).html(btnText);
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modal-create-revendedor')).hide();
                Swal.fire({
                    title: 'Sucesso!',
                    text: data.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                buscarRevendedores(); // Atualiza tabela
            } else {
                Swal.fire('Erro', data.message, 'error');
            }
        })
        .catch(err => {
            $btn.prop('disabled', false).html(btnText);
            console.error('Erro ao criar revendedor:', err);
            Swal.fire('Erro', 'Falha ao criar revendedor', 'error');
        });
    };

    // Logar como revendedor
    window.loginComoRevendedor = function(userId, username) {
        Swal.fire({
            title: 'Logar como Revendedor',
            html: `Você será redirecionado para o painel de <strong>${username}</strong>.<br><br>
                   <small class="text-muted">Um banner aparecerá no topo para você retornar ao admin.</small>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-box-arrow-in-right me-1"></i>Continuar',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#0d6efd'
        }).then(function(result) {
            if (result.isConfirmed) {
                window.location.href = '/revendedores/' + userId + '/logar-como/';
            }
        });
    };

    // Bloquear revendedor
    window.bloquearRevendedor = function(userId, username) {
        Swal.fire({
            title: 'Bloquear Revendedor',
            html: `O revendedor <strong>${username}</strong> não poderá mais acessar o sistema.<br><br>
                   <small class="text-muted">Você poderá desbloquear a qualquer momento.</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-lock me-1"></i>Bloquear',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#f59e0b'
        }).then(function(result) {
            if (result.isConfirmed) {
                toggleBloqueioRevendedor(userId);
            }
        });
    };

    // Desbloquear revendedor
    window.desbloquearRevendedor = function(userId, username) {
        Swal.fire({
            title: 'Desbloquear Revendedor',
            html: `Deseja desbloquear <strong>${username}</strong>?<br><br>
                   <small class="text-muted">O revendedor poderá acessar o sistema novamente.</small>`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-unlock me-1"></i>Desbloquear',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#198754'
        }).then(function(result) {
            if (result.isConfirmed) {
                toggleBloqueioRevendedor(userId);
            }
        });
    };

    // Toggle bloqueio
    function toggleBloqueioRevendedor(userId) {
        $.ajax({
            url: '/revendedores/' + userId + '/toggle-bloqueio/',
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            success: function(response) {
                Swal.fire({
                    title: 'Sucesso',
                    text: response.message,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                });
                buscarRevendedores($('#searchRevendedores').val());
            },
            error: function(xhr) {
                Swal.fire('Erro', xhr.responseJSON?.message || 'Erro ao processar', 'error');
            }
        });
    }

    // Excluir revendedor
    window.excluirRevendedor = function(userId, username) {
        Swal.fire({
            title: 'Excluir Revendedor',
            html: `<div class="text-danger mb-3"><i class="bi bi-exclamation-triangle-fill fs-1"></i></div>
                   Tem certeza que deseja excluir <strong>${username}</strong>?<br><br>
                   <small class="text-danger">Esta ação não pode ser desfeita!</small>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '<i class="bi bi-trash me-1"></i>Excluir',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#dc2626'
        }).then(function(result) {
            if (result.isConfirmed) {
                $.ajax({
                    url: '/revendedores/' + userId + '/excluir/',
                    method: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    success: function(response) {
                        Swal.fire({
                            title: 'Sucesso',
                            text: response.message,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        buscarRevendedores($('#searchRevendedores').val());
                    },
                    error: function(xhr) {
                        Swal.fire('Erro', xhr.responseJSON?.message || 'Erro ao excluir', 'error');
                    }
                });
            }
        });
    };

    // ========== ATUALIZAÇÃO AUTOMÁTICA DE AUTOMAÇÕES ==========
    setInterval(function() {
        // Só atualiza se a aba de revendedores estiver ativa
        if ($('#pane-revendedores').hasClass('show') && $('#pane-revendedores').hasClass('active')) {
            buscarRevendedores($('#searchRevendedores').val());
        }
    }, 30000); // A cada 30 segundos
});
</script>
{% endif %}
{% endblock %}
